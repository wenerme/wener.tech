<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-service/observability/metrics/thanos">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/story/rss.xml" title="Wener Live &amp; Life RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/story/atom.xml" title="Wener Live &amp; Life Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Wener Live &amp; Life" href="/opensearch.xml">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"><title data-rh="true">Thanos | Wener Live &amp; Life</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://wener.me/notes/service/observability/metrics/thanos"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Thanos | Wener Live &amp; Life"><meta data-rh="true" name="description" content="- thanos-io/thanos"><meta data-rh="true" property="og:description" content="- thanos-io/thanos"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://wener.me/notes/service/observability/metrics/thanos"><link data-rh="true" rel="alternate" href="https://wener.me/notes/service/observability/metrics/thanos" hreflang="en"><link data-rh="true" rel="alternate" href="https://wener.me/notes/service/observability/metrics/thanos" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://37P8DMWBKF-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a5b87add.css">
<link rel="preload" href="/assets/js/runtime~main.07b4d16f.js" as="script">
<link rel="preload" href="/assets/js/main.92dfd685.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_WawS">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_sWQn themedImage--light_HlbN"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_sWQn themedImage--dark__4Lo"></div><b class="navbar__title text--truncate">Wener</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes">笔记</a><a class="navbar__item navbar__link" href="/story">故事</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pUOn"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_N_jk colorModeToggle_wwB5"><button class="clean-btn toggleButton_gcuK toggleButtonDisabled_AJhd" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Eiwc"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_a3UO"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_Ymm7"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_uXRe docsWrapper_AGYY"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_aXSw" type="button"></button><div class="docPage_Q_rn"><aside class="theme-doc-sidebar-container docSidebarContainer_GlFK"><div class="sidebar_ogDj"><nav class="menu thin-scrollbar menu_fqy9"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes">笔记</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/algorithm">算法</a><button aria-label="Toggle the collapsible sidebar category &#x27;算法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/blockchain">区块链</a><button aria-label="Toggle the collapsible sidebar category &#x27;区块链&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/culture/anime/anime-awesome">culture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/db">数据库</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据库&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/design/ip">design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/dev/build/bazel">dev</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/devops">DevOps</a><button aria-label="Toggle the collapsible sidebar category &#x27;DevOps&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/economics">经济学</a><button aria-label="Toggle the collapsible sidebar category &#x27;经济学&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/elastic/elasticsearch-v2">elastic</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/electrical/multimeter">electrical</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/embedded/embedded-awesome">embedded</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/evolve">自我成长</a><button aria-label="Toggle the collapsible sidebar category &#x27;自我成长&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/game/mhr">game</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/hardware/arm">hardware</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/healthcare">健康</a><button aria-label="Toggle the collapsible sidebar category &#x27;健康&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/howto/network/dns-prevent-spoofing">howto</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/java">Java</a><button aria-label="Toggle the collapsible sidebar category &#x27;Java&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/languages">语言</a><button aria-label="Toggle the collapsible sidebar category &#x27;语言&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/mgmt/pm-awesome">mgmt</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/network/application/dns">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/ops/admin/augeas">ops</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/os/alpine">os</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/photography/camera-awesome">photography</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/platform">平台</a><button aria-label="Toggle the collapsible sidebar category &#x27;平台&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/queue">Queue</a><button aria-label="Toggle the collapsible sidebar category &#x27;Queue&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/reference/cook/glossary">reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/notes/security/acme-awesome">security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/notes/service/analytics/analytics-awesome">service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/analytics/analytics-awesome">analytics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/api/api-awesome">api</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/auth">Auth</a><button aria-label="Toggle the collapsible sidebar category &#x27;Auth&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/baas">Backend as a Service</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backend as a Service&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/bi/apache-superset">bi</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/cms">CMS 概览</a><button aria-label="Toggle the collapsible sidebar category &#x27;CMS 概览&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/cn">CN</a><button aria-label="Toggle the collapsible sidebar category &#x27;CN&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/collaboration">协同软件</a><button aria-label="Toggle the collapsible sidebar category &#x27;协同软件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/crm/crm-awesome">crm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/data">数据</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/dns">DNS Service</a><button aria-label="Toggle the collapsible sidebar category &#x27;DNS Service&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/download">下载器</a><button aria-label="Toggle the collapsible sidebar category &#x27;下载器&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/e-commerce">E-Commerce</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/email">EMail</a><button aria-label="Toggle the collapsible sidebar category &#x27;EMail&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/file/filebrowser">file</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/forge">Forge</a><button aria-label="Toggle the collapsible sidebar category &#x27;Forge&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/forum/forum-awesome">forum</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/im/im-awesome">im</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/media/audio-codec">media</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/network">网络服务</a><button aria-label="Toggle the collapsible sidebar category &#x27;网络服务&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/notion">Notion</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/notes/service/observability">可观察性</a><button aria-label="Toggle the collapsible sidebar category &#x27;可观察性&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/grafana-conf">Grafana 配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/grafana-operator">grafana-operator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/grafana-prometheus">Grafana Prometheus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/grafana-version">Grafana Version</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/grafana">Grafana</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/observability/logging/fluentbit">logging</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/notes/service/observability/metrics">指标</a><button aria-label="Toggle the collapsible sidebar category &#x27;指标&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/cortex">Cortex</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/m3">M3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/metrics-faq">指标服务常见问题</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/observability/metrics/prometheus">Prometheus</a><button aria-label="Toggle the collapsible sidebar category &#x27;Prometheus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/promxy">promxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/thanos-version">Thanos 版本</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/service/observability/metrics/thanos">Thanos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/victoria-metrics-operator">VictoriaMetrics Operator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/metrics/victoria-metrics">VictoriaMetrics</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/netdata">netdata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/observability-awesome">Observability Awesome</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/observability-faq">Observability FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/observability/tracing/jaeger">tracing</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/observability/vector">vector</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/office">办公套件</a><button aria-label="Toggle the collapsible sidebar category &#x27;办公套件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/printing/printing-awesome">printing</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/realtime/realtime-awesome">realtime</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/selfhost">SelfHost</a><button aria-label="Toggle the collapsible sidebar category &#x27;SelfHost&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/service/service-awesome">Service Awesome</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/storage/ceph">storage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/telecom/device">telecom</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/torrent">Torrent</a><button aria-label="Toggle the collapsible sidebar category &#x27;Torrent&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/notes/service/workflow">Workflow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Workflow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/notes/service/xaas/xaas-awesome">xaas</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/tool">工具</a><button aria-label="Toggle the collapsible sidebar category &#x27;工具&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/voip">VoIP</a><button aria-label="Toggle the collapsible sidebar category &#x27;VoIP&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/notes/web">Web</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_BKoE"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_EYvA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_RaEK"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_nrhp"><div class="docItemContainer_EkVX"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_GKCt" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OL5o"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">service</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/service/observability"><span itemprop="name">可观察性</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/service/observability/metrics"><span itemprop="name">指标</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Thanos</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_oqr9 theme-doc-toc-mobile tocMobile_5aMT"><button type="button" class="clean-btn tocCollapsibleButton_CjyO">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Thanos</h1></header><ul><li><a href="https://github.com/thanos-io/thanos">thanos-io/thanos</a><ul><li>Prometheus 长期存储</li><li>后端使用对象存储服务</li></ul></li><li>多租户方案<ul><li>sidecar 配置 external label，使用多层 query</li><li>receive 接收多租户，但不推荐<ul><li>适用于网络隔离场景，querier 无法直接访问 sidecar 时</li></ul></li></ul></li><li><a href="https://thanos.io/storage.md">存储</a><ul><li>S3</li><li>GCS</li><li>Azure</li><li>OpenStack Swift</li><li>Tencent COS</li><li>AliYun OSS</li></ul></li><li>块存储<ul><li>基于 Prometheus TSDB</li><li>默认 2h 一个区块</li><li>每个块都有对应的 index<ul><li>指标名字</li><li>标签</li><li>时间范围</li></ul></li></ul></li></ul><admonition type="caution"><ul><li>compact<ul><li>raw 格式数据<strong>非常大</strong> - 需要 compact 进行压缩</li><li>如果 raw 导致磁盘空间满，会可能驱逐 compact 进入恶性循环</li><li>compact 需要与 存储 服务进行大量数据交互 - 最好在同一个节点或机房</li><li>一个 bucket 只能运行 <strong>一个</strong> compact<ul><li>因此有一定规模后 compact 反而可能成为瓶颈</li></ul></li></ul></li><li>receive<ul><li>以为需要缓存接收的数据，因此也需要磁盘空间 一般 3-5 G</li></ul></li><li>一个租户需要一个 Bucket<ul><li><a href="https://github.com/thanos-io/thanos/issues/1318">#1318</a> 提议添加前缀 - 但工作量很大</li></ul></li></ul></admonition><h2 id="组件">组件</h2><ul><li>compactor<ul><li>不参与集群</li><li>压缩 OSS 数据</li><li>下采样 - downsampling<ul><li>大于 40 小时创建 5m 采样</li><li>大于 10 天创建 1h 采样</li></ul></li><li>默认永久保留 <code>--retention.resolution-X=0d</code> - X 为采样类型 - raw,5m,1h</li><li>执行保留策略 - 删除旧数据</li><li>一个 bucket 部署一个 - 并行部署多个会有问题</li><li>下采样并不会节省空间，每个原始区块会添加额外的下采样区块数据 - 只比原始的小一点点<ul><li>相当于容量增加 3 倍</li></ul></li><li>提升范围查询性能</li><li>运行需要本地临时存储<ul><li>建议 100G</li><li>可重启后删除 - 不需要持久</li></ul></li><li>kube-thanos 将 compact 部署为 sts 而不是 cronjob</li></ul></li><li>query<ul><li>无状态，可扩容</li><li>实现 Prometheus HTTP v1 API</li><li>PromQL</li><li>从 StoreAPI 获取数据<ul><li>部分返回<ul><li><code>?partial_response=1</code> - 请求接受部分响应</li><li><code>--query.partial-response</code> - 控制是否开启和策略</li><li><code>--query.timeout=2m</code> - 查询超时</li><li><code>--query.lookback-delta=5m</code> - 回查时间，过短会产生 gap，至少设置为抓取时间两倍</li><li><code>--store.response-timeout</code> - 存储响应超时</li><li><code>--no-query.partial-response</code> - 强制关闭</li></ul></li><li>支持指定副本 label 就行去重<ul><li><code>?replicaLabels=replicaA&amp;replicaLabels=replicaB</code></li></ul></li><li>数据去重<ul><li><code>?dedup</code></li><li><code>--query.replica-label</code> - 基于副本标签进行去重</li></ul></li><li>自动下采样<ul><li><code>?max_source_resolution=5m</code> - 0s 禁用，可设置为 1h 或 auto<ul><li>如果发现数据有 gap 可禁用</li></ul></li><li><code>--query.auto-downsampling</code> - 默认为 step/5</li></ul></li><li>并发 select<ul><li><code>--query.max-concurrent-select=4</code> - 每次请求的最大并发 select</li><li><code>--query.max-concurrent=20</code> - 最大并发查询数</li></ul></li><li>支持自定义返回字段</li><li>支持过滤 store<ul><li><code>?query=up&amp;dedup=true&amp;partial_response=true&amp;storeMatch[]={__address__=~&quot;prometheus-foo.*&quot;}</code></li></ul></li></ul></li><li>grafana 可配置查询参数 <code>max_source_resolution=auto&amp;partial_response=true</code></li></ul></li><li>query-frontend<ul><li>无状态，可扩容</li><li>实际使用时影响查询性能的关键组件</li><li>处理 <code>/api/v1/query_range</code></li><li><code>--query-frontend.downstream-url</code> - 下游 Prometheus 地址 - 一般为 Thanos Query 暴露地址</li><li><code>--query-frontend.compress-responses</code> - 响应结果压缩</li><li>并行<ul><li><code>-query-range.max-query-length=0</code> - 限制查询长度</li><li><code>--query-range.max-query-parallelism=14</code> - 最大并行查询</li></ul></li><li>切分查询<ul><li><code>--query-range.split-interval=24h</code> - 切分并行查询的间隔 <code>response-cache-config</code></li><li>可以避免 query 查询过大数据导致 OOM</li><li>并行查询效率更好</li><li>query 负载均衡</li></ul></li><li>重试<ul><li><code>--query-range.max-retries-per-request=5</code></li></ul></li><li>缓存<ul><li>下次查询时复用</li><li>缺少数据会并行查询就行补齐</li><li>支持 IN-MEMORY 和 MEMCACHED</li><li><code>--query-range.response-cache-max-freshness=1m</code> - 缓存的最新时间 - 小于该时间不缓存</li><li><code>--query-range.response-cache-config-file</code></li><li><code>--query-range.response-cache-config</code></li></ul></li><li>记录慢查询<ul><li><code>--query-frontend.log-queries-longer-than</code></li></ul></li></ul></li><li>receive<ul><li>实现 Prometheus 远程写入接口，写入本地 tsdb</li><li>目前只支持单个 tsdb</li><li>暴露 StoreAPI</li><li>实现基于推送的指标采集</li><li>用于网络不互通、外部指标采集环境</li><li>可继续传递到 receive<ul><li>支持多副本</li></ul></li><li>可以用支持多租户<ul><li>租户头 <code>--receive.tenant-header=THANOS-TENANT</code> 可用于分流</li></ul></li><li>注意 ⚠️<ul><li>write 地址为 <code>/api/v1/receive</code></li><li>节点调整时确保数据被刷到 存储</li><li>重启后可能会收到大量 Prometheus 请求需要控制好流量</li><li>默认会添加 <code>tenant_id=&quot;default-tenant&quot;</code> - 可自行控制</li><li>资源占用较多，反向代理也会占用资源<ul><li>4k/s 大约 0.1 CPU, 250M 内存</li><li>0 负载的 nginx 多了 1 的 CPU</li></ul></li></ul></li><li>参考<ul><li><a href="https://thanos.io/tip/proposals/201812_thanos-remote-receive.md/">Thanos Remote Write</a></li></ul></li></ul></li><li>rule<ul><li>对查询求值 - 提供 StoreAPI，结果写入磁盘</li><li>类似一个简单的 Prometheus 实例</li><li>因为是查询的分布式数据，查询可能失败，用于监控时需要小心</li><li>支持配置记录规则、告警规则</li></ul></li><li>sidecar<ul><li>上传 Prometheus 的数据到对象存储</li><li>提供 StoreAPI</li><li>要求 prometheus 设置参数<ul><li><code>--storage.tsdb.min-block-duration=2h</code></li><li><code>--storage.tsdb.max-block-duration=2h</code></li></ul></li><li>数据有大约 2h 延时，如果 prometheus 异常数据丢失则可能丢失 2h 的监控数据</li><li>要求 prometheus 配置 external_labels - 用于去重</li><li>默认不会上传已压缩数据<ul><li>tsdb 块下 meta.json 里的 <code>compaction.level</code> 表示了压缩级别 - 1 为未压缩</li><li><code>--shipper.upload-compacted</code> 上传压缩数据 - 用于第一次迁移</li></ul></li><li>注意 ⚠️<ul><li>无法 flush 数据 - prometheus 无法 flush wal，因此可能会丢失 2h 数据</li></ul></li></ul></li><li>store<ul><li>存储网关 - Store Gateway</li><li>读取 对象存储 暴露 StoreAPI</li><li>支持索引缓存<ul><li>in-memory</li><li>memcached</li></ul></li><li>支持 Bucket 缓存 - 缓存 Prometheus 区块数据<ul><li>memcached</li></ul></li><li>默认内存缓存 250M</li><li>支持文件缓存 index-header, in-mem cache items, meta.jsons</li><li>注意<ul><li>初始索引过程可能会耗费大量内存</li></ul></li></ul></li><li>tools<ul><li>bucket 管理工具<ul><li>ls、verify、downsampling、inspect、replicate、web</li></ul></li><li>规则检查</li></ul></li><li>StoreAPI<ul><li>提供数据的后端接口</li><li>Prometheus Sidecar</li><li>对象存储 - Store Gateway</li><li>全局 alerting/recording 规则结果 - Ruler</li><li>Receiver</li><li>其他 Queriers</li><li>其他指标系统 - OpenTSDB</li></ul></li><li><a href="https://github.com/G-Research/thanos-remote-read">G-Research/thanos-remote-read</a><ul><li>将 remove read 暴露为 StoreAPI</li><li>也可以使用 Sidecar + Prometheus Remote Read 来达到相同目的</li></ul></li></ul><table><thead><tr><th>Component</th><th>Interface</th><th>Port</th></tr></thead><tbody><tr><td>Sidecar</td><td>gRPC</td><td>10901</td></tr><tr><td>Sidecar</td><td>HTTP</td><td>10902</td></tr><tr><td>Query</td><td>gRPC</td><td>10903</td></tr><tr><td>Query</td><td>HTTP</td><td>10904</td></tr><tr><td>Store</td><td>gRPC</td><td>10905</td></tr><tr><td>Store</td><td>HTTP</td><td>10906</td></tr><tr><td>Receive</td><td>gRPC (StoreAPI)</td><td>10907</td></tr><tr><td>Receive</td><td>HTTP (remote write API)</td><td>10908</td></tr><tr><td>Receive</td><td>HTTP</td><td>10909</td></tr><tr><td>Rule</td><td>gRPC</td><td>10910</td></tr><tr><td>Rule</td><td>HTTP</td><td>10911</td></tr><tr><td>Compact</td><td>HTTP</td><td>10912</td></tr></tbody></table><pre><code class="language-bash"># macOS
brew install thanos

# external_labels 是必须的
cat &lt;&lt;YAML &gt; prometheus.yaml
global:
  external_labels:
    cluster: test
    replica: svr-1
  scrape_interval: 15s

scrape_configs:
  - job_name: &quot;prometheus&quot;
    static_configs:
    - targets: [&quot;localhost:9090&quot;]

  - job_name: &quot;node&quot;
    static_configs:
    - targets: [&quot;localhost:9100&quot;]
YAML

# 默认参数
# http://localhost:9090
prometheus \
  --config.file=&quot;prometheus.yml&quot; \
  --storage.tsdb.path=data/ \
  --storage.tsdb.max-block-duration=2h \
  --storage.tsdb.min-block-duration=2h \
  --web.enable-lifecycle \
  --web.enable-admin-api

cat &lt;&lt;YAML &gt; thanos-store.yaml
type: S3
config:
  bucket: &quot;metrics&quot;
  endpoint: &quot;minio.cluster.internal&quot;
  insecure: true
  signature_version2: false
  access_key: &quot;key&quot;
  secret_key: &quot;secretsecret&quot;
YAML
# Sidecar 上传 chunk 暴露 prometheus 为 StoreAPI
# 默认 http://localhost:10902 grpc://localhost:10901
thanos sidecar \
  --tsdb.path=&quot;./data&quot; \
  --prometheus.url=http://localhost:9090 \
  --objstore.config-file=thanos-store.yaml \
  --http-address=&quot;0.0.0.0:10902&quot; \
  --grpc-address=&quot;0.0.0.0:10901&quot;

# 暴露 S3 为 StoreAPI
# 修改端口避免冲突
thanos store \
    --http-address=0.0.0.0:10912 \
    --grpc-address=0.0.0.0:10911 \
    --data-dir=&quot;./store-cache&quot; \
    --objstore.config-file=thanos-store.yaml

# 查询
# 修改端口避免冲突
# 查询 UI http://localhost:11902/graph
# --store 为后端
thanos query \
    --http-address=0.0.0.0:11902 \
    --grpc-address=0.0.0.0:11901 \
    --store=localhost:10901 \
    --store=localhost:10911


# 压缩
# --data-dir cache blocks and process compactions
# --wait 等待新的任务，默认执行完成后退出
thanos compact \
  --http-address=0.0.0.0:12902 \
  --data-dir=thanos-compact \
  --objstore.config-file=thanos-store.yaml \
  --wait
</code></pre><h2 id="tool">Tool</h2><pre><code class="language-bash"># 查看 bucket 分布情况
# http://localhost:10902/
thanos tools bucket web --objstore.config-file=thanos-bucket.yaml

# 查看 bucket
thanos tools bucket ls
# 以 table 显示 bucket 信息
# | ULID | FROM | UNTIL | RANGE | UNTIL-DOWN | #SERIES | #SAMPLES | #CHUNKS | COMP-LEVEL | COMP-FAILED | LABELS | RESOLUTION | SOURCE |
thanos tools bucket inspect

# 标记删除或不压缩
# tools bucket mark --id=ID --marker=MARKER --details=DETAILS
# Marker - deletion-mark.json,no-compact-mark.json
# mark 或删除在 web 上不会刷新，需要停止从开
thanos tools bucket mark --id 01EJD9PS4P3MJMF3TGJGTJTE25 --marker deletion-mark.json --details &#x27;useless bucket&#x27;

# 立即清除被 mark bucket
# 默认由 compactor 来清理
thanos tools bucket cleanup

# out.txt
thanos tools bucket inspect --log.level error --objstore.config-file=thanos-store.yaml &gt; out.txt
# ids.txt
cat out.txt | grep -P &#x27;\d\d-2021&#x27; | cut -d &#x27;|&#x27; -f 2  | tr -d &#x27; &#x27;| sed &#x27;s/^/--id=/&#x27; &gt; ids.txt
# filter &amp; delete
# 批量标记删除 - 需要有 compact 实际删除 - 或者执行 compact --delete-delay=0
cat out.txt | grep -P &#x27;(01|02|03|04|05|06|07|08)-2021&#x27; | cut -d &#x27;|&#x27; -f 2  | tr -d &#x27; &#x27;| sed &#x27;s/^/--id=/&#x27; | xargs thanos tools bucket mark --marker deletion-mark.json --details &#x27;delete&#x27; --objstore.config-file=thanos-store.yaml
cat ids.txt | xargs thanos tools bucket mark --marker deletion-mark.json --details &#x27;delete&#x27; --objstore.config-file=thanos-store.yaml
</code></pre><h2 id="缓存配置">缓存配置</h2><pre><code class="language-yaml"># 文件缓存
type: IN-MEMORY
config:
  max_size: 0
  max_size_items: 2048
  # 缓存时效
  validity: 6h

---
type: MEMCACHED
config:
  addresses: []
  timeout: 0s
  max_idle_connections: 0
  max_async_concurrency: 0
  max_async_buffer_size: 0
  max_get_multi_concurrency: 0
  max_item_size: 0
  max_get_multi_batch_size: 0
  dns_provider_update_interval: 0s
  expiration: 0s
</code></pre><h2 id="存储配置">存储配置</h2><ul><li><a href="https://thanos.io/tip/thanos/storage.md">Storage</a></li></ul><pre><code class="language-yaml">---
# S3 常用配置
type: S3
config:
  bucket: &#x27;&#x27;
  endpoint: &#x27;&#x27;
  # HTTP 还是 HTTPS
  insecure: true
  access_key: &#x27;&#x27;
  secret_key: &#x27;&#x27;
  # 部分 S3 实现需要设置为 false
  signature_version2: false
  # multipart 上传的单块 大小 - 部分 S3 实现需要修改
  # 0 -&gt; 默认 128m
  part_size: 0

---
# S3 完整配置
type: S3
config:
  bucket: &#x27;&#x27;
  endpoint: &#x27;&#x27;
  region: &#x27;&#x27;
  access_key: &#x27;&#x27;
  insecure: false
  signature_version2: false
  secret_key: &#x27;&#x27;
  put_user_metadata: {}
  http_config:
    idle_conn_timeout: 1m30s
    response_header_timeout: 2m
    insecure_skip_verify: false
  trace:
    enable: false
  part_size: 134217728
  sse_config:
    type: &#x27;&#x27;
    kms_key_id: &#x27;&#x27;
    kms_encryption_context: {}
    encryption_key: &#x27;&#x27;

---
# 阿里云 OSS
type: ALIYUNOSS
config:
  endpoint: &#x27;&#x27;
  bucket: &#x27;&#x27;
  access_key_id: &#x27;&#x27;
  access_key_secret: &#x27;&#x27;

---
# 腾讯云 COS
type: COS
config:
  bucket: &#x27;&#x27;
  region: &#x27;&#x27;
  app_id: &#x27;&#x27;
  secret_key: &#x27;&#x27;
  secret_id: &#x27;&#x27;
</code></pre><h2 id="kubernetest">Kubernetest</h2><ul><li><a href="https://github.com/thanos-io/kube-thanos">thanos-io/kube-thanos</a> - jsonnet manifest<ul><li><a href="https://github.com/thanos-io/kube-thanos/blob/master/examples/all/manifests">examples/all/manifests</a><ul><li>示例，值得参考</li></ul></li></ul></li><li><a href="https://github.com/banzaicloud/thanos-operator">banzaicloud/thanos-operator</a></li></ul><h2 id="tracing">Tracing</h2><ul><li><a href="https://thanos.io/tip/thanos/tracing.md/">Tracing</a></li></ul><pre><code class="language-yaml">type: JAEGER
config:
  service_name: &#x27;&#x27;
  disabled: false
  rpc_metrics: false
  tags: &#x27;&#x27;
  sampler_type: &#x27;&#x27;
  sampler_param: 0
  sampler_manager_host_port: &#x27;&#x27;
  sampler_max_operations: 0
  sampler_refresh_interval: 0s
  reporter_max_queue_size: 0
  reporter_flush_interval: 0s
  reporter_log_spans: false
  endpoint: &#x27;&#x27;
  user: &#x27;&#x27;
  password: &#x27;&#x27;
  agent_host: &#x27;&#x27;
  agent_port: 0
</code></pre><h2 id="faq">FAQ</h2><h2 id="expire">Expire</h2><pre><code class="language-bash"># --delete-delay=0 - 立即删除 - 默认 48h
thanos compact \
  --http-address=0.0.0.0:12902 \
  --data-dir=thanos-compact \
  --objstore.config-file=thanos-store.yaml \
  --wait \
  --compact.concurrency=32 \
  --retention.resolution-raw=30d \
  --retention.resolution-5m=90d \
  --retention.resolution-1h=180d \
  --delete-delay=0
</code></pre><h2 id="sidecar-上传历史文件">Sidecar 上传历史文件</h2><pre><code class="language-bash">thanos sidecar \
  --tsdb.path=/var/lib/prometheus/data/ \
  --prometheus.url=http://localhost:9090 \
  --objstore.config-file=thanos-bucket.yaml \
  --shipper.upload-compacted
</code></pre><h3 id="sidecar-暴露-prometheus-为-storeapi">Sidecar 暴露 Prometheus 为 StoreAPI</h3><pre><code class="language-bash">thanos sidecar --prometheus.url=http://localhost:9090
</code></pre><h2 id="跨网络部署方案">跨网络部署方案</h2><ol><li>Prometheus Remote Write + Thanos Receive</li></ol><ul><li>优点<ul><li>部署简单</li><li>不丢数据</li></ul></li><li>缺点<ul><li>RW 性能扩容问题<ul><li>默认 max_samples_per_send 为 100，指标上去后很容易 qps 上百</li><li>如果使用了反向代理，反向代理也会有一定性能问题</li><li>增大单次批量会占用较多内存，例如 max_samples_per_send 5000 capacity 1000 启动发送后内存达到 1G+</li></ul></li><li>稳定性问题<ul><li>需要额外维护 thanos receive</li></ul></li><li>thanos receive 有状态 - 本地记录 tsdb</li></ul></li><li>参考<ul><li><a href="https://thanos.io/tip/proposals/201812_thanos-remote-receive.md/">Thanos Remote Write</a></li></ul></li></ul><ol><li>Prometheus + Sidecar + Prometheus Remote Write + Thanos Receive</li></ol><ul><li>Sidecar 上传 2h</li><li>Receive 查询最近 2h</li><li>优点 - thanos receive 状态无所谓，可丢弃</li><li>缺点 - 多部署一个 sidecar</li></ul><ol><li>Prometheus + Sidecar + StoreAPI tunnel</li></ol><ul><li>StoreAPI 默认 h2c</li><li>缺点<ul><li>grpc 不能 tunnel 到子路径，需要使用子域名或独立端口</li><li>需要额外的 tunnel 部署</li></ul></li><li>优点<ul><li>简单易理解</li><li>打通所需服务网络</li></ul></li></ul><ol><li>Prometheus + Sidecar + Prometheus:8080 tunnel + Sidecar</li></ol><ul><li>可以将 9090 tunnel 到子路径</li><li>内网 sidecar 将 tunnel 暴露为 StoreAPI</li><li>缺点<ul><li>多部署一个 sidecar 到内网</li></ul></li><li>优点<ul><li>可 tunnel 到子路径</li><li>打通所监控的 prometheus</li></ul></li></ul><h2 id="自动下采样">自动下采样</h2><ul><li><code>?max_source_resolution</code><ul><li>0s - 禁用</li><li>5m</li><li>1h</li><li>auto - 自动</li></ul></li><li>使用 rate 可能会导致 gap</li><li>参考<ul><li><a href="https://github.com/thanos-io/thanos/issues/813">#813</a></li></ul></li></ul><pre><code class="language-promql"># 5m 使用下采样会有 gap
avg(irate(node_cpu_seconds_total{mode=&quot;system&quot;}[5m])) by (instance) *100
# 10m 则没有问题
avg(irate(node_cpu_seconds_total{mode=&quot;system&quot;}[10m])) by (instance) *100

# grafana
avg(irate(node_cpu_seconds_total{mode=&quot;system&quot;}[$__interval])) by (instance) *100
</code></pre><h2 id="filter-meta-in-oss">filter meta in oss</h2><pre><code class="language-bash">ls */meta.json | xargs -n 1 -I {}  sh -c &quot;dirname {} | tr -d &#x27;\n&#x27;;echo -n &#x27; &#x27;;jq -r &#x27;.maxTime/1000 | todate&#x27; {}&quot; &gt; /tmp/dump.txt
# 强制删除
cat /tmp/dump.txt | grep &#x27;2021-&#x27; | awk &#x27;{print $1}&#x27; | sudo xargs -I {} rm -r {}
</code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/wenerme/wener/edit/master/notes/service/observability/metrics/thanos.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_icZ1" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_IDPb"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/service/observability/metrics/thanos-version"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Thanos 版本</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/service/observability/metrics/victoria-metrics-operator"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">VictoriaMetrics Operator</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Rbtr thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#组件" class="table-of-contents__link toc-highlight">组件</a></li><li><a href="#tool" class="table-of-contents__link toc-highlight">Tool</a></li><li><a href="#缓存配置" class="table-of-contents__link toc-highlight">缓存配置</a></li><li><a href="#存储配置" class="table-of-contents__link toc-highlight">存储配置</a></li><li><a href="#kubernetest" class="table-of-contents__link toc-highlight">Kubernetest</a></li><li><a href="#tracing" class="table-of-contents__link toc-highlight">Tracing</a></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a></li><li><a href="#expire" class="table-of-contents__link toc-highlight">Expire</a></li><li><a href="#sidecar-上传历史文件" class="table-of-contents__link toc-highlight">Sidecar 上传历史文件</a><ul><li><a href="#sidecar-暴露-prometheus-为-storeapi" class="table-of-contents__link toc-highlight">Sidecar 暴露 Prometheus 为 StoreAPI</a></li></ul></li><li><a href="#跨网络部署方案" class="table-of-contents__link toc-highlight">跨网络部署方案</a></li><li><a href="#自动下采样" class="table-of-contents__link toc-highlight">自动下采样</a></li><li><a href="#filter-meta-in-oss" class="table-of-contents__link toc-highlight">filter meta in oss</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">笔记</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notes/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/os/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip">VoIP</a></li></ul></div><div class="col footer__col"><div class="footer__title">Projects</div><ul class="footer__items clean-list"><li class="footer__item">
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wener/actions" title="wenerme/wener - ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://github.com/wenerme/wener/workflows/Build/badge.svg">
                </a>
              </div>
              </li><li class="footer__item"><a href="https://apis.wener.me" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wener&#x27;s Apis<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pUOn"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/story">Blog</a></li><li class="footer__item"><a href="https://github.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_sWQn themedImage--light_HlbN footer__logo"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_sWQn themedImage--dark__4Lo footer__logo"></div><div class="footer__copyright">Copyright © 1992-2022 Wener - <img alt="cc-by-sa-4.0" src="https://mirrors.creativecommons.org/presskit/buttons/80x15/svg/by-sa.svg"> - Build @2022-09-22 04:38</div></div></div></footer></div>
<script src="/assets/js/runtime~main.07b4d16f.js"></script>
<script src="/assets/js/main.92dfd685.js"></script>
</body>
</html>