<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/story/rss.xml" title="Wener Live &amp; Life RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/story/atom.xml" title="Wener Live &amp; Life Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Wener Live &amp; Life" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"><title data-react-helmet="true">LUKS | Wener Live &amp; Life</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://wener.me/notes/ops/storage/encryption/luks"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="LUKS | Wener Live &amp; Life"><meta data-react-helmet="true" name="description" content="- LUKS - Linux Unified Key Setup"><meta data-react-helmet="true" property="og:description" content="- LUKS - Linux Unified Key Setup"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wener.me/notes/ops/storage/encryption/luks"><link data-react-helmet="true" rel="alternate" href="https://wener.me/notes/ops/storage/encryption/luks" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wener.me/notes/ops/storage/encryption/luks" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.7900c842.css">
<link rel="preload" href="/assets/js/runtime~main.c7f5ed3e.js" as="script">
<link rel="preload" href="/assets/js/main.5d7b778c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Wener</b></a><a class="navbar__item navbar__link" href="/notes/note">笔记</a><a class="navbar__item navbar__link" href="/story">故事</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a><a class="navbar__item navbar__link" href="/notes/tool/network/ip-lookup">工具</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/evolve">自我成长</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/java">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/web/web-awesome">Web</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/languages">语言</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/os/alpine">AlpineLinux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/devops/docker/docker-cookbook">Docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/devops/kubernetes">Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/os/linux/linux-awesome">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/os/virt">虚拟化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/os/os-awesome">操作系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/voip">VoIP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/dev/dev-awesome">开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/devops/devops-faq">DevOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/db">数据库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/queue">消息队列</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/security/security-awesome">安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/service/service-awesome">服务</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/notes/ops/admin/augeas">运维</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/admin/augeas">系统管理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/infra">基础设施</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/network/application/dns">网络</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/notes/ops/storage/storage-glossary">存储</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage/storage-glossary">存储相关名词</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/storage/block/fc">块存储</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/storage/fs/btrfs">文件存储</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/storage/network/ftp">网络存储</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage/encryption">Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/ops/storage/encryption/luks">LUKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage">Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage/tool/compress">Compress</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage/tool/rclone">rclone</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/storage/tool/rsync">rsync</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/notes/ops/service/remote-desktop">服务</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/gitops">GitOps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/hardware/network/cable/poe">以太网供电</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/ops/mirrors">Mirrors</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/howto/ops/alpine-admin-ansible">指南</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/hardware/hardware-awesome">硬件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/algorithm/algorithm-awesome">算法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/healthcare/disease">健康</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/reference/software/glossary">参考</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/notes/tool">工具</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>LUKS</h1></header><ul><li>LUKS - <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup" target="_blank" rel="noopener noreferrer">Linux Unified Key Setup</a><ul><li><a href="https://en.wikipedia.org/wiki/Dm-crypt" target="_blank" rel="noopener noreferrer">dm-crypt</a></li></ul></li><li><a href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html" target="_blank" rel="noopener noreferrer">admin-guide/device-mapper/dm-crypt</a></li><li>注意<ul><li>每个块设备密码独立<ul><li>可以考虑使用 keyfile 然后使用 crypttab 挂载</li></ul></li></ul></li><li>加密方案<ul><li>ROOT 加密</li><li>非 ROOT 加密</li></ul></li><li>kernel<ul><li>AlpineLinux 配置方式 <code>cryptroot=UUID=&lt;UUID&gt; cryptdm=cryptroot</code><ul><li>cryptdm - mapper 名字</li><li>实际处理脚本 <a href="https://github.com/alpinelinux/mkinitfs/blob/961726b6aeb8e12176009675f22ed0ffc2b26e14/initramfs-init.in#L443-L482" target="_blank" rel="noopener noreferrer">initramfs-init.in#L443-L482</a></li></ul></li><li><code>cryptdevice=UUID=&lt;UUID&gt;:cryptroot</code></li><li><code>root=UUID={unencrypted} rw cryptdevice=/dev/disk/by-uuid/{encrypted}:root quiet</code>
nomodeset quiet rootfstype=ext4 cryptroot=UUID=3cb7aacf-4975-466b-bb6d-92a13ad60496 cryptdm=rootCrypt cryptdiscards cryptkey</li></ul></li><li>参考<ul><li>ArchLinux <a href="https://wiki.archlinux.org/index.php/Dm-crypt" target="_blank" rel="noopener noreferrer">dm-crypt</a></li><li><a href="https://blog.csdn.net/isclouder/article/details/80731388" target="_blank" rel="noopener noreferrer">qemu luks</a></li></ul></li></ul><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cryptsetup util-linux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># userspace DM 管理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># dmsetup dmstats</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> device-mapper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">blkid -t </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">TYPE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">crypto_LUKS</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 修改密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksChangeKey /dev/sdb2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">uuidgen </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tr</span><span class="token plain"> -d </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> new-key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksAddKey /dev/sdb2 new-key.txt -d key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 查看上级设备</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dmsetup deps -o devname /dev/mapper/decrypted</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="密钥管理">密钥管理<a class="hash-link" href="#密钥管理" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 所有 slot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksDump /dev/sdb2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 判断 slot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 一个个尝试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --test-passphrase --key-slot </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> /dev/sda2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 测试密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># --verbose 会显示 key slot 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --verbose --test-passphrase /dev/sda2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --verbose --test-passphrase /dev/sda2 -d key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 移除未知的 key slot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup -v luksKillSlot /dev/sdb2 </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 查看当前的 DM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">dmsetup table --showkeys</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 导出 master key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksDump --dump-master-key /dev/loop0p2 -d key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">xxd -r -p masker-key.txt masker-key.bin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 使用 master key 则不需要密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksAddKey /dev/sdb1 --master-key-file </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> masker-key.bin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksAddKey /dev/sdb2 -d key.txt </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> new-key.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="root-分区加密安装">Root 分区加密安装<a class="hash-link" href="#root-分区加密安装" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cryptsetup util-linux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 分区</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/dev/sdb</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">boot_dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">root_dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +128M - boot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># rest  - root</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> </span><span class="token string bash punctuation operator" style="color:rgb(137, 221, 255)">|</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> sfdisk --wipe always </span><span class="token string bash punctuation variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token string" style="color:rgb(195, 232, 141)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">label: dos</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">unit: sectors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">sector-size: 512</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="display:inline-block;color:rgb(195, 232, 141)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">/dev/sdb1 : size=+128M, type=83, bootable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">/dev/sdb2 : type=83</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ======</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 格式化 - 设置密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 设置密码文件 - 或者使用 cryptsetup 生成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">uuidgen </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">yes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> cryptsetup -y -v luksFormat </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> -d key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 打开 - 挂载为 mapper</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> cryptroot -d key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 格式化 fs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mkfs.ext4 /dev/mapper/cryptroot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 挂载到目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> /dev/mapper/cryptroot /mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 卸载再次挂载确保生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">umount</span><span class="token plain"> /mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup close cryptroot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># format bootfs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mkfs.ext4 </span><span class="token variable" style="color:rgb(191, 199, 213)">$boot_dev</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> cryptroot -d key.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> /dev/mapper/cryptroot /mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># boot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> -p /mnt/boot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$boot_dev</span><span class="token plain"> /mnt/boot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># install system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">setup-disk -m sys -o sysfs.apkvol.tar.gz -s </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> -v -k virt $/mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk --root /mnt </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> syslinux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># setup luks support</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk --root /mnt </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cryptsetup util-linux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;features=&quot;ata base ide scsi usb virtio ext4 cryptsetup cryptkey&quot;&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> /mnt/etc/mkinitfs/mkinitfs.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mkinitfs -c /mnt/etc/mkinitfs/mkinitfs.conf -b /mnt/ </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">ls</span><span class="token variable" style="color:rgb(191, 199, 213)"> /mnt/lib/modules/</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add cryptroot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># cryptroot=UUID=&lt;UUID&gt; cryptdm=cryptroot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># other options - https://github.com/alpinelinux/mkinitfs/blob/961726b6aeb8e12176009675f22ed0ffc2b26e14/initramfs-init.in#L443-L482</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sed</span><span class="token plain"> -i -r </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;s/^(default_kernel_opts)=</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">([^</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">]*)</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">/</span><span class="token string entity" style="color:rgb(195, 232, 141)">\1</span><span class="token string" style="color:rgb(195, 232, 141)">=</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\2</span><span class="token string" style="color:rgb(195, 232, 141)"> cryptroot=UUID=</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">blkid $</span><span class="token string variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string variable" style="color:rgb(191, 199, 213)">ROOT_DEV</span><span class="token string variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token string variable" style="color:rgb(191, 199, 213)"> -o value </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">head</span><span class="token string variable" style="color:rgb(191, 199, 213)"> -n </span><span class="token string variable number" style="color:rgb(247, 140, 108)">1</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)"> cryptdm=cryptroot</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">/&quot;</span><span class="token plain"> /mnt/etc/update-extlinux.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">chroot</span><span class="token plain"> /mnt update-extlinux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># done - close</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">umount</span><span class="token plain"> -R /mnt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup close cryptroot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><header><h1>FAQ</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="warning-locking-directory-runcryptsetup-is-missing">WARNING: Locking directory /run/cryptsetup is missing!<a class="hash-link" href="#warning-locking-directory-runcryptsetup-is-missing" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_y2LR" id="luks-vs-luks2">LUKS vs LUKS2<a class="hash-link" href="#luks-vs-luks2" title="Direct link to heading">​</a></h2><ul><li><p>LUKS2</p><ul><li>Full disk authenticated (FDA) 提供数据 confidentiality 和 data integrity protection<ul><li>Integrity cannot prevent a replay attack</li></ul></li><li><code>cryptsetup luksFormat --type luks2 &lt;device&gt;</code></li><li>新的格式，与 LUKS1 不兼容</li><li>sector 级别完整性校验 - Linux 4.12 - dm-integrity<ul><li><code>integritysetup</code> - 命令</li></ul></li><li>veritysetup 支持设备 FEC（Forward Error Correction） - 安装 Linux 4.5 已有在使用</li><li>sector 最大支持 4096<ul><li>确保硬件使用相同大小，如果硬件 sector 更小可能导致数据损坏 - 部分 sector 写入</li></ul></li><li>使用 Argon2i 和 Argon2id 作为 PBKDF<ul><li>memory-hard - 增加内存使用 - 是的 GPU 攻击更难 - 因为 GPU 内存成本高</li><li>赢得 Password Hashing Competition 的算法</li></ul></li><li>默认 Argon2i (data independent variant) - 内存 cost 128MB，时间 cost 800ms，并行取决于 CPU &lt;= 4<ul><li>单独配置 --pbkdf, --pbkdf-memory, --pbkdf-parallel, --iter-time</li><li>迭代周期 --pbkdf-force-iterations</li></ul></li><li>使用 Token 独立抽象 cryptsetup 硬件部分</li><li><code>--persistent</code> - 持久打开，之后打开不需要密钥</li><li>Linux kernel keyring<ul><li>避免每次 ioctl 发送密钥</li><li>自动解锁 - 例如使用 TMP 存储用户密钥</li><li><a href="https://www.man7.org/linux/man-pages/man7/keyrings.7.html" target="_blank" rel="noopener noreferrer">keyrings.7</a><ul><li><code>apk add keyutils</code></li></ul></li><li><a href="https://www.kernel.org/doc/Documentation/security/keys.txt" target="_blank" rel="noopener noreferrer">KERNEL KEY RETENTION SERVICE</a></li></ul></li><li>Keyslot priorities<ul><li>normal,prefer,ignore</li><li><code>cryptsetup config &lt;device&gt; --key-slot 1 --priority prefer</code></li></ul></li><li>LUKS2 label and subsystem<ul><li><code>cryptsetup config &lt;device&gt; --label my_device --subsystem &quot;&quot;</code></li></ul></li><li>支持转换<ul><li><code>cryptsetup convert &lt;device&gt; --type luks2</code></li><li><code>cryptsetup convert &lt;device&gt; --type luks1</code></li><li>验证 <code>cryptsetup luksDump &lt;device&gt;</code></li></ul></li></ul></li><li><p>LUKS1</p><ul><li>Full disk encryption (FDE)</li><li>保留长度加密 - length-preserving - encryption - 明文密文长度相同<ul><li>提供数据可信 （confidentiality），但不保证数据完整性</li></ul></li><li>使用 PBKDF (Password-Based Key Derivation Function) 增加攻击者耗时</li><li>PBKDF2 增加迭代次数<ul><li>目前 GPU 已经可以并行执行</li></ul></li></ul></li><li><p>参考</p><ul><li><a href="https://gitlab.com/cryptsetup/cryptsetup/blob/master/docs/v2.0.0-ReleaseNotes" target="_blank" rel="noopener noreferrer">Cryptsetup 2.0.0 Release Notes</a></li></ul></li></ul><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># aes-xts-plain64 + hmac-sha256 / hmac-sha512 作为 authentication tag - IEEE 1619.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># (Common FDE mode + independent authentication tag. Authentication key for HMAC is independently generated. This mode is very slow.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher aes-xts-plain64 --integrity hmac-sha256</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># aes-gcm-random (native AEAD mode) - IEEE 1619.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 不要用于生产 - GCM 使用 96-bit nonce - GCM 硬件支持好 - AES-NI - 可以用于性能测试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher aes-gcm-random --integrity aead</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ChaCha20 with Poly1305 authenticator (according to RFC7539)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher chacha20-random --integrity poly1305</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># LUKS2 Token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 添加 Token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup token </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> --key-description </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;my_token&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 添加密码到 keyring user sessing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">passphrase</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> keyctl padd user my_token @u</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 如果找到了密码则自动会打开</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="调整分区大小">调整分区大小<a class="hash-link" href="#调整分区大小" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> util-linux</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 确保 luks 分区已经填满</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;d</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">p</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">w</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fdisk</span><span class="token plain"> /dev/sdb</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 调整大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> /dev/sdb2 root</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup resize root</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 扩展文件系统</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> e2fsprogs-extra</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resize2fs /dev/mapper/root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="help">help<a class="hash-link" href="#help" title="Direct link to heading">​</a></h2><table><thead><tr><th>action</th><th>desc</th></tr></thead><tbody><tr><td>open <code>&lt;device&gt; [--type &lt;type&gt;][&lt;name&gt;]</code></td><td>打开设备，映射为 <code>&lt;name&gt;</code></td></tr><tr><td>close <code>&lt;name&gt;</code></td><td>关闭设备，移除映射</td></tr><tr><td>resize <code>&lt;name&gt;</code></td><td>resize active device</td></tr><tr><td>status <code>&lt;name&gt;</code></td><td>show device status</td></tr><tr><td>benchmark <code>[--cipher &lt;cipher&gt;]</code></td><td>压测编码解码性能</td></tr><tr><td>repair <code>&lt;device&gt;</code></td><td>修复元数据</td></tr><tr><td>reencrypt <code>&lt;device&gt;</code></td><td>LUKS2 从新加密</td></tr><tr><td>erase <code>&lt;device&gt;</code></td><td>擦除所有 key，移除加密密钥</td></tr><tr><td>convert <code>&lt;device&gt;</code></td><td>LUKS、LUKS2 格式转换</td></tr><tr><td>config <code>&lt;device&gt;</code></td><td>LUKS2 配置</td></tr><tr><td>luksFormat <code>&lt;device&gt; [&lt;new key file&gt;]</code></td><td>LUKS 格式化</td></tr><tr><td>luksAddKey <code>&lt;device&gt; [&lt;new key file&gt;]</code></td><td>添加密钥</td></tr><tr><td>luksRemoveKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>移除密钥</td></tr><tr><td>luksChangeKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>修改密钥</td></tr><tr><td>luksConvertKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>修改密钥为新的 pbkdf 参数</td></tr><tr><td>luksKillSlot <code>&lt;device&gt; &lt;key slot&gt;</code></td><td>移除 key</td></tr><tr><td>luksUUID <code>&lt;device&gt;</code></td><td>UUID</td></tr><tr><td>isLuks <code>&lt;device&gt;</code></td><td>检测 luks 分区头</td></tr><tr><td>luksDump <code>&lt;device&gt;</code></td><td>分区信息</td></tr><tr><td>tcryptDump <code>&lt;device&gt;</code></td><td>TCRYPT 信息</td></tr><tr><td>bitlkDump <code>&lt;device&gt;</code></td><td>BITLK 信息</td></tr><tr><td>luksSuspend <code>&lt;device&gt;</code></td><td>停止 LUKS 设备，移除 key，终止所有 IO</td></tr><tr><td>luksResume <code>&lt;device&gt;</code></td><td>恢复</td></tr><tr><td>luksHeaderBackup <code>&lt;device&gt;</code></td><td>备份头</td></tr><tr><td>luksHeaderRestore <code>&lt;device&gt;</code></td><td>恢复头</td></tr><tr><td>token `&lt;add</td><td>remove</td></tr></tbody></table><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cryptsetup --help</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup 2.3.2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Usage: cryptsetup [OPTION...] &lt;action&gt; &lt;action-specific&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -v, --verbose                         Shows more detailed error messages</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --debug                           Show debug messages</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --debug-json                      Show debug messages including JSON metadata</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -c, --cipher=STRING                   The cipher used to encrypt the disk (see /proc/crypto)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -h, --hash=STRING                     The hash used to create the encryption key from the passphrase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -y, --verify-passphrase               Verifies the passphrase by asking for it twice</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -d, --key-file=STRING                 Read the key from a file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --master-key-file=STRING          Read the volume (master) key from file.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --dump-master-key                 Dump volume (master) key instead of keyslots info</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -s, --key-size=BITS                   The size of the encryption key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -l, --keyfile-size=bytes              Limits the read from keyfile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyfile-offset=bytes            Number of bytes to skip in keyfile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --new-keyfile-size=bytes          Limits the read from newly added keyfile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --new-keyfile-offset=bytes        Number of bytes to skip in newly added keyfile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -S, --key-slot=INT                    Slot number for new key (default is first free)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -b, --size=SECTORS                    The size of the device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --device-size=bytes               Use only specified device size (ignore rest of device). DANGEROUS!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -o, --offset=SECTORS                  The start offset in the backend device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -p, --skip=SECTORS                    How many sectors of the encrypted data to skip at the beginning</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -r, --readonly                        Create a readonly mapping</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -q, --batch-mode                      Do not ask for confirmation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -t, --timeout=secs                    Timeout for interactive passphrase prompt (in seconds)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --progress-frequency=secs         Progress line update (in seconds)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -T, --tries=INT                       How often the input of the passphrase can be retried</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --align-payload=SECTORS           Align payload at &lt;n&gt; sector boundaries - for luksFormat</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --header-backup-file=STRING       File with LUKS header and keyslots backup</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --use-random                      Use /dev/random for generating volume key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --use-urandom                     Use /dev/urandom for generating volume key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --shared                          Share device with another non-overlapping crypt segment</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --uuid=STRING                     UUID for device to use</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --allow-discards                  Allow discards (aka TRIM) requests for device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --header=STRING                   Device or file with separated LUKS header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --test-passphrase                 Do not activate device, just check passphrase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-hidden                   Use hidden header (hidden TCRYPT device)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-system                   Device is system TCRYPT drive (with bootloader)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-backup                   Use backup (secondary) TCRYPT header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt                       Scan also for VeraCrypt compatible device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt-pim=INT               Personal Iteration Multiplier for VeraCrypt compatible device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt-query-pim             Query Personal Iteration Multiplier for VeraCrypt compatible device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -M, --type=STRING                     Type of device metadata: luks, luks1, luks2, plain, loopaes, tcrypt,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                        bitlk</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --force-password                  Disable password quality check (if enabled)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --perf-same_cpu_crypt             Use dm-crypt same_cpu_crypt performance compatibility option</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --perf-submit_from_crypt_cpus     Use dm-crypt submit_from_crypt_cpus performance compatibility option</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --deferred                        Device removal is deferred until the last user closes it</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --serialize-memory-hard-pbkdf     Use global lock to serialize memory hard PBKDF (OOM workaround)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -i, --iter-time=msecs                 PBKDF iteration time for LUKS (in ms)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf=STRING                    PBKDF algorithm (for LUKS2): argon2i, argon2id, pbkdf2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-memory=kilobytes          PBKDF memory cost limit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-parallel=threads          PBKDF parallel cost</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-force-iterations=LONG     PBKDF iterations cost (forced, disables benchmark)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --priority=STRING                 Keyslot priority: ignore, normal, prefer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --disable-locks                   Disable locking of on-disk metadata</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --disable-keyring                 Disable loading volume keys via kernel keyring</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -I, --integrity=STRING                Data integrity algorithm (LUKS2 only)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-no-journal            Disable journal for integrity device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-no-wipe               Do not wipe device after format</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-legacy-padding        Use inefficient legacy padding (old kernels)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --token-only                      Do not ask for passphrase if activation by token fails</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --token-id=INT                    Token number (default: any)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --key-description=STRING          Key description</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --sector-size=INT                 Encryption sector size (default: 512 bytes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --persistent                      Set activation flags persistent for device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --label=STRING                    Set label for the LUKS2 device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --subsystem=STRING                Set subsystem label for the LUKS2 device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --unbound                         Create or dump unbound (no assigned data segment) LUKS2 keyslot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --json-file=STRING                Read or write the json from or to a file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --luks2-metadata-size=bytes       LUKS2 header metadata area size</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --luks2-keyslots-size=bytes       LUKS2 header keyslots area size</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --refresh                         Refresh (reactivate) device with new parameters</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyslot-key-size=BITS           LUKS2 keyslot: The size of the encryption key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyslot-cipher=STRING           LUKS2 keyslot: The cipher used for keyslot encryption</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --encrypt                         Encrypt LUKS2 device (in-place encryption).</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --decrypt                         Decrypt LUKS2 device (remove encryption).</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --init-only                       Initialize LUKS2 reencryption in metadata only.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --resume-only                     Resume initialized LUKS2 reencryption only.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --reduce-device-size=bytes        Reduce data device size (move data offset). DANGEROUS!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --hotzone-size=bytes              Maximal reencryption hotzone size.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --resilience=STRING               Reencryption hotzone resilience type (checksum,journal,none)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --resilience-hash=STRING          Reencryption hotzone checksums hash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --active-name=STRING              Override device autodetection of dm device to be reencrypted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Help options:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -?, --help                            Show this help message</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      --usage                           Display brief usage</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -V, --version                         Print package version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;action&gt; is one of:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    open &lt;device&gt; [--type &lt;type&gt;] [&lt;name&gt;] - open device as &lt;name&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    close &lt;name&gt; - close device (remove mapping)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    resize &lt;name&gt; - resize active device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    status &lt;name&gt; - show device status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    benchmark [--cipher &lt;cipher&gt;] - benchmark cipher</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    repair &lt;device&gt; - try to repair on-disk metadata</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    reencrypt &lt;device&gt; - reencrypt LUKS2 device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    erase &lt;device&gt; - erase all keyslots (remove encryption key)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    convert &lt;device&gt; - convert LUKS from/to LUKS2 format</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    config &lt;device&gt; - set permanent configuration options for LUKS2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksFormat &lt;device&gt; [&lt;new key file&gt;] - formats a LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksAddKey &lt;device&gt; [&lt;new key file&gt;] - add key to LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksRemoveKey &lt;device&gt; [&lt;key file&gt;] - removes supplied key or key file from LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksChangeKey &lt;device&gt; [&lt;key file&gt;] - changes supplied key or key file of LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksConvertKey &lt;device&gt; [&lt;key file&gt;] - converts a key to new pbkdf parameters</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksKillSlot &lt;device&gt; &lt;key slot&gt; - wipes key with number &lt;key slot&gt; from LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksUUID &lt;device&gt; - print UUID of LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    isLuks &lt;device&gt; - tests &lt;device&gt; for LUKS partition header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksDump &lt;device&gt; - dump LUKS partition information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tcryptDump &lt;device&gt; - dump TCRYPT device information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bitlkDump &lt;device&gt; - dump BITLK device information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksSuspend &lt;device&gt; - Suspend LUKS device and wipe key (all IOs are frozen)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksResume &lt;device&gt; - Resume suspended LUKS device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksHeaderBackup &lt;device&gt; - Backup LUKS device header and keyslots</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    luksHeaderRestore &lt;device&gt; - Restore LUKS device header and keyslots</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    token &lt;add|remove|import|export&gt; &lt;device&gt; - Manipulate LUKS2 tokens</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">You can also use old &lt;action&gt; syntax aliases:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    open: create (plainOpen), luksOpen, loopaesOpen, tcryptOpen, bitlkOpen</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    close: remove (plainClose), luksClose, loopaesClose, tcryptClose, bitlkClose</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;name&gt; is the device to create under /dev/mapper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;device&gt; is the encrypted device</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;key slot&gt; is the LUKS key slot number to modify</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;key file&gt; optional key file for the new key for luksAddKey action</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in metadata format is LUKS2 (for luksFormat action).</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in key and passphrase parameters:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Maximum keyfile size: 8192kB, Maximum interactive passphrase length 512 (characters)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default PBKDF for LUKS1: pbkdf2, iteration time: 2000 (ms)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default PBKDF for LUKS2: argon2i</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Iteration time: 2000, Memory required: 1048576kB, Parallel threads: 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in device cipher parameters:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    loop-AES: aes, Key 256 bits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    plain: aes-cbc-essiv:sha256, Key: 256 bits, Password hashing: ripemd160</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    LUKS: aes-xts-plain64, Key: 256 bits, LUKS header hashing: sha256, RNG: /dev/urandom</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    LUKS: Default keysize with XTS mode (two internal keys) will be doubled.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/wenerme/wener/edit/master/notes/ops/storage/encryption/luks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/notes/ops/storage/encryption"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Encryption</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/notes/ops/storage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Storage</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#密钥管理" class="table-of-contents__link toc-highlight">密钥管理</a></li><li><a href="#root-分区加密安装" class="table-of-contents__link toc-highlight">Root 分区加密安装</a></li><li><a href="#warning-locking-directory-runcryptsetup-is-missing" class="table-of-contents__link toc-highlight">WARNING: Locking directory /run/cryptsetup is missing!</a></li><li><a href="#luks-vs-luks2" class="table-of-contents__link toc-highlight">LUKS vs LUKS2</a></li><li><a href="#调整分区大小" class="table-of-contents__link toc-highlight">调整分区大小</a></li><li><a href="#help" class="table-of-contents__link toc-highlight">help</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">笔记</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/notes/java/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/os/alpine/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes/kubernetes">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip/voip">VoIP</a></li></ul></div><div class="col footer__col"><div class="footer__title">Projects</div><ul class="footer__items"><li class="footer__item">
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wener/actions" title="wenerme/wener - ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://github.com/wenerme/wener/workflows/Build/badge.svg">
                </a>
              </div>
              </li><li class="footer__item"><a href="https://apis.wener.me" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Wener&#x27;s Apis<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/story">Blog</a></li><li class="footer__item"><a href="https://github.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></div><div class="footer__copyright">Copyright © 1992-2022 Wener - <img alt="cc-by-sa-4.0" src="https://mirrors.creativecommons.org/presskit/buttons/80x15/svg/by-sa.svg"> - Build @2022-01-04 00:19</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c7f5ed3e.js"></script>
<script src="/assets/js/main.5d7b778c.js"></script>
</body>
</html>