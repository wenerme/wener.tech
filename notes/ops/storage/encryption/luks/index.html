<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1")</script>
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1")</script>

<title data-react-helmet="true">LUKS</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Wener Live &amp; Life · Passion I&#x27;ve found"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="# LUKS"><meta data-react-helmet="true" property="og:description" content="# LUKS"><meta data-react-helmet="true" property="og:url" content="https://wener.me/notes/ops/storage/encryption/luks">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.cb15e1ce.css">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/wener-logo-head.svg" alt="Wener Logo"><strong>Wener</strong></a><a class="navbar__item navbar__link" href="/notes/java/java">笔记</a><a class="navbar__item navbar__link" href="/blog">故事</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a><a class="navbar__item navbar__link" href="/notes/tool/network/ip-lookup">工具</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/wenerme/wener">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_3gvz"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_2Zd- moon_Tgrt"></span></div><div class="react-toggle-track-x"><span class="toggle_2Zd- sun_38Cb"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/wener-logo-head.svg" alt="Wener Logo"><strong>Wener</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/notes/java/java">笔记</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">故事</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/wenerme/wener">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/tool/network/ip-lookup">工具</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_NanV"><main class="docMainContainer_3XKI"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col"><div class="docItemContainer_AHR_"><article><header><h1 class="docTitle_3A0L">LUKS</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="luks"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#luks" title="Direct link to heading">#</a>LUKS</h1><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="tips"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#tips" title="Direct link to heading">#</a>Tips</h2><ul><li><a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">Linux Unified Key Setup</a><ul><li><a href="https://en.wikipedia.org/wiki/Dm-crypt">dm-crypt</a></li></ul></li><li><a href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html">admin-guide/device-mapper/dm-crypt</a></li><li>注意<ul><li>每个块设备密码独立<ul><li>可以考虑使用 keyfile 然后使用 crypttab 挂载</li></ul></li></ul></li><li>加密方案<ul><li>ROOT 加密</li><li>非 ROOT 加密</li></ul></li><li>kernel<ul><li>AlpineLinux 配置方式 <code>cryptroot=UUID=&lt;UUID&gt; cryptdm=cryptroot</code><ul><li>cryptdm - mapper 名字</li><li>实际处理脚本 <a href="https://github.com/alpinelinux/mkinitfs/blob/961726b6aeb8e12176009675f22ed0ffc2b26e14/initramfs-init.in#L443-L482">initramfs-init.in#L443-L482</a></li></ul></li><li><code>cryptdevice=UUID=&lt;UUID&gt;:cryptroot</code></li><li><code>root=UUID={unencrypted} rw cryptdevice=/dev/disk/by-uuid/{encrypted}:root quiet</code>
nomodeset quiet rootfstype=ext4 cryptroot=UUID=3cb7aacf-4975-466b-bb6d-92a13ad60496 cryptdm=rootCrypt cryptdiscards cryptkey</li></ul></li><li>参考<ul><li>ArchLinux <a href="https://wiki.archlinux.org/index.php/Dm-crypt">dm-crypt</a></li><li><a href="https://blog.csdn.net/isclouder/article/details/80731388">qemu luks</a></li></ul></li></ul><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-bash codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">blkid -t </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">TYPE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">crypto_LUKS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 修改密码</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksChangeKey /dev/sdb2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uuidgen </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tr</span><span class="token plain"> -d </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> new-key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksAddKey /dev/sdb2 new-key.txt -d key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 查看上级设备</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dmsetup deps -o devname /dev/mapper/decrypted</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="密钥管理"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#密钥管理" title="Direct link to heading">#</a>密钥管理</h2><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-bash codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 所有 slot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksDump /dev/sdb2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 测试密码</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --verbose --test-passphrase /dev/sda2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 判断 slot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 一个个尝试</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --test-passphrase --key-slot </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> /dev/sda2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 会显示 key slot 信息</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup --verbose </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> --test-passphrase /dev/sda2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 移除未知的 key slot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup -v luksKillSlot /dev/sdb2 </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dmsetup table --showkeys</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 导出 master key</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksDump --dump-master-key /dev/loop0p2 -d key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">xxd -r -p masker-key.txt masker-key.bin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 使用 master key 则不需要密码</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksAddKey /dev/sdb1 --master-key-file </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> masker-key.bin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="root-分区加密安装"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#root-分区加密安装" title="Direct link to heading">#</a>Root 分区加密安装</h2><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-bash codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cryptsetup util-linux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 分区</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/dev/sdb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">boot_dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">root_dev</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +128M - boot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># rest  - root</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">CONF </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> sfdisk --wipe always </span><span class="token variable" style="color:rgb(191, 199, 213)">${dev}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">label: dos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">unit: sectors</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sector-size: </span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/dev/sdb1 </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">size</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">+128M, </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">type</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">83</span><span class="token plain">, bootable</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/dev/sdb2 </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">type</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">83</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CONF</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 初始化</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ======</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 格式化 - 设置密码</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 设置密码文件 - 或者使用 cryptsetup 生成</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uuidgen </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">yes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> cryptsetup -y -v luksFormat </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> -d key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 打开 - 挂载为 mapper</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> cryptroot -d key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 格式化 fs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkfs.ext4 /dev/mapper/cryptroot</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 挂载到目录</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> /dev/mapper/cryptroot /mnt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 卸载再次挂载确保生效</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">umount</span><span class="token plain"> /mnt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup close cryptroot</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># format bootfs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkfs.ext4 </span><span class="token variable" style="color:rgb(191, 199, 213)">$boot_dev</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$root_dev</span><span class="token plain"> cryptroot -d key.txt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> /dev/mapper/cryptroot /mnt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># boot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> -p /mnt/boot</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$boot_dev</span><span class="token plain"> /mnt/boot</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># install system</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">setup-disk -m sys -o sysfs.apkvol.tar.gz -s </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> -v -k virt $/mnt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk --root /mnt </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> syslinux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># setup luks support</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk --root /mnt </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cryptsetup util-linux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;features=&quot;ata base ide scsi usb virtio ext4 cryptsetup cryptkey&quot;&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> /mnt/etc/mkinitfs/mkinitfs.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkinitfs -c /mnt/etc/mkinitfs/mkinitfs.conf -b /mnt/ </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">ls</span><span class="token variable" style="color:rgb(191, 199, 213)"> /mnt/lib/modules/</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add cryptroot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># cryptroot=UUID=&lt;UUID&gt; cryptdm=cryptroot</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># other options - https://github.com/alpinelinux/mkinitfs/blob/961726b6aeb8e12176009675f22ed0ffc2b26e14/initramfs-init.in#L443-L482</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sed</span><span class="token plain"> -i -r </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;s/^(default_kernel_opts)=</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">([^</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">]*)</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">/</span><span class="token string entity" style="color:rgb(195, 232, 141)">\1</span><span class="token string" style="color:rgb(195, 232, 141)">=</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string entity" style="color:rgb(195, 232, 141)">\2</span><span class="token string" style="color:rgb(195, 232, 141)"> cryptroot=UUID=</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">blkid $</span><span class="token string variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string variable" style="color:rgb(191, 199, 213)">ROOT_DEV</span><span class="token string variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token string variable" style="color:rgb(191, 199, 213)"> -o value </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">head</span><span class="token string variable" style="color:rgb(191, 199, 213)"> -n </span><span class="token string variable number" style="color:rgb(247, 140, 108)">1</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)"> cryptdm=cryptroot</span><span class="token string entity" style="color:rgb(195, 232, 141)">\&quot;</span><span class="token string" style="color:rgb(195, 232, 141)">/&quot;</span><span class="token plain"> /mnt/etc/update-extlinux.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">chroot</span><span class="token plain"> /mnt update-extlinux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># done - close</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">umount</span><span class="token plain"> -R /mnt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup close cryptroot</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="faq"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#faq" title="Direct link to heading">#</a>FAQ</h1><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="warning-locking-directory-runcryptsetup-is-missing"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#warning-locking-directory-runcryptsetup-is-missing" title="Direct link to heading">#</a>WARNING: Locking directory /run/cryptsetup is missing!</h2><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="luks-vs-luks2"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#luks-vs-luks2" title="Direct link to heading">#</a>LUKS vs LUKS2</h2><ul><li><p>LUKS2</p><ul><li>Full disk authenticated (FDA) 提供数据 confidentiality 和 data integrity protection<ul><li>Integrity cannot prevent a replay attack</li></ul></li><li><code>cryptsetup luksFormat --type luks2 &lt;device&gt;</code></li><li>新的格式，与 LUKS1 不兼容</li><li>sector 级别完整性校验 - Linux 4.12 - dm-integrity<ul><li><code>integritysetup</code> - 命令</li></ul></li><li>veritysetup 支持设备 FEC（Forward Error Correction） - 安装 Linux 4.5 已有在使用</li><li>sector 最大支持 4096 <ul><li>确保硬件使用相同大小，如果硬件 sector 更小可能导致数据损坏 - 部分 sector 写入</li></ul></li><li>使用 Argon2i 和 Argon2id 作为 PBKDF<ul><li>memory-hard - 增加内存使用 - 是的 GPU 攻击更难 - 因为 GPU 内存成本高</li><li>赢得 Password Hashing Competition 的算法</li></ul></li><li>默认 Argon2i (data independent variant) - 内存 cost 128MB，时间 cost 800ms，并行取决于 CPU &lt;= 4<ul><li>单独配置 --pbkdf, --pbkdf-memory, --pbkdf-parallel, --iter-time</li><li>迭代周期 --pbkdf-force-iterations</li></ul></li><li>使用 Token 独立抽象 cryptsetup 硬件部分</li><li><code>--persistent</code> - 持久打开，之后打开不需要密钥</li><li>Linux kernel keyring<ul><li>避免每次 ioctl 发送密钥</li><li>自动解锁 - 例如使用 TMP 存储用户密钥</li><li><a href="https://www.man7.org/linux/man-pages/man7/keyrings.7.html">keyrings.7</a><ul><li><code>apk add keyutils</code></li></ul></li><li><a href="https://www.kernel.org/doc/Documentation/security/keys.txt">KERNEL KEY RETENTION SERVICE</a></li></ul></li><li>Keyslot priorities<ul><li>normal,prefer,ignore</li><li><code>cryptsetup config &lt;device&gt; --key-slot 1 --priority prefer</code></li></ul></li><li>LUKS2 label and subsystem<ul><li><code>cryptsetup config &lt;device&gt; --label my_device --subsystem &quot;&quot;</code></li></ul></li><li>支持转换<ul><li><code>cryptsetup convert &lt;device&gt; --type luks2</code></li><li><code>cryptsetup convert &lt;device&gt; --type luks1</code></li><li>验证 <code>cryptsetup luksDump &lt;device&gt;</code></li></ul></li></ul></li><li><p>LUKS1</p><ul><li>Full disk encryption (FDE)</li><li>保留长度加密 - length-preserving - encryption - 明文密文长度相同<ul><li>提供数据可信 （confidentiality），但不保证数据完整性</li></ul></li><li>使用 PBKDF (Password-Based Key Derivation Function) 增加攻击者耗时</li><li>PBKDF2 增加迭代次数<ul><li>目前 GPU 已经可以并行执行</li></ul></li></ul></li><li><p>参考</p><ul><li><a href="https://gitlab.com/cryptsetup/cryptsetup/blob/master/docs/v2.0.0-ReleaseNotes">Cryptsetup 2.0.0 Release Notes</a></li></ul></li></ul><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-bash codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># aes-xts-plain64 + hmac-sha256 / hmac-sha512 作为 authentication tag - IEEE 1619.1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># (Common FDE mode + independent authentication tag. Authentication key for HMAC is independently generated. This mode is very slow.)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher aes-xts-plain64 --integrity hmac-sha256</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># aes-gcm-random (native AEAD mode) - IEEE 1619.1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 不要用于生产 - GCM 使用 96-bit nonce - GCM 硬件支持好 - AES-NI - 可以用于性能测试</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher aes-gcm-random --integrity aead</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ChaCha20 with Poly1305 authenticator (according to RFC7539)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup luksFormat --type luks2 </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --cipher chacha20-random --integrity poly1305</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># LUKS2 Token</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 添加 Token</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup token </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> --key-description </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;my_token&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 添加密码到 keyring user sessing</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -n </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">passphrase</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> keyctl padd user my_token @u</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 如果找到了密码则自动会打开</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">device</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="调整分区大小"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#调整分区大小" title="Direct link to heading">#</a>调整分区大小</h2><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-bash codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> util-linux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 确保 luks 分区已经填满</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;d</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">p</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">w</span><span class="token string entity" style="color:rgb(195, 232, 141)">\n</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fdisk</span><span class="token plain"> /dev/sdb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 调整大小</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup </span><span class="token function" style="color:rgb(130, 170, 255)">open</span><span class="token plain"> /dev/sdb2 root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup resize root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 扩展文件系统</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> e2fsprogs-extra</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resize2fs /dev/mapper/root</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="help"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#help" title="Direct link to heading">#</a>help</h2><table><thead><tr><th>action</th><th>desc</th></tr></thead><tbody><tr><td>open <code>&lt;device&gt; [--type &lt;type&gt;][&lt;name&gt;]</code></td><td>打开设备，映射为 <code>&lt;name&gt;</code></td></tr><tr><td>close <code>&lt;name&gt;</code></td><td>关闭设备，移除映射</td></tr><tr><td>resize <code>&lt;name&gt;</code></td><td>resize active device</td></tr><tr><td>status <code>&lt;name&gt;</code></td><td>show device status</td></tr><tr><td>benchmark <code>[--cipher &lt;cipher&gt;]</code></td><td>压测编码解码性能</td></tr><tr><td>repair <code>&lt;device&gt;</code></td><td>修复元数据</td></tr><tr><td>reencrypt <code>&lt;device&gt;</code></td><td>LUKS2 从新加密</td></tr><tr><td>erase <code>&lt;device&gt;</code></td><td>擦除所有 key，移除加密密钥</td></tr><tr><td>convert <code>&lt;device&gt;</code></td><td>LUKS、LUKS2 格式转换</td></tr><tr><td>config <code>&lt;device&gt;</code></td><td>LUKS2 配置</td></tr><tr><td>luksFormat <code>&lt;device&gt; [&lt;new key file&gt;]</code></td><td>LUKS 格式化</td></tr><tr><td>luksAddKey <code>&lt;device&gt; [&lt;new key file&gt;]</code></td><td>添加密钥</td></tr><tr><td>luksRemoveKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>移除密钥</td></tr><tr><td>luksChangeKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>修改密钥</td></tr><tr><td>luksConvertKey <code>&lt;device&gt; [&lt;key file&gt;]</code></td><td>修改密钥为新的 pbkdf 参数</td></tr><tr><td>luksKillSlot <code>&lt;device&gt; &lt;key slot&gt;</code></td><td>移除 key</td></tr><tr><td>luksUUID <code>&lt;device&gt;</code></td><td>UUID</td></tr><tr><td>isLuks <code>&lt;device&gt;</code></td><td>检测 luks 分区头</td></tr><tr><td>luksDump <code>&lt;device&gt;</code></td><td>分区信息</td></tr><tr><td>tcryptDump <code>&lt;device&gt;</code></td><td>TCRYPT 信息</td></tr><tr><td>bitlkDump <code>&lt;device&gt;</code></td><td>BITLK 信息</td></tr><tr><td>luksSuspend <code>&lt;device&gt;</code></td><td>停止 LUKS 设备，移除 key，终止所有 IO</td></tr><tr><td>luksResume <code>&lt;device&gt;</code></td><td>恢复</td></tr><tr><td>luksHeaderBackup <code>&lt;device&gt;</code></td><td>备份头</td></tr><tr><td>luksHeaderRestore <code>&lt;device&gt;</code></td><td>恢复头</td></tr><tr><td>token `&lt;add</td><td>remove</td></tr></tbody></table><pre class="mdxCodeBlock_2E1g"><div class="codeBlockWrapper_1h2Z"><pre class="prism-code language-undefined codeBlock_3dxb" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ cryptsetup --help</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cryptsetup 2.3.2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Usage: cryptsetup [OPTION...] &lt;action&gt; &lt;action-specific&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -v, --verbose                         Shows more detailed error messages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --debug                           Show debug messages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --debug-json                      Show debug messages including JSON metadata</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -c, --cipher=STRING                   The cipher used to encrypt the disk (see /proc/crypto)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -h, --hash=STRING                     The hash used to create the encryption key from the passphrase</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -y, --verify-passphrase               Verifies the passphrase by asking for it twice</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -d, --key-file=STRING                 Read the key from a file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --master-key-file=STRING          Read the volume (master) key from file.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --dump-master-key                 Dump volume (master) key instead of keyslots info</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -s, --key-size=BITS                   The size of the encryption key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -l, --keyfile-size=bytes              Limits the read from keyfile</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyfile-offset=bytes            Number of bytes to skip in keyfile</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --new-keyfile-size=bytes          Limits the read from newly added keyfile</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --new-keyfile-offset=bytes        Number of bytes to skip in newly added keyfile</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -S, --key-slot=INT                    Slot number for new key (default is first free)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -b, --size=SECTORS                    The size of the device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --device-size=bytes               Use only specified device size (ignore rest of device). DANGEROUS!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -o, --offset=SECTORS                  The start offset in the backend device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -p, --skip=SECTORS                    How many sectors of the encrypted data to skip at the beginning</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -r, --readonly                        Create a readonly mapping</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -q, --batch-mode                      Do not ask for confirmation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -t, --timeout=secs                    Timeout for interactive passphrase prompt (in seconds)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --progress-frequency=secs         Progress line update (in seconds)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -T, --tries=INT                       How often the input of the passphrase can be retried</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --align-payload=SECTORS           Align payload at &lt;n&gt; sector boundaries - for luksFormat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --header-backup-file=STRING       File with LUKS header and keyslots backup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --use-random                      Use /dev/random for generating volume key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --use-urandom                     Use /dev/urandom for generating volume key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --shared                          Share device with another non-overlapping crypt segment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --uuid=STRING                     UUID for device to use</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --allow-discards                  Allow discards (aka TRIM) requests for device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --header=STRING                   Device or file with separated LUKS header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --test-passphrase                 Do not activate device, just check passphrase</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-hidden                   Use hidden header (hidden TCRYPT device)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-system                   Device is system TCRYPT drive (with bootloader)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --tcrypt-backup                   Use backup (secondary) TCRYPT header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt                       Scan also for VeraCrypt compatible device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt-pim=INT               Personal Iteration Multiplier for VeraCrypt compatible device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --veracrypt-query-pim             Query Personal Iteration Multiplier for VeraCrypt compatible device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -M, --type=STRING                     Type of device metadata: luks, luks1, luks2, plain, loopaes, tcrypt,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                        bitlk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --force-password                  Disable password quality check (if enabled)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --perf-same_cpu_crypt             Use dm-crypt same_cpu_crypt performance compatibility option</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --perf-submit_from_crypt_cpus     Use dm-crypt submit_from_crypt_cpus performance compatibility option</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --deferred                        Device removal is deferred until the last user closes it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --serialize-memory-hard-pbkdf     Use global lock to serialize memory hard PBKDF (OOM workaround)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -i, --iter-time=msecs                 PBKDF iteration time for LUKS (in ms)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf=STRING                    PBKDF algorithm (for LUKS2): argon2i, argon2id, pbkdf2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-memory=kilobytes          PBKDF memory cost limit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-parallel=threads          PBKDF parallel cost</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --pbkdf-force-iterations=LONG     PBKDF iterations cost (forced, disables benchmark)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --priority=STRING                 Keyslot priority: ignore, normal, prefer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --disable-locks                   Disable locking of on-disk metadata</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --disable-keyring                 Disable loading volume keys via kernel keyring</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -I, --integrity=STRING                Data integrity algorithm (LUKS2 only)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-no-journal            Disable journal for integrity device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-no-wipe               Do not wipe device after format</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --integrity-legacy-padding        Use inefficient legacy padding (old kernels)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --token-only                      Do not ask for passphrase if activation by token fails</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --token-id=INT                    Token number (default: any)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --key-description=STRING          Key description</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --sector-size=INT                 Encryption sector size (default: 512 bytes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --persistent                      Set activation flags persistent for device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --label=STRING                    Set label for the LUKS2 device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --subsystem=STRING                Set subsystem label for the LUKS2 device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --unbound                         Create or dump unbound (no assigned data segment) LUKS2 keyslot</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --json-file=STRING                Read or write the json from or to a file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --luks2-metadata-size=bytes       LUKS2 header metadata area size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --luks2-keyslots-size=bytes       LUKS2 header keyslots area size</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --refresh                         Refresh (reactivate) device with new parameters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyslot-key-size=BITS           LUKS2 keyslot: The size of the encryption key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --keyslot-cipher=STRING           LUKS2 keyslot: The cipher used for keyslot encryption</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --encrypt                         Encrypt LUKS2 device (in-place encryption).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --decrypt                         Decrypt LUKS2 device (remove encryption).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --init-only                       Initialize LUKS2 reencryption in metadata only.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --resume-only                     Resume initialized LUKS2 reencryption only.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --reduce-device-size=bytes        Reduce data device size (move data offset). DANGEROUS!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --hotzone-size=bytes              Maximal reencryption hotzone size.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --resilience=STRING               Reencryption hotzone resilience type (checksum,journal,none)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --resilience-hash=STRING          Reencryption hotzone checksums hash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --active-name=STRING              Override device autodetection of dm device to be reencrypted</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Help options:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -?, --help                            Show this help message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      --usage                           Display brief usage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -V, --version                         Print package version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;action&gt; is one of:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    open &lt;device&gt; [--type &lt;type&gt;] [&lt;name&gt;] - open device as &lt;name&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    close &lt;name&gt; - close device (remove mapping)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resize &lt;name&gt; - resize active device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    status &lt;name&gt; - show device status</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    benchmark [--cipher &lt;cipher&gt;] - benchmark cipher</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    repair &lt;device&gt; - try to repair on-disk metadata</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    reencrypt &lt;device&gt; - reencrypt LUKS2 device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    erase &lt;device&gt; - erase all keyslots (remove encryption key)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    convert &lt;device&gt; - convert LUKS from/to LUKS2 format</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    config &lt;device&gt; - set permanent configuration options for LUKS2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksFormat &lt;device&gt; [&lt;new key file&gt;] - formats a LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksAddKey &lt;device&gt; [&lt;new key file&gt;] - add key to LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksRemoveKey &lt;device&gt; [&lt;key file&gt;] - removes supplied key or key file from LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksChangeKey &lt;device&gt; [&lt;key file&gt;] - changes supplied key or key file of LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksConvertKey &lt;device&gt; [&lt;key file&gt;] - converts a key to new pbkdf parameters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksKillSlot &lt;device&gt; &lt;key slot&gt; - wipes key with number &lt;key slot&gt; from LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksUUID &lt;device&gt; - print UUID of LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    isLuks &lt;device&gt; - tests &lt;device&gt; for LUKS partition header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksDump &lt;device&gt; - dump LUKS partition information</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tcryptDump &lt;device&gt; - dump TCRYPT device information</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bitlkDump &lt;device&gt; - dump BITLK device information</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksSuspend &lt;device&gt; - Suspend LUKS device and wipe key (all IOs are frozen)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksResume &lt;device&gt; - Resume suspended LUKS device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksHeaderBackup &lt;device&gt; - Backup LUKS device header and keyslots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    luksHeaderRestore &lt;device&gt; - Restore LUKS device header and keyslots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    token &lt;add|remove|import|export&gt; &lt;device&gt; - Manipulate LUKS2 tokens</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">You can also use old &lt;action&gt; syntax aliases:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    open: create (plainOpen), luksOpen, loopaesOpen, tcryptOpen, bitlkOpen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    close: remove (plainClose), luksClose, loopaesClose, tcryptClose, bitlkClose</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;name&gt; is the device to create under /dev/mapper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;device&gt; is the encrypted device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;key slot&gt; is the LUKS key slot number to modify</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;key file&gt; optional key file for the new key for luksAddKey action</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in metadata format is LUKS2 (for luksFormat action).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in key and passphrase parameters:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Maximum keyfile size: 8192kB, Maximum interactive passphrase length 512 (characters)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Default PBKDF for LUKS1: pbkdf2, iteration time: 2000 (ms)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Default PBKDF for LUKS2: argon2i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Iteration time: 2000, Memory required: 1048576kB, Parallel threads: 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Default compiled-in device cipher parameters:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    loop-AES: aes, Key 256 bits</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    plain: aes-cbc-essiv:sha256, Key: 256 bits, Password hashing: ripemd160</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    LUKS: aes-xts-plain64, Key: 256 bits, LUKS header hashing: sha256, RNG: /dev/urandom</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    LUKS: Default keysize with XTS mode (two internal keys) will be doubled.</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3qZc">Copy</button></div></pre></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3z_-"><ul class="contents contents__left-border"><li><a href="#tips" class="contents__link">Tips</a></li><li><a href="#密钥管理" class="contents__link">密钥管理</a></li><li><a href="#root-分区加密安装" class="contents__link">Root 分区加密安装</a></li><li><a href="#warning-locking-directory-runcryptsetup-is-missing" class="contents__link">WARNING: Locking directory /run/cryptsetup is missing!</a></li><li><a href="#luks-vs-luks2" class="contents__link">LUKS vs LUKS2</a></li><li><a href="#调整分区大小" class="contents__link">调整分区大小</a></li><li><a href="#help" class="contents__link">help</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">笔记</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/notes/java/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/ops/os/alpine/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes/k8s-intro">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip/voip-intro">VoIP</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Projects</h4><ul class="footer__items"><div>
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://travis-ci.com/wenerme/wener" title="wenerme/wener - travis-ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://travis-ci.com/wenerme/wener.svg?branch=master">
                </a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wenerme.github.io/deployments" title="GitHub Pages 部署">部署状态</a>
              </div>
              </div><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://apis.wener.me">Wener&#x27;s Apis</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/wenerme" href="https://github.com/wenerme">GitHub</a></li><li class="footer__item"><a class="footer__link-item" to="https://twitter.com/wenerme" href="https://twitter.com/wenerme">Twitter</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Wener Site" src="/img/wener-logo.svg"></div>Copyright © 1992-2020 Wener - 构建时间 2020-10-10 21:30</div></div></footer>
</div>

<script src="/styles.3bfef576.js"></script>

<script src="/runtime~main.21bc78aa.js"></script>

<script src="/main.995ead94.js"></script>

<script src="/1.ea46efd4.js"></script>

<script src="/2.9c5675ff.js"></script>

<script src="/1be78505.3520f6ae.js"></script>

<script src="/7f176b88.fd00c630.js"></script>

<script src="/17896441.cc0f7da5.js"></script>

<script src="/fe7c9b90.55e630e8.js"></script>


</body>
</html>