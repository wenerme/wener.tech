<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/story/rss.xml" title="Wener Live &amp; Life Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/story/atom.xml" title="Wener Live &amp; Life Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Wener Live &amp; Life" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"><title data-react-helmet="true">Consul | Wener Live &amp; Life</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://wener.me/notes/devops/service/consul"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Consul | Wener Live &amp; Life"><meta data-react-helmet="true" name="description" content="- Consul æ‰‹å†Œ"><meta data-react-helmet="true" property="og:description" content="- Consul æ‰‹å†Œ"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wener.me/notes/devops/service/consul"><link data-react-helmet="true" rel="alternate" href="https://wener.me/notes/devops/service/consul" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wener.me/notes/devops/service/consul" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1f8f45d9.css">
<link rel="preload" href="/assets/js/runtime~main.b13495bb.js" as="script">
<link rel="preload" href="/assets/js/main.2db18e17.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Wener</b></a><a class="navbar__item navbar__link" href="/notes/note">ç¬”è®°</a><a class="navbar__item navbar__link" href="/story">æ•…äº‹</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">æŒ‡å—</a><a class="navbar__item navbar__link" href="/notes/tool/network/ip-lookup">å·¥å…·</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">è‡ªæˆ‘æˆé•¿</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Java</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Web</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">è¯­è¨€</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">AlpineLinux</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Docker</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Linux</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">è™šæ‹ŸåŒ–</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ“ä½œç³»ç»Ÿ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">VoIP</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">å¼€å‘</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">DevOps</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/devops-faq">DevOps å¸¸è§é—®é¢˜</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">æ—¥å¿—</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">æŒ‡æ ‡ç›‘æ§</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">è°ƒç”¨é“¾</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">å¯è§æ€§</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">æœåŠ¡</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/service-awesome">Service Awesome</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/ambassador">Ambassador</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/devops/service/consul">Consul</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/consul-conf">Consul é…ç½®</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/consul-connect">Consule Connect Mesh</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/fabio">fabio</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/istio">Istio</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/kuma">Kuma</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/linkerd">Linkerd</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/linkerd-version">Linkerd Version</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/meshery">meshery</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/microservices">Microservices</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/serverless-awesome">Serverless Awesome</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/service/servicemesh">Service Mesh</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Web</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">å¹³å°æœåŠ¡</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">å®¹å™¨</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/concept/bitrate">æ¯”ç‰¹ç‡</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/concept/latency">å»¶è¿Ÿæ•°</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/provider/cloudflare">CloudFlare</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/provider/cloudflare-team">Cloudflare Team</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/notes/devops/provider/cloudflared">cloudflared</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ•°æ®åº“</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ¶ˆæ¯é˜Ÿåˆ—</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">å®‰å…¨</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æœåŠ¡</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">è¿ç»´</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æŒ‡å—</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ç¡¬ä»¶</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ç®—æ³•</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">å¥åº·</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">å‚è€ƒ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">å·¥å…·</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Consul</h1></header><ul><li><a href="https://www.consul.io/docs/guides/" target="_blank" rel="noopener noreferrer">Consul æ‰‹å†Œ</a></li><li>ç«¯å£<ul><li>HTTP 8500</li><li>HTTPS 8501 - é»˜è®¤æ²¡å¼€å¯</li><li>gRPC 8502</li><li>DNS 8600</li><li>RPC 8400</li></ul></li><li>è¿è¡Œæ¨¡å¼<ul><li>server<ul><li>æœåŠ¡èŠ‚ç‚¹</li><li>ä¸€ä¸ª dc ä¸è¶…è¿‡ 5 ä¸ªæœåŠ¡èŠ‚ç‚¹</li><li>å‚ä¸ raft ä¸€è‡´æ€§äº‹åŠ¡ä¿®æ”¹</li><li>ä¸å…¶ä»– dc çš„ç½‘å…³è¿›è¡Œ WAN gossip é€šä¿¡</li><li>å¯è½¬å‘ dc æµé‡</li></ul></li><li>agent<ul><li>ä¸€èˆ¬æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¯åŠ¨</li><li>ä¸ server é€šä¿¡</li><li>æä¾›ç¼“å­˜ã€ä»£ç†ã€èŠ‚ç‚¹ç›‘æ§</li></ul></li><li>bootstrap<ul><li>å¯åŠ¨æ¨¡å¼</li><li>ä¸€ä¸ª dc åº”è¯¥åªæœ‰ä¸€ä¸ª server èŠ‚ç‚¹ä»¥è¯¥æ¨¡å¼è¿è¡Œ</li><li>å…è®¸é€‰ä¸¾è‡ªå·±ä¸ºä¸»èŠ‚ç‚¹</li><li>é›†ç¾¤å¯åŠ¨ååˆ™ä¸éœ€è¦ä½¿ç”¨è¯¥æ¨¡å¼</li><li>ç›¸å½“äº <code>bootstrap_expect</code> ä¸º 1</li></ul></li></ul></li><li>Watch<ul><li>consul ä½¿ç”¨ http blocking query å®ç° watch</li><li>é€šè¿‡ index æˆ– content hash æ¥åˆ¤æ–­å˜åŒ–</li><li><a href="https://github.com/hashicorp/consul-template/issues/1065" target="_blank" rel="noopener noreferrer">#1065</a> - When watching all services, consul-template is DOSing the Consul agent</li><li>å½“ç›‘æ§é‡å¤§çš„æ—¶å€™è€ƒè™‘å®¢æˆ·ç«¯å»é‡ï¼Œé—´éš”æŸ¥è¯¢ï¼Œé¿å…é•¿é“¾æ¥</li><li>å¯ Watch çš„ç±»å‹ - keyã€keyprefixã€servicesã€nodesã€serviceã€checksã€event</li></ul></li><li>æ³¨æ„<ul><li>Value æœ€å¤§ 512KB - ä¸è¦å°† KV ç”¨äºé€šç”¨å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨åŸºæœ¬çŠ¶æ€å’Œé…ç½®è¶³ä»¥</li><li>meta æœ€å¤š 64 ä¸ª KVï¼Œkey åªèƒ½æ˜¯ <code>[-_a-zA-Z0-9]{,128}</code>,å€¼æœ€é•¿ 512</li><li>åŒºåˆ«ä½¿ç”¨ tag å’Œ meta<ul><li>tags ä¾‹å¦‚ï¼š primaryã€secondary</li><li>metas ä¾‹å¦‚ï¼š versionã€name</li></ul></li></ul></li><li>å‚è€ƒ<ul><li><a href="https://www.consul.io/docs/troubleshoot/faq" target="_blank" rel="noopener noreferrer">FAQ</a></li></ul></li></ul><table><thead><tr><th>env</th><th>default</th><th>desc</th></tr></thead><tbody><tr><td>CONSUL_HTTP_ADDR</td><td><a href="http://127.0.0.1:5800" target="_blank" rel="noopener noreferrer">http://127.0.0.1:5800</a></td><td></td></tr><tr><td>CONSUL_HTTP_TOKEN</td><td></td><td></td></tr><tr><td>CONSUL_HTTP_TOKEN_FILE</td><td></td><td>HTTP Basic auth</td></tr><tr><td>CONSUL_HTTP_AUTH</td><td></td><td>user:pass</td></tr><tr><td>CONSUL_HTTP_SSL</td><td>false</td><td></td></tr><tr><td>CONSUL_CACERT</td><td></td><td></td></tr><tr><td>CONSUL_CAPATH</td><td></td><td></td></tr><tr><td>CONSUL_CLIENT_CERT</td><td></td><td></td></tr><tr><td>CONSUL_CLIENT_KEY</td><td></td><td></td></tr><tr><td>CONSUL_TLS_SERVER_NAME</td><td></td><td></td></tr><tr><td>CONSUL_HTTP_SSL_VERIFY</td><td>true</td><td></td></tr><tr><td>CONSUL_GRPC_ADDR</td><td>127.0.0.1:8502</td><td>envoy é›†æˆéœ€è¦</td></tr></tbody></table><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># alpine install</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 3.12 è¿˜æ²¡æœ‰ï¼Œéœ€è¦ä» edge å®‰è£…</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> -X https://mirrors.aliyun.com/alpine/edge/community/ consul</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># macOS install</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">brew </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> consul</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¯åŠ¨</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul agent -bootstrap -server -data-dir </span><span class="token environment constant" style="color:rgb(130, 170, 255)">$PWD</span><span class="token plain">/data -bind </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">.0.0 -advertise </span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.0.1 -ui</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ç»‘å®šåŠ¨æ€åœ°å€</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># {{ GetPrivateInterfaces | include &quot;network&quot; &quot;10.0.0.0/8&quot; | attr &quot;address&quot; }}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># {{ GetAllInterfaces | include &quot;name&quot; &quot;^eth&quot; | include &quot;flags&quot; &quot;forwardable|up&quot; | attr &quot;address&quot; }}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul agent -bind </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;{{ GetInterfaceIP &quot;eth0&quot; }}&#x27;</span><span class="token plain"> -server -dev</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Debug</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul monitor --log-level</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">debug</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># æ³¨é”€æœåŠ¡</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -v -X PUT http://localhost:8500/v1/agent/service/deregister/web-test</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul services deregister -id web-test</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="catalog"></a>Catalog<a class="hash-link" href="#catalog" title="Direct link to heading">#</a></h2><ul><li>Service</li><li>Node</li><li>Datacenter</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹<a class="hash-link" href="#å¿«é€Ÿå¼€å§‹" title="Direct link to heading">#</a></h2><blockquote><p>ä»¥ä¸‹å¯åŠ¨ä¸€ä¸ªä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># é»˜è®¤é…ç½®ç›®å½•ä¸º /etc/consul</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> /etc/consul</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># åŸºç¡€æœåŠ¡é…ç½®</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> </span><span class="token string bash punctuation operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> server.json</span><span class="token string" style="color:rgb(195, 232, 141)"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;data_dir&quot;: &quot;/var/consul&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;domain&quot;: &quot;consul&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;enable_script_checks&quot;: true,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;dns_config&quot;: {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">        &quot;enable_truncate&quot;: true,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">        &quot;only_passing&quot;: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;enable_syslog&quot;: true,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;leave_on_terminate&quot;: true,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;log_level&quot;: &quot;INFO&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;rejoin_after_leave&quot;: true,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;server&quot;: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¯åŠ¨è¿æ¥ - æ•°æ®ä¸­å¿ƒ</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;{&quot;start_join&quot;:[&quot;10.10.1.1&quot;,&quot;10.10.1.2&quot;,&quot;10.10.1.3&quot;],&quot;bootstrap_expect&quot;: 3,&quot;datacenter&quot;:&quot;center&quot;}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> join.json</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ç”Ÿæˆå¯†é’¥</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;{&quot;encrypt&quot;:&quot;&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">consul keygen</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&quot;}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> encrypt.json</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¦‚æœè§‰å¾—é…ç½®æ–‡ä»¶è¿‡å¤šå¯åˆå¹¶ä¸ºä¸€ä¸ª</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># jq -s add consul.d/*.json &gt; config.json</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¯åŠ¨</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul agent -config-dir /etc/consul</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="é€‰é¡¹"></a>é€‰é¡¹<a class="hash-link" href="#é€‰é¡¹" title="Direct link to heading">#</a></h2><ul><li><a href="https://www.consul.io/docs/agent/options" target="_blank" rel="noopener noreferrer">https://www.consul.io/docs/agent/options</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ“ä½œ"></a>æ“ä½œ<a class="hash-link" href="#æ“ä½œ" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ä»æ–°åŠ è½½é…ç½®</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul reload</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">killall</span><span class="token plain"> -HUP consul</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="é…ç½®"></a>é…ç½®<a class="hash-link" href="#é…ç½®" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æœ€å°æœåŠ¡é…ç½®"></a>æœ€å°æœåŠ¡é…ç½®<a class="hash-link" href="#æœ€å°æœåŠ¡é…ç½®" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;data_dir&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/var/consul&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;server&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;bootstrap_expect&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;disable_update_check&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;disable_remote_exec&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;enable_syslog&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æœåŠ¡å®šä¹‰"></a>æœåŠ¡å®šä¹‰<a class="hash-link" href="#æœåŠ¡å®šä¹‰" title="Direct link to heading">#</a></h3><ul><li><a href="https://www.consul.io/docs/agent/services.html" target="_blank" rel="noopener noreferrer">Services</a></li></ul><p><strong>å®šä¹‰å•ä¸ªæœåŠ¡</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;service&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;portal&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;tags&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;primary&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;address&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;10.66.1.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;meta&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;meta&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;for my service&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;port&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;enable_tag_override&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>å®šä¹‰å¤šä¸ªæœåŠ¡</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;services&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;svc-a&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;svc-b&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¯åŠ¨å•èŠ‚ç‚¹</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¼€å‘æ¨¡å¼</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul agent -dev -client </span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">.0.0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul agent -bootstrap -server -data-dir </span><span class="token environment constant" style="color:rgb(130, 170, 255)">$PWD</span><span class="token plain">/data -advertise </span><span class="token number" style="color:rgb(247, 140, 108)">127.0</span><span class="token plain">.0.1 -ui</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ==&gt; WARNING: Bootstrap mode enabled! Do not enable unless necessary</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ==&gt; Starting Consul agent...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ==&gt; Starting Consul agent RPC...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ==&gt; Consul agent running!</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#            Version: &#x27;v0.7.3&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#            Node ID: &#x27;f5bdf8b9-3e67-8b88-ddce-4052a5ae6bec&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#          Node name: &#x27;wener&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#         Datacenter: &#x27;dc1&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#             Server: true (bootstrap: true)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#        Client Addr: 127.0.0.1 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#       Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#     Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#              Atlas: &lt;disabled&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># åœ¨å®¹å™¨ä¸­å¯åŠ¨é›†ç¾¤, æŒ‡å®šç½‘å¡æ˜¯å…³é”®</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --rm -it </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --networ </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_CLIENT_INTERFACE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">eth0 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_BIND_INTERFACE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">eth0 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  consule agent -server -bootstrap-expect </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -retry-join consul_consul_1 -retry-join consul_consul_2 -retry-join consul_consul_3</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># æŸ¥çœ‹æˆå‘˜ä¿¡æ¯</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">exec</span><span class="token plain"> -it consul_consul_3 consul members -http-addr</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">http://consul_consul_3:8500</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å†å¯åŠ¨ä¸€ä¸ªç”¨äºåšå¯¹å¤–æš´éœ², å¯åŠ¨ ui, å…è®¸æ‰€æœ‰æ¥æºå®¢æˆ·ç«¯è®¿é—®</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -it --rm --network multi-host-network </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_BIND_INTERFACE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">eth0 -p </span><span class="token number" style="color:rgb(247, 140, 108)">8500</span><span class="token plain">:8500 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --name consul consul agent -server -retry-join consul_consul_1 -ui</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¯ç”¨ ACL</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -it --rm -p </span><span class="token number" style="color:rgb(247, 140, 108)">8500</span><span class="token plain">:8500  -v </span><span class="token environment constant" style="color:rgb(130, 170, 255)">$PWD</span><span class="token plain">/consul/data:/consul/data </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;CONSUL_LOCAL_CONFIG={&quot;datacenter&quot;:&quot;dc1&quot;,&quot;acl_datacenter&quot;: &quot;dc1&quot;,&quot;acl_master_token&quot;: &quot;b1gs33cr3t&quot;,&quot;acl_default_policy&quot;: &quot;deny&quot;,&quot;acl_down_policy&quot;: &quot;extend-cache&quot;}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_CLIENT_INTERFACE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">eth0 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -e </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_BIND_INTERFACE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">eth0 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --name consul consul agent -server -bootstrap-expect </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> -ui</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å®¢æˆ·ç«¯æŒ‡å®š Token</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul members -token b1gs33cr3t</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">CONSUL_HTTP_TOKEN</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">b1gs33cr3t consul members</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -v --request PUT http://127.0.0.1:8500/v1/acl/bootstrap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">dev-consul consul</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d consul agent -dev -join</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">172.17</span><span class="token plain">.0.2</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">exec</span><span class="token plain"> -t dev-consul consul members</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --net</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">host consul agent -server -bind</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">external ip</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> -retry-join</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">root agent ip</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> -bootstrap-expect</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">number of server agents</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Start cluster server</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">node0 consul agent -server -client</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">.0.0 -node</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">node0 -bootstrap-expect</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> -bind</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">172.17</span><span class="token plain">.0.2 -data-dir</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/tmp/consul</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Start client</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">node1 consul agent -client</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">.0.0 -node</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">node1 -bind</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">172.17</span><span class="token plain">.0.3 -data-dir</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/tmp/consul -join</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">172.17</span><span class="token plain">.0.2</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="acl"></a>ACL<a class="hash-link" href="#acl" title="Direct link to heading">#</a></h2><ul><li><a href="https://learn.hashicorp.com/consul/security-networking/production-acls" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/consul/security-networking/production-acls</a></li><li>ACL å¯æ§åˆ¶çš„èµ„æºä¸»è¦æœ‰<ul><li>agent Utility operations in the Agent API, other than service and check registration</li><li>event Listing and firing events in the Event API</li><li>key Key/value store operations in the KV Store API</li><li>keyring Keyring operations in the Keyring API</li><li>node Node-level catalog operations in the Catalog API, Health API, Prepared Query API, Network Coordinate API, and Agent API</li><li>operator Cluster-level operations in the Operator API, other than the Keyring API</li><li>query Prepared query operations in the Prepared Query API</li><li>service Service-level catalog operations in the Catalog API, Health API, Prepared Query API, and Agent API</li><li>session Session operations in the Session API</li></ul></li><li>å†…å»ºç­–ç•¥<ul><li>global-management<ul><li>ç”¨äºå…¨å±€ç®¡ç†</li></ul></li></ul></li><li><a href="https://learn.hashicorp.com/consul/security-networking/managing-acl-policies#required-privileges-for-datacenter-operations" target="_blank" rel="noopener noreferrer">æ“ä½œéœ€è¦çš„æƒé™</a></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">consul acl bootstrap</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;acl&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// å¯ç”¨ ACL</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;enabled&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// é»˜è®¤ç­–ç•¥ - é»˜è®¤ä¸º allow</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;default_policy&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deny&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;tokens&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// åœ¨ primary_datacenter é›†ç¾¤çš„æœåŠ¡ä¼šä½¿ç”¨</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ç®¡ç†çº§åˆ«çš„æƒé™</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ç”¨äºç”³è¯·é›†ç¾¤ leadership æ—¶ä½¿ç”¨</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;master&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// é»˜è®¤ TOKEN - åœ¨ agent è¯·æ±‚ æœåŠ¡æ—¶ä½¿ç”¨</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// å¦‚æœä¸ºç©ºåˆ™ä¸º anonymous çš„ ACL</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;default&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¤„ç†å†…éƒ¨æ“ä½œ - å¦‚æœæ²¡æŒ‡å®šï¼Œä½¿ç”¨ default</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// è¯¥ TOKEN è‡³å°‘éœ€è¦æœ‰å½“å‰èŠ‚ç‚¹çš„å†™æƒé™</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;agent&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ç”¨äºè®¿é—® agent æ¥å£ - éœ€è¦ agent è¯»å†™æƒé™æˆ–èŠ‚ç‚¹çš„è¯»æƒé™</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;agent_master&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;replication&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="agent"></a>agent<a class="hash-link" href="#agent" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">node_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   policy = &quot;write&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">service_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="åªè¯»ç­–ç•¥"></a>åªè¯»ç­–ç•¥<a class="hash-link" href="#åªè¯»ç­–ç•¥" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">node_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">service_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">query_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">key_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="registrator"></a>registrator<a class="hash-link" href="#registrator" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">service_prefix &quot;&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;write&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="anonymous"></a>anonymous<a class="hash-link" href="#anonymous" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace &quot;default&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">agent {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">node {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = &quot;read&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dns"></a>DNS<a class="hash-link" href="#dns" title="Direct link to heading">#</a></h3><ul><li>èŠ‚ç‚¹ <code>&lt;node&gt;.node[.datacenter].&lt;domain&gt;</code></li><li>æœåŠ¡ <code>[tag.]&lt;service&gt;.service[.datacenter].&lt;domain&gt;</code></li><li>RFC 2782 <code>_&lt;service&gt;._&lt;protocol&gt;[.service][.datacenter][.domain]</code></li><li>é¢„å®šä¹‰æŸ¥è¯¢ <code>&lt;query or name&gt;.query[.datacenter].&lt;domain&gt;</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">dig</span><span class="token plain"> @127.0.0.1 -p </span><span class="token number" style="color:rgb(247, 140, 108)">8600</span><span class="token plain"> consul.service.consul SRV</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="config"></a>Config<a class="hash-link" href="#config" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;datacenter&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;east-aws&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;data_dir&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/opt/consul&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;log_level&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;INFO&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;node_name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;foobar&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;server&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;watches&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;checks&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;handler&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/usr/bin/health-check-handler.sh&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;telemetry&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;statsite_address&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;127.0.0.1:2180&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="consul-cluster"></a>consul cluster<a class="hash-link" href="#consul-cluster" title="Direct link to heading">#</a></h2><ul><li>ä¸‰ä¸ª serverï¼Œ</li></ul><p><strong>consul.auto.tfvars.json</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;consul&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;datacenter&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wener&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;master_token&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&lt;UUID&gt;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>consul.tf</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">provider &quot;docker&quot; {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_network&quot; &quot;service&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name = &quot;service&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  check_duplicate = true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_image&quot; &quot;consul&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name = &quot;consul:latest&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  keep_locally = true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;consul&quot; {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">locals {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  server_conf = {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    datacenter: var.consul.datacenter</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    disable_update_check: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    disable_remote_exec: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discard_check_output: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    acl: {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enabled: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      default_policy: &quot;deny&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enable_token_persistence: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tokens: {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        master: var.consul.master_token</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    connect: {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enabled: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      enable_mesh_gateway_wan_federation: true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># config-dir /consul/config/</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># data-dir /consul/data/</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_container&quot; &quot;consul_1&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name  = &quot;consul_1&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostname  = &quot;consul_1&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image = docker_image.consul.latest</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  upload {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file = &quot;/consul/config/server.json&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    content = jsonencode(local.server_conf)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    source_hash = sha256(jsonencode(local.server_conf))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  command = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;agent&quot;, &quot;-server&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-advertise&quot;, &quot;{{ GetInterfaceIP `eth0` }}&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-bind&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-client&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-bootstrap-expect&quot;, &quot;3&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-ui&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ports {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    internal = 8500</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    external = 8500</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  networks_advanced {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name = &quot;service&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_container&quot; &quot;consul_2&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name  = &quot;consul_2&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostname  = &quot;consul_2&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image = docker_image.consul.latest</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  upload {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file = &quot;/consul/config/server.json&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    content = jsonencode(local.server_conf)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    source_hash = sha256(jsonencode(local.server_conf))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  command = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;agent&quot;, &quot;-server&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-advertise&quot;, &quot;{{ GetInterfaceIP `eth0` }}&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-bind&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-client&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_1&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  networks_advanced {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name = &quot;service&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_container&quot; &quot;consul_3&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name  = &quot;consul_3&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostname  = &quot;consul_3&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image = docker_image.consul.latest</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  upload {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    file = &quot;/consul/config/server.json&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    content = jsonencode(local.server_conf)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    source_hash = sha256(jsonencode(local.server_conf))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  command = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;agent&quot;, &quot;-server&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-advertise&quot;, &quot;{{ GetInterfaceIP `eth0` }}&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-bind&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-client&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_1&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_2&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  networks_advanced {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name = &quot;service&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># agent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;docker_container&quot; &quot;consul_4&quot; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name  = &quot;consul_4&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostname  = &quot;consul_4&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image = docker_image.consul.latest</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  command = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;agent&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-advertise&quot;, &quot;{{ GetInterfaceIP `eth0` }}&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-bind&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-client&quot;, &quot;0.0.0.0&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_1&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_2&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;-retry-join&quot;,&quot;consul_3&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  networks_advanced {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name = &quot;service&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="faq"></a>FAQ<a class="hash-link" href="#faq" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="åœ°å€æ¨¡æ¿éªŒè¯"></a>åœ°å€æ¨¡æ¿éªŒè¯<a class="hash-link" href="#åœ°å€æ¨¡æ¿éªŒè¯" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">go get -u github.com/hashicorp/go-sockaddr/cmd/sockaddr</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">~/go/bin/sockaddr </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">eval</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;GetPrivateInterfaces |  include &quot;network&quot; &quot;10.0.0.0/8&quot; | attr &quot;address&quot;&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dropping-node-consul-from-result-due-to-acls"></a>dropping node &quot;consul&quot; from result due to ACLs<a class="hash-link" href="#dropping-node-consul-from-result-due-to-acls" title="Direct link to heading">#</a></h3><ul><li>DNS æŸ¥è¯¢æ—¶å‡ºç°</li><li>å…è®¸åŒ¿åè®¿é—® service</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="autopilot-failed-to-remove-dead-servers-too-many-dead-servers-11"></a>autopilot: Failed to remove dead servers: too many dead servers: 1/1<a class="hash-link" href="#autopilot-failed-to-remove-dead-servers-too-many-dead-servers-11" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å°†-docker-æš´éœ²åˆ°-consul"></a>å°† docker æš´éœ²åˆ° consul<a class="hash-link" href="#å°†-docker-æš´éœ²åˆ°-consul" title="Direct link to heading">#</a></h3><ul><li><a href="https://github.com/gliderlabs/registrator" target="_blank" rel="noopener noreferrer">gliderlabs/registrator</a></li><li>é…ç½®é¡¹<ul><li>æ ‡ç¤º SERVICE_ID - é»˜è®¤æ˜¯ ä¸»æœºå:æœåŠ¡å:ç«¯å£</li><li>åå­— SERVICE_NAME</li><li>å¿½ç•¥ SERVICE_IGNORE</li><li>æ ‡ç­¾ SERVICE_TAGS=master,backups</li><li>å±æ€§ SERVICE_xxoo=abc ä¼šè®°å½•åˆ°æœåŠ¡å±æ€§</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># master ä¸ºæœ€æ–° - latest ä¸º 4 å¹´å‰æœ€åç‰ˆæœ¬</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run gliderlabs/registrator:master --help</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># -explicit åªæœ‰å®šä¹‰äº† SERVICE_NAME çš„æ‰æš´éœ²</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># -ip æš´éœ²çš„ IP - ä½¿ç”¨äº†è¯¥å‚æ•°åˆ™ä¸éœ€è¦ net=host</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># -internal ä½¿ç”¨å†…éƒ¨åœ°å€å’Œç«¯å£ - åœ¨ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œçš„æ—¶å€™å¾ˆæ–¹ä¾¿</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">registrator </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --volume</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/var/run/docker.sock:/tmp/docker.sock </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  gliderlabs/registrator:master -explicit -ip </span><span class="token number" style="color:rgb(247, 140, 108)">192.168</span><span class="token plain">.1.2 consul://192.168.1.2:8500</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name web -l </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">SERVICE_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">web -P nginx</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å½“æš´éœ²äº†å¤šä¸ªç«¯å£æ—¶éšè—æŸä¸ªç«¯å£</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name web -l </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">SERVICE_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">web -l </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">SERVICE_443_IGNORE</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">true -P nginx</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># å¦‚æœæš´éœ²äº†å¤šä¸ªç«¯å£ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åªæš´éœ²æŸä¸ªç«¯å£ä½œä¸ºæœåŠ¡</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -d --name web -l </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">SERVICE_8080_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">web -P nginx</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/wenerme/wener/edit/master/notes/devops/service/consul.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/notes/devops/service/ambassador"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Ambassador</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/notes/devops/service/consul-conf"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Consul é…ç½® Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#catalog" class="table-of-contents__link">Catalog</a></li><li><a href="#å¿«é€Ÿå¼€å§‹" class="table-of-contents__link">å¿«é€Ÿå¼€å§‹</a></li><li><a href="#é€‰é¡¹" class="table-of-contents__link">é€‰é¡¹</a></li><li><a href="#æ“ä½œ" class="table-of-contents__link">æ“ä½œ</a></li><li><a href="#é…ç½®" class="table-of-contents__link">é…ç½®</a><ul><li><a href="#æœ€å°æœåŠ¡é…ç½®" class="table-of-contents__link">æœ€å°æœåŠ¡é…ç½®</a></li><li><a href="#æœåŠ¡å®šä¹‰" class="table-of-contents__link">æœåŠ¡å®šä¹‰</a></li></ul></li><li><a href="#acl" class="table-of-contents__link">ACL</a><ul><li><a href="#dns" class="table-of-contents__link">DNS</a></li><li><a href="#config" class="table-of-contents__link">Config</a></li></ul></li><li><a href="#consul-cluster" class="table-of-contents__link">consul cluster</a></li><li><a href="#faq" class="table-of-contents__link">FAQ</a><ul><li><a href="#åœ°å€æ¨¡æ¿éªŒè¯" class="table-of-contents__link">åœ°å€æ¨¡æ¿éªŒè¯</a></li><li><a href="#dropping-node-consul-from-result-due-to-acls" class="table-of-contents__link">dropping node &quot;consul&quot; from result due to ACLs</a></li><li><a href="#autopilot-failed-to-remove-dead-servers-too-many-dead-servers-11" class="table-of-contents__link">autopilot: Failed to remove dead servers: too many dead servers: 1/1</a></li><li><a href="#å°†-docker-æš´éœ²åˆ°-consul" class="table-of-contents__link">å°† docker æš´éœ²åˆ° consul</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ç¬”è®°</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/notes/java/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/os/alpine/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes/kubernetes">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip/voip">VoIP</a></li></ul></div><div class="col footer__col"><div class="footer__title">Projects</div><ul class="footer__items"><li class="footer__item">
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wener/actions" title="wenerme/wener - ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://github.com/wenerme/wener/workflows/Build/badge.svg">
                </a>
              </div>
              </li><li class="footer__item"><a href="https://apis.wener.me" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Wener&#x27;s Apis<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/story">Blog</a></li><li class="footer__item"><a href="https://github.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/wener-logo.svg" alt="Wener Site" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 1992-2021 Wener - <img alt="cc-by-sa-4.0" src="https://mirrors.creativecommons.org/presskit/buttons/80x15/svg/by-sa.svg"> - Build @2021-10-15 00:16</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b13495bb.js"></script>
<script src="/assets/js/main.2db18e17.js"></script>
</body>
</html>