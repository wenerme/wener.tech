/*! For license information please see 6a0f3e40.eeaefeb7.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[45136],{45044:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>r,metadata:()=>t,toc:()=>o});var s=l(11527),i=l(47214);const r={title:"PL/pgSQL"},c="PL/pgSQL",t={id:"db/relational/postgresql/postgresql-plpgsql",title:"PL/pgSQL",description:"- plpgsql",source:"@site/../notes/db/relational/postgresql/postgresql-plpgsql.md",sourceDirName:"db/relational/postgresql",slug:"/db/relational/postgresql/plpgsql",permalink:"/notes/db/relational/postgresql/plpgsql",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-plpgsql.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1693133627,formattedLastUpdatedAt:"Aug 27, 2023",frontMatter:{title:"PL/pgSQL"},sidebar:"docs",previous:{title:"PostgreSQL PL",permalink:"/notes/db/relational/postgresql/pl"},next:{title:"PostgreSQL \u94fe\u63a5\u6c60",permalink:"/notes/db/relational/postgresql/pool"}},d={},o=[];function E(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",li:"li",pre:"pre",ul:"ul",...(0,i.a)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"plpgsql",children:"PL/pgSQL"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/plpgsql.html",children:"plpgsql"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/plpgsql-declarations.html",children:"declarations"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"%TYPE"}),"\n",(0,s.jsx)(e.li,{children:"%ROWTYPE"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["raise\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"DEBUG, LOG, INFO, NOTICE, WARNING, EXCEPTION"}),"\n",(0,s.jsx)(e.li,{children:"\u9ed8\u8ba4 EXCEPTION"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"caution",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5c3d\u91cf\u907f\u514d EXCEPTION - \u8fc7\u591a\u5f71\u54cd\u6027\u80fd"}),"\n"]})}),"\n",(0,s.jsx)(e.admonition,{type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4e0d\u60f3\u8981\u7ed3\u679c\u4f7f\u7528 PERFORM"}),"\n",(0,s.jsxs)(e.li,{children:["\u5185\u90e8\u903b\u8f91\u5bf9\u6bd4\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"IF expression THEN ..."})," -> ",(0,s.jsx)(e.code,{children:"SELECT expression"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"IF x < y THEN ..."})," -> ",(0,s.jsx)(e.code,{children:"PREPARE statement_name(integer, integer) AS SELECT $1 < $2"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u8bed\u53e5\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"SELECT, INSERT, UPDATE, DELETE + INTO"}),"\n",(0,s.jsx)(e.li,{children:"PERFORM - \u6267\u884c\u4e0d\u8fd4\u56de\u7ed3\u679c\u8bed\u53e5"}),"\n",(0,s.jsx)(e.li,{children:"EXECUTE - \u6267\u884c\u52a8\u6001\u6784\u5efa\u7684\u8bed\u53e5"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"GET [ CURRENT ] DIAGNOSTICS variable { = | := } item [ , ... ]"}),"\n\u83b7\u53d6\u7ed3\u679c\u72b6\u6001\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"ROW_COUNT"}),"\n",(0,s.jsx)(e.li,{children:"PG_CONTEXT"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"NULL - noop"}),"\n",(0,s.jsx)(e.li,{children:"COMMIT"}),"\n",(0,s.jsx)(e.li,{children:"ROLLBACK"}),"\n",(0,s.jsx)(e.li,{children:"RAISE"}),"\n",(0,s.jsx)(e.li,{children:"ASSERT"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u63a7\u5236\u6d41\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"RETURN"}),"\n",(0,s.jsxs)(e.li,{children:["RETURN NEXT, RETURN QUERY, RETURN QUERY EXECUTE\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b9a\u4e49\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd8\u9700\u8981\u6267\u884c RETURN \u624d\u4f1a\u8fd4\u56de"}),"\n",(0,s.jsx)(e.li,{children:"\u8fd4\u56de\u524d\u7ed3\u679c\u4f1a\u5168\u90e8\u5b58\u50a8 - \u56e0\u6b64\u4e0d\u8981\u8fd4\u56de\u5927\u91cf\u7684\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"EXIT [ label ] [ WHEN boolean-expression ]"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8df3\u51fa BLOCK - \u7c7b\u4f3c break"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"CONTINUE [ label ] [ WHEN boolean-expression ]"})}),"\n",(0,s.jsx)(e.li,{children:"IF/THEN/ELSE/ELSIF/END IF"}),"\n",(0,s.jsx)(e.li,{children:"CASE/WHEN/ELSE/END CASE"}),"\n",(0,s.jsx)(e.li,{children:"LOOP/END LOOP"}),"\n",(0,s.jsx)(e.li,{children:"WHILE/LOOP/END LOOP"}),"\n",(0,s.jsx)(e.li,{children:"FOR/IN/LOOP/END LOOP - \u4fbf\u5229\u7ed3\u679c\u3001\u6570\u5b57"}),"\n",(0,s.jsx)(e.li,{children:"FOREACH/IN ARRYAY/LOOP/END LOOP - \u4fbf\u5229\u6570\u7ec4"}),"\n",(0,s.jsxs)(e.li,{children:["EXCEPTION/WHEN/THEN\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"GET STACKED DIAGNOSTICS variable { = | := } item [ , ... ]"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u83b7\u53d6\u5f02\u5e38\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["cursor\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u5b9a\u4e49\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"refcursor"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"CURSOR FOR SELECT * FROM tenk1"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"CURSOR (key integer) FOR SELECT * FROM tenk1 WHERE unique1 = key"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"OPEN/FOR"}),"\n",(0,s.jsx)(e.li,{children:"OPEN/FOR EXECUTE"}),"\n",(0,s.jsx)(e.li,{children:"FETCH/INTO"}),"\n",(0,s.jsx)(e.li,{children:"MOVE - \u7c7b\u4f3c FETCH \u4f46\u4e0d\u8fd4\u56de\u7ed3\u679c"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"UPDATE table SET ... WHERE CURRENT OF cursor"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8981\u6c42 cursor \u6ca1\u6709 \u805a\u5408"}),"\n",(0,s.jsx)(e.li,{children:"\u5efa\u8bae\u6dfb\u52a0 FOR UPDATE"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"DELETE FROM table WHERE CURRENT OF cursor"})}),"\n",(0,s.jsx)(e.li,{children:"CLOSE"}),"\n",(0,s.jsx)(e.li,{children:"FOR/IN/LOOP/END LOOP"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"/notes/db/relational/postgresql/trigger",children:"trigger"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",metastring:'title="\u6574\u4f53\u7ed3\u6784"',children:"[ <<label>> ]\n[ DECLARE\n    declarations ]\nBEGIN\n    statements\nEND [ label ];\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",metastring:'title="print_strict_params \u8f85\u52a9\u8c03\u8bd5"',children:"CREATE FUNCTION get_userid(username text) RETURNS int\nAS $$\n#print_strict_params on\nDECLARE\nuserid int;\nBEGIN\n    SELECT users.userid INTO STRICT userid\n        FROM users WHERE users.username = get_userid.username;\n    RETURN userid;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",metastring:'title="FOR \u652f\u6301 REVERSE \u548c BY"',children:"FOR i IN REVERSE 10..1 BY 2 LOOP\n    -- i will take on the values 10,8,6,4,2 within the loop\nEND LOOP;\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u51fd\u6570\u9690\u542b\u6700\u5916\u5c42 block - label \u4e3a\u51fd\u6570\u540d\u5b57\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5305\u542b DIAGNOSTICS \u4fe1\u606f"}),"\n",(0,s.jsxs)(e.li,{children:["\u9690\u542b FOUND \u53d8\u91cf - \u5f53\u8bed\u53e5\u6709\u503c\u65f6\u4f1a\u8bbe\u7f6e\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"SELECT INTO"}),"\n",(0,s.jsx)(e.li,{children:"PERFORM"}),"\n",(0,s.jsx)(e.li,{children:"UPDATE, INSERT, DELETE"}),"\n",(0,s.jsx)(e.li,{children:"FETCH"}),"\n",(0,s.jsx)(e.li,{children:"MOVE"}),"\n",(0,s.jsx)(e.li,{children:"FOR, FOREACH"}),"\n",(0,s.jsx)(e.li,{children:"RETURN QUERY, RETURN QUERY EXECUTE"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",metastring:'title="\u4f7f\u7528\u9690\u542b\u7684 FOUND \u53d8\u91cf"',children:"SELECT * INTO STRICT myrec FROM emp WHERE empname = myname;\nIF NOT FOUND THEN\n    RAISE EXCEPTION 'employee % not found', myname;\nEND IF;\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["select into STRICT \u5355\u4e2a record \u53ef\u80fd\u7684\u5f02\u5e38 code\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"NO_DATA_FOUND"}),"\n",(0,s.jsx)(e.li,{children:"TOO_MANY_ROWS"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u6ca1\u6709 STRICT \u76f4\u63a5\u8fd4\u56de\u7b2c\u4e00\u6761\uff0c\u6ca1\u6709\u5219\u662f NULL"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"-- strict_multi_assignment\n-- too_many_rows\nSET plpgsql.extra_warnings TO 'shadowed_variables';\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"#variable_conflict error\n#variable_conflict use_variable\n#variable_conflict use_column\n"})})]})}function a(n={}){const{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(E,{...n})}):E(n)}},3354:(n,e,l)=>{var s=l(50959),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),c=Object.prototype.hasOwnProperty,t=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function o(n,e,l){var s,r={},o=null,E=null;for(s in void 0!==l&&(o=""+l),void 0!==e.key&&(o=""+e.key),void 0!==e.ref&&(E=e.ref),e)c.call(e,s)&&!d.hasOwnProperty(s)&&(r[s]=e[s]);if(n&&n.defaultProps)for(s in e=n.defaultProps)void 0===r[s]&&(r[s]=e[s]);return{$$typeof:i,type:n,key:o,ref:E,props:r,_owner:t.current}}e.Fragment=r,e.jsx=o,e.jsxs=o},11527:(n,e,l)=>{n.exports=l(3354)},47214:(n,e,l)=>{l.d(e,{Z:()=>t,a:()=>c});var s=l(50959);const i={},r=s.createContext(i);function c(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);