"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[79555],{49613:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var r=n(59496);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),d=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=d(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=d(n),m=a,h=u["".concat(s,".").concat(m)]||u[m]||c[m]||o;return n?r.createElement(h,l(l({ref:t},p),{},{components:n})):r.createElement(h,l({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var d=2;d<o;d++)l[d]=n[d];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},23801:function(e,t,n){n.r(t),n.d(t,{assets:function(){return f},contentTitle:function(){return m},default:function(){return b},frontMatter:function(){return u},metadata:function(){return h},toc:function(){return y}});var r=n(49613),a=Object.defineProperty,o=Object.defineProperties,l=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,p=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,c=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&p(e,n,t[n]);if(i)for(var n of i(t))d.call(t,n)&&p(e,n,t[n]);return e};const u={title:"Caddy"},m="Caddy",h={unversionedId:"devops/web/caddy",id:"devops/web/caddy",title:"Caddy",description:"\u6982\u8ff0",source:"@site/../notes/devops/web/caddy.md",sourceDirName:"devops/web",slug:"/devops/web/caddy",permalink:"/notes/devops/web/caddy",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/caddy.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1628160908,formattedLastUpdatedAt:"Aug 5, 2021",frontMatter:{title:"Caddy"},sidebar:"docs",previous:{title:"Apache APISIX",permalink:"/notes/devops/web/apisix"},next:{title:"HAProxy \u914d\u7f6e",permalink:"/notes/devops/web/haproxy-conf"}},f={},y=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u4fe1\u53f7\u91cf\u5904\u7406",id:"\u4fe1\u53f7\u91cf\u5904\u7406",level:2},{value:"\u65e5\u5fd7\u914d\u7f6e",id:"\u65e5\u5fd7\u914d\u7f6e",level:2},{value:"Example",id:"example",level:2},{value:"CHANGELOG",id:"changelog",level:2},{value:"0.10.12",id:"01012",level:3},{value:"FAQ",id:"faq",level:2},{value:"\u7981\u7528\u91cd\u5b9a\u5411 http \u5230 https",id:"\u7981\u7528\u91cd\u5b9a\u5411-http-\u5230-https",level:3},{value:"\u5728\u65e5\u5fd7\u6587\u4ef6\u540d\u4e2d\u4f7f\u7528\u5360\u4f4d\u7b26",id:"\u5728\u65e5\u5fd7\u6587\u4ef6\u540d\u4e2d\u4f7f\u7528\u5360\u4f4d\u7b26",level:3}],k={toc:y};function b(e){var t,n=e,{components:a}=n,p=((e,t)=>{var n={};for(var r in e)s.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&i)for(var r of i(e))t.indexOf(r)<0&&d.call(e,r)&&(n[r]=e[r]);return n})(n,["components"]);return(0,r.kt)("wrapper",(t=c(c({},k),p),o(t,l({components:a,mdxType:"MDXLayout"}))),(0,r.kt)("h1",c({},{id:"caddy"}),"Caddy"),(0,r.kt)("h2",c({},{id:"\u6982\u8ff0"}),"\u6982\u8ff0"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",c({parentName:"li"},{href:"https://github.com/mholt/caddy/issues/1806"}),"#1806")," - Watch Caddyfile for changes")),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{className:"language-bash"}),'# macOS \u5b89\u88c5\n# \u4e0d\u4f1a\u5b89\u88c5\u63d2\u4ef6\nbrew install caddy\n\n# \u76f4\u63a5\u542f\u52a8, \u4f1a\u4f7f\u7528\u5f53\u524d\u76ee\u5f55\u4e0b\u7684 Caddyfile \u4f5c\u4e3a\u914d\u7f6e\u6587\u4ef6\ncaddy\n# \u67e5\u770b\u5b89\u88c5\u7684\u63d2\u4ef6\ncaddy -plugins\n# \u9a8c\u8bc1\u914d\u7f6e\ncaddy -validate -conf Caddyfile\n\n# Docker \u542f\u52a8\n# \u914d\u7f6e /etc/Caddyfile\n# root /srv\n# cert /root/.caddy \u6216 CADDYPATH\n# \u8be5\u955c\u50cf\u4e0d\u5305\u542b\u63d2\u4ef6, \u63d2\u4ef6\u9700\u8981\u81ea\u5df1\u6784\u5efa\ndocker run --rm -it -v $PWD:/srv -p 2015:2015 abiosoft/caddy\n# \u5305\u542b\u6240\u6709\u63d2\u4ef6\n# \u5176\u4ed6\u6807\u7b7e: latest \u57fa\u4e8e Alpine, php \u6dfb\u52a0\u4e86 PHP \u652f\u6301\ndocker run --rm -it -v $PWD:/srv -p 2015:2015 wener/caddy:full\n# \u9a8c\u8bc1\u914d\u7f6e\ndocker exec web caddy -validate -conf /caddy/Caddyfile\n\n# \u4ece\u547d\u4ee4\u884c\u76f4\u63a5\u6dfb\u52a0\u914d\u7f6e\ncaddy -port 8080 browse markdown "log access.log"\n# \u91cd\u8f7d\u914d\u7f6e\nkill -USR1 PID\n# \u4f7f\u7528 Docker \u91cd\u8f7d\ndocker kill -s USR1 web\n\n# \u5e38\u7528\u7684\u914d\u7f6e\nmkdir root\ncaddy -conf Caddyfile\n')),(0,r.kt)("h2",c({},{id:"\u4fe1\u53f7\u91cf\u5904\u7406"}),"\u4fe1\u53f7\u91cf\u5904\u7406"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",c({parentName:"tr"},{align:null}),"Signal"),(0,r.kt)("th",c({parentName:"tr"},{align:null}),"Behavior"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",c({parentName:"tr"},{align:null}),"TERM"),(0,r.kt)("td",c({parentName:"tr"},{align:null}),"Forcefully exits the process without executing shutdown hooks.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",c({parentName:"tr"},{align:null}),"INT"),(0,r.kt)("td",c({parentName:"tr"},{align:null}),'Forcefully exits the process after executing shutdown hooks. This is the only "signal" that works on Windows (Ctrl+C). A second SIGINT forces immediate termination, even if shutdown hooks are still running.')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",c({parentName:"tr"},{align:null}),"HUP"),(0,r.kt)("td",c({parentName:"tr"},{align:null}),"Gracefully stops the server, but does not execute shutdown hooks.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",c({parentName:"tr"},{align:null}),"QUIT"),(0,r.kt)("td",c({parentName:"tr"},{align:null}),"Gracefully stops the server after executing shutdown hooks.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",c({parentName:"tr"},{align:null}),"USR1"),(0,r.kt)("td",c({parentName:"tr"},{align:null}),"Reloads the configuration file, then gracefully restarts the server. This spins up a process with a different process ID.")))),(0,r.kt)("h2",c({},{id:"\u65e5\u5fd7\u914d\u7f6e"}),"\u65e5\u5fd7\u914d\u7f6e"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u683c\u5f0f",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"{common}")," - ",(0,r.kt)("inlineCode",{parentName:"li"},'{remote} - {user} [{when}] \\"{method} {uri} {proto}\\" {status} {size}')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"{combined}")," - ",(0,r.kt)("inlineCode",{parentName:"li"},'{common} \\"{>Referer}\\" \\"{>User-Agent}\\"'))))),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{}),"log requests.log {\n    rotate_size 50  # Rotate after 50 MB\n    rotate_age  90  # Keep rotated files for 90 days\n    rotate_keep 20  # Keep at most 20 log files\n    rotate_compress # Compress rotated log files in gzip format\n}\n")),(0,r.kt)("h2",c({},{id:"example"}),"Example"),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{}),'# \u5185\u90e8\u6587\u4ef6\u6587\u6863\u670d\u52a1\nlocalhost:2016 {\n  gzip\n  log internal/access-2016.log\n  errors visible\n  browse\n  hugo\n  root files\n  bind 127.0.0.1\n  ext .html .htm .md\n}\n\n:80 {\n  # startup echo started > start\n  gzip\n  internal /internal\n  log internal/access-8080.log\n\n  # \u5728 localhost:9180/metrics \u67e5\u770b\n  prometheus\n\n  tls {\n    max_certs 10\n  }\n\n  # \u6388\u6743\n  basicauth /files wener wener\n  # \u8f6c\u53d1\u5230 /files\n  proxy /files http://localhost:2016 {\n    # policy round_robin\n    # health_check /health\n    without /files\n    # proxy_header X-Real-IP {remote}\n    proxy_header X-Forwarded-Proto {scheme}\n    proxy_header X-Forwarded-For {host}\n    proxy_header Host {host}\n  }\n\n  # \u8f6c\u53d1\u8fdc\u7a0b\u670d\u52a1\u5230\u672c\u5730\n  proxy /api api.wener.me {\n    without /api\n  }\n  header /api {\n    # Access-Control-Allow-Origin  *\n    # Access-Control-Allow-Methods "GET, POST, OPTIONS"\n    X-Do-Proxy "true"\n    -Server\n  }\n  # \u5141\u8bb8 CORS \u907f\u8fc7\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u8fdc\u7a0b\u7684\u95ee\u9898\n  cors /api http://editor.swagger.io\n  jsonp /api\n\n  # \u9700\u8981\u901a\u8fc7 JWT_SECRET \u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\n  jwt {\n    path /secret.md\n    allow role user\n  }\n}\n\n')),(0,r.kt)("h2",c({},{id:"changelog"}),"CHANGELOG"),(0,r.kt)("h3",c({},{id:"01012"}),"0.10.12"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",c({parentName:"li"},{href:"https://caddyserver.com/blog/caddy-0_10_12-released"}),"Caddy 0.10.12 Released with ACMEv2 and Wildcard Certificates")),(0,r.kt)("li",{parentName:"ul"},"ACMEv2 \u901a\u914d\u7b26"),(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301\u5171\u4eab\u6302\u8f7d ",(0,r.kt)("inlineCode",{parentName:"li"},"~/.caddy/acme")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"{labelN}")," \u5360\u4f4d\u7b26")),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{}),"// 1.\n*.example.com\ntls {\n    dns provider\n}\n\n// 2. \u4f7f\u7528 macro\n(wildcard_cert) {\n    tls {\n        dns provider\n        wildcard\n    }\n}\nsub1.example.com {\n    import wildcard_cert\n    ...\n}\n\nsub1000000.example.com {\n    import wildcard_cert\n    ...\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{}),"*.example.com\nrewrite {\n    to /{label1}{uri}\n}\n")),(0,r.kt)("p",null,"PDNS_API_KEY\nPDNS_API_URL \u5730\u5740\u8981\u4ee5 / \u7ed3\u5c3e"),(0,r.kt)("p",null,(0,r.kt)("a",c({parentName:"p"},{href:"https://github.com/xenolf/lego/blob/master/providers/dns/pdns/pdns.go"}),"https://github.com/xenolf/lego/blob/master/providers/dns/pdns/pdns.go")),(0,r.kt)("h2",c({},{id:"faq"}),"FAQ"),(0,r.kt)("h3",c({},{id:"\u7981\u7528\u91cd\u5b9a\u5411-http-\u5230-https"}),"\u7981\u7528\u91cd\u5b9a\u5411 http \u5230 https"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",c({parentName:"li"},{href:"https://github.com/mholt/caddy/issues/504"}),"#504")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",c({parentName:"li"},{href:"https://caddyserver.com/docs/automatic-https"}),"https://caddyserver.com/docs/automatic-https")),(0,r.kt)("li",{parentName:"ul"},"\u76ee\u524d\u53ea\u80fd\u7528\u914d\u7f6e\u4e24\u4e2a\u7684\u65b9\u5f0f\u6765\u907f\u514d")),(0,r.kt)("pre",null,(0,r.kt)("code",c({parentName:"pre"},{}),"http://yousite.com {\n  log logs www.chinazs.gov.cn.log\n  proxy / upstream\n}\n\nhttps://yousite.com {\n  proxy / localhost {\n    transparent\n  }\n}\n")),(0,r.kt)("h3",c({},{id:"\u5728\u65e5\u5fd7\u6587\u4ef6\u540d\u4e2d\u4f7f\u7528\u5360\u4f4d\u7b26"}),"\u5728\u65e5\u5fd7\u6587\u4ef6\u540d\u4e2d\u4f7f\u7528\u5360\u4f4d\u7b26"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",c({parentName:"li"},{href:"https://github.com/mholt/caddy/issues/1396"}),"https://github.com/mholt/caddy/issues/1396"))))}b.isMDXComponent=!0}}]);