/*! For license information please see 15ab0a6b.abf898e2.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[3433],{5444:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>a,frontMatter:()=>t,metadata:()=>o,toc:()=>u});var r=i(11527),s=i(47214);const t={title:"io_uring"},l="io_uring",o={id:"os/linux/network/io_uring",title:"io_uring",description:"Zero Copy, ring bazed communication channel.",source:"@site/../notes/os/linux/network/io_uring.md",sourceDirName:"os/linux/network",slug:"/os/linux/network/io_uring",permalink:"/notes/os/linux/network/io_uring",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/network/io_uring.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1667302770,formattedLastUpdatedAt:"Nov 1, 2022",frontMatter:{title:"io_uring"},sidebar:"docs",previous:{title:"interfaces",permalink:"/notes/os/linux/network/interfaces"},next:{title:"IPRoute2",permalink:"/notes/os/linux/network/iproute2"}},c={},u=[];function d(n){const e={a:"a",code:"code",h1:"h1",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"io_uring",children:"io_uring"}),"\n",(0,r.jsx)(e.p,{children:"Zero Copy, ring bazed communication channel."}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Linux v5.1 - 2019-03-03"}),"\n",(0,r.jsxs)(e.li,{children:["\u573a\u666f\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"userspace <-> kernel \u6570\u636e\u4ea4\u4e92"}),"\n",(0,r.jsx)(e.li,{children:"async io"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["SQ - Submission Queue - ",(0,r.jsx)(e.code,{children:"struct io_uring_sqe"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5e94\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u7ef4\u62a4 tail, kernel \u6d88\u8d39 head"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["CQ - Completion Queue - ",(0,r.jsx)(e.code,{children:"struct io_uring_cqe"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Kernel"}),"\n",(0,r.jsx)(e.li,{children:"\u7ef4\u62a4 tail, \u5e94\u7528 \u6d88\u8d39 head"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-c",children:"int io_uring_setup(u32 nentries, struct io_uring_params *p);\nint io_uring_enter(int ring_fd, u32 to_submit, u32 min_complete, u32 flags, sigset_t *sigset);\n\nstruct io_uring_params {\n  __u32 sq_entries;\n  __u32 cq_entries;\n  __u32 flags;\n  __u32 sq_thread_cpu;\n  __u32 sq_thread_idle;\n  __u32 features;\n  __u32 resv[4];\n  struct io_sqring_offsets sq_off;\n  struct io_cqring_offsets cq_off;\n};\n\nstruct io_sqring_offsets {\n  __u32 head;\n  __u32 tail;\n  __u32 ring_mask;\n  __u32 ring_entries;\n  __u32 flags;\n  __u32 dropped;\n  __u32 array;\n  __u32 resv1;\n  __u64 resv2;\n};\n\n#define IORING_OFF_SQ_RING 0ULL\n#define IORING_OFF_CQ_RING 0x8000000ULL\n#define IORING_OFF_SQES 0x10000000ULL\n\n// \u901a\u8fc7 mmap \u5efa\u7acb\u901a\u9053\nsq->ring_ptr = mmap(\n  0,sq->ring_sz,\n  PROT_READ|PROT_WRITE|MAP_SHARED|MAP_POPULATE,\n  ring_fd,\n  IORING_OFF_SQ_RING\n  );\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["opcode\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"nop"}),"\n",(0,r.jsx)(e.li,{children:"readv, writev, fsync, read_fixed, write_fixed"}),"\n",(0,r.jsx)(e.li,{children:"poll_add, poll_remove, sync_file_range, sendmsg, recvmsg, timeout"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"liburing - \u7b80\u5316\u64cd\u4f5c"}),"\n",(0,r.jsxs)(e.li,{children:["Golang\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://github.com/golang/go/issues/31908",children:"go#31908"}),"\ninternal/poll: transparently support new linux io_uring interface"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/dshulyak/uring",children:"dshulyak/uring"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/godzie44/go-uring",children:"godzie44/go-uring"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["used by\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["[btrfs] Linux 6.1 \u652f\u6301 io_uring\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6027\u80fd\u63d0\u5347\u660e\u663e"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"zfs \u652f\u6301 io_uring \u63a5\u53e3"}),"\n",(0,r.jsx)(e.li,{children:"Rust, C++ IO executors"}),"\n",(0,r.jsx)(e.li,{children:"Ceph blustore"}),"\n",(0,r.jsx)(e.li,{children:"libuv"}),"\n",(0,r.jsxs)(e.li,{children:["Postgres\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/anarazel/postgres/tree/aio",children:"https://github.com/anarazel/postgres/tree/aio"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://anarazel.de/talks/2020-01-31-fosdem-aio/aio.pdf",children:"https://anarazel.de/talks/2020-01-31-fosdem-aio/aio.pdf"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"RocksDB, MyRocks"}),"\n",(0,r.jsx)(e.li,{children:"TyrDB, DragonflyDB"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"aio 500K iops/core"}),"\n",(0,r.jsx)(e.li,{children:"io_uring 1-2M iops/core - 2-4x"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://git.kernel.dk/fio",children:"https://git.kernel.dk/fio"})}),"\n",(0,r.jsxs)(e.li,{children:["2019 ",(0,r.jsx)(e.a,{href:"https://kernel.dk/io_uring.pdf",children:"https://kernel.dk/io_uring.pdf"})]}),"\n",(0,r.jsxs)(e.li,{children:["2022 ",(0,r.jsx)(e.a,{href:"https://kernel.dk/io_uring-whatsnew.pdf",children:"https://kernel.dk/io_uring-whatsnew.pdf"})]}),"\n",(0,r.jsxs)(e.li,{children:["January 15, 2019 ",(0,r.jsx)(e.a,{href:"https://lwn.net/Articles/776703/",children:"https://lwn.net/Articles/776703/"}),"\nRinging in a new asynchronous I/O API"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://lwn.net/Articles/779472/",children:"https://lwn.net/Articles/779472/"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://man.archlinux.org/man/io_uring.7.en",children:"https://man.archlinux.org/man/io_uring.7.en"})}),"\n",(0,r.jsxs)(e.li,{children:["Kernel Recipes 2019 - Faster IO through io_uring ",(0,r.jsx)(e.a,{href:"https://youtu.be/-5T4Cjw46ys",children:"https://youtu.be/-5T4Cjw46ys"})]}),"\n",(0,r.jsxs)(e.li,{children:["Windows 11 ioring\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://windows-internals.com/ioring-vs-io_uring-a-comparison-of-windows-and-linux-implementations/",children:"IoRing vs. io_uring: a comparison of Windows and Linux implementations"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function a(n={}){const{wrapper:e}={...(0,s.a)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},3354:(n,e,i)=>{var r=i(50959),s=Symbol.for("react.element"),t=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,o=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function u(n,e,i){var r,t={},u=null,d=null;for(r in void 0!==i&&(u=""+i),void 0!==e.key&&(u=""+e.key),void 0!==e.ref&&(d=e.ref),e)l.call(e,r)&&!c.hasOwnProperty(r)&&(t[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps)void 0===t[r]&&(t[r]=e[r]);return{$$typeof:s,type:n,key:u,ref:d,props:t,_owner:o.current}}e.Fragment=t,e.jsx=u,e.jsxs=u},11527:(n,e,i)=>{n.exports=i(3354)},47214:(n,e,i)=>{i.d(e,{Z:()=>o,a:()=>l});var r=i(50959);const s={},t=r.createContext(s);function l(n){const e=r.useContext(t);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),r.createElement(t.Provider,{value:e},n.children)}}}]);