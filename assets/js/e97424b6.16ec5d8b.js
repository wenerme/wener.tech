/*! For license information please see e97424b6.16ec5d8b.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[23864],{73404:(n,s,e)=>{e.r(s),e.d(s,{assets:()=>c,contentTitle:()=>t,default:()=>x,frontMatter:()=>r,metadata:()=>d,toc:()=>h});var i=e(2488),l=e(62780);const r={title:"ZFS \u8c03\u4f18"},t="ZFS Tuning",d={id:"os/linux/fs/zfs/zfs-tuning",title:"ZFS \u8c03\u4f18",description:"- \u63d0\u5347 \u5e94\u7528\u6027\u80fd - \u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u8c03\u4f18 - recordsize\uff0clogbias\u3001sync=off",source:"@site/../notes/os/linux/fs/zfs/zfs-tuning.md",sourceDirName:"os/linux/fs/zfs",slug:"/os/linux/fs/zfs/tuning",permalink:"/notes/os/linux/fs/zfs/tuning",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/fs/zfs/zfs-tuning.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1689238697,formattedLastUpdatedAt:"Jul 13, 2023",frontMatter:{title:"ZFS \u8c03\u4f18"},sidebar:"docs",previous:{title:"Stat",permalink:"/notes/os/linux/fs/zfs/stat"},next:{title:"OpenZFS Version",permalink:"/notes/os/linux/fs/zfs/version"}},c={},h=[{value:"ZIL SLOG",id:"zil-slog",level:2},{value:"sync",id:"sync",level:3},{value:"logbias",id:"logbias",level:2},{value:"ashift",id:"ashift",level:2},{value:"L2ARC",id:"l2arc",level:2},{value:"\u78c1\u76d8\u4fe1\u606f",id:"\u78c1\u76d8\u4fe1\u606f",level:2},{value:"atime on temporary",id:"atime-on-temporary",level:2},{value:"zfs_vdev_mirror_rotating_inc",id:"zfs_vdev_mirror_rotating_inc",level:2},{value:"SSD TRIM",id:"ssd-trim",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function o(n){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.M)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h1,{id:"zfs-tuning",children:"ZFS Tuning"}),"\n",(0,i.jsx)(s.admonition,{title:"\u76ee\u7684",type:"tip",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u63d0\u5347 \u5e94\u7528\u6027\u80fd - \u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u8c03\u4f18 - recordsize\uff0clogbias\u3001sync=off"}),"\n",(0,i.jsx)(s.li,{children:"\u63d0\u5347 \u8bfb - cache\u3001\u5185\u5b58"}),"\n",(0,i.jsx)(s.li,{children:"\u63d0\u5347 \u5199 - slog\u3001zfs_txg_timeout"}),"\n",(0,i.jsx)(s.li,{children:"\u63d0\u5347 \u7a7a\u95f4\u4f7f\u7528\u7387 - \u538b\u7f29\u3001recordsize\u3001draid"}),"\n",(0,i.jsx)(s.li,{children:"\u63d0\u5347 \u5b89\u5168 - \u70ed\u5907\u3001\u51b7\u5907\u3001sync"}),"\n"]})}),"\n",(0,i.jsx)(s.admonition,{type:"caution",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"slog \u4e0d\u662f write buffer"}),"\n"]})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"/proc/spl/kstat/zfs/main/iostats"}),"\n",(0,i.jsxs)(s.li,{children:["/sys/module/zfs/parameters\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"ZFS \u5185\u6838\u6a21\u5757\u53c2\u6570"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.admonition,{type:"tip",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u4f7f\u7528\u673a\u68b0\u76d8\u65f6\uff0c\u5efa\u8bae\u914d\u5907\u4e00\u4e2a SSD \u5206\u4e24\u4e2a\u533a\uff0c\u4e00\u4e2a\u505a SLOG \u4e00\u4e2a\u505a L2ARC - \u5e76\u589e\u52a0 zfs_txg_timeout"}),"\n",(0,i.jsxs)(s.li,{children:["compressratio \u53d7 recordsize \u5f71\u54cd\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/openzfs/zfs/discussions/11293",children:"https://github.com/openzfs/zfs/discussions/11293"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:"\u603b\u662f\u5f00\u542f compression"}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"zpool prop"}),(0,i.jsx)(s.th,{children:"default"}),(0,i.jsx)(s.th,{children:"recommand"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"ashift"}),(0,i.jsx)(s.td,{children:"0"}),(0,i.jsx)(s.td,{children:"12"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"atime"}),(0,i.jsx)(s.td,{children:"on"}),(0,i.jsx)(s.td,{children:"off"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"recordsize"}),(0,i.jsx)(s.td,{children:"128K"}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"logbias"}),(0,i.jsx)(s.td,{children:"latency"}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"autotrim"}),(0,i.jsx)(s.td,{children:"off"}),(0,i.jsx)(s.td,{children:"SDD \u63a8\u8350 on"})]})]})]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"zdb | grep ashift # \u67e5\u770b\u4f7f\u7528\u7684 ashift\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["ashift\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"2^n - block size/sector size"}),"\n",(0,i.jsx)(s.li,{children:"\u5339\u914d\u5e95\u5c42\u7269\u7406 sector size"}),"\n",(0,i.jsx)(s.li,{children:"0 \u4e3a\u81ea\u52a8\u68c0\u6d4b"}),"\n",(0,i.jsx)(s.li,{children:"\u4e00\u822c\u4e3a 12 - 4K"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["source\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"default"}),"\n",(0,i.jsxs)(s.li,{children:["temporary\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u4e34\u65f6\u6302\u8f7d\u70b9\u5c5e\u6027 - \u4f1a\u6620\u5c04\u5230 mount"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:"inherited from"}),"\n",(0,i.jsx)(s.li,{children:"local"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["xattrs=on\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u5b58\u50a8\u6269\u5c55\u4fe1\u606f\u5230\u9690\u85cf\u76ee\u5f55\uff0c\u8bbf\u95ee\u6587\u4ef6\u65f6\u9700\u8981\u989d\u5916 lookup"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["xattr=sa\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u5b58\u50a8\u6269\u5c55\u4fe1\u606f\u5230 inode"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"zfs set compression=lz4 data\nzfs set atime=off data\nzfs set relatime=on data\nzfs set xattr=sa data\n\n# \u65ad\u7535\u53ef\u80fd\u4e22\u5931\u4e00\u5b9a\u6570\u636e\nzfs set sync=disabled POOL\n\n# primarycache=metadata - \u770b\u60c5\u51b5\nzfs set atime=off relatime=on xattr=sa compression=lz4 sync=disabled POOL\n\nzfs get all POOL | grep -E 'compression|atime|xattr|sync|primarycache|recordsize'\n"})}),"\n",(0,i.jsx)(s.h2,{id:"zil-slog",children:"ZIL SLOG"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["ZIL - ZFS Intent Log\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u77ed\u671f\u5b58\u50a8"}),"\n",(0,i.jsx)(s.li,{children:"ZIL \u9ed8\u8ba4\u5b58\u5728\u4e8e\u786c\u76d8\u4e0a\u7684\u7279\u6b8a\u533a\u57df - \u4ea7\u751f\u53cc\u5199 - \u5148\u5199 ZIL \u5728\u5199\u56de\u5230\u78c1\u76d8\u533a\u57df"}),"\n",(0,i.jsxs)(s.li,{children:["\u4e0d\u4f1a\u4f7f\u7528 ZIL \u7684\u573a\u666f\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"logbias=throughput"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"\u5927\u5757"})," - \u4f8b\u5982\uff1a \u6570\u636e\u540c\u6b65\u65f6\u4e0d\u4f1a\u7528\u5230"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.strong,{children:"\u53ea\u7528\u4e8e\u7cfb\u7edf crash \u6062\u590d"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["SLOG - Separate ZFS Intent Log\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"ZIL \u5b58\u50a8\u4e8e\u989d\u5916\u7684\u78c1\u76d8"}),"\n",(0,i.jsx)(s.li,{children:"\u66ff\u4ee3\u5b58\u50a8\u78c1\u76d8\u4e0a\u7684 ZIL - \u907f\u514d\u53cc\u5199"}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.strong,{children:"\u4e0d\u662f\u5199\u7f13\u5b58"})}),"\n",(0,i.jsxs)(s.li,{children:["\u7528\u4e0d\u4e86\u591a\u5c11\u7a7a\u95f4\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u4e00\u822c 16G \u6216 64G \u8db3\u77e3"}),"\n",(0,i.jsx)(s.li,{children:"max amount of write traffic per second x 15"}),"\n",(0,i.jsxs)(s.li,{children:["TXG commit interval - transaction group commit interval - 5s-10s\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"zfs_txg_synctime"}),"\n",(0,i.jsx)(s.li,{children:"\u589e\u52a0 \u4e8b\u52a1 \u5ef6\u65f6\u6765\u589e\u52a0\u4f7f\u7528\u7684 slog"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.admonition,{type:"tip",children:[(0,i.jsx)(s.p,{children:"\u5c0f\u7684\u5199\u64cd\u4f5c\u4f1a\u5148\u805a\u5408\u91cd\u6392\u5e8f\uff0c\u7136\u540e\u4e00\u6b21\u6027\u5199\u5165\uff0c\u6b64\u65f6\u4f7f\u7528 SLOG \u80fd\u63d0\u5347\u6027\u80fd"}),(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u907f\u514d write IOPS amplification"}),"\n"]}),(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"\u65e0 SLOG"})}),(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"async write -> TXG RAM -> ZPool"}),"\n",(0,i.jsx)(s.li,{children:"sync write -> TXG RAM & ZIL"}),"\n",(0,i.jsx)(s.li,{children:"TXG RAM -> ZPool"}),"\n"]}),(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"\u6709 SLOG"})}),(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"sync write -> TXG RAM & SLOG"}),"\n",(0,i.jsx)(s.li,{children:"\u7cfb\u7edf\u6062\u590d\u65f6 SLOG -> TXG RAM -> replay TXG -> ZPool"}),"\n"]})]}),"\n",(0,i.jsx)(s.h3,{id:"sync",children:"sync"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["sync=standard\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"POSIX-compatible"}),"\n",(0,i.jsx)(s.li,{children:"synchronous only if requested"}),"\n",(0,i.jsx)(s.li,{children:"\u90e8\u5206\u60c5\u51b5\u4f1a\u5199\u5165\u5230 slog"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["sync=always\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u4e3b\u8981\u4fdd\u969c\u6570\u636e\u5b89\u5168"}),"\n",(0,i.jsx)(s.li,{children:"\u6709\u4e9b\u4e0d\u652f\u6301 journal \u7684 DB \u5fc5\u987b\u8981 sync"}),"\n",(0,i.jsx)(s.li,{children:"slog \u5f88\u5feb \u53ef\u4ee5\u8003\u8651"}),"\n",(0,i.jsxs)(s.li,{children:["\u4f1a\u5f3a\u5236\u5148\u5199\u5165\u5230 log \u8bbe\u5907 - ",(0,i.jsx)(s.strong,{children:"\u4e0d\u4f1a\u589e\u52a0\u6027\u80fd"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["sync=disabled - sync=never, sync=off\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u8ba9\u5199\u5165\u66f4\u5feb"}),"\n",(0,i.jsx)(s.li,{children:"\u5ffd\u7565 O_SYNC"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:'# txg \u63d0\u4ea4\u95f4\u9694 - 5\u79d2\ncat /sys/module/zfs/parameters/zfs_txg_timeout\n# \u589e\u52a0 slog \u4f7f\u7528\u91cf, 180s \u63d0\u4ea4\u4e00\u6b21\necho 180 | sudo tee /sys/module/zfs/parameters/zfs_txg_timeout\n\n# \u6301\u4e45\u5316\necho "options zfs zfs_txg_timeout=180" | sudo tee /etc/modprobe.d/zfs.conf\n'})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"parameter"}),(0,i.jsx)(s.th,{children:"default"}),(0,i.jsx)(s.th,{children:"prefer"}),(0,i.jsx)(s.th,{children:"note"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_txg_timeout"}),(0,i.jsx)(s.td,{children:"5"}),(0,i.jsx)(s.td,{children:"120"}),(0,i.jsx)(s.td,{children:"\u5f3a\u5236\u63d0\u4ea4 Transaction Group (TXG) \u7684\u65f6\u95f4\u95f4\u9694,\u66f4\u5927\u7684\u503c\u53ef\u4ee5\u805a\u5408\u66f4\u591a\u6570\u636e"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"---"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_dirty_data_max"}),(0,i.jsx)(s.td,{children:"10% RAM"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_dirty_data_max_percent"}),(0,i.jsx)(s.td,{children:"10% RAM"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_dirty_data_sync_percent"}),(0,i.jsx)(s.td,{children:"20"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{children:"\u8fbe\u5230 zfs_dirty_data_max \u6bd4\u4f8b\u540e\u51fa\u53d1 sync"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_dirty_data_max_max"}),(0,i.jsx)(s.td,{children:"25% RAM"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"zfs_dirty_data_max_max_percent"}),(0,i.jsx)(s.td,{children:"25% RAM"}),(0,i.jsx)(s.td,{}),(0,i.jsx)(s.td,{})]})]})]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/",children:"https://jrs-s.net/2019/05/02/zfs-sync-async-zil-slog/"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/",children:"https://www.truenas.com/blog/zfs-zil-and-slog-demystified/"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"logbias",children:"logbias"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["logbias=latency\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u65e0 SLOG\uff0cblock \u8f83\u5927\u80fd\u63d0\u5347\u6027\u80fd"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["logbias=throughput\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u5c0f block \u5199\u5165\u4ea7\u751f\u975e\u5e38\u591a\u788e\u7247"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"zfs send dataset >/dev/null\n\nzpool iostat -r 1\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias",children:"https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"ashift",children:"ashift"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{style:{textAlign:"right"},children:"ashift"}),(0,i.jsx)(s.th,{style:{textAlign:"right"},children:"sector"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"9"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"512 B"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"10"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"1 KB"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"11"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"2 KB"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"12"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"4 KB"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"13"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"8 KB"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"14"}),(0,i.jsx)(s.td,{style:{textAlign:"right"},children:"16 KB"})]})]})]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"12=4KB - \u5e38\u7528\u7684 PageSize"}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"l2arc",children:"L2ARC"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u8bfb\u7f13\u5b58"}),"\n",(0,i.jsx)(s.li,{children:"ARC \u4e3a\u5185\u5b58"}),"\n",(0,i.jsx)(s.li,{children:"L2ARC \u4e3a cache \u8bbe\u5907"}),"\n",(0,i.jsx)(s.li,{children:"\u4e4b\u524d\u662f\u8986\u76d6\u5199"}),"\n",(0,i.jsxs)(s.li,{children:["\u76ee\u524d\u652f\u6301 TRIM - ",(0,i.jsx)(s.a,{href:"https://github.com/zfsonlinux/zfs/pull/9789",children:"https://github.com/zfsonlinux/zfs/pull/9789"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"l2arc_trim_ahead - \u9700\u8981\u65f6\u591a trim \u591a\u5c11"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# \u53ef\u67e5\u770b SSD trim \u652f\u6301\u60c5\u51b5\nzpool status -t\n# \u89e6\u53d1 pool\nzpool trim pool\n"})}),"\n",(0,i.jsx)(s.h2,{id:"\u78c1\u76d8\u4fe1\u606f",children:"\u78c1\u76d8\u4fe1\u606f"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# sector size\n# phy sector size\nblockdev --getss --getpbsz /dev/sda\n\ncat /sys/block/sd{a,b}/queue/{logical_block_size,physical_block_size,optimal_io_size}\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://github.com/bradfa/flashbench",children:"bradfa/flashbench"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u68c0\u6d4b\u95ea\u5b58\u7684 block size"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"atime-on-temporary",children:"atime on temporary"}),"\n",(0,i.jsx)(s.p,{children:"atime \u603b\u662f\u4e3a on"}),"\n",(0,i.jsx)(s.h2,{id:"zfs_vdev_mirror_rotating_inc",children:"zfs_vdev_mirror_rotating_inc"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["mirror ssd + hdd\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"\u4fdd\u7559\u8bfb\u6027\u80fd"}),"\n",(0,i.jsx)(s.li,{children:"\u5199\u6027\u80fd\u65e0\u6cd5\u4fdd\u969c"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"ssd-trim",children:"SSD TRIM"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"zpool set autotrim=on"})," + cron ",(0,i.jsx)(s.code,{children:"zpool trim"})]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7",children:"https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html",children:"https://openzfs.github.io/openzfs-docs/man/8/zpool-trim.8.html"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://www.youtube.com/watch?v=1Wo3i2gkAIk",children:"How the ZFS Adaptive Replacement Cache works"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.strong,{children:"Free RAM is wasted RAM"})}),"\n",(0,i.jsx)(s.li,{children:"ARC \u7ef4\u62a4 LRU,LFU"}),"\n",(0,i.jsx)(s.li,{children:"\u7f13\u5b58 fs \u548c metadata - metadata \u9ed8\u8ba4 25% cache"}),"\n",(0,i.jsx)(s.li,{children:"Compress ARC - \u5b58\u50a8\u66f4\u591a\u7f13\u5b58"}),"\n",(0,i.jsx)(s.li,{children:"block - 512b - 16MB"}),"\n",(0,i.jsx)(s.li,{children:"\u57fa\u4e8e\u5185\u5b58\u538b\u529b\u8c03\u6574\u4f7f\u7528\u7684\u7f13\u5b58\u91cf - adaptive"}),"\n",(0,i.jsxs)(s.li,{children:["tuning\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"file server - \u5927 ARC, \u7f13\u5b58\u66f4\u591a metadata, \u53ef\u8003\u8651 L2ARC"}),"\n",(0,i.jsx)(s.li,{children:"block storage/iSCSI - \u5927 ARC, \u914d\u7f6e volblocksize"}),"\n",(0,i.jsx)(s.li,{children:"Database/A - \u5c0f ARC, \u53ea\u7f13\u5b58 metadata, large db buffer cache"}),"\n",(0,i.jsx)(s.li,{children:"Database/B - \u4e2d ARC, \u53ea\u7f13\u5b58 metadata, small db buffer cache, compression \u80fd\u8ba9 ARC \u547d\u4e2d\u66f4\u591a\u7f13\u5b58"}),"\n",(0,i.jsx)(s.li,{children:"Hypervisor - \u4e2d\u5c0f ARC, \u4e3a VM \u9884\u7559\u5185\u5b58, \u907f\u514d\u53cc\u7f13\u5b58"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html",children:"Workload Tuning"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["PosstgreSQL - ",(0,i.jsx)(s.a,{href:"https://vadosware.io/post/everything-ive-seen-on-optimizing-postgres-on-zfs-on-linux/",children:"Everything I've seen on optimizing Postgres on ZFS"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"recordsize=8K"}),"\n",(0,i.jsx)(s.li,{children:"logbias=throughput"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["MySQL InnoDB\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"recordsize=16K"}),"\n",(0,i.jsx)(s.li,{children:"primarycache=metadata"}),"\n",(0,i.jsx)(s.li,{children:"logbias=throughput"}),"\n",(0,i.jsxs)(s.li,{children:["my.cnf\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"skip-innodb_doublewrite"}),"\n",(0,i.jsx)(s.li,{children:"innodb_use_native_aio=0"}),"\n",(0,i.jsx)(s.li,{children:"innodb_use_atomic_writes=0"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://www.delphix.com/blog/delphix-engineering/zfs-raidz-stripe-width-or-how-i-learned-stop-worrying-and-love-raidz",children:"ZFS RAIDZ stripe width, or: How I Learned to Stop Worrying and Love RAIDZ"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://www.unixarena.com/2013/07/zfs-how-to-extend-zpool-and-re-layout.html",children:"ZFS \u2013 How to Extend ZPOOL and Re-layout ?"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://docs.oracle.com/cd/E23824_01/html/821-1448/ftyue.html",children:"ZFS Terminology"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://docs.google.com/spreadsheets/d/1pdu_X2tR4ztF6_HLtJ-Dc4ZcwUdt6fkCjpnXxAEFlyA",children:"ZFS overhead calc.xlsx"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://blogs.oracle.com/roch/tuning-zfs-recordsize",children:"Tuning ZFS recordsize"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Module%20Parameters.html",children:"Module Parameters"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://calomel.org/freebsd_network_tuning.html",children:"https://calomel.org/freebsd_network_tuning.html"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning",children:"https://docs.freebsd.org/en/books/handbook/zfs/#zfs-advanced-tuning"})}),"\n"]})]})}function x(n={}){const{wrapper:s}={...(0,l.M)(),...n.components};return s?(0,i.jsx)(s,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},38088:(n,s,e)=>{var i=e(96651),l=Symbol.for("react.element"),r=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,d=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function h(n,s,e){var i,r={},h=null,o=null;for(i in void 0!==e&&(h=""+e),void 0!==s.key&&(h=""+s.key),void 0!==s.ref&&(o=s.ref),s)t.call(s,i)&&!c.hasOwnProperty(i)&&(r[i]=s[i]);if(n&&n.defaultProps)for(i in s=n.defaultProps)void 0===r[i]&&(r[i]=s[i]);return{$$typeof:l,type:n,key:h,ref:o,props:r,_owner:d.current}}s.Fragment=r,s.jsx=h,s.jsxs=h},2488:(n,s,e)=>{n.exports=e(38088)},62780:(n,s,e)=>{e.d(s,{I:()=>d,M:()=>t});var i=e(96651);const l={},r=i.createContext(l);function t(n){const s=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(s):{...s,...n}}),[s,n])}function d(n){let s;return s=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),i.createElement(r.Provider,{value:s},n.children)}}}]);