/*! For license information please see 6b7a8f0e.0e0db4c2.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[50048],{83732:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var n=s(2488),t=s(62780);const o={title:"K3S in Docker"},i="K3S in Docker",c={id:"devops/kubernetes/distro/k3s/k3d",title:"K3S in Docker",description:"- rancher/k3d - \u5bb9\u5668\u8fd0\u884c",source:"@site/../notes/devops/kubernetes/distro/k3s/k3d.md",sourceDirName:"devops/kubernetes/distro/k3s",slug:"/devops/kubernetes/distro/k3s/k3d",permalink:"/notes/devops/kubernetes/distro/k3s/k3d",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k3s/k3d.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1676862087,formattedLastUpdatedAt:"Feb 20, 2023",frontMatter:{title:"K3S in Docker"},sidebar:"docs",previous:{title:"K3S",permalink:"/notes/devops/kubernetes/distro/k3s/"},next:{title:"Centos",permalink:"/notes/devops/kubernetes/distro/k3s/centos"}},d={},l=[{value:"Registry",id:"registry",level:2},{value:"macOS",id:"macos",level:2},{value:"Failed Cluster Start: error during post-start cluster preparation: error overwriting contents of /etc/hosts: Exec process in node &#39;k3d-dev-server-0&#39; failed with exit code &#39;139&#39;: Logs from failed access process:",id:"failed-cluster-start-error-during-post-start-cluster-preparation-error-overwriting-contents-of-etchosts-exec-process-in-node-k3d-dev-server-0-failed-with-exit-code-139-logs-from-failed-access-process",level:2}];function a(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.M)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h1,{id:"k3s-in-docker",children:"K3S in Docker"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.a,{href:"https://github.com/rancher/k3d",children:"rancher/k3d"})," - \u5bb9\u5668\u8fd0\u884c\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["\u57fa\u4e8e\u4e4b\u524d\u7684 ",(0,n.jsx)(r.a,{href:"https://github.com/zeerorg/k3s-in-docker",children:"zeerorg/k3s-in-docker"})]}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"https://github.com/rancher/k3s/blob/master/docker-compose.yml",children:"rancher/k3s/docker-compose.yml"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'curl -Lo k3d https://ghproxy.com/github.com/k3d-io/k3d/releases/download/v5.4.7/k3d-linux-arm64\nchmod +x k3d\nmv k3d /usr/local/bin\n\n# k3d-default.yaml\nk3d config init\n\nk3d cluster create dev\n\nexport KUBECONFIG="$(k3d kubeconfig write k3s-default)"\n'})}),"\n",(0,n.jsx)(r.h2,{id:"registry",children:"Registry"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"write to /etc/rancher/k3s/registries.yaml"}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'# \u81ea\u5b9a\u4e49\nk3d cluster create mycluster --registry-config "$HOME/my-registries.yaml"\n\nk3d cluster create \\\n  --volume "${HOME}/.k3d/my-registries.yaml:/etc/rancher/k3s/registries.yaml" \\\n  --volume "${HOME}/.k3d/my-company-root.pem:/etc/ssl/certs/my-company-root.pem"\n\n# \u542f\u52a8 registry\nk3d cluster create mycluster --registry-create mycluster-registry\ndocker ps -f name=mycluster-registry\n\nk3d registry create myregistry.localhost --port 12345\nk3d cluster create newcluster --registry-use k3d-myregistry.localhost:12345\n'})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-yaml",children:"mirrors:\n  'my.company.registry:5000':\n    endpoint:\n      - http://my.company.registry:5000\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-yaml",children:'apiVersion: k3d.io/v1alpha3\nkind: Simple\nname: test\nservers: 1\nagents: 2\nregistries:\n  create:\n    name: myregistry\n  config: |\n    mirrors:\n      "my.company.registry":\n        endpoint:\n          - http://my.company.registry:5000\n'})}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"k3d managed"})}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["/var/lib/registry\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"\u9ed8\u8ba4\u6ca1\u6709\u6620\u5c04\u51fa\u6765"}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["/etc/docker/registry/config.yml\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"\u914d\u7f6e"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\ndocker exec dev-registry cat /etc/docker/registry/config.yml\n\n# host.k3d.internal\n# k3d-dev-server-0\n\ndocker exec k3d-dev-server-0 cat /etc/hosts\n# \u66f4\u65b0\u4e86 k3s \u955c\u50cf\u914d\u7f6e\ndocker exec k3d-dev-server-0 cat /etc/rancher/k3s/registries.yaml\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-yaml",children:"auths: null\nconfigs: null\nmirrors:\n  dev-registry:5000:\n    endpoint:\n      - http://dev-registry:5000\n  dev-registry:42095:\n    endpoint:\n      - http://dev-registry:5000\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# \u786e\u4fdd\u80fd\u89e3\u6790\ndocker exec k3d-dev-server-0 nslookup dev-registry\n\n# host \u901a\u8fc7 bridge \u8bbf\u95ee\ndocker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}'\ncurl $(docker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}'):5000 -I\n\n# \u80fd\u89e3\u6790\u6307\u5411\u540e\u53ef\u4ee5\u6d4b\u8bd5\necho \"$(docker inspect dev-registry -f '{{.NetworkSettings.Networks.bridge.IPAddress}}') dev-registry.localhost\" >> /etc/hosts\n\ndocker pull wener/base:latest\ndocker tag wener/base:latest dev-registry.localhost:5000/wener_base:latest\n# \u4e3b\u8981\u6ce8\u610f\u914d\u7f6e insecure-registries\ndocker push dev-registry.localhost:5000/wener_base:latest\n"})}),"\n",(0,n.jsx)(r.h2,{id:"macos",children:"macOS"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"brew install k3d\n"})}),"\n",(0,n.jsx)(r.h2,{id:"failed-cluster-start-error-during-post-start-cluster-preparation-error-overwriting-contents-of-etchosts-exec-process-in-node-k3d-dev-server-0-failed-with-exit-code-139-logs-from-failed-access-process",children:"Failed Cluster Start: error during post-start cluster preparation: error overwriting contents of /etc/hosts: Exec process in node 'k3d-dev-server-0' failed with exit code '139': Logs from failed access process:"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.a,{href:"https://github.com/k3d-io/k3d/issues/1220",children:"https://github.com/k3d-io/k3d/issues/1220"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"5.4.7 BUG, 5.4.6 \u6ca1\u95ee\u9898"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.p,{children:"\u8986\u76d6 hosts \u65f6\u5f02\u5e38"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"sh -c cat /tmp/-etc-hosts-cUAunADhzSQlEbdflLOb > /etc/hosts\n"})}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"\u5199\u5165\u5185\u5bb9"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hosts",children:"::1 ip6-localhost ip6-loopback localhost\n127.0.0.1 localhost\n172.18.0.1 host.k3d.internal\n172.18.0.2 k3d-dev-server-0\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n"})})]})}function h(e={}){const{wrapper:r}={...(0,t.M)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(a,{...e})}):a(e)}},38088:(e,r,s)=>{var n=s(96651),t=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,c=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function l(e,r,s){var n,o={},l=null,a=null;for(n in void 0!==s&&(l=""+s),void 0!==r.key&&(l=""+r.key),void 0!==r.ref&&(a=r.ref),r)i.call(r,n)&&!d.hasOwnProperty(n)&&(o[n]=r[n]);if(e&&e.defaultProps)for(n in r=e.defaultProps)void 0===o[n]&&(o[n]=r[n]);return{$$typeof:t,type:e,key:l,ref:a,props:o,_owner:c.current}}r.Fragment=o,r.jsx=l,r.jsxs=l},2488:(e,r,s)=>{e.exports=s(38088)},62780:(e,r,s)=>{s.d(r,{I:()=>c,M:()=>i});var n=s(96651);const t={},o=n.createContext(t);function i(e){const r=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);