/*! For license information please see 9221626b.7f4e888d.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[94382],{8933:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>i,metadata:()=>l,toc:()=>h});var r=s(11527),t=s(47214);const i={title:"Asterisk Network"},d="Asterisk Network",l={id:"voip/asterisk/asterisk-network",title:"Asterisk Network",description:"Asterisk 11+ \u652f\u6301 ICE",source:"@site/../notes/voip/asterisk/asterisk-network.md",sourceDirName:"voip/asterisk",slug:"/voip/asterisk/network",permalink:"/notes/voip/asterisk/network",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/voip/asterisk/asterisk-network.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1617462276,formattedLastUpdatedAt:"Apr 3, 2021",frontMatter:{title:"Asterisk Network"},sidebar:"docs",previous:{title:"Asterisk Modules",permalink:"/notes/voip/asterisk/moduels"},next:{title:"Asterisk QMI",permalink:"/notes/voip/asterisk/qmi"}},c={},h=[{value:"sip.conf",id:"sipconf",level:2},{value:"nat",id:"nat-1",level:3},{value:"tcpdump",id:"tcpdump",level:2},{value:"wireshark",id:"wireshark",level:2},{value:"nftables \u8f6c\u53d1",id:"nftables-\u8f6c\u53d1",level:2},{value:"IPTables \u8f6c\u53d1",id:"iptables-\u8f6c\u53d1",level:2}];function o(n){const e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.a)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"asterisk-network",children:"Asterisk Network"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"Asterisk 11+ \u652f\u6301 ICE"}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Asterisk \u662f B2BUA back-to-back user agent - \u4e0d\u662f SIP Proxy"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-sip-nat",children:"Asterisk sip nat"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-firewall-rules",children:"Asterisk Firewall Rules"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://wiki.asterisk.org/wiki/display/AST/PJSIP+with+Proxies",children:"PJSIP with Proxies"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.asteriskguru.com/tutorials/sip_nat_oneway_or_no_audio_asterisk.html",children:"SIP with NAT or Firewalls"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.asterisk.org/sip-and-rtp-routing/",children:"SIP and RTP Routing"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://blog.csdn.net/SUKHOI27SMK/article/details/40107553",children:"https://blog.csdn.net/SUKHOI27SMK/article/details/40107553"})}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"port"}),(0,r.jsx)(e.th,{children:"desc"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"5060/udp"}),(0,r.jsx)(e.td,{children:"sip"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"5060/tcp"}),(0,r.jsx)(e.td,{children:"sip"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"4569/udp"}),(0,r.jsx)(e.td,{children:"IAX2"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"5036/udp"}),(0,r.jsx)(e.td,{children:"IAX"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"10000-20000/udp"}),(0,r.jsx)(e.td,{children:"RTP"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"2727/udp"}),(0,r.jsx)(e.td,{children:"MGCP"})]})]})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"nmap 192.168.1.1 -P0 -p 5060 -sU\n"})}),"\n",(0,r.jsx)(e.h1,{id:"nat",children:"NAT"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.voip-info.org/asterisk-sip-nat-solutions/",children:"Asterisk SIP NAT solutions"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"case"}),(0,r.jsx)(e.th,{children:"asterisk role"}),(0,r.jsx)(e.th,{children:"other"}),(0,r.jsx)(e.th,{children:"nat"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#1"}),(0,r.jsx)(e.td,{children:"client nat"}),(0,r.jsx)(e.td,{children:"outside sip"}),(0,r.jsx)(e.td,{children:"yes"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#2"}),(0,r.jsx)(e.td,{children:"client nat"}),(0,r.jsx)(e.td,{children:"inside sip"}),(0,r.jsx)(e.td,{children:"no"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#3"}),(0,r.jsx)(e.td,{children:"server nat"}),(0,r.jsx)(e.td,{children:"outside client"}),(0,r.jsx)(e.td,{children:"yes"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#4"}),(0,r.jsx)(e.td,{children:"server nat"}),(0,r.jsx)(e.td,{children:"outside client nat"}),(0,r.jsx)(e.td,{children:"yes"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#5"}),(0,r.jsx)(e.td,{children:"server nat"}),(0,r.jsx)(e.td,{children:"inside client"}),(0,r.jsx)(e.td,{children:"no"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#6"}),(0,r.jsx)(e.td,{children:"client"}),(0,r.jsx)(e.td,{children:"outside sip"}),(0,r.jsx)(e.td,{children:"no"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#7"}),(0,r.jsx)(e.td,{children:"client"}),(0,r.jsx)(e.td,{children:"inside sip"}),(0,r.jsx)(e.td,{children:"yes - #3"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#8"}),(0,r.jsx)(e.td,{children:"server nat"}),(0,r.jsx)(e.td,{children:"outside client"}),(0,r.jsx)(e.td,{children:"no"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"#9"}),(0,r.jsx)(e.td,{children:"server nat"}),(0,r.jsx)(e.td,{children:"inside client"}),(0,r.jsx)(e.td,{children:"yes"})]})]})]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"SIP outside proxy"}),"\n",(0,r.jsx)(e.li,{children:"OK"}),"\n",(0,r.jsx)(e.li,{children:"1:1 \u7aef\u53e3\u8f6c\u53d1"}),"\n",(0,r.jsx)(e.li,{children:"\u7aef\u53e3\u8f6c\u53d1 + \u5ba2\u6237\u7aef STUN"}),"\n",(0,r.jsx)(e.li,{children:"OK"}),"\n",(0,r.jsx)(e.li,{children:"OK"}),"\n",(0,r.jsx)(e.li,{children:"\u540c #3"}),"\n",(0,r.jsx)(e.li,{children:"OK"}),"\n",(0,r.jsx)(e.li,{children:"nat=yes, qualify=xxx, \u5ba2\u6237\u7aef\u53ef\u4ee5 stun \u8f85\u52a9"}),"\n"]}),"\n",(0,r.jsx)(e.h1,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,r.jsx)(e.h2,{id:"sipconf",children:"sip.conf"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["asterisk ",(0,r.jsx)(e.a,{href:"https://github.com/asterisk/asterisk/blob/master/configs/samples/sip.conf.sample#L869",children:"nat support"})]}),"\n",(0,r.jsxs)(e.li,{children:["asterisk 1.8 ",(0,r.jsx)(e.a,{href:"https://github.com/asterisk/asterisk/blob/1.8/configs/sip.conf.sample#L761",children:"nat support"})]}),"\n",(0,r.jsx)(e.li,{children:"symmetric RTP"}),"\n",(0,r.jsx)(e.li,{children:"Asterisk will always send RTP packets from the same port number it expects to receive them on."}),"\n"]}),"\n",(0,r.jsx)(e.admonition,{type:"tip",children:(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5efa\u8bae\u53ea\u5728 general \u914d\u7f6e nat \u76f8\u5173\u9009\u9879\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e0d\u540c\u7684 nat \u914d\u7f6e\u53ef\u80fd\u76f8\u4e92\u5f71\u54cd"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"\u57fa\u7840\u670d\u52a1"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"[general]\nport = 5060\nbindaddr = 0.0.0.0\ncontext = error\nqualify = no\nsrvlookup = yes\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"[general]\n; \u533a\u5206 inside \u548c outside\n; \u5224\u65ad\u662f\u5426 NAT\nlocalnet=192.168.0.0/255.255.0.0\n; SIP \u548c SDP \u4f7f\u7528\u7684\u9759\u6001\u5730\u5740 - \u7aef\u53e3\u9ed8\u8ba4\u4e3a udpbindaddr\n; hostname \u542f\u52a8\u65f6\u67e5\u8be2\u4e00\u6b21\n; externip\nexternaddr = 12.34.56.78:9900\n; externtcpport = 9900\n; externtlsport = 12600\n\n; \u540c externaddr - \u6bcf\u9694 externrefresh(\u9ed8\u8ba4 10s) \u67e5\u8be2\u4e00\u6b21 hostname\nexternhost = hostname[:port]\nexternrefresh = 10\n\n; no - use rport if remote request\n; force_rport - \u5f3a\u5236 rport - \u9ed8\u8ba4\n; yes - force_rport + comedia RTP\n; comedia - no + comedia RTP\n; comedia - connection-oriented media\nnat = force_rport\n\n; \u4fee\u6539 audio, video, text \u7b49 SDP \u5730\u5740\nmedia_address =\n"})}),"\n",(0,r.jsx)(e.h3,{id:"nat-1",children:"nat"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["nat=yes\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Asterisk \u5ffd\u7565 SIP, SDP \u5934\u4e2d\u7684\u5730\u5740\u4fe1\u606f, \u76f4\u63a5\u8fd4\u56de\u7ed9\u53d1\u9001\u8005\u7684 IP \u5730\u5740\u548c\u7aef\u53e3"}),"\n",(0,r.jsxs)(e.li,{children:["\u5f3a\u5236 RFC 3581\uff0c \u5f00\u542f ",(0,r.jsx)(e.a,{href:"https://www.voip-info.org/rtp-symmetric",children:"\u5bf9\u79f0 RTP"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["net=never - 2004 \u5e74 7 \u6708 29 \u6dfb\u52a0\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7528\u4e8e UA/\u5ba2\u6237\u7aef \u4e0d\u652f\u6301 rport \u5e38\u89c1"}),"\n",(0,r.jsx)(e.li,{children:"\u4e4b\u540e\u6dfb\u52a0 route \u9009\u9879 - \u6dfb\u52a0\u53c2\u6570\u63a7\u5236\u662f\u5426\u652f\u6301"}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"nat"}),(0,r.jsx)(e.th,{children:"rfc3581"}),(0,r.jsx)(e.th,{children:"Symmetric RTP"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"yes"}),(0,r.jsx)(e.td,{children:"force"}),(0,r.jsx)(e.td,{children:"enable"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"no"}),(0,r.jsx)(e.td,{children:"enable"}),(0,r.jsx)(e.td,{children:"disable"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"force_rport"}),(0,r.jsx)(e.td,{children:"force"}),(0,r.jsx)(e.td,{children:"disable"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"comedia"}),(0,r.jsx)(e.td,{children:"enable"}),(0,r.jsx)(e.td,{children:"enable"})]})]})]}),"\n",(0,r.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,r.jsx)(e.h2,{id:"tcpdump",children:"tcpdump"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# UDP\ntcpdump -n dst portrange 10000-11000\n\ntcpdump -i bond3 udp port 5060 or udp portrange 10000-20000\n"})}),"\n",(0,r.jsx)(e.h2,{id:"wireshark",children:"wireshark"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"ssh 192.168.1.2 sudo tcpdump -U -s0 'port 5060 or udp portrange 10000-20000' -i eth0 -w - | wireshark -k -i -\n"})}),"\n",(0,r.jsx)(e.h2,{id:"nftables-\u8f6c\u53d1",children:"nftables \u8f6c\u53d1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'# SIP\niifname "wan0" udp dport 5060 counter dnat to 192.168.1.2\niifname "wan0" tcp dport 5060 counter dnat to 192.168.1.2\n# RTP\niifname "wan0" udp dport 10000-20000 counter dnat to 192.168.1.2\n# IAX\niifname "wan0" udp dport 4569 counter dnat to 192.168.1.2\niifname "wan0" udp dport 5036 counter dnat to 192.168.1.2\n# MGCP\niifname "wan0" udp dport 2727 counter dnat to 192.168.1.2\n'})}),"\n",(0,r.jsx)(e.h2,{id:"iptables-\u8f6c\u53d1",children:"IPTables \u8f6c\u53d1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# SIP\niptables -A INPUT -p udp -m udp --dport 5060 -j ACCEPT\niptables -A INPUT -p tcp -m tcp --dport 5060 -j ACCEPT\n\n# IAX2- the IAX protocol\niptables -A INPUT -p udp -m udp --dport 4569 -j ACCEPT\n# IAX\niptables -A INPUT -p udp -m udp --dport 5036 -j ACCEPT\n# RTP\niptables -A INPUT -p udp -m udp --dport 10000:20000 -j ACCEPT\n# MGCP\niptables -A INPUT -p udp -m udp --dport 2727 -j ACCEPT\n"})})]})}function a(n={}){const{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(o,{...n})}):o(n)}},3354:(n,e,s)=>{var r=s(50959),t=Symbol.for("react.element"),i=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,l=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function h(n,e,s){var r,i={},h=null,o=null;for(r in void 0!==s&&(h=""+s),void 0!==e.key&&(h=""+e.key),void 0!==e.ref&&(o=e.ref),e)d.call(e,r)&&!c.hasOwnProperty(r)&&(i[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps)void 0===i[r]&&(i[r]=e[r]);return{$$typeof:t,type:n,key:h,ref:o,props:i,_owner:l.current}}e.Fragment=i,e.jsx=h,e.jsxs=h},11527:(n,e,s)=>{n.exports=s(3354)},47214:(n,e,s)=>{s.d(e,{Z:()=>l,a:()=>d});var r=s(50959);const t={},i=r.createContext(t);function d(n){const e=r.useContext(i);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:d(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);