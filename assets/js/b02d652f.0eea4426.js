/*! For license information please see b02d652f.0eea4426.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[11712],{40428:(o,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>s,metadata:()=>l,toc:()=>a});var r=n(2488),e=n(62780);const s={title:"rootfs"},i="rootfs",l={id:"os/linux/fs/rootfs",title:"rootfs",description:"- chroot \u6216 switch_root \u4f1a\u9690\u85cf rootfs",source:"@site/../notes/os/linux/fs/rootfs.md",sourceDirName:"os/linux/fs",slug:"/os/linux/fs/rootfs",permalink:"/notes/os/linux/fs/rootfs",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/os/linux/fs/rootfs.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1666003394,formattedLastUpdatedAt:"Oct 17, 2022",frontMatter:{title:"rootfs"},sidebar:"docs",previous:{title:"RAID",permalink:"/notes/os/linux/fs/raid"},next:{title:"sfdisk",permalink:"/notes/os/linux/fs/sfdisk"}},c={},a=[{value:"switch_root",id:"switch_root",level:2},{value:"pivot_root",id:"pivot_root",level:2}];function d(o){const t={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,e.M)(),...o.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"rootfs",children:"rootfs"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"chroot \u6216 switch_root \u4f1a\u9690\u85cf rootfs"}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt",children:"ramfs-rootfs-initramfs"})}),"\n",(0,r.jsxs)(t.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man8/switch_root.8.html",children:"switch_root.8"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man8/pivot_root.8.html",children:"pivot_root.8"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://unix.stackexchange.com/a/455136/47774",children:"Why is there no rootfs file system present on my system?"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-fstab",children:"rootfs / rootfs rw 0 0\n"})}),"\n",(0,r.jsx)(t.h2,{id:"switch_root",children:"switch_root"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["\u5207\u6362\u5230 newroot \u5e76\u8c03\u7528 init \u7a0b\u5e8f\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u7528\u5728 initramfs \u4e2d\uff0c\u5207\u6362\u5230\u771f\u6b63\u7684 rootfs"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.li,{children:"\u5fc5\u987b\u7531 PID=1 \u8c03\u7528"}),"\n",(0,r.jsx)(t.li,{children:"\u4f1a\u79fb\u52a8\u5df2\u7ecf\u6302\u8f7d\u7684 /proc, /dev, /sys, /run \u5230\u65b0 root"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"# -c /dev/console\nswitch_root newroot init # init args...\n"})}),"\n",(0,r.jsx)(t.h2,{id:"pivot_root",children:"pivot_root"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"\u4fee\u6539\u5f53\u524d\u8fdb\u7a0b\u7684 root"}),"\n",(0,r.jsx)(t.li,{children:"\u8981\u6ce8\u610f\u63d0\u524d\u51c6\u5907\u597d\u73af\u5883"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"pivot_root new_root put_old\n\n# \u5207\u6362 root\nmount /dev/hda1 /new-root\ncd /new-root\npivot_root . old-root\nexec chroot . sh < dev/console > dev/console 2>&1\numount /old-root\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"umount rootfs"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"fuser -vm /\n# killall\numount -a\n\nmkdir /tmp/tmproot\nmount -t tmpfs none /tmp/tmproot\nmkdir /tmp/tmproot/{proc,sys,dev,run,usr,var,tmp,oldroot}\n\ncp -ax /{bin,etc,mnt,sbin,lib,lib64} /tmp/tmproot/\ncp -ax /usr/{bin,sbin,lib,lib64} /tmp/tmproot/usr/\ncp -ax /var/{account,empty,lib,local,lock,nis,opt,preserve,run,spool,tmp,yp} /tmp/tmproot/var/\n\nmount --make-rprivate / # necessary for pivot_root to work\npivot_root /tmp/tmproot /tmp/tmproot/oldroot\nfor i in dev proc sys run; do mount --move /oldroot/$i /$i; done\n\nfuser -vm /oldroot\n\numount /oldroot\n# \u64cd\u4f5c\u539f\u6765 rootfs block device\n\n# \u64cd\u4f5c\u5b8c\u6210\u540e\u91cd\u65b0 mount\nmount /dev/vda2 /oldroot\nmount --make-rprivate /\npivot_root /oldroot /oldroot/tmp/tmproot\nfor i in dev proc sys run; do mount --move /tmp/tmproot/$i /$i; done\n\n# \u79fb\u9664\u4e34\u65f6 rootfs\numount /tmp/tmproot\nrmdir /tmp/tmproot\n\nmount -a\n\n# \u542f\u52a8\u670d\u52a1\n\nmount --make-rshared /\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://unix.stackexchange.com/a/227318/47774",children:"https://unix.stackexchange.com/a/227318/47774"})}),"\n"]})]})}function m(o={}){const{wrapper:t}={...(0,e.M)(),...o.components};return t?(0,r.jsx)(t,{...o,children:(0,r.jsx)(d,{...o})}):d(o)}},38088:(o,t,n)=>{var r=n(96651),e=Symbol.for("react.element"),s=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,l=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function a(o,t,n){var r,s={},a=null,d=null;for(r in void 0!==n&&(a=""+n),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(d=t.ref),t)i.call(t,r)&&!c.hasOwnProperty(r)&&(s[r]=t[r]);if(o&&o.defaultProps)for(r in t=o.defaultProps)void 0===s[r]&&(s[r]=t[r]);return{$$typeof:e,type:o,key:a,ref:d,props:s,_owner:l.current}}t.Fragment=s,t.jsx=a,t.jsxs=a},2488:(o,t,n)=>{o.exports=n(38088)},62780:(o,t,n)=>{n.d(t,{I:()=>l,M:()=>i});var r=n(96651);const e={},s=r.createContext(e);function i(o){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof o?o(t):{...t,...o}}),[t,o])}function l(o){let t;return t=o.disableParentContext?"function"==typeof o.components?o.components(e):o.components||e:i(o.components),r.createElement(s.Provider,{value:t},o.children)}}}]);