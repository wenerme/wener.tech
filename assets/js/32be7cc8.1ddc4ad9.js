/*! For license information please see 32be7cc8.1ddc4ad9.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[89840],{45588:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>d,contentTitle:()=>t,default:()=>a,frontMatter:()=>i,metadata:()=>c,toc:()=>h});var r=s(2488),l=s(62780);const i={title:"HAProxy \u914d\u7f6e",tags:["Configuration"]},t="HAProxy \u914d\u7f6e",c={id:"devops/web/haproxy/haproxy-conf",title:"HAProxy \u914d\u7f6e",description:"- http-tunnel",source:"@site/../notes/devops/web/haproxy/haproxy-conf.md",sourceDirName:"devops/web/haproxy",slug:"/devops/web/haproxy/conf",permalink:"/notes/devops/web/haproxy/conf",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-conf.md",tags:[{label:"Configuration",permalink:"/notes/tags/configuration"}],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1702440128,formattedLastUpdatedAt:"Dec 13, 2023",frontMatter:{title:"HAProxy \u914d\u7f6e",tags:["Configuration"]},sidebar:"docs",previous:{title:"HAProxy",permalink:"/notes/devops/web/haproxy/"},next:{title:"HAProxy Data Plane",permalink:"/notes/devops/web/haproxy/dataplane"}},d={},h=[{value:"Timeout",id:"timeout",level:2},{value:"env",id:"env",level:2},{value:"\u63a7\u5236\u6d41",id:"control-flow",level:2},{value:"acl",id:"acl",level:2},{value:"balance",id:"balance",level:2},{value:"HAProxy \u900f\u660e\u4ee3\u7406+Traefik",id:"haproxy-\u900f\u660e\u4ee3\u7406traefik",level:2},{value:"\u4fdd\u7559\u72b6\u6001",id:"\u4fdd\u7559\u72b6\u6001",level:2},{value:"\u4ea4\u4e92\u547d\u4ee4",id:"\u4ea4\u4e92\u547d\u4ee4",level:2},{value:"SNI Proxy",id:"sni-proxy",level:2},{value:"Logging",id:"logging",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2},{value:"\u5b9e\u9a8c",id:"\u5b9e\u9a8c",level:2},{value:"redispatch",id:"redispatch",level:2},{value:"Health Check",id:"health-check",level:2}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.M)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"haproxy-\u914d\u7f6e",children:"HAProxy \u914d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"haproxy -c -V -f /etc/haproxy/haproxy.cfg # \u68c0\u6d4b\u914d\u7f6e\n\nulimit -n 8036\nhaproxy -f /etc/haproxy/haproxy.cfg -d # Debug \u542f\u52a8\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["http-tunnel\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5904\u7406 HTTP CONNECT"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv",children:"https://cbonte.github.io/haproxy-dconv"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage",children:"https://www.haproxy.com/documentation/hapee/latest/onepage"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["maxconn\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"frontend \u63a5\u53d7\u7684\u6700\u5927\u8fde\u63a5\u6570"}),"\n",(0,r.jsx)(e.li,{children:"4096 fd \u9ed8\u8ba4 maxconn ~ 1700"}),"\n",(0,r.jsx)(e.li,{children:"10000 \u8fde\u63a5 ~450MB - ~580MB"}),"\n",(0,r.jsx)(e.li,{children:"fd ~= maxconn*2 + 1000"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"/proc/sys/fs/file-max"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"timeout",children:"Timeout"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"HTTP or TCP"}),"\n",(0,r.jsx)(e.li,{children:"One Shot or Stream"}),"\n",(0,r.jsx)(e.li,{children:"Latency or Bandwidth"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"# HTTP \u573a\u666f\ntimeout connect 5s    # \u5ba2\u6237\u7aef connect \u4e0a\u7684\u65f6\u95f4\ntimeout client 50s    # \u5ba2\u6237\u7aef idle \u65f6\u957f\uff0c\u4e00\u822c 5m\ntimeout server 50s    # \u670d\u52a1\u7aef\u54cd\u5e94\u65f6\u957f - 504\n\nretries                 3\ntimeout http-request    10s\ntimeout queue           1m\ntimeout connect         10s\ntimeout client          10m\ntimeout server          10m\ntimeout http-keep-alive 10s\ntimeout check           10s\nmaxconn                 30000\n\ntimeout http-request    10s # \u6574\u4e2a\u8bf7\u6c42\u65f6\u957f\ntimeout http-keep-alive 2s\ntimeout queue           5s  # concurrent connections\uff0c\u9ed8\u8ba4 timeout connect\ntimeout tunnel          2m  # WebSockets\uff0c\u7c7b\u4f3c keep-alive\ntimeout client-fin      1s  # dropped client side connections \u53ef\u80fd\u4f1a\u6062\u590d\u7684\u65f6\u95f4\ntimeout server-fin      1s\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.papertrail.com/solution/tips/haproxy-logging-how-to-tune-timeouts-for-performance/",children:"https://www.papertrail.com/solution/tips/haproxy-logging-how-to-tune-timeouts-for-performance/"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"env",children:"env"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"${ENV_NAME-\u9ed8\u8ba4\u503c}"})}),"\n",(0,r.jsxs)(e.li,{children:["HAPROXY_LOCALPEER\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"-L"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_CFGFILES"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_HTTP_LOG_FMT"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_HTTPS_LOG_FMT"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_TCP_LOG_FMT"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_MWORKER"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_MASTER_CLI"}),"\n",(0,r.jsx)(e.li,{children:"HAPROXY_STARTUP_VERSION"}),"\n",(0,r.jsxs)(e.li,{children:["\u4f2a\u53d8\u91cf\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:".FILE"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:".LINE"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:".SECTION"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"control-flow",children:"\u63a7\u5236\u6d41"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:".if"}),",",(0,r.jsx)(e.code,{children:".elif"}),",",(0,r.jsx)(e.code,{children:".else"}),",",(0,r.jsx)(e.code,{children:".endif"})]}),"\n",(0,r.jsxs)(e.li,{children:["\u65ad\u8a00\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"defined(<name>)"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"feature(<name>)"})," - ",(0,r.jsx)(e.code,{children:"haproxy -vv"})]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"streq(<str1>,<str2>)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"strneq(<str1>,<str2>)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"version_atleast(<ver>)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"version_before(<ver>)"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:'.diag "message"'}),"\n",(0,r.jsx)(e.li,{children:".notice"}),"\n",(0,r.jsx)(e.li,{children:".warning"}),"\n",(0,r.jsx)(e.li,{children:".alert"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"acl",children:"acl"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["named acl\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"acl is_static path -i -m beg /static/"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["in-line acl\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"use_backend be_static if { path -i -m beg /static/ }"})}),"\n",(0,r.jsx)(e.li,{children:"if, unless"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u591a\u4e2a\u6761\u4ef6\u9ed8\u8ba4\u4e3a and \u5173\u7cfb\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"http-request deny if { path -i -m beg /api/ } { src 10.0.0.0/16 }"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u652f\u6301\u903b\u8f91: || or && and !\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"http-request deny if { path -i -m beg /api/ } || !{ src 10.0.0.0/16 }"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["fetch - \u6307\u5339\u914d\u7684\u6765\u6e90\u4fe1\u606f\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f8b\u5982: src, path, hdr \u7b49"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["converter - \u8f6c\u6362\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f8b\u5982: lower, upper, base64, field, bytes, map"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"flag - fetch \u64cd\u4f5c\u652f\u6301\u901a\u8fc7 flag \u4fee\u6539\u884c\u4e3a"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"flag"}),(0,r.jsx)(e.th,{children:"for"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-i"}),(0,r.jsx)(e.td,{children:"\u5ffd\u7565\u5927\u5c0f\u5199\uff0c\u5339\u914d\u540e\u7eed\u6240\u6709"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-f"}),(0,r.jsx)(e.td,{children:"\u5339\u914d\u6587\u4ef6\u5185 patterns"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-m"}),(0,r.jsx)(e.td,{children:"\u6307\u5b9a\u5339\u914d\u65b9\u5f0f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-n"}),(0,r.jsx)(e.td,{children:"\u7981\u6b62 DNS \u89e3\u6790"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-M"}),(0,r.jsx)(e.td,{children:"load the file pointed by -f like a map file."})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"-u"}),(0,r.jsx)(e.td,{children:"force the unique id of the ACL"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"--"}),(0,r.jsx)(e.td,{children:"force end of flags. Useful when a string looks like one of the flags."})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u5339\u914d\u65b9\u6cd5 - -m\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u90e8\u5206 fetch \u6709\u53d8\u79cd ",(0,r.jsx)(e.code,{children:"path_beg"})," -> ",(0,r.jsx)(e.code,{children:"path -m beg"})]}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"-m"}),(0,r.jsx)(e.th,{children:"for"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"str"}),(0,r.jsx)(e.td,{children:"\u5b8c\u6574\u5339\u914d"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"sub"}),(0,r.jsx)(e.td,{children:"\u5305\u542b"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"end"}),(0,r.jsx)(e.td,{children:"\u5f00\u5934"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"beg"}),(0,r.jsx)(e.td,{children:"\u7ed3\u5c3e"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"dir"}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.code,{children:"/"})," \u5206\u9694\uff0c\u8def\u5f84\u5339\u914d"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"dom"}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.code,{children:"."})," \u5206\u9694\uff0c\u57df\u540d\u5339\u914d"]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"reg"}),(0,r.jsxs)(e.td,{children:["\u6b63\u5219\u5339\u914d - ",(0,r.jsx)(e.strong,{children:"\u6ce8\u610f\u6027\u80fd\u95ee\u9898"})]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"found"}),(0,r.jsx)(e.td,{children:"\u5b58\u5728"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"len"}),(0,r.jsx)(e.td,{children:"\u957f\u5ea6\u5339\u914d"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"bin"}),(0,r.jsx)(e.td,{children:"\u4e8c\u8fdb\u5236\u6570\u636e\u5339\u914d - Hex"})]})]})]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"hdr_end(host) .wener.me"})," \u4e0d\u4f1a\u5339\u914d ",(0,r.jsx)(e.code,{children:"wener.me"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"hdr_end(host) wener.me"})," \u4f1a\u5339\u914d ",(0,r.jsx)(e.code,{children:"xyzwener.me"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"hdr_dom(host) wener.me"})," \u4f1a\u5339\u914d ",(0,r.jsx)(e.code,{children:"wener.me"})," \u548c ",(0,r.jsx)(e.code,{children:"*.wener.me"}),", \u4e0d\u4f1a\u5339\u914d ",(0,r.jsx)(e.code,{children:"xyzwener.me"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5927\u591a\u65f6\u5019\u671f\u671b\u7ed3\u679c"}),"\n"]}),"\n"]}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"method"}),(0,r.jsx)(e.th,{children:"alias"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"base_beg"}),(0,r.jsx)(e.td,{children:"base -m beg"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"hdr_end"}),(0,r.jsx)(e.td,{children:"hdr -m end"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"path_beg"}),(0,r.jsx)(e.td,{children:"path -m beg"})]})]})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"redirect scheme code 301 https if !{ ssl_fc }\n\n# \u52a8\u6001\u540d\u5b57\nuse_backend be_%[path,map_beg(/etc/haproxy/paths.map, mydefault)]\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"%[var()]"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"http://wtarreau.blogspot.com/2011/12/elastic-binary-trees-ebtree.html",children:"ebtree"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"balance",children:"balance"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#4.2-balance",children:"balance"})}),"\n",(0,r.jsx)(e.li,{children:"hash - 2.6+"}),"\n",(0,r.jsxs)(e.li,{children:["roundrobin\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6839\u636e weight \u8f6e\u8bad - weight \u53ef\u52a8\u6001\u8c03\u6574"}),"\n",(0,r.jsx)(e.li,{children:"\u6700\u591a 4095 server"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["static-rr\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u540c roundrobin \u4f46\u4e0d\u652f\u6301\u8c03\u6574 weight\uff0c\u4e0d\u9650\u5236 server \u6570\u91cf"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["leastconn\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9009\u62e9\u6700\u5c11\u8fde\u63a5\u6570\u7684 server"}),"\n",(0,r.jsx)(e.li,{children:"\u5728 server \u4e2d\u4f7f\u7528 rr \u5c31\u884c\u9009\u62e9 - \u652f\u6301\u52a8\u6001 weight"}),"\n",(0,r.jsx)(e.li,{children:"\u9002\u7528\u4e8e\u957f\u94fe\u63a5 \uff08\u4f8b\u5982\uff1aLDAP, SQL, TSE\uff09 \u4e0d\u9002\u7528\u4e8e\u77ed\u94fe\u63a5 \uff08\u4f8b\u5982\uff1a HTTP\uff09"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["first\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7 server id \u987a\u5e8f\u9009\u62e9\u7b2c\u4e00\u4e2a slot - id \u9ed8\u8ba4\u4e3a server \u987a\u5e8f"}),"\n",(0,r.jsx)(e.li,{children:"\u5f53 server \u8fbe\u5230 maxconn \u65f6\u9009\u62e9\u4e0b\u4e00\u4e2a - \u4f7f\u7528\u8be5\u7b97\u6cd5\u8981\u8bbe\u7f6e\u4e86 maxconn \u624d\u6709\u610f\u4e49"}),"\n",(0,r.jsx)(e.li,{children:"\u8be5\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u540e\u9762\u7684 server \u6309\u9700\u542f\u52a8 - \u914d\u5408\u57fa\u7840\u8bbe\u65bd\u52a8\u6001\u63a7\u5236\u670d\u52a1\u5668\u8d77\u505c"}),"\n",(0,r.jsx)(e.li,{children:"\u5ffd\u7565 weight\uff0c\u66f4\u9002\u7528\u4e8e\u957f\u94fe\u63a5"}),"\n",(0,r.jsxs)(e.li,{children:["\u53ef\u4f7f\u7528 ",(0,r.jsx)(e.code,{children:"http-check send-state"})," \u544a\u77e5\u670d\u52a1\u5668\u8d1f\u8f7d"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["source\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u901a\u8fc7 IP hash \u53d6\u6a21\u9009\u62e9 server"}),"\n",(0,r.jsx)(e.li,{children:"\u4fee\u6539 server \u6570\u91cf\u4f1a\u5f71\u54cd\u9009\u53d6\u7ed3\u679c - server up\u3001down \u4e5f\u4f1a\u5f71\u54cd"}),"\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["uri\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"URL hash \u53d6\u6a21\u9009\u62e9 server"}),"\n",(0,r.jsxs)(e.li,{children:["URL \u4f7f\u7528\u8def\u5f84 ",(0,r.jsx)(e.code,{children:"?"})," \u524d\u9762\u90e8\u5206\uff0c\u53ef\u6307\u5b9a\u4e3a ",(0,r.jsx)(e.code,{children:"whole"})," \u4f7f\u7528\u6240\u6709"]}),"\n",(0,r.jsx)(e.li,{children:"\u53ef\u589e\u52a0\u7f13\u5b58\u547d\u4e2d\uff0c\u53ea\u9002\u7528\u4e8e HTTP \u540e\u7aef"}),"\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u6570\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"len - \u622a\u53d6\u957f\u5ea6"}),"\n",(0,r.jsx)(e.li,{children:"depth - \u76ee\u5f55\u6df1\u5ea6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["url_param\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4f7f\u7528 HTTP GET \u8bf7\u6c42\u4e0a\u7684 URL \u53c2\u6570"}),"\n",(0,r.jsx)(e.li,{children:"\u672a\u627e\u5230\u53c2\u6570\u5219\u4f7f\u7528 rr"}),"\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u6570\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"check_post - \u9488\u5bf9 POST \u4e5f\u68c0\u6d4b"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"hdr(<name>)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u4f7f\u7528 HTTP \u5934 ",(0,r.jsx)(e.code,{children:"<name>"})," - \u5927\u5c0f\u5199\u4e0d\u654f\u611f\uff0c\u4e0d\u5b58\u5728\u5219\u4f7f\u7528 rr"]}),"\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u6570\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["use_domain_only - HASH \u57df\u540d\uff0c\u4e5f\u5c31\u662f ",(0,r.jsx)(e.code,{children:"Host"})," \u5934"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"random"}),", ",(0,r.jsx)(e.code,{children:"random(<draws>)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u968f\u673a\u6570\uff0c\u4e00\u81f4\u6027 hash - weight \u52a8\u6001"}),"\n",(0,r.jsx)(e.li,{children:"\u9002\u7528\u4e8e server \u6570\u91cf\u591a\u4e14\u9891\u7e41\u52a0\u51cf\u573a\u666f - \u6bd4 roundrobin \u548c leastconn \u5f71\u54cd\u66f4\u5c0f"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"<draws>"})," - number of draws before selecting the least loaded of these servers\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4 2"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u6570\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["hash-balance-factor\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u53ef\u589e\u5f3a\u516c\u5e73\u6027"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"http://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf",children:"Power of Two Random Choices"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["rdp-cookie, ",(0,r.jsx)(e.code,{children:"rdp-cookie(<name>)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["name \u9ed8\u8ba4 ",(0,r.jsx)(e.code,{children:"mstshash"})]}),"\n",(0,r.jsxs)(e.li,{children:["\u9700\u8981 ",(0,r.jsx)(e.code,{children:"tcp-request content accept"})," + ",(0,r.jsx)(e.code,{children:"req_rdp_cookie_cnt"})]}),"\n",(0,r.jsx)(e.li,{children:"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"haproxy-\u900f\u660e\u4ee3\u7406traefik",children:"HAProxy \u900f\u660e\u4ee3\u7406+Traefik"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/blog/haproxy/proxy-protocol",children:"haproxy/proxy-protocol"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.org/download/2.2/doc/proxy-protocol.txt",children:"proxy-protocol.txt"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://docs.traefik.io/routing/entrypoints/#proxyprotocol",children:"traefik proxy protocol"})}),"\n",(0,r.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://stackoverflow.com/a/57503161/1870054",children:"HAProxy tcp mode source client ip"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://yq.aliyun.com/articles/492367",children:"Haproxy \u5168\u900f\u660e\u4ee3\u7406"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"global\n  log /dev/log    local0\n  log /dev/log    local1 notice\n  chroot /var/lib/haproxy\n  # \u5e38\u89c1\u4f4d\u7f6e\n  # /run/haproxy/admin.sock\n  # /var/run/haproxy.sock\n  stats socket /var/lib/haproxy/stats mode 660 level admin\n  # stats socket ipv4@192.168.0.1:9999 level admin\n  stats timeout 30s\n  user haproxy\n  group haproxy\n  daemon\n\ndefaults\n  log global\n  retries 2\n  option  dontlognull\n  timeout connect 10000\n  timeout server 600000\n  timeout client 600000\n\nfrontend https\n  bind 0.0.0.0:443\n  default_backend https\n\nbackend https\n  mode tcp\n  balance roundrobin\n  option tcp-check\n  # traefik \u540e\u7aef\u4e5f\u652f\u6301 proxy \u534f\u8bae\n  server traefik 192.168.128.5:9443 check fall 3 rise 2 send-proxy\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"iptables -F\niptables -t mangle -N DIVERT\niptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT\niptables -t mangle -A DIVERT -j MARK --set-mark 222\niptables -t mangle -A DIVERT -j ACCEPT\nip rule add fwmark 222 lookup 100\nip route add local 0.0.0.0/0 dev lo table 100\n\n# \u5141\u8bb8ip\u8f6c\u53d1\necho 1 > /proc/sys/net/ipv4/conf/all/forwarding\n\n# \u8bbe\u7f6e\u677e\u6563\u9006\u5411\u8def\u5f84\u8fc7\u6ee4\necho 2 > /proc/sys/net/ipv4/conf/default/rp_filter\necho 2 > /proc/sys/net/ipv4/conf/all/rp_filter\necho 0 > /proc/sys/net/ipv4/conf/enp0s8/rp_filter\n\n# \u5141\u8bb8ICMP\u91cd\u5b9a\u5411\necho 1 > /proc/sys/net/ipv4/conf/all/send_redirects\necho 1 > /proc/sys/net/ipv4/conf/enp0s8/send_redirects\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u4fdd\u7559\u72b6\u6001",children:"\u4fdd\u7559\u72b6\u6001"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u4e0d\u4f1a\u4fdd\u7559\u7edf\u8ba1\u4fe1\u606f"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"global\n  # \u72b6\u6001\u6587\u4ef6\n  server-state-file /var/lib/haproxy/server-state\n  stats socket /var/lib/haproxy/stats\n\ndefaults\n  # \u52a0\u8f7d\u7edf\u8ba1\n  load-server-state-from-file global\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u4fdd\u7559\u72b6\u6001\necho "show servers state" | socat /var/lib/haproxy/stats stdio > /var/lib/haproxy/server-state\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u4ea4\u4e92\u547d\u4ee4",children:"\u4ea4\u4e92\u547d\u4ee4"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/2.2/management.html#9.3",children:"Unix Socket commands"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u811a\u672c\u4e00\u6b21\u6267\u884c\n# socat \u53ef\u80fd\u9700\u8981 sudo\necho "show info;show stat;show table" | socat /var/lib/haproxy/stats stdio\n# \u4ea4\u4e92\u5f0f\nsocat /var/lib/haproxy/stats readline\n# prompt\n'})}),"\n",(0,r.jsx)(e.h2,{id:"sni-proxy",children:"SNI Proxy"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/",children:"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.liip.ch/en/blog/haproxy-selective-tls-termination",children:"HAProxy selective TLS termination"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"backend bk_ssl\n  mode tcp\n  no option checkcache\n  no option httpclose\n  tcp-request inspect-delay 5s\n  tcp-request content accept if { req.ssl_hello_type 1 }\n  tcp-request content reject\n  use-server server1 if { req.ssl_sni -m beg app1. }\n  server server1 server1:8443 check id 1 weight 0\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"backend https\n  option tcplog\n  bind 0.0.0.0:443\n  tcp-request inspect-delay 5s\n  tcp-request content accept if { req_ssl_hello_type 1 }\n\n  use_backend s1 if { req.ssl_sni -i site1.example.com or site1alias.example.com }\n\n  use_backend s2 if { ssl_fc_sni_end s2.example.com }\n"})}),"\n",(0,r.jsx)(e.p,{children:"-m end\nuse_backend apache if { ssl_fc_sni_end domain.com }"}),"\n",(0,r.jsx)(e.p,{children:"hdr(host)\nhdr_end(host) -i .wener.me\nhdr_beg(host) -i .wener.me"}),"\n",(0,r.jsx)(e.h2,{id:"logging",children:"Logging"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"global\n  # syslog UNIX socket\n  log /dev/log local0\n\n  # \u672c\u5730 syslog server\n  log 127.0.0.1 local1 notice\n  # log \u5230 hostname \u4e3a rsyslog \u7684\u670d\u52a1\u5668\n  log rsyslog:514 local0\n\n  # stdout - \u7528\u4e8e\u5bb9\u5668\u73af\u5883\n  log stdout format raw local0\n  log stdout format raw daemon debug\n\ndefaults\n  log global\n  mode http\n  option httplog\n\nbackend s1\n  mode tcp\n  option tcplog\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#8",children:"https://www.haproxy.com/documentation/hapee/latest/onepage/#8"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/observability/logging/overview/",children:"https://www.haproxy.com/documentation/hapee/latest/observability/logging/overview/"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/blog/introduction-to-haproxy-logging/",children:"https://www.haproxy.com/blog/introduction-to-haproxy-logging/"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/",children:"HAProxy Documentation Converter"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://cbonte.github.io/haproxy-dconv/2.6/configuration.html#4.1",children:"Proxy keywords matrix"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://gist.github.com/krams915/1269101/62614130ae58a1ae107cef251a82716af3edf95b",children:"https://gist.github.com/krams915/1269101/62614130ae58a1ae107cef251a82716af3edf95b"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5b9e\u9a8c",children:"\u5b9e\u9a8c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-haproxy",children:"global\n  log stdout format raw local0\n  log stdout format raw daemon debug\n\ndefaults\n  log global\n  option httplog\n  timeout client 300s\n  timeout server 300s\n  timeout connect 5s\n\n  mode http\n\nfrontend f1\n  bind 0.0.0.0:8088\n\n  use_backend http:b1 if { hdr_dom(host) -i wener.me }\n\nbackend http:b1\n  mode http\n\nbackend tcp:b1\n  mode tcp\n\nlisten stats\n  bind :8084\n  mode http\n\n  http-request use-service prometheus-exporter if { path /metrics }\n\n  stats enable\n  stats hide-version\n  stats uri /\n  stats refresh 5s\n  stats realm Haproxy\\ Statistics\n  # stats auth Username:Password\n\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"haproxy -c -f haproxy.cfg # Check\nhaproxy -f haproxy.cfg    # Run\n# stats http://127.0.0.1:8083\n\n# \u9a8c\u8bc1\u8def\u7531\ncurl -H 'Host: wener.me' 127.0.0.1:8088\n"})}),"\n",(0,r.jsx)(e.h2,{id:"redispatch",children:"redispatch"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"session redistribution in case of connection failure"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"health-check",children:"Health Check"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"agent-check"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"option ldap-check\n# user USER\noption mysql-check\noption pgsql-check\noption redis-check\n\noption smtpchk\n# [HELO|EHLO] [<domain>]\noption smtpchk EHLO mydomain.com\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5982\u679c\u8bbe\u7f6e\u4e86\u5bc6\u7801\uff0c PING \u4e5f\u9700\u8981\u5bc6\u7801"}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.haproxy.com/documentation/hapee/latest/service-reliability/health-checking/active-checks/",children:"https://www.haproxy.com/documentation/hapee/latest/service-reliability/health-checking/active-checks/"})}),"\n"]})]})}function a(n={}){const{wrapper:e}={...(0,l.M)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(o,{...n})}):o(n)}},38088:(n,e,s)=>{var r=s(96651),l=Symbol.for("react.element"),i=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,c=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function h(n,e,s){var r,i={},h=null,o=null;for(r in void 0!==s&&(h=""+s),void 0!==e.key&&(h=""+e.key),void 0!==e.ref&&(o=e.ref),e)t.call(e,r)&&!d.hasOwnProperty(r)&&(i[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps)void 0===i[r]&&(i[r]=e[r]);return{$$typeof:l,type:n,key:h,ref:o,props:i,_owner:c.current}}e.Fragment=i,e.jsx=h,e.jsxs=h},2488:(n,e,s)=>{n.exports=s(38088)},62780:(n,e,s)=>{s.d(e,{I:()=>c,M:()=>t});var r=s(96651);const l={},i=r.createContext(l);function t(n){const e=r.useContext(i);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);