"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[15836],{49613:function(e,t,n){n.d(t,{Zo:function(){return s},kt:function(){return h}});var r=n(59496);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),i=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},s=function(e){var t=i(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),m=i(n),h=a,d=m["".concat(l,".").concat(h)]||m[h]||u[h]||o;return n?r.createElement(d,c(c({ref:t},s),{},{components:n})):r.createElement(d,c({ref:t},s))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,c=new Array(o);c[0]=m;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p.mdxType="string"==typeof e?e:a,c[1]=p;for(var i=2;i<o;i++)c[i]=n[i];return r.createElement.apply(null,c)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5735:function(e,t,n){n.r(t),n.d(t,{assets:function(){return y},contentTitle:function(){return h},default:function(){return k},frontMatter:function(){return m},metadata:function(){return d},toc:function(){return f}});var r=n(49613),a=Object.defineProperty,o=Object.defineProperties,c=Object.getOwnPropertyDescriptors,p=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,s=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,u=(e,t)=>{for(var n in t||(t={}))l.call(t,n)&&s(e,n,t[n]);if(p)for(var n of p(t))i.call(t,n)&&s(e,n,t[n]);return e};const m={title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"},h="Reverse proxy cache",d={unversionedId:"devops/web/proxy-cache",id:"devops/web/proxy-cache",title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58",description:"\u63a8\u8350 nginx - poor man's cdn.",source:"@site/../notes/devops/web/proxy-cache.md",sourceDirName:"devops/web",slug:"/devops/web/proxy-cache",permalink:"/notes/devops/web/proxy-cache",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/proxy-cache.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1664328487,formattedLastUpdatedAt:"Sep 28, 2022",frontMatter:{title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"},sidebar:"docs",previous:{title:"openresty",permalink:"/notes/devops/web/openresty"},next:{title:"Proxy FAQ",permalink:"/notes/devops/web/proxy-faq"}},y={},f=[{value:"Varnish",id:"varnish",level:2},{value:"NGINX",id:"nginx",level:2},{value:"HAProxy",id:"haproxy",level:2},{value:"HTTP Cache \u7c7b\u578b",id:"http-cache-types",level:2}],v={toc:f};function k(e){var t,n=e,{components:a}=n,s=((e,t)=>{var n={};for(var r in e)l.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&p)for(var r of p(e))t.indexOf(r)<0&&i.call(e,r)&&(n[r]=e[r]);return n})(n,["components"]);return(0,r.kt)("wrapper",(t=u(u({},v),s),o(t,c({components:a,mdxType:"MDXLayout"}))),(0,r.kt)("h1",u({},{id:"reverse-proxy-cache"}),"Reverse proxy cache"),(0,r.kt)("admonition",u({},{type:"tip"}),(0,r.kt)("p",{parentName:"admonition"},"\u63a8\u8350 nginx - poor man's cdn.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"varnish",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5185\u5b58\u7f13\u5b58"),(0,r.kt)("li",{parentName:"ul"},"\u53ef mmap \u4e3a\u6587\u4ef6 - \u6240\u6709\u7f13\u5b58\u5728\u4e00\u8d77 - \u91cd\u542f\u4f1a\u5931\u6548"),(0,r.kt)("li",{parentName:"ul"},"pro \u7248\u672c\u66f4\u591a\u5b58\u50a8\u9009\u9879"))),(0,r.kt)("li",{parentName:"ul"},"nginx",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"proxy_cache_path"),(0,r.kt)("li",{parentName:"ul"},"\u9010\u6587\u4ef6\u7f13\u5b58 - \u91cd\u542f\u540e\u8fd8\u662f\u6709\u6548"),(0,r.kt)("li",{parentName:"ul"},"\u6587\u4ef6\u540d\u4e3a md5(cache_key)"),(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 levels=3"))),(0,r.kt)("li",{parentName:"ul"},"haproxy - cache",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5185\u5b58\u7f13\u5b58"),(0,r.kt)("li",{parentName:"ul"},"total-max-size"),(0,r.kt)("li",{parentName:"ul"},"max-object-size"),(0,r.kt)("li",{parentName:"ul"},"max-age"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"http-request cache-use mycache")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"http-response cache-store mycache")),(0,r.kt)("li",{parentName:"ul"},"Cache \u8981\u6c42",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"HTTP 1.1 GET 200"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/haproxy/haproxy/issues/214"}),"https://github.com/haproxy/haproxy/issues/214")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/jiangwenyuan/nuster"}),"jiangwenyuan/nuster"))),(0,r.kt)("h2",u({},{id:"varnish"}),"Varnish"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"varnishd -a 127.0.0.1:8080 -b 185.199.109.153:80 -T 127.0.0.1:6082 -d -S $PWD/varnish-secret\n# \u56e0\u4e3a -d \u6240\u4ee5\u9700\u8981\u624b\u52a8\u542f\u52a8\nvarnishadm -S $PWD/varnish-secret -T 127.0.0.1:6082 start\n\ncurl -H 'Host: wener.me' 127.0.0.1:8080\n")),(0,r.kt)("h2",u({},{id:"nginx"}),"NGINX"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-nginx"}),"user nginx;\n\nworker_processes auto;\npcre_jit on;\nerror_log /dev/stdout warn;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n  # https://serverfault.com/a/912897\n  # HIT, MISS, BYPASS, EXPIRED\n  log_format cache_st '$remote_addr - $upstream_cache_status [$time_local]  '\n                    '\"$request\" $status $body_bytes_sent '\n                    '\"$http_referer\" \"$http_user_agent\"';\n  access_log /dev/stdout cache_st;\n\n  proxy_cache_path  /tmp/nginx-cache levels=1:2 keys_zone=static:8m max_size=1000m inactive=600m;\n  proxy_temp_path /tmp/nginx-cache-tmp;\n\n\n  server {\n    listen 8080;\n\n    location / {\n      proxy_pass http://185.199.109.153;\n      proxy_set_header Host $host;\n      proxy_cache static;\n      proxy_cache_valid  200 302  60m;\n      proxy_cache_valid  404      1m;\n    }\n  }\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"nginx -c $PWD/nginx.conf -g 'daemon off;'\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://www.sheshbabu.com/posts/nginx-caching-proxy/"}),"https://www.sheshbabu.com/posts/nginx-caching-proxy/"))),(0,r.kt)("h2",u({},{id:"haproxy"}),"HAProxy"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-haproxy"}),"frontend http\n  mode http\n  bind 0.0.0.0:8080 name v4\n  default_backend gh\nbackend gh\n  http-request cache-use mycache\n  http-response cache-store mycache\n  server svr 185.199.109.153:80 check\n\ncache mycache\n  total-max-size 4095   # MB\n  max-object-size 10000 # bytes\n  max-age 30            # seconds\n")),(0,r.kt)("h2",u({},{id:"http-cache-types"}),"HTTP Cache \u7c7b\u578b"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Page cache - \u901a\u5e38\u4e3a HTML"),(0,r.kt)("li",{parentName:"ul"},"Browser cache - \u8d44\u6e90"),(0,r.kt)("li",{parentName:"ul"},"Object cache - \u6570\u636e\u5e93\u67e5\u8be2"),(0,r.kt)("li",{parentName:"ul"},"Bytecode cache - PHP, JS"),(0,r.kt)("li",{parentName:"ul"},"CDN cache - HTML, Image, CSS, JS"),(0,r.kt)("li",{parentName:"ul"},"Reverse proxy cache - \u53d1\u751f\u5728\u53cd\u5411\u4ee3\u7406\u5c42")))}k.isMDXComponent=!0}}]);