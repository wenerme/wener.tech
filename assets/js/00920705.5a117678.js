/*! For license information please see 00920705.5a117678.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[73124],{11576:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>x,frontMatter:()=>i,metadata:()=>d,toc:()=>a});var l=s(2488),r=s(62780);const i={title:"gitlab-ci.yml"},t="gitlab-ci.yml",d={id:"service/forge/gitlab/gitlab-ci-yml",title:"gitlab-ci.yml",description:"- Gitlab CI YAML",source:"@site/../notes/service/forge/gitlab/gitlab-ci-yml.md",sourceDirName:"service/forge/gitlab",slug:"/service/forge/gitlab/ci-yml",permalink:"/notes/service/forge/gitlab/ci-yml",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/service/forge/gitlab/gitlab-ci-yml.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1652772118,formattedLastUpdatedAt:"May 17, 2022",frontMatter:{title:"gitlab-ci.yml"},sidebar:"docs",previous:{title:"Gitlab CI \u6280\u5de7",permalink:"/notes/service/forge/gitlab/ci-cookbook"},next:{title:"GitaLab\u6301\u7eed\u96c6\u6210\u6301\u7eed\u4ea4\u4ed8",permalink:"/notes/service/forge/gitlab/cicd"}},c={},a=[{value:"\u73af\u5883\u53d8\u91cf",id:"\u73af\u5883\u53d8\u91cf",level:2},{value:"job/except",id:"jobexcept",level:2},{value:"job",id:"job",level:2},{value:"cache",id:"cache",level:2},{value:"workflow",id:"workflow",level:2},{value:"release",id:"release",level:2},{value:"\u90e8\u7f72 pages",id:"\u90e8\u7f72-pages",level:2},{value:"\u6709 Tag \u7684\u65f6\u5019\u624d\u6267\u884c",id:"\u6709-tag-\u7684\u65f6\u5019\u624d\u6267\u884c",level:2},{value:"\u9ed8\u8ba4\u5206\u652f",id:"\u9ed8\u8ba4\u5206\u652f",level:2}];function h(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h1,{id:"gitlab-ciyml",children:"gitlab-ci.yml"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Gitlab CI ",(0,l.jsx)(e.a,{href:"https://docs.gitlab.com/ce/ci/yaml/index.html",children:"YAML"})]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://gitlab.com/gitlab-org/gitlab/tree/master/lib/gitlab/ci/templates",children:"\u6a21\u677f"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.gitlab.com/ee/ci/examples/",children:"\u793a\u4f8b"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.gitlab.com/ce/ci/variables/README.html",children:"\u53d8\u91cf\u8bf4\u660e"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",children:"\u9884\u5b9a\u4e49\u7684\u53d8\u91cf"})}),"\n"]}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f7f\u7528 extends \u590d\u7528\u73b0\u6709\u903b\u8f91"}),"\n",(0,l.jsxs)(e.li,{children:["\u4f7f\u7528 ",(0,l.jsx)(e.code,{children:"!reference [.setup, before_script]"})," \u590d\u7528\u90e8\u5206\u903b\u8f91 - \u4f8b\u5982\u5408\u5e76\u591a\u4e2a before_script"]}),"\n",(0,l.jsx)(e.li,{children:"\u53ef\u4ee5\u4f7f\u7528 YAML \u5f15\u7528\u903b\u8f91"}),"\n"]})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"# \u81ea\u5b9a\u4e49\u9ed8\u8ba4\u914d\u7f6e\ndefault:\n  # \u57fa\u7840\u955c\u50cf\n  image: wener/node:docker\n  cache:\n    # \u7f13\u5b58\u4ed3\u5e93\u91cc\u6240\u6709 untracked \u6587\u4ef6\n    untracked: true\n    # \u7f13\u5b58\u6309\u5206\u652f\u5212\u5206 - \u5982\u679c\u6709 tag \u8fd9\u4e2a\u4f1a\u662f tag \u540d\u5b57\n    key: '$CI_COMMIT_REF_NAME'\n    # \u5e38\u89c1\u7684\u7f13\u5b58\u76ee\u5f55\n    paths:\n      - node_modules/\n      - .yarn/\n      - .cache/\n      - .next/\n      - packages/server/.next/cache/\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u73af\u5883\u53d8\u91cf",children:"\u73af\u5883\u53d8\u91cf"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"env"}),(0,l.jsx)(e.th,{children:"e.g"}),(0,l.jsx)(e.th,{children:"desc"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI"}),(0,l.jsx)(e.td,{children:"true"}),(0,l.jsx)(e.td,{children:"\u8868\u793a\u5728\u8fd0\u884c CI"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"GITLAB_CI"}),(0,l.jsx)(e.td,{children:"true"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_REGISTRY"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"gitlab registry"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_REGISTRY_USER"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"gitlab registry user"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_REGISTRY_PASSWORD"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"gitlab registry password"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_REGISTRY_IMAGE"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"\u9879\u76ee\u5bb9\u5668\u955c\u50cf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_DEFAULT_BRANCH"}),(0,l.jsx)(e.td,{children:"main"}),(0,l.jsx)(e.td,{children:"\u9ed8\u8ba4 branch \u540d\u5b57"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_REF_NAME"}),(0,l.jsx)(e.td,{children:"main"}),(0,l.jsx)(e.td,{children:"branch or tag"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_REF_SLUG"}),(0,l.jsx)(e.td,{children:"main"}),(0,l.jsxs)(e.td,{children:["CI_COMMIT_REF_NAME \u7528\u4e8e url \u6216\u540d\u5b57\u65f6,63 \u4f4d,\u66ff\u4ee3",(0,l.jsx)(e.code,{children:"[^0-9a-z]"})," \u4e3a ",(0,l.jsx)(e.code,{children:"-"})]})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_REF_PROTECTED"}),(0,l.jsx)(e.td,{children:"true"}),(0,l.jsx)(e.td,{children:"\u4fdd\u62a4\u5206\u652f"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_BRANCH"}),(0,l.jsx)(e.td,{children:"main"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_SHA"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_SHORT_SHA"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_TAG"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_TIMESTAMP"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"ISO 8601"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_COMMIT_TITLE"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"\u7b2c\u4e00\u884c commit \u4fe1\u606f"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_ENVIRONMENT_NAME"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_ENVIRONMENT_SLUG"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_ENVIRONMENT_URL"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_ENVIRONMENT_ACTION"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"start, prepare, stop"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_ENVIRONMENT_TIER"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"production,staging,testing,development,other"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_KUBERNETES_ACTIVE"}),(0,l.jsx)(e.td,{children:"true"}),(0,l.jsx)(e.td,{children:"\u5173\u8054\u4e86 k8s \u90e8\u7f72\u96c6\u7fa4"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_ID"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_NAME"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_NAMESPACE"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"\u7528\u6237\u540d \u6216 \u7ec4\u540d"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_ROOT_NAMESPACE"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_PATH_SLUG"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"CI_PROJECT_PATH"}),(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{})]})]})]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY\n# \u5e38\u7528 $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG\ndocker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" ./build\ndocker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"\n'})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",children:"Predefined variables reference"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"jobexcept",children:"job:only/except"}),"\n",(0,l.jsx)(e.admonition,{type:"caution",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5f00\u53d1\u4e0d\u6d3b\u8dc3\uff0c\u63a8\u8350\uff0c\u4f7f\u7528 rules"}),"\n"]})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:'build:\n  script: npm run build\n  only:\n    # \u7b80\u5355\u914d\u7f6e - refs\n    # \u5b8c\u6574\u5339\u914d - master \u5206\u652f\u8fd0\u884c\n    - master\n    # \u652f\u6301\u6b63\u5219 \u5339\u914d tag \u6216 branch - \u5982\u679c \u6392\u9664\u4e86 branches \u5219\u662f\u5339\u914d tag\n    - /^issue-.*$/i\n\n    # \u9ad8\u7ea7\u914d\u7f6e\n    # \u4e0d\u6307\u5b9a\u9ed8\u8ba4\u5219\u662f refs \u5339\u914d\n    refs:\n      - master\n      - schedules\n    # \u53d8\u91cf\u5339\u914d\n    variables:\n      - $CI_COMMIT_MESSAGE =~ /run-end-to-end-tests/ # \u5339\u914d\u53d8\u91cf\n      - $RELEASE == "staging" # \u53d8\u91cf\u6ee1\u8db3\n      - $STAGING # \u6709\u53d8\u91cf\n      # \u590d\u6742\u6761\u4ef6\u53d8\u91cf\n      - ($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop") && $MY_VARIABLE\n    # \u5339\u914d\u53d8\u5316\u6587\u4ef6\n    # \u53ea\u6709\u5728 branches external_pull_requests merge_requests \u6709\u6548\n    changes:\n      - README.md\n      - "*.md" # \u4f8b\u5982 \u4ece\u65b0\u751f\u6210\u6587\u6863\n      - base/Dockerfile # \u4f8b\u5982 \u91cd\u6784\u57fa\u7840\u955c\u50cf\n      - "**/*.sql" # \u4f8b\u5982 \u6570\u636e\u5e93\u8fc1\u79fb\n    # \u8981\u6c42\u5f00\u542f\u4e86 k8s \u670d\u52a1\n    kubernetes: active\n  except:\n    # \u652f\u6301\u4f7f\u7528\u5173\u952e\u8bcd - \u5206\u652f\u4e0d\u89e6\u53d1\n    - branches\n    # \u53ef\u5305\u542b\u4ed3\u5e93\u4fe1\u606f\u5339\u914d - \u7528\u4e8e fork \u573a\u666f\n    - /^release/.*$/@gitlab-org/gitlab\n'})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"value"}),(0,l.jsx)(e.th,{children:"desc"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"api"}),(0,l.jsx)(e.td,{children:"Pipline API \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"branches"}),(0,l.jsx)(e.td,{children:"ref \u662f\u5206\u652f"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"chat"}),(0,l.jsx)(e.td,{children:"ChatOps \u521b\u5efa\u7684 Pipeline"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"external"}),(0,l.jsx)(e.td,{children:"\u5916\u90e8 CI \u670d\u52a1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"external_pull_requests"}),(0,l.jsx)(e.td,{children:"\u5916\u90e8\u4ed3\u5e93 PR\uff0c\u4f8b\u5982 Github"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"merge_requests"}),(0,l.jsx)(e.td,{children:"\u4ed3\u5e93\u6536\u5230 pr"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"pipelines"}),(0,l.jsx)(e.td,{children:"\u6d41\u6c34\u7ebf\u4e2d\u521b\u5efa\u7684\u591a\u9879\u76ee pipeline"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"pushes"}),(0,l.jsx)(e.td,{children:"git push \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"schedules"}),(0,l.jsx)(e.td,{children:"\u8c03\u5ea6\u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"tags"}),(0,l.jsx)(e.td,{children:"ref \u662f tag"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"triggers"}),(0,l.jsx)(e.td,{children:"trigger token \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"web"}),(0,l.jsx)(e.td,{children:"Web \u89e6\u53d1/\u8fd0\u884c\u6d41\u6c34\u7ebf"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"job",children:"job:rules"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9650\u5b9a job \u662f\u5426\u8fd0\u884c"}),"\n",(0,l.jsxs)(e.li,{children:["\u57fa\u7840\u8bed\u53e5\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["if\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7c7b\u4f3c only:variables \u914d\u7f6e"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"&&"}),", ",(0,l.jsx)(e.code,{children:"||"}),", ",(0,l.jsx)(e.code,{children:"=="}),", ",(0,l.jsx)(e.code,{children:"!="}),", ",(0,l.jsx)(e.code,{children:"=~"}),", ",(0,l.jsx)(e.code,{children:"!~"})]}),"\n",(0,l.jsx)(e.li,{children:"CI_PIPELINE_SOURCE \u7528\u4e8e\u652f\u6301\u7c7b\u4f3c rules \u7684\u5173\u952e\u5b57"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["changes\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7c7b\u4f3c only:changes \u914d\u7f6e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["exists\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5305\u542b\u6307\u5b9a\u6587\u4ef6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u8bed\u53e5\u5c5e\u6027\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["when - \u9650\u5b9a\u8fd0\u884c\u6761\u4ef6\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"on_success, delayed, always"}),"\n",(0,l.jsx)(e.li,{children:"never - \u4e0d\u89e6\u53d1 - \u7b49\u540c\u4e8e rules:except"}),"\n",(0,l.jsx)(e.li,{children:"manual - \u624b\u52a8\u89e6\u53d1\u65f6"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"allow_failure - \u662f\u5426\u5141\u8bb8\u8fd0\u884c\u9519\u8bef"}),"\n",(0,l.jsx)(e.li,{children:"changes \u6587\u4ef6\u53d8\u5316"}),"\n",(0,l.jsx)(e.li,{children:"variables \u5b9a\u4e49\u989d\u5916\u53d8\u91cf"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"build:\n  script: npm run build\n  rules:\n    - if: '$CI_COMMIT_BRANCH == \"master\"'\n      when: delayed\n      start_in: '3 hours'\n      allow_failure: true\n    # \u8981\u6c42\u6709\u53d8\u5316\u6587\u4ef6\n    - if: '$CI_PIPELINE_SOURCE == \"merge_request_event\"'\n      changes:\n        - Dockerfile\n      when: manual\n      allow_failure: true\nbuild:\n  script: npm run build\n  rules:\n    # \u524d\u4e24\u4e2a\u6761\u4ef6\u4e0d\u6ee1\u8db3\u624d\u8fd0\u884c\n    - if: '$CI_PIPELINE_SOURCE == \"merge_request_event\"'\n      when: never\n    - if: '$CI_PIPELINE_SOURCE == \"schedule\"'\n      when: never\n    - when: on_success\n\nbuild:\n  script: npm run build\n  rules:\n    # \u5e38\u89c1\n    - if: $CI_COMMIT_TAG # \u6709 tag\n    - if: $CI_COMMIT_BRANCH # \u5206\u652f\u63a8\u9001\n    - if: '$CI_COMMIT_BRANCH == \"main\"' # \u4e3b\u5206\u652f\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH' # \u9ed8\u8ba4\u5206\u652f\n    - if: '$CI_COMMIT_BRANCH =~ /regex-expression/' # \u5206\u652f\u5339\u914d\n\n"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"if CI_PIPELINE_SOURCE"}),(0,l.jsx)(e.th,{children:"desc"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"api"}),(0,l.jsx)(e.td,{children:"Pipline API \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"chat"}),(0,l.jsx)(e.td,{children:"ChatOps \u521b\u5efa\u7684 Pipeline"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"external"}),(0,l.jsx)(e.td,{children:"\u5916\u90e8 CI \u670d\u52a1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"external_pull_request_event"}),(0,l.jsx)(e.td,{children:"\u5916\u90e8\u4ed3\u5e93 PR\uff0c\u4f8b\u5982 Github"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"merge_request_event"}),(0,l.jsx)(e.td,{children:"\u4ed3\u5e93\u6536\u5230 pr"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"parent_pipeline"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"pipeline"}),(0,l.jsx)(e.td,{children:"\u6d41\u6c34\u7ebf\u4e2d\u521b\u5efa\u7684\u591a\u9879\u76ee pipeline"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"push"}),(0,l.jsx)(e.td,{children:"git push \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"schedule"}),(0,l.jsx)(e.td,{children:"\u8c03\u5ea6\u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"tags"}),(0,l.jsx)(e.td,{children:"ref \u662f tag"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"trigger"}),(0,l.jsx)(e.td,{children:"trigger token \u89e6\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"web"}),(0,l.jsx)(e.td,{children:"Web \u89e6\u53d1/\u8fd0\u884c\u6d41\u6c34\u7ebf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"webide"}),(0,l.jsx)(e.td,{children:"WebIDE"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"cache",children:"cache"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u4f4d\u7f6e"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["cache\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5168\u5c40 - \u4e0d\u63a8\u8350\uff0c\u5efa\u8bae\u4f7f\u7528 default"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["defaul:cache\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"job \u9ed8\u8ba4\u7f13\u5b58"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["job:cache\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"job \u7ef4\u5ea6\u7f13\u5b58\u914d\u7f6e"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u5c5e\u6027"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["cache:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ef\u914d\u7f6e\u4e3a\u6570\u7ec4 - \u591a\u4e2a\u7f13\u5b58"}),"\n",(0,l.jsxs)(e.li,{children:["key:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9ed8\u8ba4 default - \u5168\u5c40\u5171\u7528"}),"\n",(0,l.jsxs)(e.li,{children:["\u53ef\u8bbe\u7f6e\u4e3a ",(0,l.jsx)(e.code,{children:"$CI_COMMIT_REF_SLUG"})," - \u5206\u652f\u72ec\u7acb\u7f13\u5b58"]}),"\n",(0,l.jsxs)(e.li,{children:["files:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["prefix:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"${CI_JOB_NAME}"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["untracked:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7f13\u5b58\u4ed3\u5e93\u91cc\u6240\u6709 untracked \u6587\u4ef6"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["paths:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u7f13\u5b58\u7684\u76ee\u5f55"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["when:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"on_success - \u9ed8\u8ba4 \u6210\u529f\u65f6\u4fdd\u5b58\u7f13\u5b58"}),"\n",(0,l.jsx)(e.li,{children:"on_failure"}),"\n",(0,l.jsx)(e.li,{children:"always"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["policy:\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"pull-push - \u9ed8\u8ba4 - \u542f\u52a8\u524d\u62c9\uff0c\u5b8c\u6210\u540e\u63a8"}),"\n",(0,l.jsx)(e.li,{children:"pull \u53ea\u62c9 - \u7528\u4e8e\u5df2\u77e5\u4e0d\u4f1a\u4fee\u6539\u7f13\u5b58\u573a\u666f"}),"\n",(0,l.jsx)(e.li,{children:"push \u53ea\u63a8"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"cache:\n  paths:\n    - my/files\n\nrspec:\n  script: test\n  cache:\n    key: rspec\n    paths:\n      - binaries/\n"})}),"\n",(0,l.jsx)(e.h2,{id:"workflow",children:"workflow"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9650\u5b9a pipeline \u662f\u5426\u8fd0\u884c/\u521b\u5efa"}),"\n",(0,l.jsx)(e.li,{children:"\u8fd0\u884c\u65f6\u8fd0\u884c\u8986\u76d6\u53d8\u91cf"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"workflow:\n  rules:\n    - if: $CI_COMMIT_MESSAGE =~ /-draft$/\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /feature/\n      variables:\n        IS_A_FEATURE: 'true' # \u8986\u76d6\u53d8\u91cf\n    - when: always #\n"})}),"\n",(0,l.jsx)(e.h2,{id:"release",children:"release"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4f9d\u8d56 ",(0,l.jsx)(e.a,{href:"https://gitlab.com/gitlab-org/release-cli/-/tree/master/docs",children:"release-cli"})," \u547d\u4ee4\u884c\u5de5\u5177\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"image: registry.gitlab.com/gitlab-org/release-cli:latest"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://gitlab.com/gitlab-org/release-cli/-/tree/master/docs/examples/release-assets-as-generic-package/",children:"Release assets as Generic packages"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# AlpineLinux\napk add gitlab-release-cli -X https://mirrors.aliyun.com/alpine/edge/testing\n\n# shell executor \u9700\u8981\u5b89\u88c5\u547d\u4ee4\u884c\u6839\u636e\ncurl --location --output /usr/local/bin/release-cli "https://release-cli-downloads.s3.amazonaws.com/latest/release-cli-linux-amd64"\nchmod +x /usr/local/bin/release-cli\n\n# \u786e\u4fdd\u53ef\u7528\nrelease-cli -v\n'})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"# \u57fa\u4e8e tag release\njob:\n  release:\n    tag_name: $CI_COMMIT_TAG\n    description: 'Release description'\n    # name - \u9ed8\u8ba4\u4e3a tag_name\n    # ref - \u5982\u679c\u6ca1\u6709 tag_name \u53ef\u4ee5\u901a\u8fc7 ref \u521b\u5efa\n    # milestones - \u5173\u8054\u91cc\u7a0b\u7891\n    # released_at: '2021-03-15T08:00:00Z' # \u4e0d\u6307\u5b9a\u4f1a\u81ea\u52a8\u751f\u6210\n\n---\n# \u76f4\u63a5\u8c03\u7528\u547d\u4ee4\u884c - \u53ef\u4ee5\u6dfb\u52a0 assets-link\n# gitlab \u5185\u7f6e artifact https://gitlab.com/org/proj/-/jobs/<JOB_ID>/artifacts/browse\nrelease:\n  stage: release\n  image: registry.gitlab.com/gitlab-org/release-cli:v0.4.0\n  # \u624b\u52a8\u89e6\u53d1\n  when: manual\n  rules:\n    - if: $CI_COMMIT_TAG\n      when: never\n\n  script:\n    - >\n      release-cli create --name release-branch-$CI_JOB_ID --description release-branch-$CI_COMMIT_REF_NAME-$CI_JOB_ID\n      --tag-name job-$CI_JOB_ID --ref $CI_COMMIT_SHA\n      --assets-link '{\"name\":\"Asset1\",\"url\":\"https://<domain>/some/location/1\",\"link_type\":\"other\",\"filepath\":\"xzy\"}'\n      --assets-link '{\"name\":\"Asset2\",\"url\":\"https://<domain>/some/location/2\"}'\n      --milestone \"v1.0.0\" --milestone \"v1.0.0-rc\"\n      --released-at \"2020-06-30T07:00:00Z\"\n\n---\nrelease_job:\n  stage: release\n  image: registry.gitlab.com/gitlab-org/release-cli:latest\n  rules:\n    - if: $CI_COMMIT_TAG # Run this job when a tag is created manually\n  script:\n    - echo 'running release_job'\n  release:\n    name: 'Release $CI_COMMIT_TAG'\n    description: 'Created using the release-cli $EXTRA_DESCRIPTION' # $EXTRA_DESCRIPTION must be defined\n    tag_name: '$CI_COMMIT_TAG' # elsewhere in the pipeline.\n    ref: '$CI_COMMIT_TAG'\n    milestones:\n      - 'm1'\n      - 'm2'\n      - 'm3'\n    released_at: '2020-07-15T08:00:00Z' # Optional, is auto generated if not defined, or can use a variable.\n---\nprepare_job:\n  stage: prepare # This stage must run before the release stage\n  rules:\n    - if: $CI_COMMIT_TAG\n      when: never # Do not run this job when a tag is created manually\n    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Run this job when commits are pushed or merged to the default branch\n  script:\n    - echo \"EXTRA_DESCRIPTION=some message\" >> variables.env # Generate the EXTRA_DESCRIPTION and TAG environment variables\n    - echo \"TAG=v$(cat VERSION)\" >> variables.env # and append to the variables.env file\n  artifacts:\n    reports:\n      dotenv: variables.env # Use artifacts:reports:dotenv to expose the variables to other jobs\n\nrelease_job:\n  stage: release\n  image: registry.gitlab.com/gitlab-org/release-cli:latest\n  needs:\n    - job: prepare_job\n      artifacts: true\n  rules:\n    - if: $CI_COMMIT_TAG\n      when: never # Do not run this job when a tag is created manually\n    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Run this job when commits are pushed or merged to the default branch\n  script:\n    - echo 'running release_job for $TAG'\n  release:\n    name: 'Release $TAG'\n    description: 'Created using the release-cli $EXTRA_DESCRIPTION' # $EXTRA_DESCRIPTION and the $TAG\n    tag_name: '$TAG' # variables must be defined elsewhere\n    ref: '$CI_COMMIT_SHA' # in the pipeline. For example, in the\n    milestones: # prepare_job\n      - 'm1'\n      - 'm2'\n      - 'm3'\n    released_at: '2020-07-15T08:00:00Z' # Optional, is auto generated if not defined, or can use a variable.\n"})}),"\n",(0,l.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(e.h2,{id:"\u90e8\u7f72-pages",children:"\u90e8\u7f72 pages"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"pages:\n  script:\n    - yarn\n    - yarn build:public\n  artifacts:\n    # \u5fc5\u987b\u662f public \u76ee\u5f55\n    paths:\n      - public\n  only:\n    - master\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u6709-tag-\u7684\u65f6\u5019\u624d\u6267\u884c",children:"\u6709 Tag \u7684\u65f6\u5019\u624d\u6267\u884c"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u4e0d\u80fd\u6709 tag \u4e14\u6392\u9664\u5206\u652f - ",(0,l.jsx)(e.a,{href:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/23251",children:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/23251"})]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"build-tag:\n  only:\n    # \u6307\u5b9a\u5206\u652f\n    - master\n    # \u5fc5\u987b\u6709 tag\n    - tags\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u6216\u8005"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:'rules:\n  # \u6ca1\u6709 tag \u7684\u65f6\u5019\u624d\u6267\u884c\n  - if: $CI_COMMIT_TAG != ""\n    when: on_success\n  - when: never\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u9ed8\u8ba4\u5206\u652f",children:"\u9ed8\u8ba4\u5206\u652f"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"master \u6216 main \u6216 \u81ea\u5b9a\u4e49\u7684\u9ed8\u8ba4\u5206\u652f"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"only:\n  variables:\n    - $CI_DEFAULT_BRANCH == $CI_COMMIT_REF_NAME\n"})})]})}function x(n={}){const{wrapper:e}={...(0,r.M)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(h,{...n})}):h(n)}},38088:(n,e,s)=>{var l=s(96651),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,d=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function a(n,e,s){var l,i={},a=null,h=null;for(l in void 0!==s&&(a=""+s),void 0!==e.key&&(a=""+e.key),void 0!==e.ref&&(h=e.ref),e)t.call(e,l)&&!c.hasOwnProperty(l)&&(i[l]=e[l]);if(n&&n.defaultProps)for(l in e=n.defaultProps)void 0===i[l]&&(i[l]=e[l]);return{$$typeof:r,type:n,key:a,ref:h,props:i,_owner:d.current}}e.Fragment=i,e.jsx=a,e.jsxs=a},2488:(n,e,s)=>{n.exports=s(38088)},62780:(n,e,s)=>{s.d(e,{I:()=>d,M:()=>t});var l=s(96651);const r={},i=l.createContext(r);function t(n){const e=l.useContext(i);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),l.createElement(i.Provider,{value:e},n.children)}}}]);