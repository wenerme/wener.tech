"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[36992],{3905:function(e,l,a){a.d(l,{Zo:function(){return d},kt:function(){return g}});var t=a(67294);function n(e,l,a){return l in e?Object.defineProperty(e,l,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[l]=a,e}function o(e,l){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);l&&(t=t.filter((function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable}))),a.push.apply(a,t)}return a}function r(e){for(var l=1;l<arguments.length;l++){var a=null!=arguments[l]?arguments[l]:{};l%2?o(Object(a),!0).forEach((function(l){n(e,l,a[l])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(l){Object.defineProperty(e,l,Object.getOwnPropertyDescriptor(a,l))}))}return e}function i(e,l){if(null==e)return{};var a,t,n=function(e,l){if(null==e)return{};var a,t,n={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],l.indexOf(a)>=0||(n[a]=e[a]);return n}(e,l);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],l.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=t.createContext({}),u=function(e){var l=t.useContext(s),a=l;return e&&(a="function"==typeof e?e(l):r(r({},l),e)),a},d=function(e){var l=u(e.components);return t.createElement(s.Provider,{value:l},e.children)},p={inlineCode:"code",wrapper:function(e){var l=e.children;return t.createElement(t.Fragment,{},l)}},c=t.forwardRef((function(e,l){var a=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=u(a),g=n,m=c["".concat(s,".").concat(g)]||c[g]||p[g]||o;return a?t.createElement(m,r(r({ref:l},d),{},{components:a})):t.createElement(m,r({ref:l},d))}));function g(e,l){var a=arguments,n=l&&l.mdxType;if("string"==typeof e||n){var o=a.length,r=new Array(o);r[0]=c;var i={};for(var s in l)hasOwnProperty.call(l,s)&&(i[s]=l[s]);i.originalType=e,i.mdxType="string"==typeof e?e:n,r[1]=i;for(var u=2;u<o;u++)r[u]=a[u];return t.createElement.apply(null,r)}return t.createElement.apply(null,a)}c.displayName="MDXCreateElement"},59381:function(e,l,a){a.r(l),a.d(l,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return d},default:function(){return c}});var t=a(87462),n=a(63366),o=(a(67294),a(3905)),r=["components"],i={title:"Brazel Go"},s=void 0,u={unversionedId:"dev/build/bazel/bazel-go",id:"dev/build/bazel/bazel-go",title:"Brazel Go",description:"Brazel Go",source:"@site/notes/dev/build/bazel/bazel-go.md",sourceDirName:"dev/build/bazel",slug:"/dev/build/bazel/bazel-go",permalink:"/notes/dev/build/bazel/bazel-go",editUrl:"https://github.com/wenerme/wener/edit/master/notes/dev/build/bazel/bazel-go.md",tags:[],version:"current",frontMatter:{title:"Brazel Go"},sidebar:"docs",previous:{title:"Bazel FAQ",permalink:"/notes/dev/build/bazel/bazel-faq"},next:{title:"Bazel Java",permalink:"/notes/dev/build/bazel/bazel-java"}},d=[{value:"Brazel Go",id:"brazel-go",children:[{value:"cross compile",id:"cross-compile",children:[],level:3}],level:2},{value:"go_repository does not support file path replacements",id:"go_repository-does-not-support-file-path-replacements",children:[],level:2},{value:"rules_go",id:"rules_go",children:[],level:2},{value:"gazelle",id:"gazelle",children:[],level:2},{value:"go_sdk",id:"go_sdk",children:[],level:2},{value:"found but does not contain package",id:"found-but-does-not-contain-package",children:[],level:2},{value:"is not visible from target",id:"is-not-visible-from-target",children:[],level:2},{value:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898",id:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898",children:[],level:2},{value:"go: cannot find GOROOT directory: /usr/local/go",id:"go-cannot-find-goroot-directory-usrlocalgo",children:[],level:2}],p={toc:d};function c(e){var l=e.components,a=(0,n.Z)(e,r);return(0,o.kt)("wrapper",(0,t.Z)({},p,a,{components:l,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"brazel-go"},"Brazel Go"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle"},"bazelbuild/bazel-gazelle"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u4e3a go \u548c protobuf \u751f\u6210 BUILD"))),(0,o.kt)("li",{parentName:"ul"},"deps.bzl"),(0,o.kt)("li",{parentName:"ul"},"\u53c2\u8003",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.tweag.io/blog/2021-09-08-rules_go-gazelle/"},"BUILDING A GO PROJECT USING BAZEL"))))),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("ul",{parentName:"div"},(0,o.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5f00\u542f trimpath"),(0,o.kt)("li",{parentName:"ul"},"\u6682\u4e0d\u652f\u6301 coverage")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# cross compile no cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# cross compile with cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'workspace(name = "my_project")\n\nload("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")\n\nhttp_archive(\n    name = "io_bazel_rules_go",\n    sha256 = "2b1641428dff9018f9e85c0384f03ec6c10660d935b750e3fa1492a281a53b0f",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n        "https://github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n    ],\n)\n\nhttp_archive(\n    name = "bazel_gazelle",\n    sha256 = "de69a09dc70417580aabf20a28619bb3ef60d038470c7cf8442fafcf627c21cb",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n        "https://github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n    ],\n)\n\nload("@io_bazel_rules_go//go:deps.bzl", "go_register_toolchains", "go_rules_dependencies")\nload("@bazel_gazelle//:deps.bzl", "gazelle_dependencies", "go_repository")\n\n#\ngo_rules_dependencies()\ngo_register_toolchains(version = "1.17.2")\ngazelle_dependencies()\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py",metastring:'title="BUILD"',title:'"BUILD"'},'load("@bazel_gazelle//:def.bzl", "gazelle")\n\n# gazelle:prefix zhensikeji.net/inccall/core\ngazelle(name = "gazelle")\n\ngazelle(\n    name = "gazelle-update-repos",\n    args = [\n        "-from_file=go.mod",\n        "-to_macro=deps.bzl%go_dependencies",\n        "-prune",\n        "-build_file_proto_mode=disable_global",\n    ],\n    command = "update-repos",\n)\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"bazel run //:gazelle\n\nbazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies\nbazel run //:gazelle-update-repos\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"go get github.com/bazelbuild/bazel-gazelle/cmd/gazelle\ngazelle -go_prefix github.com/example/project\n")),(0,o.kt)("h3",{id:"cross-compile"},"cross compile"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'go_library(\n    name = "foo",\n    srcs = [\n        "foo_linux.go",\n        "foo_windows.go",\n    ],\n    deps = select({\n        "@io_bazel_rules_go//go/platform:linux_amd64": [\n            "//bar_linux",\n        ],\n        "@io_bazel_rules_go//go/platform:windows_amd64": [\n            "//bar_windows",\n        ],\n        "//conditions:default": [],\n    }),\n)\n')),(0,o.kt)("h2",{id:"go_repository-does-not-support-file-path-replacements"},"go_repository does not support file path replacements"),(0,o.kt)("h2",{id:"rules_go"},"rules_go"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/rules_go"},"bazelbuild/rules_go")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/rules_go/blob/master/go/modes.rst#mode-attributes"},"Build modes"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"static, race, msan, pure, strip, debug, gotags, linkmode"),(0,o.kt)("li",{parentName:"ul"},"\u547d\u4ee4\u884c ",(0,o.kt)("inlineCode",{parentName:"li"},"--@io_bazel_rules_go//go/config:<mode>")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'go_binary(<mode> = "")')))),(0,o.kt)("li",{parentName:"ul"},"toolchain",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"go_register_toolchains -> @go_sdk -> go_download_sdk"),(0,o.kt)("li",{parentName:"ul"},"go_download_sdk - \u4e0b\u8f7d"),(0,o.kt)("li",{parentName:"ul"},"go_local_sdk - \u6307\u5b9a\u672c\u5730 PATH"))),(0,o.kt)("li",{parentName:"ul"},"go_binary",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"out - \u8f93\u51fa\u540d\u5b57",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5982\u679c name \u548c dir \u540d\u5b57\u76f8\u540c\uff0c\u5219\u4f1a\u6dfb\u52a0\u4e0b\u5212\u7ebf")))))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'load("@io_bazel_rules_go//go:deps.bzl", "go_rules_dependencies", "go_register_toolchains")\n\ngo_rules_dependencies()\n\ngo_register_toolchains(version = "1.15.5")\n# \u4f7f\u7528 host \u7684 go \u7248\u672c - \u7f16\u8bd1\u4e0d\u4e00\u5b9a\u53ef\u91cd\u73b0\n# \u4f46\u66f4\u5feb\uff0c\u5c11\u4e86\u4e0b\u8f7d\u5b89\u88c5\u8fc7\u7a0b\ngo_register_toolchains(version = "host")\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# \u4ea4\u53c9\u7f16\u8bd1\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# with CGO\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u4e5f\u53ef\u4ee5\u5728 go_binary \u8bbe\u7f6e goos \u548c goarch")),(0,o.kt)("h2",{id:"gazelle"},"gazelle"),(0,o.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("ul",{parentName:"div"},(0,o.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u8981\u6c42 proto \u5305\u540d\u5339\u914d\u76ee\u5f55 \u540d\u5b57 - ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/271"},"#271"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},'go_repository(build_file_proto_mode = "disable_global",)'))))))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# \u547d\u4ee4\u884c\u751f\u6210\ngazelle -go_prefix go-micro.dev/v4 -proto disable\n\ngazelle update\n")),(0,o.kt)("h2",{id:"go_sdk"},"go_sdk"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'# Host\ngo_host_sdk(name="go_sdk")\n# Local\ngo_local_sdk(\n    name = "go_sdk",\n    path = "/Users/wener/sdk/go1.18beta1",\n)\ngo_register_toolchains()\n\n# Download\ngo_register_toolchains(version = "1.17.6")\n# Host\ngo_register_toolchains(version = "host")\n')),(0,o.kt)("h2",{id:"found-but-does-not-contain-package"},"found but does not contain package"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/953"},"https://github.com/bazelbuild/bazel-gazelle/issues/953"))),(0,o.kt)("h2",{id:"is-not-visible-from-target"},"is not visible from target"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/1117"},"https://github.com/bazelbuild/bazel-gazelle/issues/1117"))),(0,o.kt)("h2",{id:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898"},"\u7f13\u5b58\u76f8\u5173\u95ee\u9898"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"GO_REPOSITORY_USE_HOST_CACHE",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u4f7f\u7528 ",(0,o.kt)("inlineCode",{parentName:"li"},"go env GOPATH")," \u800c\u4e0d\u662f\u4f7f\u7528 bazel \u7f13\u5b58"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/701"},"https://github.com/bazelbuild/bazel-gazelle/issues/701")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/549"},"https://github.com/bazelbuild/bazel-gazelle/issues/549")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel-gazelle/issues/543"},"https://github.com/bazelbuild/bazel-gazelle/issues/543"))),(0,o.kt)("h2",{id:"go-cannot-find-goroot-directory-usrlocalgo"},"go: cannot find GOROOT directory: /usr/local/go"),(0,o.kt)("p",null,"/usr/lib/go"))}c.isMDXComponent=!0}}]);