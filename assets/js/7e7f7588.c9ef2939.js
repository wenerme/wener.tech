/*! For license information please see 7e7f7588.c9ef2939.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[51365],{52345:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var i=s(11527),t=s(47214);const r={title:"kustomize"},l="kustomize",a={id:"devops/kubernetes/ops/kustomize",title:"kustomize",description:"- kubernetes-sigs/kustomize",source:"@site/../notes/devops/kubernetes/ops/kustomize.md",sourceDirName:"devops/kubernetes/ops",slug:"/devops/kubernetes/ops/kustomize",permalink:"/notes/devops/kubernetes/ops/kustomize",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/ops/kustomize.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1695042174,formattedLastUpdatedAt:"Sep 18, 2023",frontMatter:{title:"kustomize"},sidebar:"docs",previous:{title:"Kubectl",permalink:"/notes/devops/kubernetes/ops/kubectl"},next:{title:"RBAC",permalink:"/notes/devops/kubernetes/ops/rbac"}},o={},c=[{value:"\u76ee\u5f55\u7ed3\u6784",id:"\u76ee\u5f55\u7ed3\u6784",level:2},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",level:2},{value:"\u6279\u91cf\u5408\u5e76\u4fee\u6539",id:"\u6279\u91cf\u5408\u5e76\u4fee\u6539",level:2},{value:"vars/replacements",id:"varsreplacements",level:2},{value:"accumulating resources: accumulation err=&#39;merging resources from &#39;res.yaml&#39;: may not add resource with an already registered id",id:"accumulating-resources-accumulation-errmerging-resources-from-resyaml-may-not-add-resource-with-an-already-registered-id",level:2},{value:"index out of range [4] with length 4",id:"index-out-of-range-4-with-length-4",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"kustomize",children:"kustomize"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize",children:"kubernetes-sigs/kustomize"})}),"\n",(0,i.jsxs)(n.li,{children:["kustomize ",(0,i.jsx)(n.a,{href:"https://kubectl.docs.kubernetes.io/references/kustomize/",children:"reference"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubectl.docs.kubernetes.io/pages/app_management/introduction.html",children:"kubectl apply -k"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"v1.14+"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/issues/1500",children:"#1500"})," - \u5347\u7ea7\u5230\u65b0\u7248\u53d7\u5230\u963b\u788d"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u7279\u70b9\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e0d\u57fa\u4e8e\u5b57\u7b26\u4e32\u6a21\u677f"}),"\n",(0,i.jsxs)(n.li,{children:["\u53d8\u91cf\u5f15\u7528\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"vars"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Patch \u4fee\u6539\u5b9a\u4e49\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"JSON Patch"}),"\n",(0,i.jsx)(n.li,{children:"patchesStrategicMerge"}),"\n",(0,i.jsx)(n.li,{children:"patchesJson6902"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["DSL \u4fee\u6539\u5b9a\u4e49\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"namespace"}),"\n",(0,i.jsx)(n.li,{children:"namePrefix"}),"\n",(0,i.jsx)(n.li,{children:"nameSuffix"}),"\n",(0,i.jsx)(n.li,{children:"commonLabels"}),"\n",(0,i.jsx)(n.li,{children:"commonAnnotations"}),"\n",(0,i.jsx)(n.li,{children:"images - \u955c\u50cf\u66ff\u6362"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["DSL \u751f\u6210\u5b9a\u4e49\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"configmapGenerator"}),"\n",(0,i.jsx)(n.li,{children:"secretGenerator"}),"\n",(0,i.jsx)(n.li,{children:"generatorOptions"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u8d44\u6e90\u805a\u5408\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"resources"}),"\n",(0,i.jsx)(n.li,{children:"bases - overlay \u591a\u5c42\u76ee\u5f55"}),"\n",(0,i.jsx)(n.li,{children:"configurations"}),"\n",(0,i.jsx)(n.li,{children:"crds"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"kustomization.yaml - \u6838\u5fc3\u5b9a\u4e49\u6587\u4ef6"}),"\n",(0,i.jsxs)(n.li,{children:["\u53c2\u8003\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/",children:"Declarative Management of Kubernetes Objects Using Kustomize"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u4e0d\u652f\u6301\u79fb\u9664\u8d44\u6e90 - ",(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/issues/1593",children:"#1593"})]}),"\n"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# macOS\nbrew install kustomize\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u76ee\u5f55\u7ed3\u6784",children:"\u76ee\u5f55\u7ed3\u6784"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u5e94\u7528\u57fa\u7840\u76ee\u5f55\nmkdir -p app/base app/overlays/{staging,production}\n\n# kustomize build \u751f\u6210 yaml\n# \u90e8\u7f72\u4e0d\u540c\u73af\u5883\nkustomize build ~/ldap/overlays/staging | kubectl apply -f - --context staging\nkustomize build ~/ldap/overlays/production | kubectl apply -f - --context production\n\n# -k \u53ef\u76f4\u63a5 apply\nkubectl apply -k ~/ldap/overlays/staging --context staging\nkubectl apply -k ~/ldap/overlays/production --context production\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"~/someApp - \u57fa\u7840\u5e94\u7528\u76ee\u5f55\n\u251c\u2500\u2500 base - \u57fa\u7840\u5c42\n\u2502   \u251c\u2500\u2500 deployment.yaml\n\u2502   \u251c\u2500\u2500 kustomization.yaml\n\u2502   \u2514\u2500\u2500 service.yaml\n\u2514\u2500\u2500 overlays - \u53e0\u52a0\u5c42\n    \u251c\u2500\u2500 development - base+\u5f00\u53d1\u73af\u5883\u81ea\u5b9a\u4e49\u5185\u5bb9\n    \u2502   \u251c\u2500\u2500 cpu_count.yaml\n    \u2502   \u251c\u2500\u2500 kustomization.yaml\n    \u2502   \u2514\u2500\u2500 replica_count.yaml\n    \u2514\u2500\u2500 production - base+\u751f\u4ea7\u73af\u5883\u81ea\u5b9a\u4e49\u5185\u5bb9\n        \u251c\u2500\u2500 cpu_count.yaml\n        \u251c\u2500\u2500 kustomization.yaml\n        \u2514\u2500\u2500 replica_count.yaml\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u793a\u4f8b",children:"\u793a\u4f8b"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs",children:"https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u6279\u91cf\u5408\u5e76\u4fee\u6539",children:"\u6279\u91cf\u5408\u5e76\u4fee\u6539"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"kustomization.yaml"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"patches:\n  - target:\n      kind: Application\n    path: patch.yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"patch.yaml"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  # \u5339\u914d\u6240\u6709\n  name: '*'\nspec:\n  project: dev-cluster\n"})}),"\n",(0,i.jsx)(n.h2,{id:"varsreplacements",children:"vars/replacements"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'resources:\n- admin.cm.yaml\n\nreplacements:\n- source:\n   kind: ConfigMap\n   name: admin-conf\n   fieldPath: data.version\n targets:\n - select:\n     kind: Deployment\n   fieldPaths:\n   # \u66ff\u6362\u955c\u50cf\u7248\u672c\u53f7\n   - spec.template.spec.containers.[name=admin].image\n   options:\n     delimiter: ":"\n     index: 1\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/blob/7c36ed21b3587e7124326743a888db5374e86d93/api/types/replacement.go",children:"api/types/replacement.go"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/issues/3492",children:"https://github.com/kubernetes-sigs/kustomize/issues/3492"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"vars -> replacements"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/issues/2052#issuecomment-1411757485",children:"https://github.com/kubernetes-sigs/kustomize/issues/2052#issuecomment-1411757485"})}),"\n"]}),"\n",(0,i.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(n.h2,{id:"accumulating-resources-accumulation-errmerging-resources-from-resyaml-may-not-add-resource-with-an-already-registered-id",children:"accumulating resources: accumulation err='merging resources from 'res.yaml': may not add resource with an already registered id"}),"\n",(0,i.jsx)(n.p,{children:"\u68c0\u67e5\u662f\u5426\u5df2\u7ecf\u5b9a\u4e49\u8fc7\u8d44\u6e90"}),"\n",(0,i.jsx)(n.h2,{id:"index-out-of-range-4-with-length-4",children:"index out of range [4] with length 4"}),"\n",(0,i.jsx)(n.p,{children:"YAML \u8bed\u6cd5\u53ef\u80fd\u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u6709 CJK \u53ef\u80fd\u4f1a\u5bfc\u81f4\u8fd9\u4e2a\u5f02\u5e38"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kustomize/issues/3778",children:"kubernetes-sigs/kustomize#3778"})," - Can not add any comment in .yaml\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"go-yaml \u5305\u7248\u672c\u95ee\u9898"}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},3354:(e,n,s)=>{var i=s(50959),t=Symbol.for("react.element"),r=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,s){var i,r={},c=null,d=null;for(i in void 0!==s&&(c=""+s),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(d=n.ref),n)l.call(n,i)&&!o.hasOwnProperty(i)&&(r[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps)void 0===r[i]&&(r[i]=n[i]);return{$$typeof:t,type:e,key:c,ref:d,props:r,_owner:a.current}}n.Fragment=r,n.jsx=c,n.jsxs=c},11527:(e,n,s)=>{e.exports=s(3354)},47214:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>l});var i=s(50959);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);