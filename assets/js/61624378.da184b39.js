/*! For license information please see 61624378.da184b39.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[92953],{12529:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var l=s(11527),t=s(47214);const r={title:"Alpine local backup"},c="Alpine local backup",i={id:"os/alpine/alpine-lbu",title:"Alpine local backup",description:"- lbu - Alpine local backup",source:"@site/../notes/os/alpine/alpine-lbu.md",sourceDirName:"os/alpine",slug:"/os/alpine/lbu",permalink:"/notes/os/alpine/lbu",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/os/alpine/alpine-lbu.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1692169664,formattedLastUpdatedAt:"Aug 16, 2023",frontMatter:{title:"Alpine local backup"},sidebar:"docs",previous:{title:"Alpine \u5165\u95e8",permalink:"/notes/os/alpine/intro"},next:{title:"Alpine \u8fd0\u7ef4\u7b14\u8bb0",permalink:"/notes/os/alpine/ops"}},o={},d=[{value:"lbu.conf",id:"lbuconf",level:2},{value:"rootfs.apkvol",id:"rootfsapkvol",level:2},{value:"restore from apkvol",id:"restore-from-apkvol",level:2}];function a(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.a)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h1,{id:"alpine-local-backup",children:"Alpine local backup"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["lbu - ",(0,l.jsx)(e.a,{href:"https://wiki.alpinelinux.org/wiki/Alpine_local_backup",children:"Alpine local backup"})]}),"\n",(0,l.jsx)(e.li,{children:"apkvol.tar.gz"}),"\n"]}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"diskless \u5b89\u88c5\u5fc5\u5907 - commit \u4fee\u6539\u5230\u5916\u90e8 media"}),"\n",(0,l.jsxs)(e.li,{children:["\u9ed8\u8ba4\u53ea\u5173\u5fc3 /etc \u4e0b\u5185\u5bb9\uff0c\u4e0d\u5305\u542b ",(0,l.jsx)(e.code,{children:"/etc/init.d"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u76f8\u5f53\u4e8e\u628a\u6240\u6709 /etc \u4e0b\u7684\u5185\u5bb9\u8fdb\u884c\u5907\u4efd\u6216\u6062\u590d"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"apk fix"})," \u4f1a\u5b89\u88c5\u6240\u9700\u5305"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"abbr."}),(0,l.jsx)(e.th,{children:"command"}),(0,l.jsx)(e.th,{children:"desc"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"ci"}),(0,l.jsx)(e.td,{children:"commit"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"pkg"}),(0,l.jsx)(e.td,{children:"package"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"st"}),(0,l.jsx)(e.td,{children:"status"}),(0,l.jsx)(e.td,{children:"\u5bf9\u6bd4\u4e0a\u6b21 commit"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"ls"}),(0,l.jsx)(e.td,{children:"list"}),(0,l.jsxs)(e.td,{children:["\u53d8\u5316\u5217\u8868 - \u7c7b\u4f3c ",(0,l.jsx)(e.code,{children:"lbu status -a"}),", \u4e0e ",(0,l.jsx)(e.code,{children:"lbu package -v /dev/null"})," \u8f93\u51fa\u76f8\u540c"]})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"diff"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"inc,add"}),(0,l.jsx)(e.td,{children:"include"}),(0,l.jsxs)(e.td,{children:["\u4fee\u6539 ",(0,l.jsx)(e.code,{children:"/etc/apk/protected_paths.d/lbu.list"})]})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"ex,delete"}),(0,l.jsx)(e.td,{children:"exclude"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"lb"}),(0,l.jsx)(e.td,{children:"list-backup"}),(0,l.jsx)(e.td,{})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{}),(0,l.jsx)(e.td,{children:"revert"}),(0,l.jsxs)(e.td,{children:[(0,l.jsx)(e.strong,{children:"\u4e0d\u4f1a\u4fee\u6539\u7cfb\u7edf"})," - \u4fee\u6539\u5f53\u524d\u6d3b\u8dc3\u7684 apkvol\uff0c\u4e0b\u6b21\u542f\u52a8\u65f6\u52a0\u8f7d"]})]})]})]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# \u9ed8\u8ba4\u63a8\u8350\u914d\u7f6e\nsudo mkdir /root/config-backups/\nsudo lbu pkg /root/config-backups/\n\nlbu st -a # \u5f53\u524d\u7cfb\u7edf\u4fee\u6539\n\nmkdir backups      # \u51c6\u5907\u5907\u4efd\u76ee\u5f55\nlbu pkg -v backups # \u5907\u4efd\nls backups         # \u751f\u6210 <hostname>.apkovl.tar.gz\n\n# \u5907\u4efd\u5230\u672c\u5730\nmkdir /root/lbu-backups\nsed -ri "s@^(#\\s*)?LBU_BACKUPDIR=.*@LBU_BACKUPDIR=/root/lbu-backups@" /etc/lbu/lbu.conf\nlbu ci               # commit\nls /root/lbu-backups # <hostname>.apkovl.tar.gz\nlbu st               # \u5df2\u7ecf\u6ca1\u6709\u53d8\u5316\n\nlbu ci\nls /root/lbu-backups # \u65e7\u7684\u53d8\u6210 <hostname>.<YYYYMMDDHHmmSS>.apkovl.tar.gz\nlbu lb               # \u4f1a\u663e\u793a <hostname>.<YYYYMMDDHHmmSS>.apkovl.tar.gz\n\n# \u5224\u65ad\u662f\u5426\u6709\u4fee\u6539\n[ $(lbu st | wc -c) = 0 ] && echo No change || lbu ci -v\n\n# \u8fdc\u7a0b\u5907\u4efd\nssh root@server "lbu package -" > server.apkovl.tar.gz\nssh admin@server "sudo lbu package -" > server.apkovl.tar.gz\n# \u6062\u590d\ncat server.aplovl.tar.gz | ssh admin@server \'sudo tar -C / --numeric-owner -zxvf - > /tmp/ovlfiles\'\n\n# diff\ntar df os.apkvol.tar.gz -C / # \u6c47\u62a5\u4fee\u6539\n'})}),"\n",(0,l.jsx)(e.h2,{id:"lbuconf",children:"lbu.conf"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"/etc/lbu/lbu.conf"}),"\n",(0,l.jsx)(e.li,{children:"/etc/lbu/pre-package.d"}),"\n",(0,l.jsx)(e.li,{children:"/etc/lbu/post-package.d"}),"\n",(0,l.jsxs)(e.li,{children:["/etc/apk/protected_paths.d/lbu.list\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"+var/lib/tailscale"})," - inlcude - \u589e\u52a0\u5907\u4efd\u6587\u4ef6"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"-etc/ssh/sshd_host*"})," - exclude - \u6392\u9664\u5907\u4efd\u6587\u4ef6"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-conf",metastring:'title="lbu.conf"',children:"# -e\nDEFAULT_CIPHER=aes-256-cbc\n\n# \u5f00\u542f\u52a0\u5bc6\n# ENCRYPTION=$DEFAULT_CIPHER\n\n# \u5b58\u50a8\u7684\u5916\u90e8\u5a92\u4f53\u8bbe\u5907\n# \u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a floppy\n# LBU_MEDIA=usb\n\n# \u5b58\u50a8\u5230\u672c\u5730\u76ee\u5f55\u800c\u4e0d\u662f\u5916\u90e8 \u5a92\u4f53\n# LBU_BACKUPDIR=/root/config-backups\n\n# \u6700\u591a\u5b58\u50a8\u591a\u5c11\u5907\u4efd\n# BACKUP_LIMIT=3\n"})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u63a8\u8350"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-pre",metastring:"/etc/apk/protected_paths.d/lbu.list",children:"+var/lib/tailscale/\n-etc/ssh/ssh_host*\n\nhome/admin/.ssh\nroot/.ssh\n\n# /etc/init.d/tincd.netname\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6ce8\u610f\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684 initd \u811a\u672c - symlink \u9ed8\u8ba4\u4f1a\u590d\u5236"}),"\n",(0,l.jsxs)(e.li,{children:["\u6062\u590d\u6ce8\u610f \u4fee\u6539 rootfs UUID\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"/etc/update-extlinux.conf"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4fee\u6539\u6216\u5220\u9664 root"}),"\n",(0,l.jsxs)(e.li,{children:["\u9ed8\u8ba4 ",(0,l.jsx)(e.code,{children:"blkid -o export /dev/root"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"/etc/fstab"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4fee\u6539 UUID"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u91cd\u65b0 mkinitfs \u6216 \u4fee\u6539 ",(0,l.jsx)(e.code,{children:"/boot/extlinux.conf"})]}),"\n",(0,l.jsxs)(e.li,{children:["\u9519\u8bef\u53ef\u80fd\u5bfc\u81f4 rootfs \u53ea\u8bfb\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"sudo mount -o remount,rw /dev/vda2 /"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"rootfsapkvol",children:"rootfs.apkvol"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"curl -LO https://mirrors.aliyun.com/alpine/v3.12/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz\nmkdir -p rootfs\ntar zxf alpine-minirootfs-3.12.0-x86_64.tar.gz -C rootfs\n\ncp /etc/apk/repositories rootfs/etc/apk/\n# \u53ef\u9009 - chroot \u540e\u53ef apk add\n# echo nameserver 114.114.114.114 > rootfs/etc/resolv.conf\napk --root rootfs add alpine-conf\n\n# \u83b7\u53d6\u5230 rootfs.apkvol\nchroot rootfs/ lbu pkg rootfs.apkvol.tar.gz\nmv rootfs/rootfs.apkvol.tar.gz .\n"})}),"\n",(0,l.jsx)(e.h2,{id:"restore-from-apkvol",children:"restore from apkvol"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"tar -C / --numeric-owner -zxvf os.apkvol.tar.gz > /tmp/ovlfiles\n\napk fix                   # /etc/apk/world\nhostname -F /etc/hostname # /etc/hostname\nservice modules restart   # /etc/modules-load.d\nservice sysctl restart    # /etc/sysctl.d\nservice sshd reload       # /etc/ssh/sshd_config\n\ngrep etc/tinc/ /tmp/ovlfiles > /dev/null && service tincd restart\ngrep etc/sockd.conf /tmp/ovlfiles > /dev/null && service sockd restart\n\n# service xyz start       # start needed services\n"})})]})}function h(n={}){const{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(a,{...n})}):a(n)}},3354:(n,e,s)=>{var l=s(50959),t=Symbol.for("react.element"),r=Symbol.for("react.fragment"),c=Object.prototype.hasOwnProperty,i=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function d(n,e,s){var l,r={},d=null,a=null;for(l in void 0!==s&&(d=""+s),void 0!==e.key&&(d=""+e.key),void 0!==e.ref&&(a=e.ref),e)c.call(e,l)&&!o.hasOwnProperty(l)&&(r[l]=e[l]);if(n&&n.defaultProps)for(l in e=n.defaultProps)void 0===r[l]&&(r[l]=e[l]);return{$$typeof:t,type:n,key:d,ref:a,props:r,_owner:i.current}}e.Fragment=r,e.jsx=d,e.jsxs=d},11527:(n,e,s)=>{n.exports=s(3354)},47214:(n,e,s)=>{s.d(e,{Z:()=>i,a:()=>c});var l=s(50959);const t={},r=l.createContext(t);function c(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:c(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);