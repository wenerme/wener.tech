/*! For license information please see d6687ca3.d64169f5.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[39367],{614:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>m,frontMatter:()=>a,metadata:()=>c,toc:()=>i});var s=r(11527),d=r(47214);const a={slug:"recover-synology",title:"\u6062\u590d\u7fa4\u6656\u6570\u636e\u76d8",tags:["AlpineLinux","\u8fd0\u7ef4"]},l=void 0,c={permalink:"/story/recover-synology",editUrl:"https://github.com/wenerme/wener/edit/master/story/../story/2023/2023-05-29-recover-synology.md",source:"@site/../story/2023/2023-05-29-recover-synology.md",title:"\u6062\u590d\u7fa4\u6656\u6570\u636e\u76d8",description:"Recover Synology",date:"2023-05-29T00:00:00.000Z",formattedDate:"May 29, 2023",tags:[{label:"AlpineLinux",permalink:"/story/tags/alpine-linux"},{label:"\u8fd0\u7ef4",permalink:"/story/tags/\u8fd0\u7ef4"}],readingTime:5.3,hasTruncateMarker:!1,authors:[],frontMatter:{slug:"recover-synology",title:"\u6062\u590d\u7fa4\u6656\u6570\u636e\u76d8",tags:["AlpineLinux","\u8fd0\u7ef4"]},unlisted:!1,prevItem:{title:"\u57fa\u4e8e SNI \u5b9e\u73b0\u65e0\u611f\u5168\u5c40\u4ee3\u7406",permalink:"/story/sni-proxy"},nextItem:{title:"\u8fc1\u79fb\u963f\u91cc\u4e91 CDN \u5230 Cloudflare",permalink:"/story/migrate-aliyun-cdn-to-cf"}},t={authorsImageUrls:[]},i=[{value:"Recover Synology",id:"recover-synology",level:2},{value:"\u95ee\u9898",id:"\u95ee\u9898",level:2},{value:"\u64cd\u4f5c",id:"\u64cd\u4f5c",level:2},{value:"wrong fs type, bad option, bad superblock on /dev/mapper/vg1-volume_1",id:"wrong-fs-type-bad-option-bad-superblock-on-devmappervg1-volume_1",level:2},{value:"S.M.A.T Check",id:"smat-check",level:2},{value:"LVM Check",id:"lvm-check",level:2},{value:"mdadm check",id:"mdadm-check",level:2},{value:"BTRFS critical (device dm-1): corrupt leaf",id:"btrfs-critical-device-dm-1-corrupt-leaf",level:2},{value:"btrfs backup",id:"btrfs-backup",level:2},{value:"LV Status NOT available",id:"lv-status-not-available",level:2},{value:"WARNING: PV /dev/md127 in VG vg1 is using an old PV header, modify the VG to update.",id:"warning-pv-devmd127-in-vg-vg1-is-using-an-old-pv-header-modify-the-vg-to-update",level:2},{value:"File descriptor 63 (pipe: 111755) leaked on pvck invocation.",id:"file-descriptor-63-pipe-111755-leaked-on-pvck-invocation",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"recover-synology",children:"Recover Synology"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Recover Synology from AlpineLinux"}),"\n",(0,s.jsx)(n.li,{children:"btrfs report I/O Error"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u95ee\u9898",children:"\u95ee\u9898"}),"\n",(0,s.jsx)(n.p,{children:"\u7fa4\u6656\u7684\u76d8\u641e\u7684\u5f88\u590d\u6742"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"mdraid -> lvm -> btrfs"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u53ea\u770b\u5230 btrfs \u62a5\u9519\uff08I/O Error\uff09\uff0c\u65e0\u6cd5\u4f7f\u7528\uff0c\u6ca1\u770b\u5230\u5177\u4f53\u7684\u78c1\u76d8\u9519\u8bef\uff0c\u53ea\u80fd\u9010\u7ea7\u6392\u67e5\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u4e3b\u8981\u76ee\u7684\u662f\u6302\u8f7d btrfs \u6062\u590d\u6570\u636e\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u64cd\u4f5c",children:"\u64cd\u4f5c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"file -s /dev/sda1 # linux_raid_member\nfile -s /dev/sda2 # swap\nfile -s /dev/sda3 # \u53d1\u73b0\u662f\u7528\u7684 mdadm RAID 6\n# /dev/sda3: Linux Software RAID version 1.2 (1) UUID= name=DF:2 level=6 disks=4\n\napk add mdadm\n\nmdadm --examine --scan  # \u626b\u63cf\nmdadm --assemble --scan # \u6dfb\u52a0\ncat /proc/mdstat        # \u72b6\u6001\n\nfile -s /dev/md127 # \u53d1\u73b0\u662f LVM\n# /dev/md127: LVM2 PV (Linux Logical Volume Manager), UUID: , size: 11980386729984\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u6302\u8f7d LVM"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'apk add lvm2\n\npvscan\n# PV /dev/md127   VG vg1             lvm2 [<10.90 TiB / 604.00 MiB free]\nvgscan\n# Found volume group "vg1" using metadata type lvm2\n\nlvdisplay\nlvs\n# /dev/vg1/syno_vg_reserved_area\n# /dev/vg1/volume_1\n\nvgchange -ay vg1 # \u6fc0\u6d3b vg1\n\nfile -s /dev/vg1/volume_1 # -> /dev/mapper/vg1-volume_1\nfile -s /dev/mapper/vg1-volume_1\n# /dev/mapper/vg1-volume_1: BTRFS Filesystem label "2022.12.04-17:42:08 v42661", sectorsize 4096, nodesize 16384, leafsize 16384, UUID=, 151894196224/11979737530368 bytes used, 1 devices\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u6302\u8f7d btrfs"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apk add btrfs-progs btrfs-progs-extra\nmodprobe btrfs\n\nbtrfs device scan\nbtrfs filesystem show\n\nbtrfs check /dev/mapper/vg1-volume_1 # \u5c1d\u8bd5\u68c0\u6d4b\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ERROR: errors found in fs roots\nfound 151884984320 bytes used, error(s) found\ntotal csum bytes: 2896392\ntotal tree bytes: 127860736\ntotal fs tree bytes: 99958784\ntotal extent tree bytes: 15761408\nbtree space waste bytes: 25632487\nfile data blocks allocated: 103613448192\n referenced 103061467136\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u53d1\u73b0\u4e0d\u5c11\u95ee\u9898"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mount /dev/mapper/vg1-volume_1 /mnt # \u5c1d\u8bd5\u6302\u8f7d\n# wrong fs type, bad option, bad superblock on /dev/mapper/vg1-volume_1\n\ndmesg # \u5185\u6838\u65e5\u5fd7\u627e\u539f\u56e0\n# BTRFS critical (device dm-1): corrupt leaf\n\nmount -t btrfs -o recovery,ro /dev/mapper/vg1-volume_1 /mnt\n\nbtrfs check /dev/mapper/vg1-volume_1 --repair # \u5c1d\u8bd5\u4fee\u590d\uff0c\u4f46\u662f\u5931\u8d25\n# ERROR: failed to repair root items: I/O error\n\nbtrfs scrub start -Bf /dev/mapper/vg1-volume_1\n# btrfs rescue zero-log /dev/<device_name>\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"smartctl \u5c1d\u8bd5\u68c0\u6d4b\u786c\u76d8\u95ee\u9898"}),"\n",(0,s.jsx)(n.li,{children:"mdadm \u5c1d\u8bd5 resync"}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u65e0\u89e3, TODO"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/dev/mapper/cachedev_0 on /volume1 type btrfs (rw,nodev,relatime,ssd,synoacl,space_cache=v2,auto_reclaim_space,metadata_ratio=50,block_group_cache_tree,subvolid=256,subvol=/@syno)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"wrong-fs-type-bad-option-bad-superblock-on-devmappervg1-volume_1",children:"wrong fs type, bad option, bad superblock on /dev/mapper/vg1-volume_1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mount -t btrfs /dev/mapper/vg1-volume_1 /mnt\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"BTRFS: device label 2022.12.04-17:42:08 v42661 devid 1 transid 449145 /dev/mapper/vg1-volume_1 scanned by mount (4067)\nBTRFS info (device dm-1): using crc32c (crc32c-intel) checksum algorithm\nBTRFS info (device dm-1): using free space tree\nBTRFS critical (device dm-1): corrupt leaf: root=1 block=668844032 slot=1, invalid root flags, have 0x400000000 expect mask 0x1000000000001\nBTRFS error (device dm-1): read time tree block corruption detected on logical 668844032 mirror 1\nBTRFS critical (device dm-1): corrupt leaf: root=1 block=668844032 slot=1, invalid root flags, have 0x400000000 expect mask 0x1000000000001\nBTRFS error (device dm-1): read time tree block corruption detected on logical 668844032 mirror 2\nBTRFS error (device dm-1): open_ctree failed\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"btrfs check /dev/mapper/vg1-volume_1 --repair\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ERROR: failed to repair root items: I/O error\n"})}),"\n",(0,s.jsx)(n.h2,{id:"smat-check",children:"S.M.A.T Check"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apk add smartmontools\n\nsmartctl -t long /dev/sda\nsmartctl -t long /dev/sdb\nsmartctl -t long /dev/sdc\nsmartctl -t long /dev/sdd\n\n# \u5f88\u6162\nsmartctl -l selftest /dev/sda\nsmartctl -l selftest /dev/sdb\nsmartctl -l selftest /dev/sdc\nsmartctl -l selftest /dev/sdd\n\nsmartctl -a /dev/sda\n"})}),"\n",(0,s.jsx)(n.h2,{id:"lvm-check",children:"LVM Check"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"vgck vg1 -v\npvck /dev/md127\n"})}),"\n",(0,s.jsx)(n.h2,{id:"mdadm-check",children:"mdadm check"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"4*10T SAS \u9700\u8981\u8dd1 8h, iostat -> ~200MB/s"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mdadm --detail /dev/md127\nmdadm --action=check /dev/md127\n\n# \u67e5\u770b\u6709\u95ee\u9898\u7684\u5757\nwatch cat /sys/block/md127/md/mismatch_cnt\n# \u67e5\u770b\u8fdb\u5ea6\ncat /proc/mdstat\ncat /sys/block/md127/md/sync_action\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"md127: mismatch sector in range 713232-713240\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"echo idle > /sys/block/md127/md/sync_action # \u505c\u6b62 check\nmdadm --action=repair /dev/md127            # \u5c1d\u8bd5\u4fee\u590d - repair=resync\niostat -h                                   # write \u662f\u6709\u4fee\u590d\n\n# K/Sec\ncat /proc/sys/dev/raid/speed_limit_max\nsysctl dev.raid.speed_limit_max # 200000\nsysctl dev.raid.speed_limit_max=2000000\n\n# \u4e0d\u662f\u5e73\u6ed1\u9650\u901f\uff0c\u800c\u662f\u5e73\u5747 - \u56e0\u6b64 resync \u4e00\u4f1a\u513f\u6ee1\u901f\uff0c\u4e00\u4f1a\u513f 0\nsysctl dev.raid.speed_limit_max=100000 # \u5982\u679c\u89c9\u5f97\u4fee\u590d\u4e86\u95ee\u9898\uff0c\u53ef\u4ee5\u964d\u4f4e\u901f\u5ea6\uff0c\u7136\u540e\u5c1d\u8bd5\u7cfb\u7edf\u64cd\u4f5c\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://unix.stackexchange.com/a/531230/47774",children:"https://unix.stackexchange.com/a/531230/47774"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"btrfs-critical-device-dm-1-corrupt-leaf",children:"BTRFS critical (device dm-1): corrupt leaf"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"BTRFS error (device dm-1): read time tree block corruption detected on logical 668844032 mirror 2\nBTRFS critical (device dm-1): corrupt leaf: root=1 block=668844032 slot=1, invalid root flags, have 0x400000000 expect mask 0x1000000000001\nBTRFS error (device dm-1): read time tree block corruption detected on logical 668844032 mirror 1\nBTRFS critical (device dm-1): corrupt leaf: root=1 block=668844032 slot=1, invalid root flags, have 0x400000000 expect mask 0x1000000000001\nBTRFS error (device dm-1): read time tree block corruption detected on logical 668844032 mirror 2\nBTRFS error (device dm-1): open_ctree failed\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"btrfs check /dev/mapper/vg1-volume_1 --repair\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"[1/7] checking root items\nchecksum verify failed on 711114752 wanted 0xed010ef2 found 0xb32e10d9\nchecksum verify failed on 711114752 wanted 0xed010ef2 found 0x3a406fa5\nchecksum verify failed on 711114752 wanted 0xed010ef2 found 0xb32e10d9\nCsum didn't match\nERROR: failed to repair root items: I/O error\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"BTRFS: device label 2022.12.04-17:42:08 v42661 devid 1 transid 449145 /dev/mapper/vg1-volume_1 scanned by btrfs (22854)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"btrfs-backup",children:"btrfs backup"}),"\n",(0,s.jsx)(n.p,{children:"apk add partclone"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#btrfstune -u /dev/mapper/vg1-volume_1\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://manpages.debian.org/jessie/partclone/partclone.btrfs.8",children:"https://manpages.debian.org/jessie/partclone/partclone.btrfs.8"})}),"\n",(0,s.jsx)(n.p,{children:"noerror: Instructs dd to continue operation, ignoring all read errors\nsync: Instruct dd to fill input blocks with zeroes if there were any read errors"}),"\n",(0,s.jsx)(n.p,{children:"dd if=/dev/sda of=/dev/sdb1 bs=1MB conv=noerror,sync status=progress\n| gzip -c > backup.img.gz\ngunzip -c /PATH/TO/DRIVE/backup_image.img.gz | dd of=/dev/sda"}),"\n",(0,s.jsx)(n.h2,{id:"lv-status-not-available",children:"LV Status NOT available"}),"\n",(0,s.jsx)(n.p,{children:"\u662f\u56e0\u4e3a\u6ca1\u6709 active"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"vgchange -ay vg1\n"})}),"\n",(0,s.jsx)(n.h2,{id:"warning-pv-devmd127-in-vg-vg1-is-using-an-old-pv-header-modify-the-vg-to-update",children:"WARNING: PV /dev/md127 in VG vg1 is using an old PV header, modify the VG to update."}),"\n",(0,s.jsx)(n.p,{children:"\u4e0d\u7ba1"}),"\n",(0,s.jsx)(n.h2,{id:"file-descriptor-63-pipe-111755-leaked-on-pvck-invocation",children:"File descriptor 63 (pipe: 111755) leaked on pvck invocation."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"LVM_SUPPRESS_FD_WARNINGS=1 vgck vg1\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/btrfs.8.html",children:"btrfs.8"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/btrfs-check.8.html",children:"btrfs-check.8"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/vgchange.8.html",children:"vgchange.8"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/vgck.8.html",children:"vgck.8"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man4/md.4.html",children:"md.4"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/mdadm.8.html",children:"mdadm.8"})}),"\n",(0,s.jsxs)(n.li,{children:["BTRFS: failed to read log tree\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"btrfs rescue zero-log /dev/<devicename>"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.suse.com/support/kb/doc/?id=000018761",children:"https://www.suse.com/support/kb/doc/?id=000018761"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.cyberciti.biz/tips/linux-raid-increase-resync-rebuild-speed.html",children:"https://www.cyberciti.biz/tips/linux-raid-increase-resync-rebuild-speed.html"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"clean up"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"apk del mdadm lvm2 btrfs-progs btrfs-progs-extra\n"})})]})}function m(e={}){const{wrapper:n}={...(0,d.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},3354:(e,n,r)=>{var s=r(50959),d=Symbol.for("react.element"),a=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,t={key:!0,ref:!0,__self:!0,__source:!0};function i(e,n,r){var s,a={},i=null,o=null;for(s in void 0!==r&&(i=""+r),void 0!==n.key&&(i=""+n.key),void 0!==n.ref&&(o=n.ref),n)l.call(n,s)&&!t.hasOwnProperty(s)&&(a[s]=n[s]);if(e&&e.defaultProps)for(s in n=e.defaultProps)void 0===a[s]&&(a[s]=n[s]);return{$$typeof:d,type:e,key:i,ref:o,props:a,_owner:c.current}}n.Fragment=a,n.jsx=i,n.jsxs=i},11527:(e,n,r)=>{e.exports=r(3354)},47214:(e,n,r)=>{r.d(n,{Z:()=>c,a:()=>l});var s=r(50959);const d={},a=s.createContext(d);function l(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:l(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);