"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[10568],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return k}});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=s(n),k=a,h=m["".concat(p,".").concat(k)]||m[k]||u[k]||l;return n?r.createElement(h,o(o({ref:t},c),{},{components:n})):r.createElement(h,o({ref:t},c))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=m;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:a,o[1]=i;for(var s=2;s<l;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},81865:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return p},metadata:function(){return s},toc:function(){return c},default:function(){return m}});var r=n(22122),a=n(19756),l=(n(67294),n(3905)),o=["components"],i={id:"haproxy-conf",title:"HAProxy \u914d\u7f6e"},p=void 0,s={unversionedId:"devops/web/haproxy-conf",id:"devops/web/haproxy-conf",isDocsHomePage:!1,title:"HAProxy \u914d\u7f6e",description:"balance",source:"@site/notes/devops/web/haproxy-conf.md",sourceDirName:"devops/web",slug:"/devops/web/haproxy-conf",permalink:"/notes/devops/web/haproxy-conf",editUrl:"https://github.com/wenerme/wener/edit/master/notes/devops/web/haproxy-conf.md",version:"current",frontMatter:{id:"haproxy-conf",title:"HAProxy \u914d\u7f6e"},sidebar:"docs",previous:{title:"HAProxy",permalink:"/notes/devops/web/haproxy"},next:{title:"HAProxy Version",permalink:"/notes/devops/web/haproxy-version"}},c=[{value:"balance",id:"balance",children:[]},{value:"HAProxy \u900f\u660e\u4ee3\u7406+Traefik",id:"haproxy-\u900f\u660e\u4ee3\u7406traefik",children:[]},{value:"\u4fdd\u7559\u72b6\u6001",id:"\u4fdd\u7559\u72b6\u6001",children:[]},{value:"\u4ea4\u4e92\u547d\u4ee4",id:"\u4ea4\u4e92\u547d\u4ee4",children:[]},{value:"SNI Proxy",id:"sni-proxy",children:[]}],u={toc:c};function m(e){var t=e.components,n=(0,a.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"balance"},"balance"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.haproxy.com/documentation/hapee/latest/onepage/#4.2-balance"},"balance")),(0,l.kt)("li",{parentName:"ul"},"roundrobin",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u6839\u636e weight \u8f6e\u8bad - weight \u53ef\u52a8\u6001\u8c03\u6574"),(0,l.kt)("li",{parentName:"ul"},"\u6700\u591a 4095 server"))),(0,l.kt)("li",{parentName:"ul"},"static-rr",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u540c roundrobin \u4f46\u4e0d\u652f\u6301\u8c03\u6574 weight\uff0c\u4e0d\u9650\u5236 server \u6570\u91cf"))),(0,l.kt)("li",{parentName:"ul"},"leastconn",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u9009\u62e9\u6700\u5c11\u8fde\u63a5\u6570\u7684 server"),(0,l.kt)("li",{parentName:"ul"},"\u5728 server \u4e2d\u4f7f\u7528 rr \u5c31\u884c\u9009\u62e9 - \u652f\u6301\u52a8\u6001 weight"),(0,l.kt)("li",{parentName:"ul"},"\u9002\u7528\u4e8e\u957f\u94fe\u63a5 \uff08\u4f8b\u5982\uff1aLDAP, SQL, TSE\uff09 \u4e0d\u9002\u7528\u4e8e\u77ed\u94fe\u63a5 \uff08\u4f8b\u5982\uff1a HTTP\uff09"))),(0,l.kt)("li",{parentName:"ul"},"first",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u901a\u8fc7 server id \u987a\u5e8f\u9009\u62e9\u7b2c\u4e00\u4e2a slot - id \u9ed8\u8ba4\u4e3a server \u987a\u5e8f"),(0,l.kt)("li",{parentName:"ul"},"\u5f53 server \u8fbe\u5230 maxconn \u65f6\u9009\u62e9\u4e0b\u4e00\u4e2a - \u4f7f\u7528\u8be5\u7b97\u6cd5\u8981\u8bbe\u7f6e\u4e86 maxconn \u624d\u6709\u610f\u4e49"),(0,l.kt)("li",{parentName:"ul"},"\u8be5\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u540e\u9762\u7684 server \u6309\u9700\u542f\u52a8 - \u914d\u5408\u57fa\u7840\u8bbe\u65bd\u52a8\u6001\u63a7\u5236\u670d\u52a1\u5668\u8d77\u505c"),(0,l.kt)("li",{parentName:"ul"},"\u5ffd\u7565 weight\uff0c\u66f4\u9002\u7528\u4e8e\u957f\u94fe\u63a5"),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"http-check send-state")," \u544a\u77e5\u670d\u52a1\u5668\u8d1f\u8f7d"))),(0,l.kt)("li",{parentName:"ul"},"source",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u901a\u8fc7 IP hash \u53d6\u6a21\u9009\u62e9 server"),(0,l.kt)("li",{parentName:"ul"},"\u4fee\u6539 server \u6570\u91cf\u4f1a\u5f71\u54cd\u9009\u53d6\u7ed3\u679c - server up\u3001down \u4e5f\u4f1a\u5f71\u54cd"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"))),(0,l.kt)("li",{parentName:"ul"},"uri",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"URL hash \u53d6\u6a21\u9009\u62e9 server"),(0,l.kt)("li",{parentName:"ul"},"URL \u4f7f\u7528\u8def\u5f84 ",(0,l.kt)("inlineCode",{parentName:"li"},"?")," \u524d\u9762\u90e8\u5206\uff0c\u53ef\u6307\u5b9a\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"whole")," \u4f7f\u7528\u6240\u6709"),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u589e\u52a0\u7f13\u5b58\u547d\u4e2d\uff0c\u53ea\u9002\u7528\u4e8e HTTP \u540e\u7aef"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"),(0,l.kt)("li",{parentName:"ul"},"\u53c2\u6570",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"len - \u622a\u53d6\u957f\u5ea6"),(0,l.kt)("li",{parentName:"ul"},"depth - \u76ee\u5f55\u6df1\u5ea6"))))),(0,l.kt)("li",{parentName:"ul"},"url_param",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528 HTTP GET \u8bf7\u6c42\u4e0a\u7684 URL \u53c2\u6570"),(0,l.kt)("li",{parentName:"ul"},"\u672a\u627e\u5230\u53c2\u6570\u5219\u4f7f\u7528 rr"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"),(0,l.kt)("li",{parentName:"ul"},"\u53c2\u6570",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"check_post - \u9488\u5bf9 POST \u4e5f\u68c0\u6d4b"))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"hdr(<name>)"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528 HTTP \u5934 ",(0,l.kt)("inlineCode",{parentName:"li"},"<name>")," - \u5927\u5c0f\u5199\u4e0d\u654f\u611f\uff0c\u4e0d\u5b58\u5728\u5219\u4f7f\u7528 rr"),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type"),(0,l.kt)("li",{parentName:"ul"},"\u53c2\u6570",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"use_domain_only - HASH \u57df\u540d\uff0c\u4e5f\u5c31\u662f ",(0,l.kt)("inlineCode",{parentName:"li"},"Host")," \u5934"))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"random"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"random(<draws>)"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u968f\u673a\u6570\uff0c\u4e00\u81f4\u6027 hash - weight \u52a8\u6001"),(0,l.kt)("li",{parentName:"ul"},"\u9002\u7528\u4e8e server \u6570\u91cf\u591a\u4e14\u9891\u7e41\u52a0\u51cf\u573a\u666f - \u6bd4 roundrobin \u548c leastconn \u5f71\u54cd\u66f4\u5c0f"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"<draws>")," - number of draws before selecting the least loaded of these servers",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 2"))),(0,l.kt)("li",{parentName:"ul"},"\u53c2\u6570",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"hash-balance-factor",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u53ef\u589e\u5f3a\u516c\u5e73\u6027"))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"http://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf"},"Power of Two Random Choices")))),(0,l.kt)("li",{parentName:"ul"},"rdp-cookie, ",(0,l.kt)("inlineCode",{parentName:"li"},"rdp-cookie(<name>)"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"name \u9ed8\u8ba4 ",(0,l.kt)("inlineCode",{parentName:"li"},"mstshash")),(0,l.kt)("li",{parentName:"ul"},"\u9700\u8981 ",(0,l.kt)("inlineCode",{parentName:"li"},"tcp-request content accept")," + ",(0,l.kt)("inlineCode",{parentName:"li"},"req_rdp_cookie_cnt")),(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u9759\u6001 weight \u65e0\u6548\uff0c\u53ef\u914d\u7f6e hash-type")))),(0,l.kt)("h2",{id:"haproxy-\u900f\u660e\u4ee3\u7406traefik"},"HAProxy \u900f\u660e\u4ee3\u7406+Traefik"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.haproxy.com/blog/haproxy/proxy-protocol"},"haproxy/proxy-protocol")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.haproxy.org/download/2.2/doc/proxy-protocol.txt"},"proxy-protocol.txt")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.traefik.io/routing/entrypoints/#proxyprotocol"},"traefik proxy protocol")),(0,l.kt)("li",{parentName:"ul"},"\u53c2\u8003",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://stackoverflow.com/a/57503161/1870054"},"HAProxy tcp mode source client ip")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://yq.aliyun.com/articles/492367"},"Haproxy\u5168\u900f\u660e\u4ee3\u7406"))))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-haproxy"},"global\n  log /dev/log    local0\n  log /dev/log    local1 notice\n  chroot /var/lib/haproxy\n  # \u5e38\u89c1\u4f4d\u7f6e\n  # /run/haproxy/admin.sock\n  # /var/run/haproxy.sock\n  stats socket /var/lib/haproxy/stats mode 660 level admin\n  # stats socket ipv4@192.168.0.1:9999 level admin\n  stats timeout 30s\n  user haproxy\n  group haproxy\n  daemon\n\ndefaults\n  log global\n  retries 2\n  option  dontlognull\n  timeout connect 10000\n  timeout server 600000\n  timeout client 600000\n\nfrontend https\n  bind 0.0.0.0:443\n  default_backend https\n\nbackend https\n  mode tcp\n  balance roundrobin\n  option tcp-check\n  # traefik \u540e\u7aef\u4e5f\u652f\u6301 proxy \u534f\u8bae\n  server traefik 192.168.128.5:9443 check fall 3 rise 2 send-proxy\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\niptables -t mangle -N DIVERT\niptables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT\niptables -t mangle -A DIVERT -j MARK --set-mark 222\niptables -t mangle -A DIVERT -j ACCEPT\nip rule add fwmark 222 lookup 100\nip route add local 0.0.0.0/0 dev lo table 100\n\n# \u5141\u8bb8ip\u8f6c\u53d1\necho 1 > /proc/sys/net/ipv4/conf/all/forwarding\n\n# \u8bbe\u7f6e\u677e\u6563\u9006\u5411\u8def\u5f84\u8fc7\u6ee4\necho 2 > /proc/sys/net/ipv4/conf/default/rp_filter\necho 2 > /proc/sys/net/ipv4/conf/all/rp_filter\necho 0 > /proc/sys/net/ipv4/conf/enp0s8/rp_filter\n\n# \u5141\u8bb8ICMP\u91cd\u5b9a\u5411\necho 1 > /proc/sys/net/ipv4/conf/all/send_redirects\necho 1 > /proc/sys/net/ipv4/conf/enp0s8/send_redirects\n")),(0,l.kt)("h2",{id:"\u4fdd\u7559\u72b6\u6001"},"\u4fdd\u7559\u72b6\u6001"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4e0d\u4f1a\u4fdd\u7559\u7edf\u8ba1\u4fe1\u606f")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"global\n  # \u72b6\u6001\u6587\u4ef6\n  server-state-file /var/lib/haproxy/server-state\n  stats socket /var/lib/haproxy/stats\n\ndefaults\n  # \u52a0\u8f7d\u7edf\u8ba1\n  load-server-state-from-file global\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# \u4fdd\u7559\u72b6\u6001\necho "show servers state" | socat /var/lib/haproxy/stats stdio > /var/lib/haproxy/server-state\n')),(0,l.kt)("h2",{id:"\u4ea4\u4e92\u547d\u4ee4"},"\u4ea4\u4e92\u547d\u4ee4"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://cbonte.github.io/haproxy-dconv/2.2/management.html#9.3"},"Unix Socket commands"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# \u811a\u672c\u4e00\u6b21\u6267\u884c\n# socat \u53ef\u80fd\u9700\u8981 sudo\necho "show info;show stat;show table" | socat /var/lib/haproxy/stats stdio\n# \u4ea4\u4e92\u5f0f\nsocat /var/lib/haproxy/stats readline\n# prompt\n')),(0,l.kt)("h2",{id:"sni-proxy"},"SNI Proxy"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/"},"http://blog.haproxy.com/2012/04/13/enhanced-ssl-load-balancing-with-server-name-indication-sni-tls-extension/")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.liip.ch/en/blog/haproxy-selective-tls-termination"},"HAProxy selective TLS termination"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ini"},"backend bk_ssl\n  mode tcp\n  no option checkcache\n  no option httpclose\n  tcp-request inspect-delay 5s\n  tcp-request content accept if { req.ssl_hello_type 1 }\n  tcp-request content reject\n  use-server server1 if { req.ssl_sni -m beg app1. }\n  server server1 server1:8443 check id 1 weight 0\n")),(0,l.kt)("p",null,"-m end\nuse_backend apache if { ssl_fc_sni_end domain.com }"),(0,l.kt)("p",null,"hdr(host)\nhdr_end(host) -i .wener.me\nhdr_beg(host) -i .wener.me"))}m.isMDXComponent=!0}}]);