/*! For license information please see 30933f7a.9b6b9e2b.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[82200],{51272:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>c});var s=r(2488),i=r(62780);const t={title:"Terraform"},l="Terraform",a={id:"devops/infra/terraform/README",title:"Terraform",description:"- opentofu/opentofu",source:"@site/../notes/devops/infra/terraform/README.md",sourceDirName:"devops/infra/terraform",slug:"/devops/infra/terraform/",permalink:"/notes/devops/infra/terraform/",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/infra/terraform/README.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1696577752,formattedLastUpdatedAt:"Oct 6, 2023",frontMatter:{title:"Terraform"},sidebar:"docs",previous:{title:"Pulumi",permalink:"/notes/devops/infra/pulumi"},next:{title:"Terraform Awesome",permalink:"/notes/devops/infra/terraform/awesome"}},o={},c=[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"terraformrc",id:"terraformrc",level:2},{value:"\u53d8\u91cf",id:"\u53d8\u91cf",level:2},{value:"\u540e\u7aef",id:"\u540e\u7aef",level:2},{value:"GitLab Terraform State Backend",id:"gitlab-terraform-state-backend",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,i.M)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"terraform",children:"Terraform"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/opentofu/opentofu",children:"opentofu/opentofu"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"OpenTofu"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.terraform.io/docs/configuration/functions.html",children:"functions"})}),"\n",(0,s.jsxs)(e.li,{children:["\u6a21\u677f\u8bed\u6cd5 ",(0,s.jsx)(e.a,{href:"https://www.terraform.io/docs/configuration/expressions.html#string-templates",children:"string-templates"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://www.terraform.io/docs/provisioners/index.html",children:"Provisioners"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u672c\u5730\u6216\u8fdc\u7a0b\u670d\u52a1\u5668\u6267\u884c\u7279\u5b9a\u52a8\u4f5c"}),"\n",(0,s.jsx)(e.li,{children:"\u7528\u4e8e\u51c6\u5907\u670d\u52a1\u6216\u5176\u4ed6\u57fa\u7840\u8bbe\u65bd\u5bf9\u8c61"}),"\n",(0,s.jsx)(e.li,{children:"\u4e0d\u5efa\u8bae\u4f7f\u7528\uff0c\u4f5c\u4e3a\u6700\u540e\u7684\u65b9\u5f0f"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u6ce8\u610f\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Provider configurations can be defined only in a root Terraform module."}),"\n",(0,s.jsxs)(e.li,{children:["\u88ab\u8c03\u7528\u6a21\u5757\u4e0d\u80fd\u5b9a\u4e49 ",(0,s.jsx)(e.code,{children:"provider"})]}),"\n",(0,s.jsxs)(e.li,{children:["0.10 \u65e7\u7684\u6a21\u5757\u4e0d\u652f\u6301 ",(0,s.jsx)(e.code,{children:"for_each"}),", ",(0,s.jsx)(e.code,{children:"count"}),", ",(0,s.jsx)(e.code,{children:"depends_on"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u79fb\u9664 ",(0,s.jsx)(e.code,{children:"provider"})," \u4e4b\u524d\u786e\u4fdd\u6240\u6709\u8d44\u6e90\u5220\u9664"]}),"\n",(0,s.jsx)(e.li,{children:"\u6a21\u5757\u4f1a\u96c6\u6210\u9ed8\u8ba4 provider - \u6ca1\u6709\u522b\u540d\u7684 provider"}),"\n",(0,s.jsxs)(e.li,{children:["\u5982\u679c\u53d1\u73b0\u7f51\u7edc\u4e0d\u901a\uff0c\u786e\u4fdd\u672c\u5730\u53ef\u4ee5\u6253\u5f00 ",(0,s.jsx)(e.a,{href:"https://registry.terraform.io/.well-known/terraform.json",children:"https://registry.terraform.io/.well-known/terraform.json"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u8f6c\u6362\u51fd\u6570\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"yamldecode"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u540e\u7aef\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"local - \u672c\u5730\u5b58\u50a8 terraform.tfstate"}),"\n",(0,s.jsx)(e.li,{children:"remote - Terraform Enterprise"}),"\n",(0,s.jsx)(e.li,{children:"artifactory - \u65e0\u9501"}),"\n",(0,s.jsx)(e.li,{children:"consul"}),"\n",(0,s.jsx)(e.li,{children:"etcdv3"}),"\n",(0,s.jsx)(e.li,{children:"http - \u53ef\u9009\u9501 - REST \u63a5\u53e3"}),"\n",(0,s.jsx)(e.li,{children:"kubernetes - secret \u9650\u5236\u4e86\u6700\u5927 1MB - \u4e0d\u5efa\u8bae\u4f7f\u7528"}),"\n",(0,s.jsx)(e.li,{children:"\u963f\u91cc\u4e91 oss\u3001\u817e\u8baf\u4e91 cos"}),"\n",(0,s.jsx)(e.li,{children:"pg"}),"\n",(0,s.jsx)(e.li,{children:"s3 - DynamoDB \u652f\u6301\u9501"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# \u65e5\u5fd7\nTF_LOG=1 terraform apply\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  backend "local" {}\n\n  # experiments = [example]\n\n  required_providers {\n    # aws = ">= 2.7.0"\n\n    aws = {\n      version = ">= 2.7.0"\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"terraformrc",children:"terraformrc"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.terraform.io/docs/commands/cli-config.html",children:"https://www.terraform.io/docs/commands/cli-config.html"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat <<HCL > ~/.terraformrc\nplugin_cache_dir   = "$HOME/.terraform.d/plugin-cache"\ndisable_checkpoint = true\n\nprovider_installation {\n  filesystem_mirror {\n    path    = "$HOME/.terraform.d/plugins"\n    include = ["terraform.wener.me/*/*","registry.terraform.io/*/*"]\n  }\n}\nHCL\n\nmkdir -p $HOME/.terraform.d/plugin-cache $HOME/.terraform.d/plugins\n\n# \u5728 tf \u9879\u76ee\u4e0b\u8fd0\u884c\nterraform providers mirror ~/.terraform.d/plugins\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u53d8\u91cf",children:"\u53d8\u91cf"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u8f93\u5165\u53d8\u91cf\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.strong,{children:"\u4f7f\u7528\u53d8\u91cf\u5fc5\u987b\u5148\u5b9a\u4e49\u53d8\u91cf"})}),"\n",(0,s.jsxs)(e.li,{children:["\u8bfb\u53d6\u987a\u5e8f\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u73af\u5883\u53d8\u91cf"}),"\n",(0,s.jsxs)(e.li,{children:["\u53d8\u91cf\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"terraform.tfvars"})," ",(0,s.jsx)(e.code,{children:"terraform.tfvars.json"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"HCL \u6216 JSON"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u53d8\u91cf\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"*.auto.tfvars"})," ",(0,s.jsx)(e.code,{children:"*.auto.tfvars.json"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u53c2\u6570 ",(0,s.jsx)(e.code,{children:"-var"}),", ",(0,s.jsx)(e.code,{children:"-var-file"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u4f1a\u68c0\u6d4b\u73af\u5883\u53d8\u91cf\uff0c\u4f8b\u5982 ",(0,s.jsx)(e.code,{children:"name"})," \u5219\u4f1a\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"TF_VAR_name"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u672c\u5730\u53d8\u91cf\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u76f4\u63a5\u5199\u5728\u6587\u4ef6\u91cc\u7684\u53d8\u91cf"}),"\n",(0,s.jsx)(e.li,{children:"\u53ef\u91cd\u590d\u4f7f\u7528"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u8f93\u51fa\u53d8\u91cf\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u7c7b\u4f3c\u4e8e\u4e00\u4e2a\u6a21\u5757\u7684\u8fd4\u56de\u503c"}),"\n",(0,s.jsx)(e.li,{children:"\u5b50\u6a21\u5757\u53ef\u901a\u8fc7\u8f93\u51fa\u53d8\u91cf\u66b4\u9732\u4fe1\u606f\u7ed9\u4e0a\u7ea7"}),"\n",(0,s.jsx)(e.li,{children:"root \u6a21\u5757\u53ef\u8f93\u51fa\u5230\u547d\u4ee4\u884c"}),"\n",(0,s.jsxs)(e.li,{children:["\u5f53\u4f7f\u7528\u8fdc\u7a0b\u72b6\u6001\u65f6\uff0croot \u6a21\u5757\u8f93\u51fa\u53d8\u91cf\u80fd\u591f\u88ab\u5176\u4ed6\u914d\u7f6e\u8bbf\u95ee\u5230\uff0c ",(0,s.jsx)(e.code,{children:"terraform_remote_state"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  # \u5f00\u542f\u53d8\u91cf\u6821\u9a8c\n  experiments = [variable_validation]\n}\n\nvariable "gitlab_token" {\n  # \u7b80\u5355\u7c7b\u578b\n  # string number bool\n  # \u590d\u6742\u7c7b\u578b\n  # list(<TYPE>) set(<TYPE>) map(<TYPE>) object({<ATTR NAME> = <TYPE>, ... }) tuple([<TYPE>, ...])\n  type = string\n  # default = \'\'\n  description = "token for gitlab access"\n\n  validation {\n    condition     = length(var.gitlab_token) > 0 && substr(var.gitlab_token, 0, 4) == "ami-"\n    # condition     = can(regex("^ami-", var.image_id))\n    error_message = "Invalid token"\n  }\n}\nprovider "gitlab" {\n  token = var.gitlab_token\n}\n\n# \u672c\u5730\u53d8\u91cf\nlocals {\n  service_name = "forum"\n  owner        = "Community Team"\n\n  instance_ids = concat(aws_instance.blue.*.id, aws_instance.green.*.id)\n\n  # \u901a\u8fc7 local.common_tags \u65b9\u5f0f\u5f15\u7528\n  common_tags = {\n    Service = local.service_name\n    Owner   = local.owner\n  }\n}\n\n# \u8f93\u51fa\u53d8\u91cf\noutput "instance_ip_addr" {\n  value = aws_instance.server.private_ip\n}\n\noutput "db_password" {\n  value       = aws_db_instance.db.password\n  description = "The password for logging in to the database."\n  sensitive   = true\n}\n\noutput "instance_ip_addr" {\n  value       = aws_instance.server.private_ip\n  description = "The private IP address of the main server instance."\n\n  depends_on = [\n    # Security group rule must be created before this IP address could\n    # actually be used, otherwise the services will be unreachable.\n    aws_security_group_rule.local_access,\n  ]\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u540e\u7aef",children:"\u540e\u7aef"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Enhanced - \u53ef\u5b58\u50a8\u72b6\u6001\u548c\u6267\u884c\u64cd\u4f5c\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"local, remote"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["Standard - \u8fdc\u7a0b\u5b58\u50a8\uff0c\u4f9d\u8d56 local \u6267\u884c\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"consul, etcd, etcdv3"}),"\n",(0,s.jsx)(e.li,{children:"artifactory, pg, swift, http"}),"\n",(0,s.jsx)(e.li,{children:"azurerm, gcs, cos, oss, manta"}),"\n",(0,s.jsxs)(e.li,{children:["s3\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u901a\u8fc7 Dynamo DB \u53ef\u652f\u6301 locking \u548c \u4e00\u81f4\u6027\u68c0\u67e5"}),"\n",(0,s.jsx)(e.li,{children:"\u5efa\u8bae\u5f00\u542f\u7248\u672c"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["kubernetes - \u5b58\u50a8\u4e3a secret, \u6700\u591a 1MB \u9650\u5236\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"tfstate-{workspace}-{secret_suffix}"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u7279\u6027\u652f\u6301\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://www.terraform.io/docs/language/state/locking.html",children:"State Locking"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u907f\u514d\u5e76\u53d1\u64cd\u4f5c"}),"\n",(0,s.jsx)(e.li,{children:"remote, sql, s3+dynamo, kubernetes"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-hcl",children:'terraform {\n  backend "kubernetes" {\n    # tfstate-{workspace}-state\n    secret_suffix = "state"\n    # ~/.kube/config\n    load_config_file = true\n    config_context = "demo"\n    # \u9ed8\u8ba4\u4f7f\u7528 context \u5173\u8054 ns\n    namespace = "demo"\n  }\n\n  # remote\n  backend "http" {\n  }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"gitlab-terraform-state-backend",children:"GitLab Terraform State Backend"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'STATE_NAME=staging\nPROJECT_ID=\nUSERNAME=\nPTA=\nterraform init \\\n    -backend-config="address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME" \\\n    -backend-config="lock_address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME/lock" \\\n    -backend-config="unlock_address=https://gitlab.com/api/v4/projects/$PROJECT_ID/terraform/state/$STATE_NAME/lock" \\\n    -backend-config="username=$USERNAME" \\\n    -backend-config="password=$PTA" \\\n    -backend-config="lock_method=POST" \\\n    -backend-config="unlock_method=DELETE" \\\n    -backend-config="retry_wait_min=5"\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest\n\nvariables:\n  TF_ROOT: ${CI_PROJECT_DIR}/environments/example/production\n  TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/example-production\n\ncache:\n  key: example-production\n  paths:\n    - ${TF_ROOT}/.terraform\n\nbefore_script:\n  - cd ${TF_ROOT}\n\nstages:\n  - prepare\n  - validate\n  - build\n  - deploy\n\ninit:\n  stage: prepare\n  script:\n    - gitlab-terraform init\n\nvalidate:\n  stage: validate\n  script:\n    - gitlab-terraform validate\n\nplan:\n  stage: build\n  script:\n    - gitlab-terraform plan\n    - gitlab-terraform plan-json\n  artifacts:\n    name: plan\n    paths:\n      - ${TF_ROOT}/plan.cache\n    reports:\n      terraform: ${TF_ROOT}/plan.json\n\napply:\n  stage: deploy\n  environment:\n    name: production\n  script:\n    - gitlab-terraform apply\n  dependencies:\n    - plan\n  when: manual\n  only:\n    - master\n"})})]})}function h(n={}){const{wrapper:e}={...(0,i.M)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},38088:(n,e,r)=>{var s=r(96651),i=Symbol.for("react.element"),t=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(n,e,r){var s,t={},c=null,d=null;for(s in void 0!==r&&(c=""+r),void 0!==e.key&&(c=""+e.key),void 0!==e.ref&&(d=e.ref),e)l.call(e,s)&&!o.hasOwnProperty(s)&&(t[s]=e[s]);if(n&&n.defaultProps)for(s in e=n.defaultProps)void 0===t[s]&&(t[s]=e[s]);return{$$typeof:i,type:n,key:c,ref:d,props:t,_owner:a.current}}e.Fragment=t,e.jsx=c,e.jsxs=c},2488:(n,e,r)=>{n.exports=r(38088)},62780:(n,e,r)=>{r.d(e,{I:()=>a,M:()=>l});var s=r(96651);const i={},t=s.createContext(i);function l(n){const e=s.useContext(t);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);