/*! For license information please see 88a3b7e0.4bb41de8.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[69819],{62698:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>o,frontMatter:()=>r,metadata:()=>d,toc:()=>h});var s=i(11527),l=i(47214);const r={title:"CNI"},t="CNI",d={id:"devops/container/cni",title:"CNI",description:"- \u662f\u4ec0\u4e48\uff1f",source:"@site/../notes/devops/container/cni.md",sourceDirName:"devops/container",slug:"/devops/container/cni",permalink:"/notes/devops/container/cni",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/container/cni.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1652772118,formattedLastUpdatedAt:"May 17, 2022",frontMatter:{title:"CNI"},sidebar:"docs",previous:{title:"buildkit",permalink:"/notes/devops/container/buildkit"},next:{title:"colima",permalink:"/notes/devops/container/colima"}},c={},h=[{value:"spec",id:"spec",level:2},{value:"bridge",id:"bridge",level:2},{value:"Windows",id:"windows",level:2},{value:"error while GETHNSNewtorkByName(mynet): hnsCall failed in Win32: The specified module could not be found. (0x7e)",id:"error-while-gethnsnewtorkbynamemynet-hnscall-failed-in-win32-the-specified-module-could-not-be-found-0x7e",level:2},{value:"failed to find plugin flannel in path /usr/libexec/cni",id:"failed-to-find-plugin-flannel-in-path-usrlibexeccni",level:2}];function a(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.a)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"cni",children:"CNI"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u662f\u4ec0\u4e48\uff1f\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u62bd\u8c61\u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\u89c4\u8303"}),"\n",(0,s.jsx)(e.li,{children:"cni-plugins \u63d0\u4f9b\u4e86\u5927\u91cf\u5b9e\u73b0"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/cni",children:"containernetworking/cni"})," - \u89c4\u8303"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/plugins",children:"containernetworking/plugins"})," - \u53c2\u8003\u5b9e\u73b0\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://pkgs.alpinelinux.org/contents?branch=edge&name=cni-plugins&arch=x86_64&repo=community",children:"\u5305\u5185\u5bb9"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["alpine \u9ed8\u8ba4\u5b89\u88c5\u8def\u5f84 ",(0,s.jsx)(e.code,{children:"/usr/libexec/cni/"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u9ed8\u8ba4\u7f51\u7edc\u914d\u7f6e\u76ee\u5f55 ",(0,s.jsx)(e.code,{children:"/etc/cni/net.d"})]}),"\n",(0,s.jsxs)(e.li,{children:["CNI \u5305\u542b\u4e86\u542f\u52a8\u811a\u672c - ",(0,s.jsx)(e.a,{href:"https://github.com/containernetworking/cni/tree/master/scripts",children:"cni/scripts"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u64cd\u4f5c netns - ",(0,s.jsx)(e.code,{children:"ip netns"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"exec-plugins add|del CNI_CONTAINERID CNI_NETNS"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["CNI_CONTAINERID - \u5bb9\u5668 ID\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u552f\u4e00\u6807\u793a\u76ee\u7684\uff0c\u53ef\u4ee5\u968f\u673a\u751f\u6210"}),"\n",(0,s.jsx)(e.li,{children:"docker \u53ef\u76f4\u63a5\u4f7f\u7528 \u5bb9\u5668 ID"}),"\n",(0,s.jsxs)(e.li,{children:["\u4f8b\u5982 ",(0,s.jsx)(e.code,{children:"printf '%x%x%x%x' $RANDOM $RANDOM $RANDOM $RANDOM"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["CNI_NETNS - \u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u8def\u5f84\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"/proc/<pid>/ns/net"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/flannel-io/flannel",children:"flannel-io/flannel"})}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"warning",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["cni-plugins v1 \u4e4b\u540e\u4e0d\u5305\u542b flannel - AlpineLinux 3.15\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["apk add flannel -X ",(0,s.jsx)(e.a,{href:"https://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing",children:"https://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Type"}),(0,s.jsx)(e.th,{children:"Desc"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Main: \u7f51\u53e3\u521b\u5efa"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"bridge"}),(0,s.jsx)(e.td,{children:"\u521b\u5efa\u6865\u63a5\uff0c\u6dfb\u52a0\u5bbf\u4e3b\u673a\u548c\u5bb9\u5668\u7f51\u7edc\u5230\u6865\u63a5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"ipvlan"}),(0,s.jsx)(e.td,{children:"\u6dfb\u52a0 ipvlan \u5230\u5bb9\u5668"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"loopback"}),(0,s.jsx)(e.td,{children:"ip li set lo1 up"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"macvlan"}),(0,s.jsx)(e.td,{children:"\u521b\u5efa macvlan \u7ed9\u5bb9\u5668\uff0c\u8f6c\u53d1 mac \u6d41\u91cf"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"ptp"}),(0,s.jsx)(e.td,{children:"veth \u5bf9"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"vlan"}),(0,s.jsx)(e.td,{children:"\u521b\u5efa vlan"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"host-device"}),(0,s.jsx)(e.td,{children:"\u900f\u4f20\u5df2\u5b58\u5728\u8bbe\u5907"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Windows"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"win-bridge"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"win-overlay"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"IPAM: IP \u5730\u5740\u7533\u8bf7"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"dhcp"}),(0,s.jsx)(e.td,{children:"DHCP \u7533\u8bf7"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"host-local"}),(0,s.jsx)(e.td,{children:"\u7ba1\u7406\u672c\u5730\u7533\u8bf7\u5230\u7684 IP"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"static"}),(0,s.jsx)(e.td,{children:"\u4f7f\u7528\u9759\u6001\u5730\u5740"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Meta: \u5176\u4ed6\u63d2\u4ef6"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"flannel"}),(0,s.jsx)(e.td,{children:"\u57fa\u4e8e flannel \u751f\u6210\u7f51\u53e3"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"tuning"}),(0,s.jsx)(e.td,{children:"\u901a\u8fc7 sysctl \u4fee\u6539\u7f51\u53e3\u914d\u7f6e"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"portmap"}),(0,s.jsx)(e.td,{children:"\u57fa\u4e8e iptables \u7684\u7aef\u53e3\u6620\u5c04 - \u4e3b\u673a\u5730\u5740\u7aef\u53e3\u5230\u5bb9\u5668"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"bandwidth"}),(0,s.jsx)(e.td,{children:"\u8fdb\u51fa\u5e26\u5bbd\u9650\u5236"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"sbr"}),(0,s.jsx)(e.td,{children:"\u57fa\u4e8e\u6765\u6e90\u7684\u8def\u7531"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"firewall"}),(0,s.jsx)(e.td,{children:"\u57fa\u4e8e iptables \u6216 firewalld \u7684\u9632\u706b\u5899\u63a7\u5236"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"spec",children:"spec"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"add,delete,version"}),"\n",(0,s.jsx)(e.li,{children:"stdin, stdout"}),"\n",(0,s.jsx)(e.li,{children:"CNI_ARGS, CAP_ARGS"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat <<CONF > bridge.conf\n{\n  "name": "mynet",\n  "type": "bridge",\n  "ipam": {\n    "type":"host-local",\n    "subnet": "10.10.1.0/24"\n  }\n}\nCONF\nip netns add ns1\n\nCNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth2 CNI_PATH="$PWD" \\\nbridge < bridge.conf\n'})}),"\n",(0,s.jsx)(e.h2,{id:"bridge",children:"bridge"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "cniVersion": "0.3.1",\n  // \u7f51\u7edc\u540d\u5b57\n  "name": "mynet",\n  // \u7f51\u7edc\u7c7b\u578b - \u5bf9\u5e94 /usr/libexec/cni/\n  "type": "bridge",\n\n  // \u6865\u63a5\u540d\u5b57 - \u9ed8\u8ba4 cni0\n  "bridge": "cni0",\n  // \u8bbe\u7f6e\u7684 IP \u4f5c\u4e3a\u9ed8\u8ba4\u8def\u7531\n  "isDefaultGateway": false,\n  // \u8bbe\u5426\u8bbe\u7f6e\u65b0\u7684 IP \u5730\u5740\n  "forceAddress": false,\n  // \u662f\u5426\u914d\u7f6e masquerade\n  "ipMasq": false,\n  // MTU \u9ed8\u8ba4\u53d6\u51b3\u4e8e \u5185\u6838\n  "mtu": 0,\n  // hairpin \u6a21\u5f0f\n  "hairpinMode": false,\n  // IP \u5730\u5740\u7ba1\u7406 - L2 \u7f51\u7edc\n  "ipam": {\n    "type": "host-local",\n    "subnet": "10.10.0.0/16"\n  },\n  // promiscuous \u6a21\u5f0f\n  "promiscMode": false\n  // \u662f\u5426\u8bbe\u7f6e VLAN tag\n  // "vlan":0\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"windows",children:"Windows"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"win-overlay"}),"\n",(0,s.jsx)(e.li,{children:"win-bridge"}),"\n",(0,s.jsx)(e.li,{children:"host-local"}),"\n",(0,s.jsx)(e.li,{children:"flannel"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'cat <<CONF > overlay.conf\n{\n\t"name": "mynet",\n\t"type": "win-overlay",\n\t"ipMasq": true,\n\t"endpointMacPrefix": "0E-2A",\n\t"ipam": {\n\t\t"type": "host-local",\n\t\t"subnet": "10.10.0.0/16"\n\t},\n  "loopbackDSR": true,\n  "capabilites": {\n      "dns": true\n  }\n}\nCONF\n\nCNI_COMMAND=ADD CNI_CONTAINERID=ns1 CNI_NETNS=/var/run/netns/ns1 CNI_IFNAME=eth2 CNI_PATH="$PWD" \\\n./win-overlay < overlay.conf\n'})}),"\n",(0,s.jsx)(e.h2,{id:"error-while-gethnsnewtorkbynamemynet-hnscall-failed-in-win32-the-specified-module-could-not-be-found-0x7e",children:"error while GETHNSNewtorkByName(mynet): hnsCall failed in Win32: The specified module could not be found. (0x7e)"}),"\n",(0,s.jsx)(e.h2,{id:"failed-to-find-plugin-flannel-in-path-usrlibexeccni",children:"failed to find plugin flannel in path /usr/libexec/cni"}),"\n",(0,s.jsx)(e.p,{children:"cni-plugins v1 \u540e\u6ca1\u6709 flannel"})]})}function o(n={}){const{wrapper:e}={...(0,l.a)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}},3354:(n,e,i)=>{var s=i(50959),l=Symbol.for("react.element"),r=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,d=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function h(n,e,i){var s,r={},h=null,a=null;for(s in void 0!==i&&(h=""+i),void 0!==e.key&&(h=""+e.key),void 0!==e.ref&&(a=e.ref),e)t.call(e,s)&&!c.hasOwnProperty(s)&&(r[s]=e[s]);if(n&&n.defaultProps)for(s in e=n.defaultProps)void 0===r[s]&&(r[s]=e[s]);return{$$typeof:l,type:n,key:h,ref:a,props:r,_owner:d.current}}e.Fragment=r,e.jsx=h,e.jsxs=h},11527:(n,e,i)=>{n.exports=i(3354)},47214:(n,e,i)=>{i.d(e,{Z:()=>d,a:()=>t});var s=i(50959);const l={},r=s.createContext(l);function t(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);