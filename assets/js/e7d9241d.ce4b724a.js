/*! For license information please see e7d9241d.ce4b724a.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[46048],{7580:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>u,frontMatter:()=>d,metadata:()=>s,toc:()=>c});var o=r(2488),i=r(62780);const d={title:"DID"},l="Docker In Docker",s={id:"devops/docker/docker-dind",title:"DID",description:"- 2376 - tls",source:"@site/../notes/devops/docker/docker-dind.md",sourceDirName:"devops/docker",slug:"/devops/docker/dind",permalink:"/notes/devops/docker/dind",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/docker/docker-dind.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1702882608,formattedLastUpdatedAt:"Dec 18, 2023",frontMatter:{title:"DID"},sidebar:"docs",previous:{title:"credential helpers",permalink:"/notes/devops/docker/credential-helpers"},next:{title:"Dockerfile",permalink:"/notes/devops/docker/dockerfile"}},t={},c=[{value:"rootless",id:"rootless",level:2},{value:"buildx",id:"buildx",level:2},{value:"\u5b58\u5728 mtu \u95ee\u9898",id:"\u5b58\u5728-mtu-\u95ee\u9898",level:2},{value:"invalid TLS configuration: Could not load X509 key pair (cert: &quot;&quot;, key: &quot;&quot;): open : no such file or directory",id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory",level:2},{value:"could not change group /var/run/docker.sock to docker: group docker not found",id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found",level:2},{value:"libcontainerd: failed to save daemon pid to disk: process with PID 65 is still running",id:"libcontainerd-failed-to-save-daemon-pid-to-disk-process-with-pid-65-is-still-running",level:2},{value:"containerd is still running",id:"containerd-is-still-running",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.M)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"docker-in-docker",children:"Docker In Docker"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"2376 - tls"}),"\n",(0,o.jsx)(n.li,{children:"2375"}),"\n",(0,o.jsx)(n.li,{children:"cert 825d"}),"\n",(0,o.jsx)(n.li,{children:"\u624b\u52a8\u5173\u95ed tls --tls=fals --tlsverify=false"}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u6620\u5c04 sock \u5728\u91cd\u542f\u540e\u4f1a\u5931\u6548"}),"\n",(0,o.jsxs)(n.li,{children:["mtu \u6700\u597d\u8bbe\u7f6e <= 1450 - ",(0,o.jsx)(n.code,{children:"--mtu"})]}),"\n",(0,o.jsxs)(n.li,{children:["dind network create \u4e0d\u4f1a\u7ee7\u627f ",(0,o.jsx)(n.code,{children:"--mtu"})," \u53c2\u6570"]}),"\n"]})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# -e DOCKER_TLS_CERTDIR=/certs\n# /certs/ca\n# /certs/client - \u53ef\u6302\u8f7d\u7ed9\u5ba2\u6237\u7aef\n# \u4e5f\u53ef\u901a\u8fc7 sock \u6302\u8f7d\u7ed9\u5ba2\u6237\u7aef /var/run/docker.sock\n# \u8bbe\u7f6e DOCKER_TLS_CERTDIR \u4e3a\u7a7a\u5219\u7981\u7528 tls\uff0c\u7aef\u53e3\u4e3a 2375\ndocker run --rm -it \\\n  --privileged \\\n  -e DOCKER_TLS_CERTDIR='' \\\n  -v $PWD/data:/var/lib/docker \\\n  --name dind docker:dind --storage-driver overlay2\n\n# \u901a\u8fc7 HOST \u8c03\u7528\nexport DOCKER_HOST=tcp://dind:2375/\nexport DOCKER_DRIVER=overlay2\n# https://github.com/docker-library/docker/pull/166\nexport DOCKER_TLS_CERTDIR=''\n\ncurl --unix-socket /var/run/docker.sock http://localhost/images/json | jq\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh",children:"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"rootless",children:"rootless"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\u8bd5\u9a8c\u6027\u7684 rootless\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/docker-library/docker/pull/174",children:"docker-library/docker#174"})}),"\n",(0,o.jsxs)(n.li,{children:["\u8fd8\u662f\u9700\u8981 ",(0,o.jsx)(n.code,{children:"--privileged"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run -d --name docker --privileged docker:dind-rootless\n"})}),"\n",(0,o.jsx)(n.h2,{id:"buildx",children:"buildx"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"BUILDX_VERSION=v0.10.4\n\nmkdir -p ~/.docker/cli-plugins\ncurl -sSLo ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/$BUILDX_VERSION/buildx-$BUILDX_VERSION.linux-amd64\nchmod +x ~/.docker/cli-plugins/docker-buildx\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\ndocker info\n"})}),"\n",(0,o.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,o.jsx)(n.h2,{id:"\u5b58\u5728-mtu-\u95ee\u9898",children:"\u5b58\u5728 mtu \u95ee\u9898"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"curl https \u7684\u65f6\u5019 hang"}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"--mtu=1400"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory",children:'invalid TLS configuration: Could not load X509 key pair (cert: "", key: ""): open : no such file or directory'}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\u4e0d\u8981\u914d\u7f6e ",(0,o.jsx)(n.code,{children:"--tls=false --tlsverify=false"}),",\u53ef\u4ee5\u914d\u7f6e  ",(0,o.jsx)(n.code,{children:"--tls=false"})]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/moby/moby/issues/27105",children:"https://github.com/moby/moby/issues/27105"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found",children:"could not change group /var/run/docker.sock to docker: group docker not found"}),"\n",(0,o.jsxs)(n.p,{children:["\u6dfb\u52a0\u542f\u52a8\u53c2\u6570 ",(0,o.jsx)(n.code,{children:"--group=1000"})," \u6216"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dockerfile",children:"FROM docker:dind\nRUN addgroup -g 2999 docker\n"})}),"\n",(0,o.jsx)(n.h2,{id:"libcontainerd-failed-to-save-daemon-pid-to-disk-process-with-pid-65-is-still-running",children:"libcontainerd: failed to save daemon pid to disk: process with PID 65 is still running"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"rm /var/run/docker.pid\n"})}),"\n",(0,o.jsx)(n.h2,{id:"containerd-is-still-running",children:"containerd is still running"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'level=info msg="containerd not running, starting managed containerd"\nlevel=info msg="containerd is still running" module=libcontainerd pid=943\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},38088:(e,n,r)=>{var o=r(96651),i=Symbol.for("react.element"),d=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,s=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,t={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,r){var o,d={},c=null,a=null;for(o in void 0!==r&&(c=""+r),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(a=n.ref),n)l.call(n,o)&&!t.hasOwnProperty(o)&&(d[o]=n[o]);if(e&&e.defaultProps)for(o in n=e.defaultProps)void 0===d[o]&&(d[o]=n[o]);return{$$typeof:i,type:e,key:c,ref:a,props:d,_owner:s.current}}n.Fragment=d,n.jsx=c,n.jsxs=c},2488:(e,n,r)=>{e.exports=r(38088)},62780:(e,n,r)=>{r.d(n,{I:()=>s,M:()=>l});var o=r(96651);const i={},d=o.createContext(i);function l(e){const n=o.useContext(d);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),o.createElement(d.Provider,{value:n},e.children)}}}]);