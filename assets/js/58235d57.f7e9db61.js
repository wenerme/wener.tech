/*! For license information please see 58235d57.f7e9db61.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[67876],{31008:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>o});var s=t(2488),i=t(62780);const r={title:"k6"},a="k6",l={id:"dev/testing/k6",title:"k6",description:"- grafana/k6",source:"@site/../notes/dev/testing/k6.md",sourceDirName:"dev/testing",slug:"/dev/testing/k6",permalink:"/notes/dev/testing/k6",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/testing/k6.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1692169664,formattedLastUpdatedAt:"Aug 16, 2023",frontMatter:{title:"k6"},sidebar:"docs",previous:{title:"jmeter",permalink:"/notes/dev/testing/jmeter"},next:{title:"wrk",permalink:"/notes/dev/testing/wrk"}},c={},o=[{value:"context",id:"context",level:2},{value:"xk6",id:"xk6",level:2},{value:"timescaledb",id:"timescaledb",level:2},{value:"SQL",id:"sql",level:2},{value:"Setup",id:"setup",level:2},{value:"Target RPS",id:"target-rps",level:2},{value:"gracefulStop",id:"gracefulstop",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"k6",children:"k6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/grafana/k6",children:"grafana/k6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"AGPL-3.0, Golang"}),"\n",(0,s.jsx)(e.li,{children:"\u73b0\u4ee3\u5316\u538b\u6d4b\u5de5\u5177"}),"\n",(0,s.jsx)(e.li,{children:"\u4f7f\u7528 JS \u7f16\u5199\u538b\u6d4b\u903b\u8f91"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301\u975e\u5e38\u4e30\u5bcc\u7684\u63d2\u4ef6: JS \u6269\u5c55\u3001\u8f93\u51fa\u6269\u5c55"}),"\n",(0,s.jsxs)(e.li,{children:["JS \u5f15\u64ce ",(0,s.jsx)(e.a,{href:"https://github.com/dop251/goja",children:"dop251/goja"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"brew install k6\n# https://github.com/grafana/k6/releases\ncurl -LO https://github.com/grafana/k6/releases/download/v0.45.0/k6-v0.45.0-linux-amd64.tar.gz\ntar zxvf k6-v0.45.0-linux-amd64.tar.gz --strip-components 1\n./k6\n\nk6 run script.js\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:"import { check, sleep } from 'k6';\nimport http from 'k6/http';\n\nexport const options = {\n  // \u5355\u4e2a\n  vus: 10,\n  duration: '30s',\n  // or \u591a\u4e2a\u573a\u666f\n  // stages: [\n  //   { duration: '30s', target: 20 },\n  //   { duration: '1m30s', target: 10 },\n  //   { duration: '20s', target: 0 },\n  // ],\n  // \u76ee\u6807\uff0cSLO\n  thresholds: {\n    // Assert that 99% of requests finish within 3000ms.\n    http_req_duration: ['p(99) < 3000'],\n  },\n};\n\nexport default function () {\n  const res = http.get('https://wener.me');\n  check(res, { 'status was 200': (r) => r.status == 200 });\n  sleep(1);\n}\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"virtual users (VUs)"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"__ENV"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:"// 1. init code - \u6bcf\u4e2a UV \u8c03\u7528 1 \u6b21\n\nexport function setup() {\n  // 2. setup code - \u5168\u5c40\u53ea\u4f1a\u8c03\u7528 1 \u6b21\n  return {};\n}\n\n// data \u4e3a setup \u8fd4\u56de\u7ed3\u679c\nexport default function (data) {\n  // 3. VU code - \u6bcf\u6b21\u8fed\u4ee3\u8c03\u7528 1 \u6b21\n}\n\n// data \u4e3a setup \u8fd4\u56de\u7ed3\u679c\nexport function teardown(data) {\n  // 4. teardown code - \u5168\u5c40\u8c03\u7528 1 \u6b21\uff0c\u5982\u679c setup \u5931\u8d25\u5219\u4e0d\u8c03\u7528\n}\n\n// \u901a\u8fc7\u914d\u7f6e scenarios.*.exec \u6765\u6307\u5b9a\u6267\u884c\nexport function webtest() {}\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"handleSummary"}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"k6 run flags"}),(0,s.jsx)(e.th,{children:"for"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"-u,--vus INT"}),(0,s.jsx)(e.td,{children:"\u9ed8\u8ba4 1, \u865a\u62df\u7528\u6237\u6570"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"-d,--duration DURATION"}),(0,s.jsx)(e.td,{children:"\u6301\u7eed\u65f6\u95f4"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"-i,--iterations INT"}),(0,s.jsx)(e.td,{children:"\u8fed\u4ee3\u6b21\u6570"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"-s,--stage STAGE"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"[duration]:[target]"})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"--rps INT"}),(0,s.jsx)(e.td,{children:"\u9650\u5236\u6bcf\u79d2\u8bf7\u6c42\u6570"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"--http-debug"}),(0,s.jsx)(e.td,{children:"\u9ed8\u8ba4 headers, dump http request"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"--http-debug=full"}),(0,s.jsx)(e.td,{children:"\u5305\u542b body"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"context",children:"context"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"instance"}),"\n",(0,s.jsx)(e.li,{children:"scenario"}),"\n",(0,s.jsx)(e.li,{children:"vu"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:"import exec from 'k6/execution';\n\nexport default function () {\n  console.log(`Execution context\n\nInstance info\n-------------\nVus active: ${exec.instance.vusActive}\nIterations completed: ${exec.instance.iterationsCompleted}\nIterations interrupted:  ${exec.instance.iterationsInterrupted}\nIterations completed:  ${exec.instance.iterationsCompleted}\nIterations active:  ${exec.instance.vusActive}\nInitialized vus:  ${exec.instance.vusInitialized}\nTime passed from start of run(ms):  ${exec.instance.currentTestRunDuration}\n\nScenario info\n-------------\nName of the running scenario: ${exec.scenario.name}\nExecutor type: ${exec.scenario.executor}\nScenario start timestamp: ${exec.scenario.startTime}\nPercenatage complete: ${exec.scenario.progress}\nIteration in instance: ${exec.scenario.iterationInInstance}\nIteration in test: ${exec.scenario.iterationInTest}\n\nTest info\n---------\nAll test options: ${exec.test.options}\n\nVU info\n-------\nIteration id: ${exec.vu.iterationInInstance}\nIteration in scenario: ${exec.vu.iterationInScenario}\nVU ID in instance: ${exec.vu.idInInstance}\nVU ID in test: ${exec.vu.idInTest}\nVU tags: ${exec.vu.tags}`);\n}\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://k6.io/docs/using-k6/execution-context-variables/",children:"https://k6.io/docs/using-k6/execution-context-variables/"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"xk6",children:"xk6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["k6 Extensions\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Javascript"}),"\n",(0,s.jsx)(e.li,{children:"Output"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://k6.io/docs/extensions/get-started/explore/",children:"https://k6.io/docs/extensions/get-started/explore/"})}),"\n",(0,s.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/szkiba/xk6-dashboard",children:"szkiba/xk6-dashboard"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"github.com/szkiba/xk6-dashboard@latest"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"http://127.0.0.1:5665",children:"http://127.0.0.1:5665"})}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"--out dashboard=open"})," \u6253\u5f00\u6d4f\u89c8\u5668"]}),"\n",(0,s.jsx)(e.li,{children:"\u5176\u4ed6\u53c2\u6570 host,port=5665,period=20s,config=.dashboard.js"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/szkiba/xk6-top",children:"szkiba/xk6-top"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"--out top"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/szkiba/xk6-dotenv",children:"szkiba/xk6-dotenv"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"github.com/szkiba/xk6-dotenv@latest"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:".env.{development,test,production}.local"})," - $K6_ENV"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:".env.{local,development,test,production}"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:".env"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/grafana/xk6-output-timescaledb",children:"grafana/xk6-output-timescaledb"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"K6_TIMESCALEDB_PUSH_INTERVAL=1s"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/grafana/xk6-sql",children:"grafana/xk6-sql"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u538b\u6d4b SQL"}),"\n",(0,s.jsx)(e.li,{children:"PostgreSQL, MySQL, MS SQL, SQLite3"}),"\n",(0,s.jsxs)(e.li,{children:["SQLite \u9700\u8981 ",(0,s.jsx)(e.code,{children:"CGO_ENABLED=1"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/avitalique/xk6-file",children:"avitalique/xk6-file"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6587\u4ef6\u8bfb\u5199"}),"\n",(0,s.jsx)(e.li,{children:"github.com/avitalique/xk6-file@latest"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"go install go.k6.io/xk6/cmd/xk6@latest\n\nxk6 build --with github.com/grafana/xk6-output-timescaledb --with github.com/szkiba/xk6-dotenv@latest\n./k6\n\n# -o $K6_OUT\nK6_OUT=timescaledb=postgresql://k6:k6@timescaledb:5432/k6 k6 run script.js\n"})}),"\n",(0,s.jsx)(e.h2,{id:"timescaledb",children:"timescaledb"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"samples"}),"\n",(0,s.jsx)(e.li,{children:"thresholds"}),"\n",(0,s.jsxs)(e.li,{children:["K6_TIMESCALEDB_PUSH_INTERVAL=1s\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"2min \u7ea6 500 \u4e07 \u6761\u8bb0\u5f55\u30012G"}),"\n",(0,s.jsx)(e.li,{children:"\u8d8a\u957f\u4f7f\u7528\u8d8a\u591a\u5185\u5b58"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"k6 run --tag testid=SVR-$(date +%Y%m%d-%H%M)\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE IF NOT EXISTS samples (\n  ts timestamptz NOT NULL DEFAULT current_timestamp,\n  metric varchar(128) NOT NULL,\n  tags jsonb,\n  value real\n);\nCREATE TABLE IF NOT EXISTS thresholds (\n  id serial,\n  ts timestamptz NOT NULL DEFAULT current_timestamp,\n  metric varchar(128) NOT NULL,\n  tags jsonb,\n  threshold varchar(128) NOT NULL,\n  abort_on_fail boolean DEFAULT FALSE,\n  delay_abort_eval varchar(128),\n  last_failed boolean DEFAULT FALSE\n);\nSELECT create_hypertable('samples', 'ts');\nCREATE INDEX IF NOT EXISTS idx_samples_ts ON samples (ts DESC);\nCREATE INDEX IF NOT EXISTS idx_thresholds_ts ON thresholds (ts DESC);\n\n-- \u53ef\u4ee5\u8003\u8651\ncreate index samples_ts_tags_testid on samples using btree (ts, ((tags ->> 'testid'::text)));\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/grafana/xk6-output-timescaledb/blob/main/output.go",children:"https://github.com/grafana/xk6-output-timescaledb/blob/main/output.go"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/grafana/xk6-output-timescaledb/",children:"https://github.com/grafana/xk6-output-timescaledb/"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"sql",children:"SQL"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://k6.io/blog/load-testing-sql-databases-with-k6/",children:"https://k6.io/blog/load-testing-sql-databases-with-k6/"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/grafana/xk6-sql",children:"https://github.com/grafana/xk6-sql"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"setup",children:"Setup"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'sudo apk add go\nsudo chown $USER mkdir -p /data\n\nmkdir -p /data/bin\ngo env -w GOPROXY=https://goproxy.cn,direct\n\ngo install go.k6.io/xk6/cmd/xk6@latest\nGOBIN=/data/bin go install go.k6.io/xk6/cmd/xk6@latest\n\nexport PATH="/data/bin:$PATH"\n\n# CGO_ENABLED=1 for SQLite\n# --output /data/bin\nxk6 build \\\n  --with github.com/grafana/xk6-output-timescaledb \\\n  --with github.com/szkiba/xk6-dotenv \\\n  --with github.com/szkiba/xk6-dashboard \\\n  --with github.com/avitalique/xk6-file \\\n  --with github.com/szkiba/xk6-top \\\n  --with github.com/grafana/xk6-sql\n\nmv k6 /data/bin/\nmkdir -p /data/k6\ncd /data/k6\n'})}),"\n",(0,s.jsx)(e.h2,{id:"target-rps",children:"Target RPS"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:"export const options = {\n  scenarios: {\n    constant_request_rate: {\n      executor: 'constant-arrival-rate',\n      rate: 1,\n      timeUnit: '1s',\n      duration: '1m',\n      preAllocatedVUs: 20,\n      maxVUs: 100,\n    },\n    stageOne: {\n      executor: 'constant-arrival-rate',\n      duration: '5m',\n      rate: 1000000, // 1mil QPS for 5 min\n      timeUnit: '1s',\n      maxVUs: 12500, // Some number with headroom where I try to judge, given some hypothetical SUT latency, how I can reach 1mil QPS?\n    },\n    stageTwo: {\n      executor: 'constant-arrival-rate',\n      duration: '5m',\n      startTime: '5m',\n      rate: 10000000, // 10mil QPS for 5 min\n      timeUnit: '1s',\n      maxVUs: 125000, // Ditto\n    },\n    // ...\n  },\n};\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"rate+timeUnit"}),"\n",(0,s.jsx)(e.li,{children:"preAllocatedVUs, maxVUs"}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://k6.io/blog/how-to-generate-a-constant-request-rate-with-the-new-scenarios-api/",children:"https://k6.io/blog/how-to-generate-a-constant-request-rate-with-the-new-scenarios-api/"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/grafana/k6-operator/issues/120",children:"https://github.com/grafana/k6-operator/issues/120"})}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"gracefulstop",children:"gracefulStop"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://k6.io/docs/using-k6/scenarios/concepts/graceful-stop/",children:"https://k6.io/docs/using-k6/scenarios/concepts/graceful-stop/"})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,i.M)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},38088:(n,e,t)=>{var s=t(96651),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,l=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function o(n,e,t){var s,r={},o=null,d=null;for(s in void 0!==t&&(o=""+t),void 0!==e.key&&(o=""+e.key),void 0!==e.ref&&(d=e.ref),e)a.call(e,s)&&!c.hasOwnProperty(s)&&(r[s]=e[s]);if(n&&n.defaultProps)for(s in e=n.defaultProps)void 0===r[s]&&(r[s]=e[s]);return{$$typeof:i,type:n,key:o,ref:d,props:r,_owner:l.current}}e.Fragment=r,e.jsx=o,e.jsxs=o},2488:(n,e,t)=>{n.exports=t(38088)},62780:(n,e,t)=>{t.d(e,{I:()=>l,M:()=>a});var s=t(96651);const i={},r=s.createContext(i);function a(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);