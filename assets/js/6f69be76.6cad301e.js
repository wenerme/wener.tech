"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[12566],{49613:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var r=n(59496);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),k=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=k(e.components);return r.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=k(n),m=a,d=p["".concat(o,".").concat(m)]||p[m]||u[m]||l;return n?r.createElement(d,i(i({ref:t},c),{},{components:n})):r.createElement(d,i({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,i=new Array(l);i[0]=p;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var k=2;k<l;k++)i[k]=n[k];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},77407:function(e,t,n){n.r(t),n.d(t,{assets:function(){return b},contentTitle:function(){return m},default:function(){return N},frontMatter:function(){return p},metadata:function(){return d},toc:function(){return v}});var r=n(49613),a=Object.defineProperty,l=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,c=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,u=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&c(e,n,t[n]);if(s)for(var n of s(t))k.call(t,n)&&c(e,n,t[n]);return e};const p={title:"k0s"},m="k0s",d={unversionedId:"devops/kubernetes/distro/k0s/README",id:"devops/kubernetes/distro/k0s/README",title:"k0s",description:"- [k0s] \u662f\u4ec0\u4e48\uff1f",source:"@site/../notes/devops/kubernetes/distro/k0s/README.md",sourceDirName:"devops/kubernetes/distro/k0s",slug:"/devops/kubernetes/distro/k0s/",permalink:"/notes/devops/kubernetes/distro/k0s/",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k0s/README.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1675953425,formattedLastUpdatedAt:"Feb 9, 2023",frontMatter:{title:"k0s"},sidebar:"docs",previous:{title:"autok3s",permalink:"/notes/devops/kubernetes/distro/autok3s"},next:{title:"K0S FAQ",permalink:"/notes/devops/kubernetes/distro/k0s/faq"}},b={},v=[{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"File structure",id:"file-structure",level:2},{value:"k0s supervisor",id:"k0s-supervisor",level:2},{value:"k0s.yaml",id:"k0syaml",level:2},{value:"containerd.toml",id:"containerdtoml",level:2},{value:"helm crd",id:"helm-crd",level:2},{value:"openrc",id:"openrc",level:2},{value:"\u624b\u52a8\u4e0b\u8f7d\u5b89\u88c5",id:"\u624b\u52a8\u4e0b\u8f7d\u5b89\u88c5",level:2},{value:"\u73af\u5883\u76d1\u6d4b",id:"\u73af\u5883\u76d1\u6d4b",level:2}],g={toc:v};function N(e){var t,n=e,{components:a}=n,c=((e,t)=>{var n={};for(var r in e)o.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&s)for(var r of s(e))t.indexOf(r)<0&&k.call(e,r)&&(n[r]=e[r]);return n})(n,["components"]);return(0,r.kt)("wrapper",(t=u(u({},g),c),l(t,i({components:a,mdxType:"MDXLayout"}))),(0,r.kt)("h1",u({},{id:"k0s"}),"k0s"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/k0sproject/k0s"}),"k0s")," \u662f\u4ec0\u4e48\uff1f",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u7c7b\u4f3c k3s \u7684\u7cbe\u7b80 k8s",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u65e0\u7cfb\u7edf\u4f9d\u8d56 - \u9759\u6001"),(0,r.kt)("li",{parentName:"ul"},"\u65e0\u5916\u90e8\u4f9d\u8d56"))),(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301 amd64 Windows"),(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301 amd64, arm, arm64"),(0,r.kt)("li",{parentName:"ul"},"\u7f51\u7edc",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kube-router - \u9ed8\u8ba4",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u8d44\u6e90\u5360\u7528\u66f4\u5c11 - \u6bd4 calico \u5c11 15%"),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u652f\u6301 DualStack"),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u652f\u6301 Windows"))),(0,r.kt)("li",{parentName:"ul"},"calico",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 vxlan overlay"),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u652f\u6301 armv7"),(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301 DualStack"),(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301 Windowss"),(0,r.kt)("li",{parentName:"ul"},"IPv6 \u4e0d\u652f\u6301 tunnal"))))),(0,r.kt)("li",{parentName:"ul"},"etcd \u5c42\u4f7f\u7528 k3s \u7684 ",(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/k3s-io/kine"}),"k3s-io/kine")),(0,r.kt)("li",{parentName:"ul"},"\u80cc\u540e\u7531 Mirants \u516c\u53f8\u652f\u6301"),(0,r.kt)("li",{parentName:"ul"},"bin \u5305\u542b\u4e86 containerd,runc,etcd,xtables-legacy-multi"),(0,r.kt)("li",{parentName:"ul"},"\u81ea 2020 \u5e74 - \u76f8\u6bd4 k3s \u8981\u5e74\u8f7b\u4e00\u70b9")))),(0,r.kt)("h2",u({},{id:"\u5b89\u88c5"}),"\u5b89\u88c5"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6570\u636e\u76ee\u5f55 /var/lib/k0s - ",(0,r.kt)("inlineCode",{parentName:"li"},"--data-dir")),(0,r.kt)("li",{parentName:"ul"},"/etc/k0s/containerd.toml"),(0,r.kt)("li",{parentName:"ul"},"\u786e\u4fdd\u5b58\u5728 /etc/machine-id",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b89\u88c5 dbus \u4f1a\u521b\u5efa"),(0,r.kt)("li",{parentName:"ul"},"alpine openrc \u76ee\u524d\u65b0\u589e\u4e86 /etc/init.d/machine-id \u670d\u52a1"),(0,r.kt)("li",{parentName:"ul"},"denisbrodbeck/machineid ",(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/denisbrodbeck/machineid/blob/v1.0.1/README.md#what-you-get"}),"What you get"))))),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# K0S_VERSION \u63a7\u5236\u7248\u672c\n# DEBUG \u5f00\u542f set -x\n# \u4ece https://github.com/k0sproject/k0s \u4e0b\u8f7d\u5230 /usr/local/bin/k0s\n# chmod 755 /usr/local/bin/k0s\n# \u7248\u672c\u53f7\u6765\u81ea https://docs.k0sproject.io/stable.txt\ncurl -sSLf https://get.k0s.sh | sudo sh\n\n# \u547d\u4ee4\u8865\u5168\nsource <(k0s completion bash)\n# \u67e5\u770b\u7cfb\u7edf\u4fe1\u606f\nk0s sysinfo\n# \u751f\u6210\u914d\u7f6e\nmkdir -p /etc/k0s\nk0s config create > /etc/k0s/k0s.yaml\nk0s config validate --config /etc/k0s/k0s.yaml\n\n# AlpineLinux \u63a8\u8350\u4f9d\u8d56\n# \u5b98\u65b9\u8bf4\u4e0d\u9700\u8981\u4f9d\u8d56 - \u4f46\u8fd8\u662f\u5efa\u8bae\u5b89\u88c5\u8fd9\u4e9b\u57fa\u7840\u5de5\u5177\napk add conntrack-tools coreutils dbus findutils ipvsadm ipset iptables socat iproute2 nfs-utils\n\n# \u521b\u5efa /etc/init.d/k0scontroller\n# \u7528\u6237 etcd kube-apiserver konnectivity-server kube-apiserver kube-scheduler\n# \u53ef\u4fee\u6539 kublete \u53c2\u6570 - \u9ed8\u8ba4 k0s \u4f1a\u7528\u5230 k8s.gcr.io \u955c\u50cf - \u4f1a\u4e0b\u8f7d\u5931\u8d25\nk0s install controller --enable-worker -c /etc/k0s/k0s.yaml --kubelet-extra-args='--pod-infra-container-image=registry.cn-hongkong.aliyuncs.com/cmi/pause:3.5'\nid etcd kube-apiserver konnectivity-server kube-apiserver kube-scheduler\n\nk0s start\n\nk0s kubectl get nodes\nk0s kc -n kube-system get pods\n\n# \u670d\u52a1\u7ba1\u7406\n# k0s install|start|stop|reset|status\n# \u8fd0\u7ef4\n# k0s backup|restore\n# Daemon\n# k0s api|controller|worker\n# CLI\n# k0s ctr|kubectl|etcd\n\n# \u624b\u52a8\u524d\u53f0\u542f\u52a8 - \u65b9\u4fbf\u6392\u67e5\u95ee\u9898\nk0s controller --config=/etc/k0s/k0s.yaml --enable-worker=true\n\ncontainerd config default > /etc/k0s/containerd.toml\n\n# airegap\n# ==========\n# $K0S_DATA_DIR/images\n# /var/lib/k0s/images/bundle_file\n# \u7528\u5230\u7684\u955c\u50cf\nk0s airgap list-images\n# \u53ef\u76f4\u63a5\u4e0b\u8f7d\n# https://github.com/k0sproject/k0s/releases/download/v1.23.3%2Bk0s.1/k0s-airgap-bundle-v1.23.3+k0s.1-amd64\ncurl -LOC- 'https://ghproxy.com/https://github.com/k0sproject/k0s/releases/download/v1.23.3%2Bk0s.1/k0s-airgap-bundle-v1.23.3+k0s.1-amd64'\nmkdir -p /var/lib/k0s/images\ncp k0s-airgap-bundle-v1.23.3+k0s.1-amd64 /var/lib/k0s/images/bundle_file\n\n# backup\n# ==========\n# k0s_backup_<ISODatetimeString>.tar.gz\n# --save-path k0s-data\n# \u4f1a\u5907\u4efd\u8f83\u591a\u5185\u5bb9\nk0s backup\n# k0s restore\n")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-yaml"}),"apiVersion: k0s.k0sproject.io/v1beta1\nkind: ClusterConfig\nmetadata:\n  name: k0s\nspec:\n  images:\n    # airgap \u65f6\u907f\u514d pull\n    default_pull_policy: Never\n")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash",metastring:'title="worker"',title:'"worker"'}),"# \u5728 server \u6267\u884c\n# base64-encoded kubeconfig\n# k0s token create --role=worker --expiry=24h > worker-token\n# \u52a0 controller \u540c\u7406\n# k0s token create --role=controller --expiry=1h > controller-token\n\nk0s install worker --token-file /etc/k0s/worker-token --kubelet-extra-args='--pod-infra-container-image=registry.cn-hongkong.aliyuncs.com/cmi/pause:3.5'\n")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# containerd\nk0s ctr --address /run/k0s/containerd.sock\n\nk0s ctr i ls\nk0s ctr c ls\n")),(0,r.kt)("h2",u({},{id:"file-structure"}),"File structure"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kubelet.conf"),(0,r.kt)("li",{parentName:"ul"},"kubelet-config.yaml"),(0,r.kt)("li",{parentName:"ul"},"kubelet-bootstrap.conf",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u542f\u52a8 \u914d\u7f6e"),(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c worker token \u8d85\u65f6\u53ef\u5c1d\u8bd5\u5220\u9664\uff0c\u91cd\u542f\u91cd\u65b0\u521b\u5efa"))))),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/bin/",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"xtables-legacy-multi",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ip6tables, ip6tables-restore, ip6tables-save"),(0,r.kt)("li",{parentName:"ul"},"iptables-restore, iptables-save"))),(0,r.kt)("li",{parentName:"ul"},"containerd, containerd-shim, containerd-shim-runc-v1, containerd-shim-runc-v2"),(0,r.kt)("li",{parentName:"ul"},"etcd"),(0,r.kt)("li",{parentName:"ul"},"runc"),(0,r.kt)("li",{parentName:"ul"},"kube-apiserver, kube-controller-manager, kube-scheduler, kubelet"))),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/db/ - kine SQLite"),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/etcd/ - etcd \u6570\u636e\u76ee\u5f55"),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/images/bundle_file - \u79bb\u7ebf images \u5305"),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/pki/ - \u5404\u79cd\u8bc1\u4e66\u76f8\u5173\u5185\u5bb9",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"admin.conf - kubeconfig"))),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/containerd/ - containerd \u6570\u636e\u76ee\u5f55"),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/helmhome/ - HELM \u6570\u636e\u76ee\u5f55",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"repositories.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"openebs-internal -> ",(0,r.kt)("a",u({parentName:"li"},{href:"https://openebs.github.io/charts"}),"https://openebs.github.io/charts")))),(0,r.kt)("li",{parentName:"ul"},"k0s \u90e8\u7f72\u65f6\u662f\u4f7f\u7528\u7684\u8fd9\u91cc\u7684 repo"))),(0,r.kt)("li",{parentName:"ul"},"/var/lib/k0s/manifests/ - \u542f\u52a8\u90e8\u7f72\u5185\u5bb9",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"api-config"),(0,r.kt)("li",{parentName:"ul"},"calico"),(0,r.kt)("li",{parentName:"ul"},"coredns"),(0,r.kt)("li",{parentName:"ul"},"helm",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"helm-crd-helm.k0sproject.io_charts.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"CustomResourceDefinition"),(0,r.kt)("li",{parentName:"ul"},"helm.k0sproject.io/v1beta1/Chart"))),(0,r.kt)("li",{parentName:"ul"},"addon_crd_manifest_openebs.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"OpenEBS"))))),(0,r.kt)("li",{parentName:"ul"},"kubeproxy",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kube-proxy.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"KubeProxyConfiguration"),(0,r.kt)("li",{parentName:"ul"},"/run/xtables.lock"))))),(0,r.kt)("li",{parentName:"ul"},"metricserver",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"metric_server.yaml"))),(0,r.kt)("li",{parentName:"ul"},"bootstraprbac",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ClusterRoleBinding"),(0,r.kt)("li",{parentName:"ul"},"kubelet-bootstrap, node-autoapprove-bootstrap, node-autoapprove-certificate-rotation"))),(0,r.kt)("li",{parentName:"ul"},"calico_init"),(0,r.kt)("li",{parentName:"ul"},"defaultpsp",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"default-psp.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"00-k0s-privileged"),(0,r.kt)("li",{parentName:"ul"},"99-k0s-restricted"))))),(0,r.kt)("li",{parentName:"ul"},"kubelet",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kubelet-config.yaml"))),(0,r.kt)("li",{parentName:"ul"},"kuberouter",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kube-router.yaml"),(0,r.kt)("li",{parentName:"ul"},"/etc/cni/net.d/10-kuberouter.conflist"))))),(0,r.kt)("li",{parentName:"ul"},"/var/log/pods/",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Pod \u65e5\u5fd7\u76ee\u5f55"))),(0,r.kt)("li",{parentName:"ul"},"/var/lib/cni/ - CNI \u5de5\u4f5c\u7a7a\u95f4")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",u({parentName:"tr"},{align:null}),"port"),(0,r.kt)("th",u({parentName:"tr"},{align:null}),"type"),(0,r.kt)("th",u({parentName:"tr"},{align:null}),"component"),(0,r.kt)("th",u({parentName:"tr"},{align:null}),"note"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"179"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"kube-router"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"worker <-> worker - BGP")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"2379"),(0,r.kt)("td",u({parentName:"tr"},{align:null})),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"kine"),(0,r.kt)("td",u({parentName:"tr"},{align:null}))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"2380"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"etcd peers"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"controller <-> controller")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"4789"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"udp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"calico"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"worker <-> worker - VXLAN overlay")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"6443"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"https"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"kube-apiserver"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"worker,cli->controller")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"8132"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"konnectivity agent"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"worker <-> controller")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"8133"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"konnectivity admin"),(0,r.kt)("td",u({parentName:"tr"},{align:null}))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"9443"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"k0s-api"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"controller <-> controller")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",u({parentName:"tr"},{align:null}),"10250"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"tcp"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"kubelet"),(0,r.kt)("td",u({parentName:"tr"},{align:null}),"master,worker => host")))),(0,r.kt)("h2",u({},{id:"k0s-supervisor"}),"k0s supervisor"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"k0s \u662f\u4e00\u4e2a supervisor\uff0c\u53d6\u4fdd\u7ec4\u4ef6\u59cb\u7ec8\u8fd0\u884c",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"k0s api"),(0,r.kt)("li",{parentName:"ul"},"containerd"),(0,r.kt)("li",{parentName:"ul"},"konnectivity-server",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u6ca1\u6709 LB \u4e14\u5728\u5e73\u5766\u7f51\u7edc\uff0c\u5219\u53ef\u4ee5\u7981\u7528",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/k0sproject/k0s/issues/1352#issuecomment-994350579"}),"https://github.com/k0sproject/k0s/issues/1352#issuecomment-994350579")))),(0,r.kt)("li",{parentName:"ul"},"\u62c6\u5206 controller \u548c worker \u65f6\u5219\u5fc5\u987b\u9700\u8981 LB"))),(0,r.kt)("li",{parentName:"ul"},"etcd"),(0,r.kt)("li",{parentName:"ul"},"kube-controller-manager"),(0,r.kt)("li",{parentName:"ul"},"kube-scheduler"),(0,r.kt)("li",{parentName:"ul"},"kube-apiserver"))),(0,r.kt)("li",{parentName:"ul"},"k0s \u9ed8\u8ba4\u90e8\u7f72\u4e86\u90e8\u5206\u7ec4\u4ef6\uff0c\u786e\u4fdd\u96c6\u7fa4\u53ef\u7528 - manifest",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"coredns"),(0,r.kt)("li",{parentName:"ul"},"konnectivity-agent"),(0,r.kt)("li",{parentName:"ul"},"kube-proxy"),(0,r.kt)("li",{parentName:"ul"},"kube-router"),(0,r.kt)("li",{parentName:"ul"},"metrics-server")))),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# k0s controller \u81ea\u8eab\n/usr/local/bin/k0s controller --config=/etc/k0s/k0s.yaml --enable-worker=true\n\n# \u67e5\u770b supervisor \u7ef4\u62a4\u7684\u6240\u6709\u8fdb\u7a0b\nps -o command -f $(pgrep -P $(k0s status | grep 'Process ID' | cut -d ':' -f 2)) | tee\n\n/usr/local/bin/k0s api \\\n  --config=/etc/k0s/k0s.yaml \\\n  --data-dir=/var/lib/k0s\n\n/var/lib/k0s/bin/containerd \\\n  --root=/var/lib/k0s/containerd \\\n  --state=/run/k0s/containerd \\\n  --address=/run/k0s/containerd.sock \\\n  --log-level=info \\\n  --config=/etc/k0s/containerd.toml\n\n# controller & worker \u901a\u8baf\n/var/lib/k0s/bin/konnectivity-server \\\n  --admin-port=8133 \\\n  --agent-namespace=kube-system \\\n  --agent-port=8132 \\\n  --agent-service-account=konnectivity-agent \\\n  --authentication-audience=system:konnectivity-server \\\n  --cluster-cert=/var/lib/k0s/pki/server.crt \\\n  --cluster-key=/var/lib/k0s/pki/server.key \\\n  --enable-profiling=false \\\n  --kubeconfig=/var/lib/k0s/pki/konnectivity.conf \\\n  --logtostderr=true \\\n  --mode=grpc \\\n  --server-count=1 \\\n  --server-id=$(sha256sum XXX) \\\n  --server-port=0 \\\n  --stderrthreshold=1 \\\n  --uds-name=/run/k0s/konnectivity-server/konnectivity-server.sock \\\n  --v=1\n\n# \u771f\u6b63\u7684 controller\n/var/lib/k0s/bin/kube-controller-manager \\\n  --allocate-node-cidrs=true \\\n  --authentication-kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --authorization-kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --bind-address=127.0.0.1 \\\n  --client-ca-file=/var/lib/k0s/pki/ca.crt \\\n  --cluster-cidr=10.244.0.0/16 \\\n  --cluster-name=k0s \\\n  --cluster-signing-cert-file=/var/lib/k0s/pki/ca.crt \\\n  --cluster-signing-key-file=/var/lib/k0s/pki/ca.key \\\n  --controllers=*,bootstrapsigner,tokencleaner \\\n  --enable-hostpath-provisioner=true \\\n  --kubeconfig=/var/lib/k0s/pki/ccm.conf \\\n  --leader-elect=false \\\n  --node-cidr-mask-size=24 \\\n  --profiling=false \\\n  --requestheader-client-ca-file=/var/lib/k0s/pki/front-proxy-ca.crt \\\n  --root-ca-file=/var/lib/k0s/pki/ca.crt \\\n  --service-account-private-key-file=/var/lib/k0s/pki/sa.key \\\n  --service-cluster-ip-range=10.96.0.0/12 \\\n  --terminated-pod-gc-threshold=12500 \\\n  --use-service-account-credentials=true \\\n  --v=1\n\n# workload \u8c03\u5ea6\n/var/lib/k0s/bin/kube-scheduler \\\n  --authentication-kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --authorization-kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --bind-address=127.0.0.1 \\\n  --kubeconfig=/var/lib/k0s/pki/scheduler.conf \\\n  --leader-elect=false \\\n  --profiling=false \\\n  --v=1\n\n# etcd - \u5982\u679c\u4f7f\u7528\u7684\u662f kine \u5219\u6ca1\u6709\n/var/lib/k0s/bin/etcd \\\n  --advertise-client-urls=https://127.0.0.1:2379 \\\n  --auth-token=jwt,pub-key=/var/lib/k0s/pki/etcd/jwt.pub,priv-key=/var/lib/k0s/pki/etcd/jwt.key,sign-method=RS512,ttl=10m \\\n  --cert-file=/var/lib/k0s/pki/etcd/server.crt \\\n  --client-cert-auth=true \\\n  --data-dir=/var/lib/k0s/etcd \\\n  --enable-pprof=false \\\n  --initial-advertise-peer-urls=https://192.168.1.2:2380 \\\n  --key-file=/var/lib/k0s/pki/etcd/server.key \\\n  --listen-client-urls=https://127.0.0.1:2379 \\\n  --listen-peer-urls=https://192.168.1.2:2380 \\\n  --log-level=info \\\n  --name=$(hostname) \\\n  --peer-cert-file=/var/lib/k0s/pki/etcd/peer.crt \\\n  --peer-client-cert-auth=true \\\n  --peer-key-file=/var/lib/k0s/pki/etcd/peer.key \\\n  --peer-trusted-ca-file=/var/lib/k0s/pki/etcd/ca.crt \\\n  --trusted-ca-file=/var/lib/k0s/pki/etcd/ca.crt\n\n# k8s API - \u4e3b\u8981\u63a5\u53e3\n/var/lib/k0s/bin/kube-apiserver \\\n  --allow-privileged=true \\\n  --anonymous-auth=false \\\n  --api-audiences=https://kubernetes.default.svc,system:konnectivity-server \\\n  --authorization-mode=Node,RBAC --service-account-key-file=/var/lib/k0s/pki/sa.pub --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 \\\n  --client-ca-file=/var/lib/k0s/pki/ca.crt --tls-cert-file=/var/lib/k0s/pki/server.crt \\\n  --egress-selector-config-file=/var/lib/k0s/konnectivity.conf \\\n  --enable-admission-plugins=NodeRestriction,PodSecurityPolicy \\\n  --enable-bootstrap-token-auth=true --advertise-address=192.168.1.2 \\\n  --feature-gates=ServiceInternalTrafficPolicy=true \\\n  --insecure-port=0 \\\n  --kubelet-certificate-authority=/var/lib/k0s/pki/ca.crt \\\n  --kubelet-client-certificate=/var/lib/k0s/pki/apiserver-kubelet-client.crt \\\n  --kubelet-client-key=/var/lib/k0s/pki/apiserver-kubelet-client.key \\\n  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\n  --profiling=false \\\n  --proxy-client-cert-file=/var/lib/k0s/pki/front-proxy-client.crt \\\n  --proxy-client-key-file=/var/lib/k0s/pki/front-proxy-client.key \\\n  --requestheader-allowed-names=front-proxy-client \\\n  --requestheader-extra-headers-prefix=X-Remote-Extra- \\\n  --requestheader-group-headers=X-Remote-Group \\\n  --requestheader-username-headers=X-Remote-User \\\n  --secure-port=6443 \\\n  --service-account-issuer=https://kubernetes.default.svc \\\n  --service-account-jwks-uri=https://kubernetes.default.svc/openid/v1/jwks \\\n  --service-account-signing-key-file=/var/lib/k0s/pki/sa.key --requestheader-client-ca-file=/var/lib/k0s/pki/front-proxy-ca.crt \\\n  --service-cluster-ip-range=10.96.0.0/12 \\\n  --tls-private-key-file=/var/lib/k0s/pki/server.key \\\n  --v=1 \\\n  --etcd-servers=https://127.0.0.1:2379 \\\n  --etcd-cafile=/var/lib/k0s/pki/etcd/ca.crt \\\n  --etcd-certfile=/var/lib/k0s/pki/apiserver-etcd-client.crt \\\n  --etcd-keyfile=/var/lib/k0s/pki/apiserver-etcd-client.key\n")),(0,r.kt)("h2",u({},{id:"k0syaml"}),"k0s.yaml"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-yaml"}),"apiVersion: k0s.k0sproject.io/v1beta1\nkind: ClusterConfig\nmetadata:\n  creationTimestamp: null\n  # kube-controller-manager --cluster-name\n  name: k0s\nspec:\n  # kube-apiserver\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/\n  api:\n    # LB \u5730\u5740 - \u4f9b woker \u4f7f\u7528\n    externalAddress:\n    address: 192.168.1.2\n    k0sApiPort: 9443\n    port: 6443\n    # \u8bc1\u4e66\u91cc\u7684 SANs\n    sans:\n      - 192.168.1.2\n      - kube.example.com\n    # \u989d\u5916\u7684 kube-apiserver \u53c2\u6570\n    extraArgs:\n    # access to KAS through konnectivity tunnel\n    tunneledNetworkingMode: false\n  storage:\n    # etcd, kine\n    type: etcd\n    etcd:\n      # etcd \u53d1\u73b0\u5730\u5740\n      peerAddress: 192.168.1.2\n    kine:\n      dataSource:\n\n  extensions:\n    # \u8981\u90e8\u7f72\u7684 Helm\n    helm:\n      # \u4ed3\u5e93\u5b9a\u4e49\n      repositories:\n        - name: stable\n          url: https://charts.helm.sh/stable\n      # Chart \u5b9a\u4e49\n      charts:\n        - name: prometheus-stack\n          chartname: prometheus-community/prometheus\n          version: '14.6.1'\n          values: |\n            # YAML values\n          namespace: default\n    # \u5b58\u50a8\u914d\u7f6e\n    storage:\n      # \u5efa\u8bae\u81ea\u884c\u90e8\u7f72 openebs \u4e0d\u4f7f\u7528 k0s \u90e8\u7f72\n      # external_storage \u4e0d\u90e8\u7f72\u5b58\u50a8\u76f8\u5173\u670d\u52a1\n      # openebs_local_storage \u90e8\u7f72 openebs\n      type: external_storage\n      # openebs-device, openebs-hostpath\n      # /var/openebs/\n      create_default_storage_class: false\n  images:\n    # \u9ed8\u8ba4 \u4ed3\u5e93 - \u4f1a\u52a0\u5728\u6240\u6709 image \u524d - \u652f\u6301\u5e26 path\n    repository:\n    default_pull_policy: IfNotPresent\n    # \u4e0d\u4fee\u6539 - \u5efa\u8bae\u4f7f\u7528 bundle \u5bfc\u5165\n    # \u9ed8\u8ba4\u7528\u5230\u4e86 k8s.gcr.io \u955c\u50cf - \u65e0\u6cd5\u62c9\u53d6\n  installConfig:\n    # \u7528\u6237 - install \u65f6\u4f1a\u521b\u5efa\n    users:\n      etcdUser: etcd\n      kineUser: kube-apiserver\n      konnectivityUser: konnectivity-server\n      kubeAPIserverUser: kube-apiserver\n      kubeSchedulerUser: kube-scheduler\n  konnectivity:\n    adminPort: 8133\n    agentPort: 8132\n  network:\n    # calico, kuberouter, custom\n    # \u521d\u59cb\u5316\u540e\u65e0\u6cd5\u4fee\u6539 - \u53ea\u6709\u91cd\u65b0\u90e8\u7f72\n    provider: kuberouter\n    podCIDR: 10.244.0.0/16\n    serviceCIDR: 10.96.0.0/12\n    calico:\n      # vxlan, ipip\n      mode: vxlan\n      # Always, CrossSubnet, Never\n      # vxlan \u4e0d\u4f7f\u7528\n      overlay: Always\n      vxlanPort: 4789\n      # virtual network ID for VXLAN\n      vxlanVNI: 4096\n      mtu: 0\n      # wireguard-based encryption\n      wireguard: false\n      flexVolumeDriverPath: /usr/libexec/k0s/kubelet-plugins/volume/exec/nodeagent~uds\n      ipAutodetectionMethod:\n    # https://github.com/cloudnativelabs/kube-router/blob/master/docs/user-guide.md\n    kuberouter:\n      autoMTU: true\n      mtu: 0\n      # BGP\n      peerRouterASNs: ''\n      peerRouterIPs: ''\n    dualStack: {}\n    kubeProxy:\n      disabled: false\n      # iptables, ipvs, userspace\n      mode: iptables\n  podSecurityPolicy:\n    # 00-k0s-privileged - \u5bbd\u677e\n    # 99-k0s-restricted - \u4e25\u683c\u9650\u5236\n    defaultPolicy: 00-k0s-privileged\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/\n  controllerManager:\n    extraArgs:\n      # cluster-name: wener-k0s\n  # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/\n  scheduler:\n    extraArgs:\n  # \u533a\u5206\u5b9a\u4e49 worker \u914d\u7f6e\n  workerProfiles:\n    - name: custom-role\n      values:\n        volumePluginDir: /var/libexec/k0s/kubelet-plugins/volume/exec\n  telemetry:\n    # \u9ed8\u8ba4\u5f00\u542f - \u5efa\u8bae\u5173\u95ed\n    enabled: false\n")),(0,r.kt)("h2",u({},{id:"containerdtoml"}),"containerd.toml"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md"}),"containerd-config.toml.5"))),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# \u53c2\u8003\uff0c\u7136\u540e\u6309\u9700\u4fee\u6539 /etc/k0s/containerd.toml\n/var/lib/k0s/bin/containerd config default > containerd.toml\n\n# \u67e5\u770b\u652f\u6301\u7684\u63d2\u4ef6\nk0s ctr plugins ls\n")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash",metastring:'title="k3s \u6267\u884c\u7684 containerd"',title:'"k3s',"\u6267\u884c\u7684":!0,'containerd"':!0}),"/var/lib/k0s/bin/containerd \\\n  --root=/var/lib/k0s/containerd \\\n  --state=/var/lib/k0s/run/containerd \\\n  --address=/var/lib/k0s/run/containerd.sock \\\n  --config=/etc/k0s/containerd.toml\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u4f7f\u7528 ZFS")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"zfs create -o mountpoint=/var/lib/k0s/containerd/io.containerd.snapshotter.v1.zfs main/containerd\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e3a overlayfs")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-toml",metastring:'title="/etc/k0s/containerd.toml"',title:'"/etc/k0s/containerd.toml"'}),'version = 2\n\n[plugins."io.containerd.grpc.v1.cri".containerd]\nsnapshotter = "zfs"\n\n')),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# \u5e94\u8be5\u4e3a ok \u800c\u4e0d\u662f skip\nk0s ctr plugins ls | grep zfs\n\n# \u5224\u65ad\u65e7\u7684\u662f\u5426\u8fd8\u5728\u7528\n# \u5982\u679c\u6ca1\u91cd\u542f\u4e4b\u524d\u5bb9\u5668\uff0c\u65e7\u7684\u4e5f\u8fd8\u8fd8\u5728\u4f7f\u7528\nlsof +D /var/lib/k0s/containerd/io.containerd.snapshotter.v1.overlayfs/\n")),(0,r.kt)("h2",u({},{id:"helm-crd"}),"helm crd"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-yaml"}),"apiVersion: helm.k0sproject.io/v1beta1\nkind: Chart\nmetadata:\n  name: k0s-addon-chart-openebs\n  namespace: 'kube-system'\n  finalizers:\n    - helm.k0sproject.io/uninstall-helm-release\nspec:\n  chartName: openebs-internal/openebs\n  values: |\n\n  version: 3.0.3\n  namespace: openebs\n")),(0,r.kt)("h2",u({},{id:"openrc"}),"openrc"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5728 install \u65f6\u751f\u6210")),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-sh",metastring:'title="/etc/init.d/k0scontroller"',title:'"/etc/init.d/k0scontroller"'}),'#!/sbin/openrc-run\nsupervisor=supervise-daemon\nname="k0s controller"\ndescription="k0s - Zero Friction Kubernetes"\ncommand=/usr/local/bin/k0s\ncommand_args="controller --config=/etc/k0s/k0s.yaml --enable-dynamic-config=true --enable-worker=true "\nname=$(basename $(readlink -f $command))\nsupervise_daemon_args="--stdout /var/log/${name}.log --stderr /var/log/${name}.err"\ndepend() {\n  need net\n  use dns\n  after firewall\n}\n')),(0,r.kt)("h2",u({},{id:"\u624b\u52a8\u4e0b\u8f7d\u5b89\u88c5"}),"\u624b\u52a8\u4e0b\u8f7d\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),'ver=$(curl https://docs.k0sproject.io/stable.txt)\ncurl -LC- -o k0s "https://ghproxy.com/https://github.com/k0sproject/k0s/releases/download/${ver}/k0s-${ver}-amd64"\nchmod 755 k0s\nsudo mkdir -p /usr/local/bin/\nsudo mv k0s /usr/local/bin/k0s\n')),(0,r.kt)("h2",u({},{id:"\u73af\u5883\u76d1\u6d4b"}),"\u73af\u5883\u76d1\u6d4b"),(0,r.kt)("pre",null,(0,r.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"# https://github.com/k0sproject/k0s/releases/download/v1.23.7%2Bk0s.0/k0s-v1.23.7+k0s.0-amd64\ncurl -LOC- 'https://ghproxy.com/https://github.com/k0sproject/k0s/releases/download/v1.23.7%2Bk0s.0/k0s-v1.23.7+k0s.0-amd64'\nchmod +x k0s-v1.23.7+k0s.0-amd64\n./k0s-v1.23.7+k0s.0-amd64 sysinfo\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",u({parentName:"li"},{href:"https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh"}),"https://github.com/k3s-io/k3s/blob/master/contrib/util/check-config.sh"))))}N.isMDXComponent=!0}}]);