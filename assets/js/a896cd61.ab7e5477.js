/*! For license information please see a896cd61.ab7e5477.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[54716],{5724:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var s=r(2488),t=r(62780);const i={title:"Traefik"},l="Traefik",a={id:"devops/web/traefik",title:"Traefik",description:"- containous/traefik",source:"@site/../notes/devops/web/traefik.md",sourceDirName:"devops/web",slug:"/devops/web/traefik",permalink:"/notes/devops/web/traefik",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/traefik.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1627904182,formattedLastUpdatedAt:"Aug 2, 2021",frontMatter:{title:"Traefik"},sidebar:"docs",previous:{title:"Traefik V1",permalink:"/notes/devops/web/traefik-v1"},next:{title:"Tyk",permalink:"/notes/devops/web/tyk"}},o={},c=[{value:"\u89c4\u5219",id:"\u89c4\u5219",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"\u9759\u6001\u914d\u7f6e\u9879",id:"\u9759\u6001\u914d\u7f6e\u9879",level:3},{value:"PowerDNS \u8bc1\u4e66",id:"powerdns-\u8bc1\u4e66",level:4},{value:"Docker \u914d\u7f6e\u53d1\u73b0",id:"docker-\u914d\u7f6e\u53d1\u73b0",level:4},{value:"FAQ",id:"faq",level:2},{value:"traefik v1 vs v2",id:"traefik-v1-vs-v2",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"traefik",children:"Traefik"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/containous/traefik",children:"containous/traefik"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml",children:"traefik.sample.toml"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["ISSUES\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u652f\u6301\u6cdb\u57df\u540d"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/containous/traefik/issues/5048",children:"#5048"})," \u652f\u6301 UDP"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["ACME\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"20 certificates per domain per week"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://letsencrypt.org/docs/rate-limits/",children:"https://letsencrypt.org/docs/rate-limits/"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u6ce8\u610f\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5982\u679c EndPoint \u662f HTTPS \u4f46\u662f router \u672a\u6307\u5b9a tls \u4f1a\u65e0\u6cd5\u5339\u914d\u51fa\u73b0 404 - router \u76f8\u5f53\u4e8e\u662f\u5339\u914d HTTP"}),"\n",(0,s.jsxs)(n.li,{children:["V2 \u4e0d\u652f\u6301\u9ad8\u53ef\u7528\u90e8\u7f72 ",(0,s.jsx)(n.a,{href:"https://github.com/containous/traefik/issues/5792",children:"#5792"})]}),"\n",(0,s.jsx)(n.li,{children:"\u4e0d\u652f\u6301\u91cd\u5199 Host"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u542f\u52a8\n# \u914d\u7f6e\u6587\u4ef6\u652f\u6301 yaml\u3001toml\u3001json\n# \u4eba\u4e3a\u914d\u7f6e\u63a8\u8350 yaml\ntraefik --configfile traefik.yaml\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u57fa\u7840\u914d\u7f6e"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"providers:\n  file:\n    # \u81ea\u52a8\u76d1\u542c\u8be5\u76ee\u5f55\u914d\u7f6e\n    directory: traefik.d\n    watch: true\n\nentryPoints:\n  http:\n    address: ':8080'\n  https:\n    address: ':8443'\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u89c4\u5219",children:"\u89c4\u5219"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Host \u5339\u914d\u57df\u540d"}),"\n",(0,s.jsxs)(n.li,{children:["HostRegexp\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:'HostRegexp("a.example.com","{subdomain}.domain.com","{subdomain:[a-z]+}.domain.com")'})}),"\n",(0,s.jsxs)(n.li,{children:["\u5e76\u4e0d\u662f\u771f\u6b63\u7684\u5b8c\u5168\u6b63\u5219\u5339\u914d - \u53ea\u6709\u5728 ",(0,s.jsx)(n.code,{children:"{}"})," \u5185\u7684\u624d\u4f1a\u5904\u7406"]}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528\u7684\u662f gorilla/mux \u7684 ",(0,s.jsx)(n.a,{href:"https://github.com/gorilla/mux/blob/4de8a5a4d283677c69afa1a86a044c8451633a18/route.go#L293:17",children:"Host"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.traefik.io/master/reference/static-configuration/file/",children:"Static Configuration"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"\u9759\u6001\u914d\u7f6e\u9879",children:"\u9759\u6001\u914d\u7f6e\u9879"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# \u5168\u5c40\u914d\u7f6e\nglobal:\n  checkNewVersion: false\n  sendAnonymousUsage: false\n# \u670d\u52a1\u7aef\u4f20\u8f93\u914d\u7f6e\nserversTransport:\n  insecureSkipVerify: false\n  rootCAs: ['foobar', 'foobar']\n  maxIdleConnsPerHost: 42\n  forwardingTimeouts:\n    dialTimeout: 42\n    responseHeaderTimeout: 42\n    idleConnTimeout: 42\n\n# \u9ed8\u8ba4\nentryPoints:\n  web:\n    address: ':80'\n  websecure:\n    address: ':443'\n# \u914d\u7f6e\u53d1\u73b0\nproviders:\n  providersThrottleDuration: 42\n  file:\n    directory: traefik.d\n    watch: true\n    filename: traefik.yaml\n    debugLogGeneratedTemplate: true\n# \u542f\u7528 API\napi:\n  # \u4e0d\u5b89\u5168\u6a21\u5f0f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\n  # \u5b89\u5168\u6a21\u5f0f\u4f1a\u5b9a\u4e49 api@internal \u5185\u90e8\u670d\u52a1\uff0c\u9700\u8981\u81ea\u884c\u914d\u7f6e\u8def\u7531\n  insecure: true\n  dashboard: true\n  # \u6dfb\u52a0 /debug \u7aef\u53e3\n  debug: true\n# \u6307\u6807\u76d1\u63a7\nmetrics:\n  prometheus:\n    buckets: []\n    addEntryPointsLabels: true\n    addServicesLabels: true\n    entryPoint: traefik\n# \u542f\u7528 PING - \u7528\u4e8e\u5065\u5eb7\u68c0\u67e5 - \u7aef\u53e3\u4e3a /ping\nping:\n  entryPoint: traefik\n# \u65e5\u5fd7\u914d\u7f6e\nlog:\n  level: INFO\n  filePath: traefik.log\n  # common/json\n  format: common\n# \u8bbf\u95ee\u65e5\u5fd7\u914d\u7f6e\naccessLog:\n  filePath: access.log\n  format: json\n  # \u5728\u5185\u5b58\u7f13\u51b2\u7684\u884c\u6570\n  bufferingSize: 100\n  # \u843d\u65e5\u5fd7\u7684\u6761\u4ef6 - \u6216 \u5173\u7cfb\n  filters:\n    statusCodes: [400, 401]\n    # \u91cd\u8bd5\n    retryAttempts: true\n    # \u81f3\u5c11 10ms\n    minDuration: 10\n  # \u5b57\u6bb5\u63a7\u5236\n  fields:\n    # \u4fdd\u7559\u5b57\u6bb5\n    defaultMode: keep\n    names:\n      # \u4e22\u5f03\u5b57\u6bb5\n      ClientUsername: drop\n      name1: foobar\n    headers:\n      # \u5c06\u5b57\u6bb5\u503c\u66ff\u6362\u4e3a redacted\n      'User-Agent': 'redact'\n\n# \u8c03\u7528\u8ddf\u8e2a\ntracing:\n  serviceName: foobar\n  spanNameLimit: 42\n  zipkin:\n    httpEndpoint: foobar\n    sameSpan: true\n    id128Bit: true\n    sampleRate: 42\n# \u4e3b\u673a\u57df\u540d\u89e3\u6790\nhostResolver:\n  cnameFlattening: true\n  resolvConfig: foobar\n  resolvDepth: 5\n# \u8bc1\u4e66\u89e3\u6790\ncertificatesResolvers:\n  CertificateResolver0:\n    # let\u2018s encrypt\n    acme:\n      email: foobar\n      caServer: foobar\n      storage: foobar\n      keyType: foobar\n      dnsChallenge:\n        provider: foobar\n        delayBeforeCheck: 42\n        resolvers:\n          - foobar\n          - foobar\n        disablePropagationCheck: true\n      httpChallenge:\n        entryPoint: foobar\n      tlsChallenge: {}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"powerdns-\u8bc1\u4e66",children:"PowerDNS \u8bc1\u4e66"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"certificatesResolvers:\n  pdns:\n    acme:\n      dnsChallenge:\n        # \u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u94fe\u63a5\u4fe1\u606f PDNS_API_KEY, PDNS_API_URL\n        # \u73af\u5883\u53d8\u91cf\u4e5f\u53ef\u4ee5\u4f7f\u7528 *_FILE \u6307\u5411\u6587\u4ef6\u6765\u914d\u7f6e\n        provider: pdns\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u4f7f\u7528"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"http:\n  routers:\n    traefik:\n      entryPoints: [https]\n      rule: Host(`traefik.example.com`)\n      service: api@internal\n      tls:\n        # \u5f15\u7528\u5b9a\u4e49\n        certResolver: pdns\n        # \u4f7f\u7528\u901a\u914d\u7b26\u8bc1\u4e66\n        domains:\n          - main: example.com\n            sans:\n              - '*.example.com'\n"})}),"\n",(0,s.jsx)(n.h4,{id:"docker-\u914d\u7f6e\u53d1\u73b0",children:"Docker \u914d\u7f6e\u53d1\u73b0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# \u8fd0\u884c docker \u6dfb\u52a0 -v /var/run/docker.sock:/var/run/docker.sock\nproviders:\n  docker:\n    endpoint: \'unix:///var/run/docker.sock\'\n    # \u662f\u5426\u9ed8\u8ba4\u66b4\u9732\u670d\u52a1 - \u6b63\u5e38\u9700\u8981 traefik.enable=true\n    exposedByDefault: false\n    # \u9ed8\u8ba4\u7684\u6620\u5c04\u89c4\u5219\n    # \u652f\u6301 https://masterminds.github.io/sprig \u51fd\u6570\n    # defaultRule: "Host(`{{ .Name }}.{{ index .Labels \\"customLabel\\"}}`)"\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it \\\n  -l traefik.enable=true \\\n  -l traefik.http.routers.my-container.rule=Host(`mydomain.com`) \\\n  -l traefik.http.services.my-container-service.loadbalancer.server.port=80\n  --name web nginx\n\n# \u6307\u5b9a\u7aef\u53e3 - \u591a\u4e2a\u9017\u53f7\u5206\u5272\n# traefik.http.routers.my-container.entrypoints=https\n# \u542f\u7528 tls\n# traefik.http.routers.my-container.tls=true\n"})}),"\n",(0,s.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(n.h3,{id:"traefik-v1-vs-v2",children:"traefik v1 vs v2"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u65b0\u7279\u6027\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u652f\u6301\u5e26 SNI \u7684 TCP \u8def\u7531\u548c\u591a\u534f\u8bae\u7aef\u53e3"}),"\n",(0,s.jsx)(n.li,{children:"\u652f\u6301 TCP \u548c HTTP \u5728\u540c\u4e00\u4e2a\u7aef\u53e3 - \u4f7f\u7528 SNI \u533a\u5206"}),"\n",(0,s.jsx)(n.li,{children:"\u65b0\u7684\u7ed3\u6784 Routers, Middlewares, Services"}),"\n",(0,s.jsx)(n.li,{children:"\u65b0\u7684\u76d1\u63a7\u9875\u9762"}),"\n",(0,s.jsx)(n.li,{children:"\u5e26\u6743\u91cd\u7684 AB \u53d1\u5e03"}),"\n",(0,s.jsx)(n.li,{children:"\u670d\u52a1\u8d1f\u8f7d\u5747\u8861\u652f\u6301\u955c\u50cf\u8bf7\u6c42 - \u5c06\u8bf7\u6c42\u53d1\u9001\u5230\u591a\u4e2a\u7aef\u5ffd\u7565\u8fd4\u56de\u7ed3\u679c"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u8fc1\u79fb\u70b9\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6ca1\u6709\u4e86 Frontends \u548c Backends \u6982\u5ff5\uff0c\u65b0\u7684\u6838\u5fc3\u7ec4\u4ef6\u4e3a Routers, Middlewares, Services"}),"\n",(0,s.jsx)(n.li,{children:"TLS \u6bcf\u4e2a\u8def\u7531\u52a8\u6001\u914d\u7f6e - v1 \u4e3a\u5168\u5c40\u9759\u6001"}),"\n",(0,s.jsx)(n.li,{children:"HTTP \u8c03\u6574 HTTPS \u73b0\u5728\u662f\u8def\u7531 - v1 \u9700\u8981\u5728\u5165\u53e3\u914d\u7f6e"}),"\n",(0,s.jsx)(n.li,{children:"LetsEncrypt \u914d\u7f6e\u8c03\u6574"}),"\n",(0,s.jsx)(n.li,{children:"\u65e5\u5fd7\u4e0d\u5728\u4f5c\u4e3a\u5168\u5c40\u914d\u7f6e\uff0c\u914d\u7f6e\u5728 log \u533a\u5757\u4e0b"}),"\n",(0,s.jsx)(n.li,{children:"\u79fb\u9664\u4e86\u6240\u6709\u5168\u5c40\u8bbe\u7f6e"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"v2 \u7684 provider \u652f\u6301\u8f83\u5c11"})," - \u4f1a\u9010\u6e10\u5b8c\u5584"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u53c2\u8003\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://blog.containo.us/traefik-2-0-6531ec5196c2",children:"v2"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.traefik.io/migration/v1-to-v2/",children:"v1 \u8fc1\u79fb v2"})}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},38088:(e,n,r)=>{var s=r(96651),t=Symbol.for("react.element"),i=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,r){var s,i={},c=null,d=null;for(s in void 0!==r&&(c=""+r),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(d=n.ref),n)l.call(n,s)&&!o.hasOwnProperty(s)&&(i[s]=n[s]);if(e&&e.defaultProps)for(s in n=e.defaultProps)void 0===i[s]&&(i[s]=n[s]);return{$$typeof:t,type:e,key:c,ref:d,props:i,_owner:a.current}}n.Fragment=i,n.jsx=c,n.jsxs=c},2488:(e,n,r)=>{e.exports=r(38088)},62780:(e,n,r)=>{r.d(n,{I:()=>a,M:()=>l});var s=r(96651);const t={},i=s.createContext(t);function l(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);