/*! For license information please see 47bc9389.17900553.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[26180],{46440:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var t=o(2488),r=o(62780);const a={title:"OPA"},s="OPA",l={id:"service/auth/opa/README",title:"OPA",description:"- open-policy-agent/opa",source:"@site/../notes/service/auth/opa/README.md",sourceDirName:"service/auth/opa",slug:"/service/auth/opa/",permalink:"/notes/service/auth/opa/",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/service/auth/opa/README.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1689238697,formattedLastUpdatedAt:"Jul 13, 2023",frontMatter:{title:"OPA"},sidebar:"docs",previous:{title:"oauth2-proxy",permalink:"/notes/service/auth/oauth2-proxy"},next:{title:"gatekeeper",permalink:"/notes/service/auth/opa/gatekeeper"}},i={},c=[{value:"policy-as-code repository",id:"policy-as-code-repository",level:2},{value:"OIDC",id:"oidc",level:2},{value:"Awesome",id:"awesome",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"opa",children:"OPA"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/open-policy-agent/opa",children:"open-policy-agent/opa"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"REST API\u3001gRPC API\u3001SDK"}),"\n",(0,t.jsx)(n.li,{children:"\u901a\u7528\u7684\u3001\u72ec\u7acb\u7684\u653f\u7b56\u5f15\u64ce"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Rego\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://play.openpolicyagent.org/",children:"https://play.openpolicyagent.org/"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/rest-api/",children:"REST API"})}),"\n",(0,t.jsxs)(n.li,{children:["npm ",(0,t.jsx)(n.a,{href:"https://github.com/open-policy-agent/npm-opa-wasm",children:"@open-policy-agent/opa-wasm"})]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/StyraInc/awesome-opa",children:"StyraInc/awesome-opa"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'brew install opa\nopa run --server \\\n  --log-level debug \\\n  --addr https://0.0.0.0:8181\n\ncat << EOF > example.rego\npackage example\n\nimport input.request\n\ndefault allow = false\n\nallow {\n\trequest.method == "GET"\n}\nEOF\n\ncat << EOF > input.json\n{\n    "request": {\n        "method": "GET"\n    }\n}\nEOF\n\n# value: true\nopa eval -i input.json -d example.rego "data.example.allow"\n\n# --set=default_decision=example/allow\nopa run --server example.rego # \u670d\u52a1\n\n# \u9ed8\u8ba4 data.system.main, \u4f20\u9012 data/example \u4fee\u6539\u8c03\u7528\u7684 policy\ncat << EOF > request.json\n{\n    "input": $(cat input.json)\n}\nEOF\ncurl localhost:8181/v1/data/example -i -d @request.json -H \'Content-Type: application/json\'\n\n# \u4ee5\u670d\u52a1\u8fd0\u884c\uff0c\u4e0d\u52a0\u8f7d\u9884\u8bbe\nopa run --server \\\n  --log-format=json-pretty \\\n  --log-level=debug \\\n  --set=decision_logs.console=true\n\ncurl -X PUT \'localhost:8181/v1/policies/example\' --data-binary @example.rego\ncurl localhost:8181/v1/data/example -d @request.json -H \'Content-Type: application/json\' -s | jq\n\nopa capabilities --current                      # \u7248\u672c\u529f\u80fd\nopa build -t wasm -e example/allow example.rego # bundle.tar.gz\nopa inspect bundle.tar.gz\nopa check example.rego\nopa fmt example.rego\nopa deps --data example.rego data.example.allow\n\nmkdir -p policy\ncp example.rego policy\nopa build -b policy/ # bundle.tar.gz\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"--bundle"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"foo/\n  |\n  +-- bar/\n  |     |\n  |     +-- data.json\n  |\n  +-- baz.rego\n  |\n  +-- manifest.yaml\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/management-bundles/",children:"https://www.openpolicyagent.org/docs/latest/management-bundles/"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"policy-as-code-repository",children:"policy-as-code repository"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'mkdir -p src/policies\necho \'{}\' > src/data.json\ncat << EOF > src/.manifest\n{\n  "roots": ["policies"],\n  "metadata": {\n    "required_builtins": {\n      "builtin1": []\n    }\n  }\n}\nEOF\ncat << EOF > src/policies/example.rego\npackage example\n\nimport input.request\n\ndefault allow = false\n\nallow {\n\trequest.method == "GET"\n}\nEOF\nopa build src/\n# echo \'{}\' > config.json\n# --manifest-config config.json:application/vnd.oci.image.config.v1+json\n# oras push ghcr.io/wenerme/opa-policy:1.0.0 bundle.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip\n# https://hub.docker.com/r/wener/opa-policy\noras push docker.io/wener/opa-policy:1.0.0 bundle.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"services:\n  dockercr:\n    url: https://dockercr.wener.me\n    #url: https://docker.io\n    type: oci\n\nbundles:\n  authz:\n    service: dockercr\n    resource: dockercr.wener.me/wener/opa-policy:1.0.0\n    persist: true\n    polling:\n      min_delay_seconds: 30\n      max_delay_seconds: 120\n# persistence_directory: ${PWD}/.opa\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl localhost:8181/v1/data/example -d @request.json -H 'Content-Type: application/json' -s | jq\n\nls .opa/bundles/authz/ # \u7f13\u5b58\u76ee\u5f55 bundle.tar.gz\n"})}),"\n",(0,t.jsx)(n.h2,{id:"oidc",children:"OIDC"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rego",children:'package oidc\n\njwks_request(url) := http.send({\n    "url": url,\n    "method": "GET",\n    "force_cache": true,\n    "force_cache_duration_seconds": 3600\n})\n\njwt_unverified := io.jwt.decode(input.token)\njwt_header := jwt_unverified[0]\n\n# Use the key ID (kid) from the token as a cache key - if a new kid is encountered\n# we obtain a fresh JWKS object as the keys have likely been rotated.\njwks_url := concat("?", [\n    "https://authorization-server.example.com/jwks",\n    urlquery.encode_object({"kid": jwt_header.kid}),\n])\njwks := jwks_request(jwks_url).raw_body\n\njwt_verified := jwt_unverified {\n    io.jwt.verify_rs256(input.token, jwks)\n}\n\nclaims_verified := jwt_verified[1]\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/oauth-oidc/",children:"https://www.openpolicyagent.org/docs/latest/oauth-oidc/"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"awesome",children:"Awesome"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/rond-authz/rond",children:"rond-authz/rond"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"sidecar proxy"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/aserto-dev/topaz",children:"aserto-dev/topaz"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"OPA + Zanzibar"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/notes/service/auth/opa/opal",children:"permitio/opal"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u7ba1\u7406\u548c\u81ea\u52a8\u63a8\u9001 Policy \u66f4\u65b0"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/opcr-io/policy",children:"opcr-io/policy"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"building OPA policies into OCI images"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/StyraInc/regal",children:"StyraInc/regal"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"linter"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/StyraInc/awesome-opa",children:"StyraInc/awesome-opa"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/fugue/regula",children:"fugue/regula"})}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},38088:(e,n,o)=>{var t=o(96651),r=Symbol.for("react.element"),a=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,l=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,o){var t,a={},c=null,p=null;for(t in void 0!==o&&(c=""+o),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(p=n.ref),n)s.call(n,t)&&!i.hasOwnProperty(t)&&(a[t]=n[t]);if(e&&e.defaultProps)for(t in n=e.defaultProps)void 0===a[t]&&(a[t]=n[t]);return{$$typeof:r,type:e,key:c,ref:p,props:a,_owner:l.current}}n.Fragment=a,n.jsx=c,n.jsxs=c},2488:(e,n,o)=>{e.exports=o(38088)},62780:(e,n,o)=>{o.d(n,{I:()=>l,M:()=>s});var t=o(96651);const r={},a=t.createContext(r);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);