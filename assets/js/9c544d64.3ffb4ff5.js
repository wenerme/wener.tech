/*! For license information please see 9c544d64.3ffb4ff5.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[9396],{27223:(e,l,n)=>{n.r(l),n.d(l,{assets:()=>d,contentTitle:()=>a,default:()=>g,frontMatter:()=>i,metadata:()=>r,toc:()=>t});var o=n(11527),s=n(47214);const i={title:"Brazel Go"},a=void 0,r={id:"dev/build/bazel/bazel-go",title:"Brazel Go",description:"Brazel Go",source:"@site/../notes/dev/build/bazel/bazel-go.md",sourceDirName:"dev/build/bazel",slug:"/dev/build/bazel/go",permalink:"/notes/dev/build/bazel/go",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/dev/build/bazel/bazel-go.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1642767775,formattedLastUpdatedAt:"Jan 21, 2022",frontMatter:{title:"Brazel Go"},sidebar:"docs",previous:{title:"Bazel FAQ",permalink:"/notes/dev/build/bazel/faq"},next:{title:"Bazel Java",permalink:"/notes/dev/build/bazel/java"}},d={},t=[{value:"Brazel Go",id:"brazel-go",level:2},{value:"cross compile",id:"cross-compile",level:3},{value:"go_repository does not support file path replacements",id:"go_repository-does-not-support-file-path-replacements",level:2},{value:"rules_go",id:"rules_go",level:2},{value:"gazelle",id:"gazelle",level:2},{value:"go_sdk",id:"go_sdk",level:2},{value:"found but does not contain package",id:"found-but-does-not-contain-package",level:2},{value:"is not visible from target",id:"is-not-visible-from-target",level:2},{value:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898",id:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898",level:2},{value:"go: cannot find GOROOT directory: /usr/local/go",id:"go-cannot-find-goroot-directory-usrlocalgo",level:2}];function c(e){const l={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.h2,{id:"brazel-go",children:"Brazel Go"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:[(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle",children:"bazelbuild/bazel-gazelle"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u4e3a go \u548c protobuf \u751f\u6210 BUILD"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.li,{children:"deps.bzl"}),"\n",(0,o.jsxs)(l.li,{children:["\u53c2\u8003\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://www.tweag.io/blog/2021-09-08-rules_go-gazelle/",children:"BUILDING A GO PROJECT USING BAZEL"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.admonition,{type:"tip",children:(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u9ed8\u8ba4\u5f00\u542f trimpath"}),"\n",(0,o.jsx)(l.li,{children:"\u6682\u4e0d\u652f\u6301 coverage"}),"\n"]})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# cross compile no cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# cross compile with cgo\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n"})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'workspace(name = "my_project")\n\nload("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")\n\nhttp_archive(\n    name = "io_bazel_rules_go",\n    sha256 = "2b1641428dff9018f9e85c0384f03ec6c10660d935b750e3fa1492a281a53b0f",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n        "https://github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip",\n    ],\n)\n\nhttp_archive(\n    name = "bazel_gazelle",\n    sha256 = "de69a09dc70417580aabf20a28619bb3ef60d038470c7cf8442fafcf627c21cb",\n    urls = [\n        "https://mirror.bazel.build/github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n        "https://github.com/bazelbuild/bazel-gazelle/releases/download/v0.24.0/bazel-gazelle-v0.24.0.tar.gz",\n    ],\n)\n\nload("@io_bazel_rules_go//go:deps.bzl", "go_register_toolchains", "go_rules_dependencies")\nload("@bazel_gazelle//:deps.bzl", "gazelle_dependencies", "go_repository")\n\n#\ngo_rules_dependencies()\ngo_register_toolchains(version = "1.17.2")\ngazelle_dependencies()\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",metastring:'title="BUILD"',children:'load("@bazel_gazelle//:def.bzl", "gazelle")\n\n# gazelle:prefix zhensikeji.net/inccall/core\ngazelle(name = "gazelle")\n\ngazelle(\n    name = "gazelle-update-repos",\n    args = [\n        "-from_file=go.mod",\n        "-to_macro=deps.bzl%go_dependencies",\n        "-prune",\n        "-build_file_proto_mode=disable_global",\n    ],\n    command = "update-repos",\n)\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"bazel run //:gazelle\n\nbazel run //:gazelle -- update-repos -from_file=go.mod -to_macro=deps.bzl%go_dependencies\nbazel run //:gazelle-update-repos\n"})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"go get github.com/bazelbuild/bazel-gazelle/cmd/gazelle\ngazelle -go_prefix github.com/example/project\n"})}),"\n",(0,o.jsx)(l.h3,{id:"cross-compile",children:"cross compile"}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'go_library(\n    name = "foo",\n    srcs = [\n        "foo_linux.go",\n        "foo_windows.go",\n    ],\n    deps = select({\n        "@io_bazel_rules_go//go/platform:linux_amd64": [\n            "//bar_linux",\n        ],\n        "@io_bazel_rules_go//go/platform:windows_amd64": [\n            "//bar_windows",\n        ],\n        "//conditions:default": [],\n    }),\n)\n'})}),"\n",(0,o.jsx)(l.h2,{id:"go_repository-does-not-support-file-path-replacements",children:"go_repository does not support file path replacements"}),"\n",(0,o.jsx)(l.h2,{id:"rules_go",children:"rules_go"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/rules_go",children:"bazelbuild/rules_go"})}),"\n",(0,o.jsxs)(l.li,{children:[(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/rules_go/blob/master/go/modes.rst#mode-attributes",children:"Build modes"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"static, race, msan, pure, strip, debug, gotags, linkmode"}),"\n",(0,o.jsxs)(l.li,{children:["\u547d\u4ee4\u884c ",(0,o.jsx)(l.code,{children:"--@io_bazel_rules_go//go/config:<mode>"})]}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.code,{children:'go_binary(<mode> = "")'})}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(l.li,{children:["toolchain\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"go_register_toolchains -> @go_sdk -> go_download_sdk"}),"\n",(0,o.jsx)(l.li,{children:"go_download_sdk - \u4e0b\u8f7d"}),"\n",(0,o.jsx)(l.li,{children:"go_local_sdk - \u6307\u5b9a\u672c\u5730 PATH"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(l.li,{children:["go_binary\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["out - \u8f93\u51fa\u540d\u5b57\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u9ed8\u8ba4\u5982\u679c name \u548c dir \u540d\u5b57\u76f8\u540c\uff0c\u5219\u4f1a\u6dfb\u52a0\u4e0b\u5212\u7ebf"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-py",children:'load("@io_bazel_rules_go//go:deps.bzl", "go_rules_dependencies", "go_register_toolchains")\n\ngo_rules_dependencies()\n\ngo_register_toolchains(version = "1.15.5")\n# \u4f7f\u7528 host \u7684 go \u7248\u672c - \u7f16\u8bd1\u4e0d\u4e00\u5b9a\u53ef\u91cd\u73b0\n# \u4f46\u66f4\u5feb\uff0c\u5c11\u4e86\u4e0b\u8f7d\u5b89\u88c5\u8fc7\u7a0b\ngo_register_toolchains(version = "host")\n'})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# \u4ea4\u53c9\u7f16\u8bd1\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //cmd\n# with CGO\nbazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64_cgo //cmd\n"})}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:"\u4e5f\u53ef\u4ee5\u5728 go_binary \u8bbe\u7f6e goos \u548c goarch"}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"gazelle",children:"gazelle"}),"\n",(0,o.jsx)(l.admonition,{type:"caution",children:(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["\u9ed8\u8ba4\u8981\u6c42 proto \u5305\u540d\u5339\u914d\u76ee\u5f55 \u540d\u5b57 - ",(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/271",children:"#271"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.code,{children:'go_repository(build_file_proto_mode = "disable_global",)'})}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:"# \u547d\u4ee4\u884c\u751f\u6210\ngazelle -go_prefix go-micro.dev/v4 -proto disable\n\ngazelle update\n"})}),"\n",(0,o.jsx)(l.h2,{id:"go_sdk",children:"go_sdk"}),"\n",(0,o.jsx)(l.pre,{children:(0,o.jsx)(l.code,{className:"language-bash",children:'# Host\ngo_host_sdk(name="go_sdk")\n# Local\ngo_local_sdk(\n    name = "go_sdk",\n    path = "/Users/wener/sdk/go1.18beta1",\n)\ngo_register_toolchains()\n\n# Download\ngo_register_toolchains(version = "1.17.6")\n# Host\ngo_register_toolchains(version = "host")\n'})}),"\n",(0,o.jsx)(l.h2,{id:"found-but-does-not-contain-package",children:"found but does not contain package"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/953",children:"https://github.com/bazelbuild/bazel-gazelle/issues/953"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"is-not-visible-from-target",children:"is not visible from target"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/1117",children:"https://github.com/bazelbuild/bazel-gazelle/issues/1117"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898",children:"\u7f13\u5b58\u76f8\u5173\u95ee\u9898"}),"\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["GO_REPOSITORY_USE_HOST_CACHE\n",(0,o.jsxs)(l.ul,{children:["\n",(0,o.jsxs)(l.li,{children:["\u4f7f\u7528 ",(0,o.jsx)(l.code,{children:"go env GOPATH"})," \u800c\u4e0d\u662f\u4f7f\u7528 bazel \u7f13\u5b58"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/701",children:"https://github.com/bazelbuild/bazel-gazelle/issues/701"})}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/549",children:"https://github.com/bazelbuild/bazel-gazelle/issues/549"})}),"\n",(0,o.jsx)(l.li,{children:(0,o.jsx)(l.a,{href:"https://github.com/bazelbuild/bazel-gazelle/issues/543",children:"https://github.com/bazelbuild/bazel-gazelle/issues/543"})}),"\n"]}),"\n",(0,o.jsx)(l.h2,{id:"go-cannot-find-goroot-directory-usrlocalgo",children:"go: cannot find GOROOT directory: /usr/local/go"}),"\n",(0,o.jsx)(l.p,{children:"/usr/lib/go"})]})}function g(e={}){const{wrapper:l}={...(0,s.a)(),...e.components};return l?(0,o.jsx)(l,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},3354:(e,l,n)=>{var o=n(50959),s=Symbol.for("react.element"),i=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,r=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function t(e,l,n){var o,i={},t=null,c=null;for(o in void 0!==n&&(t=""+n),void 0!==l.key&&(t=""+l.key),void 0!==l.ref&&(c=l.ref),l)a.call(l,o)&&!d.hasOwnProperty(o)&&(i[o]=l[o]);if(e&&e.defaultProps)for(o in l=e.defaultProps)void 0===i[o]&&(i[o]=l[o]);return{$$typeof:s,type:e,key:t,ref:c,props:i,_owner:r.current}}l.Fragment=i,l.jsx=t,l.jsxs=t},11527:(e,l,n)=>{e.exports=n(3354)},47214:(e,l,n)=>{n.d(l,{Z:()=>r,a:()=>a});var o=n(50959);const s={},i=o.createContext(s);function a(e){const l=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(l):{...l,...e}}),[l,e])}function r(e){let l;return l=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(i.Provider,{value:l},e.children)}}}]);