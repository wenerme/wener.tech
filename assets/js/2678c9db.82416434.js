/*! For license information please see 2678c9db.82416434.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[41168],{50004:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>a});var s=n(2488),r=n(62780);const i={title:"etcd"},l="etcd",c={id:"db/kv/etcd",title:"etcd",description:"- etcd.conf.yml",source:"@site/../notes/db/kv/etcd.md",sourceDirName:"db/kv",slug:"/db/kv/etcd",permalink:"/notes/db/kv/etcd",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/db/kv/etcd.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1704307832,formattedLastUpdatedAt:"Jan 3, 2024",frontMatter:{title:"etcd"},sidebar:"docs",previous:{title:"dragonflydb",permalink:"/notes/db/kv/dragonflydb"},next:{title:"FoundationDB",permalink:"/notes/db/kv/foundationdb"}},d={},a=[{value:"etcdctl",id:"etcdctl",level:2},{value:"\u914d\u7f6e {configuration}",id:"\u914d\u7f6e-configuration",level:2},{value:"limits",id:"limits",level:2},{value:"the member has been permanently removed from the cluster",id:"the-member-has-been-permanently-removed-from-the-cluster",level:2},{value:"member has already been bootstrapped",id:"member-has-already-been-bootstrapped",level:2},{value:"prober detected unhealthy status",id:"prober-detected-unhealthy-status",level:2}];function o(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"etcd",children:"etcd"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/etcd-io/etcd/blob/main/etcd.conf.yml.sample",children:"etcd.conf.yml"})}),"\n",(0,s.jsxs)(t.li,{children:["adopters:\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"kubernetes"}),"\n",(0,s.jsx)(t.li,{children:"vitess"}),"\n",(0,s.jsx)(t.li,{children:"Apache APISIX"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://discovery.etcd.io",children:"https://discovery.etcd.io"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u53d1\u73b0\u9636\u6bb5"}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"https://discovery.etcd.io/${UUID}"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\u5b58\u50a8 ",(0,s.jsx)(t.a,{href:"https://github.com/etcd-io/bbolt",children:"etcd-io/bbolt"})]}),"\n",(0,s.jsxs)(t.li,{children:["\u53c2\u8003\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/integrations/",children:"https://etcd.io/docs/v3.5/integrations/"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"v3 API"}),"\n",(0,s.jsx)(t.li,{children:"RBAC"}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u9002\u7528\u4e8e \u5c11\u91cf\u66f4\u65b0\uff0c\u5927\u91cf\u8bfb\u53d6\u7684\u573a\u666f"}),"\n",(0,s.jsx)(t.li,{children:"\u9891\u7e41\u66f4\u65b0\u5bfc\u81f4 snapshot \u589e\u957f\u5f88\u5feb"}),"\n",(0,s.jsx)(t.li,{children:"\u9ed8\u8ba4 2GiB \u5b58\u50a8"}),"\n",(0,s.jsx)(t.li,{children:"\u9ed8\u8ba4 value \u4e0a\u9650 1.5MiB"}),"\n",(0,s.jsx)(t.li,{children:"v2 API - 3.5 \u5e9f\u5f03, 3.6 \u9000\u5f79"}),"\n"]})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'# Docker\n# ==========\ndocker run --rm -it \\\n  -v $PWD/data:/data \\\n  -p 2379:2379 \\\n  -e ETCD_AUTO_COMPACTION_MODE=revision \\\n  -e ETCD_AUTO_COMPACTION_RETENTION=1000 \\\n  -e ETCD_QUOTA_BACKEND_BYTES=4294967296 \\\n  -e ETCD_SNAPSHOT_COUNT=50000 \\\n  --name etcd quay.io/coreos/etcd:v3.5.0 \\\n  etcd --advertise-client-urls=http://127.0.0.1:2379 --listen-client-urls http://0.0.0.0:2379 --data-dir /data\n\n# macOS\n# ==========\nbrew install etcd\n\n# \u670d\u52a1\u7aef\n# ==========\netcd\n\n# \u5ba2\u6237\u7aef\n# ==========\netcdctl put key "value"\netcdctl get ket\n\n# \u5176\u4ed6\u670d\u52a1\n# stateless pass-through etcd TCP connection forwarding proxy\netcd gateway\n# stateless etcd v3 gRPC L7 reverse proxy\netcd grpc-proxy\n'})}),"\n",(0,s.jsx)(t.h2,{id:"etcdctl",children:"etcdctl"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"etcdctl flag"}),(0,s.jsx)(t.th,{children:"env"}),(0,s.jsx)(t.th,{children:"demo"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{}),(0,s.jsx)(t.td,{children:"ETCDCTL_API"}),(0,s.jsx)(t.td,{children:"3"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"--endpoints"}),(0,s.jsx)(t.td,{}),(0,s.jsx)(t.td,{children:"localhost:2379"})]})]})]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"etcdctl check perf|datascale"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl put|get|watch|lock|del"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl snapshot save|status|restore"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl member list|add|promote|remove|update"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl user list|add|get|delete|passwd|grant-role|revoke-role"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl role list|add|get|delete|grant-permission|revoke-permission"}),"\n",(0,s.jsx)(t.li,{children:"etcdctl auth enable|status|disable"}),"\n",(0,s.jsxs)(t.li,{children:["permission\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"read,readwrite"}),"\n",(0,s.jsx)(t.li,{children:"prefix"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"\u914d\u7f6e-configuration",children:"\u914d\u7f6e {configuration}"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:"# Member\n# ==============================\nname: default # \u6210\u5458\u540d\u5b57\ndata-dir: ${name}.etcd # \u6570\u636e\u76ee\u5f55\nwal-dir: # WAL \u65e5\u5fd7\u76ee\u5f55\n\n# \u5feb\u7167\u5230\u78c1\u76d8\u7684 \u4e8b\u52a1\u6570\nsnapshot-count: 10000\n# \u5fc3\u8df3\u95f4\u9694 ms\nheartbeat-interval: 100\n# \u9009\u4e3e\u8d85\u65f6 ms\nelection-timeout: 1000\n\n# \u540e\u7aef\u6570\u636e\u5927\u5c0f\u62a5\u8b66\u9600\u503c - 0 \u7981\u7528\nquota-backend-bytes: 0\n\n# peer traffic.\n# \u9017\u53f7\u5206\u9694\u591a\u4e2a\nlisten-peer-urls: http://localhost:2380\n# client traffic.\nlisten-client-urls: http://localhost:2379\n\n# \u4fdd\u7559\u5feb\u7167\u6587\u4ef6 - 0 \u65e0\u9650\nmax-snapshots: 5\n# \u4fdd\u7559 WAL \u6587\u4ef6\nmax-wals: 5\n\n# CORS \u57df\u540d - \u9017\u53f7\u5206\u9694\ncors:\n\n# List of this member's peer URLs to advertise to the rest of the cluster.\n# The URLs needed to be a comma-separated list.\ninitial-advertise-peer-urls: http://localhost:2380\n\n# List of this member's client URLs to advertise to the public.\n# The URLs needed to be a comma-separated list.\nadvertise-client-urls: http://localhost:2379\n\n# Discovery URL used to bootstrap the cluster.\ndiscovery:\n\n# exit,proxy\ndiscovery-fallback: 'proxy'\n\n# HTTP proxy to use for traffic to discovery service.\ndiscovery-proxy:\n\n# DNS domain used to bootstrap initial cluster.\ndiscovery-srv:\n\n# Initial cluster configuration for bootstrapping.\ninitial-cluster:\n\n# Initial cluster token for the etcd cluster during bootstrap.\ninitial-cluster-token: 'etcd-cluster'\n\n# Initial cluster state ('new' or 'existing').\ninitial-cluster-state: 'new'\n\n# Reject reconfiguration requests that would cause quorum loss.\nstrict-reconfig-check: false\nenable-pprof: true\n\nclient-transport-security:\n  # Path to the client server TLS cert file.\n  cert-file:\n\n  # Path to the client server TLS key file.\n  key-file:\n\n  # Enable client cert authentication.\n  client-cert-auth: false\n\n  # Path to the client server TLS trusted CA cert file.\n  trusted-ca-file:\n\n  # Client TLS using generated certificates\n  auto-tls: false\n\npeer-transport-security:\n  # Path to the peer server TLS cert file.\n  cert-file:\n\n  # Path to the peer server TLS key file.\n  key-file:\n\n  # Enable peer client cert authentication.\n  client-cert-auth: false\n\n  # Path to the peer server TLS trusted CA cert file.\n  trusted-ca-file:\n\n  # Peer TLS using generated certificates.\n  auto-tls: false\n\n# The validity period of the self-signed certificate, the unit is year.\nself-signed-cert-validity: 1\n\nlog-level: debug\nlogger: zap\n# default, stderr, stdout\nlog-outputs: [stderr]\nenable-log-rotation: false\nlog-rotation-config-json: '{\"maxsize\": 100, \"maxage\": 0, \"maxbackups\": 0, \"localtime\": false, \"compress\": false}'\n\n# Clustering\n# ==============================\n\n# periodic - \u57fa\u4e8e\u95f4\u9694\uff0c\u9ed8\u8ba4\u5355\u4f4d\u4e3a\u5c0f\u65f6\n# revision - \u57fa\u4e8e\u7248\u672c\nauto-compaction-mode: periodic\nauto-compaction-retention: '1'\n\nenable-v2: false\n\n# v2 Proxy\n# on,off\nproxy: 'off'\nproxy-failure-wait: 5000\nproxy-refresh-interval: 30000\nproxy-dial-timeout: 1000\nproxy-write-timeout: 5000\nproxy-read-timeout: 0\n\n# Unsafe\n# ==============================\n# \u5f3a\u5236\u521b\u5efa\u5355\u6210\u5458\u96c6\u7fa4\nforce-new-cluster: false\nunsafe-no-fsync: false\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/op-guide/configuration/",children:"https://etcd.io/docs/v3.5/op-guide/configuration/"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"limits",children:"limits"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"flag"}),(0,s.jsx)(t.th,{style:{textAlign:"right"},children:"default"}),(0,s.jsx)(t.th,{children:"note"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"--max-request-bytes"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"1.5MiB"}),(0,s.jsx)(t.td,{})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"--quota-backend-bytes"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"2GiB"}),(0,s.jsx)(t.td,{children:"\u63a8\u8350 8GiB"})]})]})]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://etcd.io/docs/v3.5/dev-guide/limit/",children:"https://etcd.io/docs/v3.5/dev-guide/limit/"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"the-member-has-been-permanently-removed-from-the-cluster",children:"the member has been permanently removed from the cluster"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/bitnami/charts/issues/16071",children:"https://github.com/bitnami/charts/issues/16071"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"member-has-already-been-bootstrapped",children:"member has already been bootstrapped"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"etcdctl endpoint status\netcdctl member list\netcdctl member remove 3ff1b5cd453a87df\n\n# etcdserver: member not found\n\netcdctl member add apisix-etcd-2 --peer-urls=http://apisix-etcd-2.apisix-etcd-headless.apisix.svc.cluster.local:2380,http://apisix-etcd-2.apisix-etcd-headless.apisix.svc.cluster.local:2379,http://apisix-etcd.apisix.svc.cluster.local:2379\n"})}),"\n",(0,s.jsx)(t.h2,{id:"prober-detected-unhealthy-status",children:"prober detected unhealthy status"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"connection refused"}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.M)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},38088:(e,t,n)=>{var s=n(96651),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function a(e,t,n){var s,i={},a=null,o=null;for(s in void 0!==n&&(a=""+n),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(o=t.ref),t)l.call(t,s)&&!d.hasOwnProperty(s)&&(i[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===i[s]&&(i[s]=t[s]);return{$$typeof:r,type:e,key:a,ref:o,props:i,_owner:c.current}}t.Fragment=i,t.jsx=a,t.jsxs=a},2488:(e,t,n)=>{e.exports=n(38088)},62780:(e,t,n)=>{n.d(t,{I:()=>c,M:()=>l});var s=n(96651);const r={},i=s.createContext(r);function l(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);