/*! For license information please see 02f06bb8.cd8ae26e.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[32656],{86642:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>a});var l=i(11527),r=i(47214);const s={title:"Linkerd"},d="Linkerd",t={id:"devops/service/linkerd",title:"Linkerd",description:"- linkerd/linkerd2",source:"@site/../notes/devops/service/linkerd.md",sourceDirName:"devops/service",slug:"/devops/service/linkerd",permalink:"/notes/devops/service/linkerd",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/service/linkerd.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1693122196,formattedLastUpdatedAt:"Aug 27, 2023",frontMatter:{title:"Linkerd"},sidebar:"docs",previous:{title:"Linkerd Version",permalink:"/notes/devops/service/linkerd-version"},next:{title:"lura",permalink:"/notes/devops/service/lura"}},c={},a=[{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"Helm \u5b89\u88c5",id:"helm-\u5b89\u88c5",level:3},{value:"TLS \u8bc1\u4e66\u66f4\u65b0",id:"tls-\u8bc1\u4e66\u66f4\u65b0",level:2},{value:"\u5b9e\u9a8c",id:"\u5b9e\u9a8c",level:2},{value:"Service Profile",id:"service-profile",level:2},{value:"ingress",id:"ingress",level:2},{value:"tracing",id:"tracing",level:2},{value:"\u4ee3\u7406\u914d\u7f6e",id:"\u4ee3\u7406\u914d\u7f6e",level:2},{value:"addons",id:"addons",level:2},{value:"linker1 \u914d\u7f6e",id:"linker1-\u914d\u7f6e",level:2},{value:"\u591a\u96c6\u7fa4",id:"\u591a\u96c6\u7fa4",level:2}];function o(n){const e={a:"a",code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",li:"li",pre:"pre",ul:"ul",...(0,r.a)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h1,{id:"linkerd",children:"Linkerd"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2",children:"linkerd/linkerd2"})}),"\n",(0,l.jsxs)(e.li,{children:["\u4f18\u52bf\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["linkerd2-proxy\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u975e\u5e38\u8f7b\u91cf\u5feb\u901f"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["top/tap/routes\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5df2\u7ecf\u5305\u542b\u4e86\u7528\u4e8e\u5feb\u901f\u8c03\u8bd5\u548c\u68c0\u67e5\u6d41\u91cf\u7684\u529f\u80fd"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"prometheus/grafana - \u5185\u5efa\u96c6\u6210"}),"\n",(0,l.jsx)(e.li,{children:"mTLS"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u52a3\u52bf\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["linkerd2-proxy\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9488\u5bf9\u6027\u5f00\u53d1 - \u529f\u80fd\u76f8\u5bf9\u7b80\u5355"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u80fd\u652f\u6301\u7c7b\u4f3c envoy\u3001nginx \u4e4b\u7c7b\u7684\u534f\u8bae\u5c42\u57fa\u7840\u529f\u80fd"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u652f\u6301 Circuit Breaker"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u652f\u6301 Auth"}),"\n",(0,l.jsx)(e.li,{children:"CP \u4e0d\u80fd\u7ba1\u7406\u591a\u96c6\u7fa4"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u652f\u6301 Service-to-Service \u6388\u6743"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.del,{children:"\u4e0d\u652f\u6301 Header \u8def\u7531"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3165",children:"#3165"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u95ee\u9898\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3403",children:"linkerd/linkerd2#3403"})," - Injected nginx ingress controller doesn't have access to the remote client IP"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2846",children:"linkerd/linkerd2#2846"})," - Circuit Breaker"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3165",children:"linkerd/linkerd2#3165"})," - Header based routing"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u6ce8\u610f\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"linkerd2 \u76f8\u5bf9\u8f83\u65b0\uff0c\u529f\u80fd\u4e0a\u53ef\u80fd\u8fd8\u6709\u7f3a\u5931"}),"\n",(0,l.jsxs)(e.li,{children:["Prometheus \u53ef\u80fd\u4f1a\u5360\u7528\u8f83\u591a\u8d44\u6e90\uff0c\u53ef\u4ee5\u4f7f\u7528\u5916\u90e8\u5b9e\u4f8b - ",(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2980",children:"#2980"})]}),"\n",(0,l.jsx)(e.li,{children:"ECDSA \u8bc1\u4e66\u9700\u8981 P256"}),"\n",(0,l.jsxs)(e.li,{children:["egress \u652f\u6301\u4e0d\u592a\u597d - \u53ea\u652f\u6301 HTTP\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"TCP \u5916\u90e8\u6d41\u91cf\u65e0\u6cd5\u76d1\u63a7"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3190",children:"#3190"})," - Egress HTTPS Metrics"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/2192",children:"#2192"})," - Monitoring outbound HTTPS external call"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.del,{children:"TCP \u652f\u6301\u4e0d\u597d"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsxs)(e.del,{children:["\u4e0d\u652f\u6301 mTLS ",(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3207",children:"#3207"})]})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsxs)(e.del,{children:["\u4e0d\u652f\u6301 LB \u548c\u8f6c\u53d1 ",(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3445",children:"#3445"})]})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u6ce8\u610f Ingress \u8fdc\u7a0b IP \u95ee\u9898\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2/issues/3403",children:"#3403"})}),"\n",(0,l.jsxs)(e.li,{children:["\u6dfb\u52a0 annotations - ",(0,l.jsx)(e.code,{children:"config.linkerd.io/skip-inbound-ports: '80,443'"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://linkerd.io/2/reference/architecture/",children:"\u67b6\u6784"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u7ec4\u4ef6\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["cp\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["sp-validator - Service Profile Validator\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"admission controller"}),"\n",(0,l.jsx)(e.li,{children:"\u5f53 service profile \u4fdd\u5b58\u7684\u65f6\u5019\u6821\u9a8c"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"destination"}),"\n",(0,l.jsx)(e.li,{children:"identity - CA, \u63a5\u53d7\u4ee3\u7406\u7684 CSR \u8bf7\u6c42"}),"\n",(0,l.jsx)(e.li,{children:"heartbeat"}),"\n",(0,l.jsx)(e.li,{children:"web"}),"\n",(0,l.jsxs)(e.li,{children:["tap\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u63a5\u53d7 cli \u548c dashboard \u8bf7\u6c42\u76d1\u542c\u4ee3\u7406\u7684\u6d41\u91cf"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["proxy-injector\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"admission controller"}),"\n",(0,l.jsx)(e.li,{children:"\u6dfb\u52a0\u6ce8\u5165\u903b\u8f91\uff0c\u4f7f\u7528 initContainer \u521d\u59cb\u5316 iptables"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"grafana"}),"\n",(0,l.jsx)(e.li,{children:"prometheus"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["dp\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"proxy - linkerd2-proxy"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-init"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Control Plane\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2",children:"linkerd/linkerd2"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Dataplane\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/linkerd/linkerd2-proxy",children:"linkerd/linkerd2-proxy"})}),"\n",(0,l.jsx)(e.li,{children:"\u65e0\u914d\u7f6e\u4ee3\u7406 - iptable \u8f6c\u53d1"}),"\n",(0,l.jsx)(e.li,{children:"/metrics"}),"\n",(0,l.jsx)(e.li,{children:"WebSocket \u4ee3\u7406"}),"\n",(0,l.jsx)(e.li,{children:"\u5ef6\u65f6\u611f\u77e5\u7684 L7 \u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(e.li,{children:"L4 TCP \u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(e.li,{children:"mtls"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"tap"})," \u8bca\u65ad\u63a5\u53e3 - \u7c7b\u4f3c tcpdump \u6982\u5ff5"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u7279\u6027\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"HTTP, HTTP/2, gRPC"}),"\n",(0,l.jsx)(e.li,{children:"TCP \u4ee3\u7406\u548c\u534f\u8bae\u68c0\u6d4b"}),"\n",(0,l.jsx)(e.li,{children:"\u8d85\u65f6\u3001\u91cd\u8bd5"}),"\n",(0,l.jsx)(e.li,{children:"mtls"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u63d0\u4f9b Ingress\uff0c\u4e0e\u73b0\u6709 Ingress \u5171\u5b58"}),"\n",(0,l.jsxs)(e.li,{children:["\u6307\u6807\u76d1\u63a7\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e3a\u6240\u6709\u6d41\u91cf\u8bb0\u5f55\u6838\u5fc3\u6307\u6807 - request volume, success rate, latency distributions"}),"\n",(0,l.jsx)(e.li,{children:"\u8bb0\u5f55 TCP \u6307\u6807"}),"\n",(0,l.jsx)(e.li,{children:"\u6839\u636e Service Profile \u8bb0\u5f55\u8bf7\u6c42\u3001\u88ab\u8bf7\u6c42\u6307\u6807"}),"\n",(0,l.jsx)(e.li,{children:"\u751f\u6210\u62d3\u6251\u56fe"}),"\n",(0,l.jsx)(e.li,{children:"\u8bf7\u6c42\u91c7\u6837"}),"\n",(0,l.jsxs)(e.li,{children:["\u67e5\u770b\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"linkerd stat"}),", ",(0,l.jsx)(e.code,{children:"linkerd routes"})]}),"\n",(0,l.jsx)(e.li,{children:"dashboard -> Grafana"}),"\n",(0,l.jsxs)(e.li,{children:["\u5185\u5efa Prometheus \u5b9e\u4f8b\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9ed8\u8ba4\u4fdd\u7559 6 \u5c0f\u65f6"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u8d1f\u8f7d\u5747\u8861 - EWMA \u7b97\u6cd5 - exponentially weighted moving average"}),"\n",(0,l.jsxs)(e.li,{children:["\u81ea\u52a8\u6ce8\u5165 - ",(0,l.jsx)(e.code,{children:"linkerd.io/inject: enabled"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"admission webhook \u5b9e\u73b0"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-init \u914d\u7f6e iptables"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-proxy - dp"}),"\n",(0,l.jsxs)(e.li,{children:["\u6dfb\u52a0 annotation \u540e\u9700\u8981 ",(0,l.jsx)(e.code,{children:"kubectl rollout restart"})]}),"\n",(0,l.jsxs)(e.li,{children:["\u4e3b\u52a8\u7981\u7528 ",(0,l.jsx)(e.code,{children:"linkerd.io/inject: disabled"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["CNI \u63d2\u4ef6\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f7f\u7528\u4e86\u5219\u4e0d\u9700\u8981 linkerd-init \u914d\u7f6e iptables\uff0c\u4f1a\u81ea\u52a8\u91cd\u5199"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u96c6\u6210 grafana"}),"\n",(0,l.jsx)(e.li,{children:"\u5206\u5e03\u5f0f\u8ddf\u8e2a"}),"\n",(0,l.jsx)(e.li,{children:"Fault Injection"}),"\n",(0,l.jsxs)(e.li,{children:["ha cp\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.code,{children:"linkerd install --ha --controller-replicas=2"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u8de8\u96c6\u7fa4\u901a\u4fe1"}),"\n",(0,l.jsxs)(e.li,{children:["Service Profile\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u63d0\u4f9b\u989d\u5916\u63a5\u53e3\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u6d41\u91cf\u5207\u5206"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"linkerd install"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9ed8\u8ba4\u5b89\u88c5\u5230 linkerd \u7a7a\u95f4"}),"\n",(0,l.jsxs)(e.li,{children:["ClusterRole - ",(0,l.jsx)(e.code,{children:"$NAMESPACE-linkerd-$COMPONENT"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-identity"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-controller"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-destination"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-prometheus"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-proxy-injector"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-sp-validator"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-linkerd-tap"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"linkerd-heartbeat"}),"\n",(0,l.jsx)(e.li,{children:"linkerd-web"}),"\n",(0,l.jsxs)(e.li,{children:["crds\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"serviceprofiles.linkerd.io/v1alpha2"}),"\n",(0,l.jsx)(e.li,{children:"trafficsplits.split.smi-spec.io/v1alpha1"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"secret/linkerd-proxy-injector-tls"}),"\n",(0,l.jsx)(e.li,{children:"secret/linkerd-sp-validator-tls"}),"\n",(0,l.jsx)(e.li,{children:"secret/linkerd-tap-tls"}),"\n",(0,l.jsx)(e.li,{children:"cm/linkerd-config"}),"\n",(0,l.jsx)(e.li,{children:"cm/linkerd-config-addons"}),"\n",(0,l.jsx)(e.li,{children:"deploy/linkerd-identity"}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-controller\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-controller-api"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-destination\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-dst"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["cronjob/linkerd-heartbeat\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"linkerd telemetry"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-web\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-web"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-prometheus\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-prometheus"}),"\n",(0,l.jsx)(e.li,{children:"cm/linkerd-prometheus-config"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-proxy-injector\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-proxy-injector"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-sp-validator\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-sp-validator"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-tap\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-tap"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["deploy/linkerd-grafana\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"svc/linkerd-grafana"}),"\n",(0,l.jsx)(e.li,{children:"cm/linkerd-grafana-config"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.infoq.com/articles/linkerd-v2-production-adoption/",children:"Linkerd v2: How Lessons from Production Adoption Resulted in a Rewrite of the Service Mesh"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["tls\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["secret/linkerd-identity-issuer\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5305\u542b\u4e86 issuer \u8bc1\u4e66"}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679c schema \u4e3a kubernetes.io/tls \u5219\u9700\u8981 tls.crt, tls.key, ca.crt"}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679c schema \u4e3a linkerd.io/tls \u5219\u9700\u8981 crt.pem, key.pem"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"secret/linkerd-trust-anchor"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"brew install linkerd\n\nlinkerd version\nlinkerd check --pre\n\nlinkerd install | kubectl apply -f -\n\nlinkerd check\n\nkubectl -n linkerd get deploy\n\nlinkerd dashboard\nlinkerd -n linkerd top deploy/linkerd-web\n\n# \u6ce8\u5165\nkubectl get -n emojivoto deploy -o yaml \\\n  | linkerd inject - \\\n  | kubectl apply -f -\n\n# \u5378\u8f7d\nlinkerd install --ignore-cluster | kubectl delete -f -\n\n\n# \u6ce8\u5165\u7a7a\u95f4\nkubectl get ns monitoring -o yaml | linkerd inject - | kubectl apply -f -\n# \u91cd\u542f\u540e\u5168\u90e8\u751f\u6548\nkubectl rollout restart -n monitoring deployment\nkubectl rollout restart -n monitoring daemonset\nkubectl rollout restart -n monitoring statefulset\n\nkubectl get ns kubernetes-dashboard -o yaml | linkerd inject - | kubectl apply -f -\nkubectl rollout restart -n kubernetes-dashboard deployment\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# https://linkerd.io/2/reference/cli/install/\n# --addon-config - \u81ea\u5b9a\u4e49\u914d\u7f6e\n# --controller-replicas=1\n# --disable-heartbeat\n# --registry=gcr.io/linkerd-io \u9ed8\u8ba4\u955c\u50cf\u4ed3\u5e93\n# cmi - https://github.com/wenerme/container-mirror\nlinkerd install --disable-heartbeat --registry registry.cn-hongkong.aliyuncs.com/cmi\n\n# \u6240\u6709\u7684\u955c\u50cf\nlinkerd install | grep 'image: ' | sed -r 's/\\s*image:\\s*(.*)/\\1/' | sort -u\n\nlinkerd install | grep 'image: ' | sed -r 's/\\s*image:\\s*(.*)/\\1/' | sort -u | xargs -n 1 -I {} echo A {} B\n"})}),"\n",(0,l.jsx)(e.h3,{id:"helm-\u5b89\u88c5",children:"Helm \u5b89\u88c5"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# \u751f\u6210\u8bc1\u4e66\nbrew install step\n\nstep certificate create identity.linkerd.cluster.local ca.crt ca.key --profile root-ca --no-password --insecure\n\nstep certificate create identity.linkerd.cluster.local issuer.crt issuer.key --ca ca.crt --ca-key ca.key --profile intermediate-ca --not-after 8760h --no-password --insecure\n\n# Helm \u5b89\u88c5\n# https://linkerd.io/2/tasks/install-helm/\n# helm repo add linkerd-edge https://helm.linkerd.io/edge\nhelm repo add linkerd https://helm.linkerd.io/stable\n\n# set expiry date one year from now\n# in Mac:\n# exp=$(date -v+8760H +"%Y-%m-%dT%H:%M:%SZ")\n# in Linux:\n# exp=$(date -d \'+8760 hour\' +"%Y-%m-%dT%H:%M:%SZ")\n\n# \u5982\u679c\u6709 CNI --set global.cniEnabled=true\n# \u9ed8\u8ba4\u5b89\u88c5\u5230 linkerd \u7a7a\u95f4\n# \u81ea\u5df1\u63d0\u4f9b prometheus\n# https://linkerd.io/2/tasks/external-prometheus/\n# --set global.prometheusUrl: existing-prometheus.xyz:9090\nhelm install linkerd2 \\\n  --set-file global.identityTrustAnchorsPEM=ca.crt \\\n  --set-file identity.issuer.tls.crtPEM=issuer.crt \\\n  --set-file identity.issuer.tls.keyPEM=issuer.key \\\n  --set identity.issuer.crtExpiry=$(date -d \'+8760 hour\' +"%Y-%m-%dT%H:%M:%SZ") \\\n  --set installNamespace=false \\\n  --create-namespace \\\n  linkerd/linkerd2\n'})}),"\n",(0,l.jsx)(e.h2,{id:"tls-\u8bc1\u4e66\u66f4\u65b0",children:"TLS \u8bc1\u4e66\u66f4\u65b0"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://linkerd.io/2/tasks/automatically-rotating-control-plane-tls-credentials/",children:"https://linkerd.io/2/tasks/automatically-rotating-control-plane-tls-credentials/"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u5b9e\u9a8c",children:"\u5b9e\u9a8c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"cat <<YAML | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: alpine\n  namespace: default\n  annotations:\n    linkerd.io/inject: enabled\nspec:\n  containers:\n  - name: alpine\n    image: wener/base\n    command:\n    - tail\n    args:\n    - -f\n    - /dev/null\nYAML\n"})}),"\n",(0,l.jsx)(e.h2,{id:"service-profile",children:"Service Profile"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://linkerd.io/2/reference/service-profiles/",children:"https://linkerd.io/2/reference/service-profiles/"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# linkerd \u5185\u90e8\u7684 sp \u5b9a\u4e49\nlinkerd install-sp\n\n# \u6709 sp \u4fe1\u606f\u7684\u4f1a\u9644\u52a0 rt_route \u5230\u6307\u6807\nlinkerd tap -o wide <target> | grep req | grep -v rt_route\n\n\n# \u68c0\u6d4b\u6d41\u91cf\u751f\u6210 profile\nlinkerd profile -n emojivoto web-svc --tap deploy/web --tap-duration 10s\n# \u901a\u8fc7 pb \u751f\u6210\nlinkerd profile --proto web.proto web-svc\n# \u901a\u8fc7 swagger \u751f\u6210\nlinkerd profile --open-api webapp.swagger webapp\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"apiVersion: linkerd.io/v1alpha2\nkind: ServiceProfile\nmetadata:\n  name: nginx-demo.default.svc.cluster.local\n  namespace: default\nspec:\n  routes:\n    - name: me.wener.apis.test.PingService#ping\n      condition:\n        method: POST\n        pathRegex: /api/service/me.wener.apis.test.PingService/ping\n      isRetryable: true\n      timeout: 3s\n      responseClasses:\n        - condition:\n            not:\n              status:\n                min: 200\n                max: 399\n          isFailure: true\n    - name: me.wener.apis.test.PingService\n      condition:\n        method: POST\n        pathRegex: /api/service/me.wener.apis.test.PingService/.*\n      isRetryable: false\n  retryBudget:\n    # \u6700\u591a\u6709 20% \u88ab\u91cd\u8bd5\n    retryRatio: 0.2\n    # \u5141\u8bb8\u7684\u6bcf\u79d2\u91cd\u8bd5\u6b21\u6570\n    minRetriesPerSecond: 10\n    # \u8ba1\u7b97 retryRatio \u7684\u65f6\u95f4\u7a97\u53e3\n    ttl: 10s\n"})}),"\n",(0,l.jsx)(e.h2,{id:"ingress",children:"ingress"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u6ce8\u610f\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f1a\u5bfc\u81f4 nginx \u7684\u7c98\u6027\u4f1a\u8bdd\u65e0\u6548"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"# nginx annotation\nnginx.ingress.kubernetes.io/configuration-snippet: |\n  proxy_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n  grpc_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n\n# with auth url\nnginx.ingress.kubernetes.io/auth-url: 'https://$host/oauth2/auth'\nnginx.ingress.kubernetes.io/auth-signin: 'https://$host/oauth2/start?rd=$escaped_request_uri'\nnginx.ingress.kubernetes.io/auth-snippet: |\n  proxy_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n  grpc_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:$service_port;\n"})}),"\n",(0,l.jsx)(e.h2,{id:"tracing",children:"tracing"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://linkerd.io/2/tasks/distributed-tracing/",children:"Distributed tracing with Linkerd"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://linkerd.io/2019/08/09/service-mesh-distributed-tracing-myths/",children:"Distributed tracing in the service mesh: four myths"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5e76\u4e0d\u9700\u8981\u8ddf\u8e2a \u68c0\u6d4b \u76d1\u63a7\u3001\u5ef6\u65f6\u3001\u541e\u5410"}),"\n",(0,l.jsx)(e.li,{children:"\u5e76\u4e0d\u9700\u8981\u8ddf\u8e2a \u624d\u77e5\u9053\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u4f9d\u8d56\u5173\u7cfb"}),"\n",(0,l.jsx)(e.li,{children:"\u60f3\u8981\u77e5\u9053\u65f6\u95f4\u7247\u6bb5\u91cc\u7684\u8c03\u7528\u5173\u7cfb\u5fc5\u987b\u8981\u4fee\u6539\u4ee3\u7801"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["linkerd \u6709\u7c7b\u4f3c tracing \u7684\u529f\u80fd\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"tap"}),"\n",(0,l.jsx)(e.li,{children:"top"}),"\n",(0,l.jsx)(e.li,{children:"service profile"}),"\n",(0,l.jsx)(e.li,{children:"\u670d\u52a1\u62d3\u6251"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u6ce8\u610f\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Linkerd \u4f7f\u7528 ",(0,l.jsx)(e.a,{href:"https://github.com/openzipkin/b3-propagation",children:"openzipkin/b3-propagation"})," \u683c\u5f0f"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"OpenCensus"})," \u652f\u6301\u73af\u5883\u53d8\u91cf ",(0,l.jsx)(e.code,{children:"OC_AGENT_HOST=linkerd-collector.linkerd:55678"})]}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u679c\u8981\u4f7f\u7528 Tracing \u5219\u4e00\u5b9a\u8981\u5bf9 Ingress \u4e5f\u5f00\u542f\uff0c\u56e0\u4e3a Ingress \u4f1a\u521b\u5efa\u6700\u5f00\u59cb\u7684 Span"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"cat << EOF >> config.yaml\ntracing:\n  enabled: true\nEOF\n# \u90e8\u7f72\n# linker-collector\n# linkerd-jaeger\nlinkerd upgrade --addon-config config.yaml | kubectl apply -f -\n\nkubectl -n linkerd rollout status deploy/linkerd-collector\nkubectl -n linkerd rollout status deploy/linkerd-jaeger\n\n# POD Annotation\n# config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678\n# config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector\n\n# \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u652f\u6301\nkubectl -n emojivoto set env --all deploy OC_AGENT_HOST=linkerd-collector.linkerd:55678\n\nkubectl -n linkerd port-forward svc/linkerd-jaeger 16686\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u4ee3\u7406\u914d\u7f6e",children:"\u4ee3\u7406\u914d\u7f6e"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://linkerd.io/2/reference/proxy-configuration/",children:"Proxy Configuration"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"spec:\n  template:\n    metadata:\n      annotations:\n        config.linkerd.io/proxy-cpu-limit: '1.5'\n        config.linkerd.io/proxy-cpu-request: '0.2'\n        config.linkerd.io/proxy-memory-limit: 2Gi\n        config.linkerd.io/proxy-memory-request: 128Mi\n"})}),"\n",(0,l.jsx)(e.h2,{id:"addons",children:"addons"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://linkerd.io/2/tasks/enabling-addons/",children:"Enabling Add-Ons"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"tracing:\n  enabled: true\n  collector:\n    resources:\n      cpu:\n        limit: 100m\n        request: 10m\n      memory:\n        limit: 100Mi\n        request: 50Mi\n"})}),"\n",(0,l.jsx)(e.h2,{id:"linker1-\u914d\u7f6e",children:"linker1 \u914d\u7f6e"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"dtabs - delegate tables \u2014 a backtracking, hierarchical, suffix-preserving routing language used by Finagle"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://api.linkerd.io/head/linkerd/index.html",children:"https://api.linkerd.io/head/linkerd/index.html"})}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-yaml",children:"# \u540d\u5b57 -> \u5730\u5740\nnamers:\n  # Consul \u670d\u52a1\u53d1\u73b0\n  # /svc => /#/io.l5d.consul/dc1/prod;\n  - kind: io.l5d.consul\n    # \u76f4\u63a5\u8bbf\u95ee\u670d\u52a1 - \u5982\u679c\u8bbf\u95ee agent \u5219\u662f $HOST_IP:8500\n    host: consul-server.consul\n    port: 8500\n    # token:\n    includeTag: true\n    useHealthCheck: false\n    healthStatuses:\n      - 'passing'\n      - 'warning'\n    setHost: true\n    consistencyMode: stale\n    # \u901a\u8fc7 tag \u5173\u8054\u6743\u91cd\n    weights:\n      - tag: experimental\n        weight: 0.1\n      - tag: primary\n        weight: 5.0\n\n  # \u91cd\u5199\n  # /svc => /#/rewrite\n  - kind: io.l5d.rewrite\n    prefix: /rewrite\n    pattern: '/{service}/api'\n    name: '/srv/{service}'\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u591a\u96c6\u7fa4",children:"\u591a\u96c6\u7fa4"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Ingress \u57fa\u4e8e Ambassador"}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.a)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(o,{...n})}):o(n)}},3354:(n,e,i)=>{var l=i(50959),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,t=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function a(n,e,i){var l,s={},a=null,o=null;for(l in void 0!==i&&(a=""+i),void 0!==e.key&&(a=""+e.key),void 0!==e.ref&&(o=e.ref),e)d.call(e,l)&&!c.hasOwnProperty(l)&&(s[l]=e[l]);if(n&&n.defaultProps)for(l in e=n.defaultProps)void 0===s[l]&&(s[l]=e[l]);return{$$typeof:r,type:n,key:a,ref:o,props:s,_owner:t.current}}e.Fragment=s,e.jsx=a,e.jsxs=a},11527:(n,e,i)=>{n.exports=i(3354)},47214:(n,e,i)=>{i.d(e,{Z:()=>t,a:()=>d});var l=i(50959);const r={},s=l.createContext(r);function d(n){const e=l.useContext(s);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:d(n.components),l.createElement(s.Provider,{value:e},n.children)}}}]);