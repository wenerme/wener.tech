/*! For license information please see 9c1382e8.065c4a5c.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[52976],{30984:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>c,metadata:()=>a,toc:()=>o});var t=s(2488),r=s(62780);const c={title:"smallstep"},i="smallstep",a={id:"security/cert/smallstep",title:"smallstep",description:"- \u51fa\u4e8e\u5546\u4e1a\u51b3\u5b9a\u79fb\u9664\u4e86 EAB #897",source:"@site/../notes/security/cert/smallstep.md",sourceDirName:"security/cert",slug:"/security/cert/smallstep",permalink:"/notes/security/cert/smallstep",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/security/cert/smallstep.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1699003495,formattedLastUpdatedAt:"Nov 3, 2023",frontMatter:{title:"smallstep"},sidebar:"docs",previous:{title:"Let's Encrypt",permalink:"/notes/security/cert/letsencrypt"},next:{title:"Crypto",permalink:"/notes/security/crypto/"}},l={},o=[{value:"Endpoint",id:"endpoint",level:2},{value:"Get Started",id:"get-started",level:2},{value:"ACME",id:"acme",level:2},{value:"Yubikey KMS",id:"yubikey-kms",level:2},{value:"\u914d\u7f6e",id:"config",level:2},{value:"Concepts",id:"concepts",level:2},{value:"ssh",id:"ssh",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"K8S",id:"k8s",level:2},{value:"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner &#39;Admin JWK&#39;",id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk",level:2},{value:"ACME EAB not enabled for provisioner",id:"acme-eab-not-enabled-for-provisioner",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"smallstep",children:"smallstep"}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u51fa\u4e8e\u5546\u4e1a\u51b3\u5b9a\u79fb\u9664\u4e86 EAB ",(0,t.jsx)(n.a,{href:"https://github.com/smallstep/certificates/issues/897",children:"#897"})]}),"\n"]})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/smallstep/certificates",children:"smallstep/certificates"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Apache-2.0, Go"}),"\n",(0,t.jsx)(n.li,{children:"CA, ACME server"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/smallstep/cli",children:"smallstep/cli"})}),"\n",(0,t.jsxs)(n.li,{children:["kubernetes\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["step-certificates ",(0,t.jsx)(n.a,{href:"https://hub.helm.sh/charts/smallstep/step-certificates",children:"https://hub.helm.sh/charts/smallstep/step-certificates"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/smallstep/autocert",children:"smallstep/autocert"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u6ce8\u5165 TLS/HTTPS \u8bc1\u4e66\u5230\u5bb9\u5668"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u53c2\u8003\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://smallstep.com/blog/everything-pki",children:"Everything you should know about certificates and PKI but are too afraid to ask"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://smallstep.com/blog/use-tls",children:"The case for using TLS everywhere"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["step-ca\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u652f\u6301\u6570\u636e\u5e93 Badger, BoltDB, MySQL, PostgreSQL\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u76ee\u524d\u6b63\u5728\u5c06 NoSQL \u8c03\u6574\u4e3a SQL \u903b\u8f91 - \u4f1a\u652f\u6301\u66f4\u591a DB ",(0,t.jsx)(n.a,{href:"https://github.com/smallstep/certificates/issues/282",children:"smallstep/certificates#282"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u652f\u6301\u7684\u8fd0\u884c\u6a21\u5f0f\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u79bb\u7ebf - \u4e0d\u542f\u52a8\u670d\u52a1\uff0c\u79bb\u7ebf\u7ba1\u7406\u8bc1\u4e66"}),"\n",(0,t.jsx)(n.li,{children:"\u5728\u7ebf - \u542f\u52a8 step-ca\uff0c\u63d0\u4f9b\u63a5\u53e3\u80fd\u529b"}),"\n",(0,t.jsxs)(n.li,{children:["RA - Registration Authority\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"RA \u4f5c\u4e3a CA \u7684\u524d\u7aef"}),"\n",(0,t.jsx)(n.li,{children:"\u4f8b\u5982\u4e3a Vault \u63d0\u4f9b ACMEv2 server \u7684\u80fd\u529b"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["vault \u4e0d\u652f\u6301\u4f5c\u4e3a acme server\uff0c\u5982\u679c\u9700\u8981\u79c1\u6709\u5316 acme \u53ef\u4ee5\u8003\u8651 step-ca\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/hashicorp/vault/issues/8690",children:"hashicorp/vault#8690"})}),"\n",(0,t.jsx)(n.li,{children:"step-ca \u652f\u6301\u5c06 vault \u4f5c\u4e3a RA/registration authority"}),"\n",(0,t.jsxs)(n.li,{children:["\u4e5f\u53ef\u4ee5\u4f7f\u7528 ",(0,t.jsx)(n.a,{href:"https://github.com/letsencrypt/boulder",children:"letsencrypt/boulder"})]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# macOS\nbrew install step\n# AlpineLinux\napk add step-cli step-certificates -X http://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing/\n\nstep path # \u6570\u636e\u76ee\u5f55 $HOME/.step\nSTEPPATH=/tmp/step step path\n# \u914d\u7f6e $(step path)/config/ca.json\nmkdir -p $STEPPATH && cd $_\n\n# \u751f\u6210 CA $HOME/.step/certs/root_ca.crt $HOME/.step/secrets/root_ca_key\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\nstep certificate fingerprint certs/root_ca.crt\n\n# step ca certificate --offline foo.smallstep.com foo.crt foo.key\n\n\n# \u83b7\u53d6\u5f53\u524d\u7684 root fingerprint\nstep certificate fingerprint $(step path)/certs/root_ca.crt\n# \u53e6\u5916\u4e00\u4e2a\u8282\u70b9\nstep ca bootstrap --ca-url 127.0.0.1:443 --fingerprint <root fingerprint>\n\n# \u751f\u6210\u8bc1\u4e66\nstep ca certificate localhost srv.crt srv.key\n# \u4fdd\u6301 root ca - \u6709\u4e9b\u573a\u666f\u9700\u8981\u7528\u4e8e\u8ba4\u8bc1\nstep ca root root.crt\n\n# \u67e5\u770b\u8bc1\u4e66\u4fe1\u606f\nstep certificate inspect srv.crt --short\n\n# \u751f\u6210 CSR\nstep certificate create --csr foo.example.com foo.csr foo.key\n# \u5bf9 CSR \u7b7e\u540d\nstep ca sign foo.csr foo.crt\n# renew \u8bc1\u4e66\nstep ca renew foo.crt foo.key\n# \u56de\u6536\u8bc1\u4e66\nstep ca revoke --cert svc.crt --key svc.key\n\n\n# \u5f53\u524d\u652f\u6301 provisioner\nstep ca provisioner list\n# \u6dfb\u52a0\u540e\u9700\u8981\u91cd\u542f ca \u751f\u6548\nstep ca provisioner add you@example.com --create\n\n# step \u5305\u542b jwt \u89e3\u7801\u903b\u8f91\necho $TOKEN | step crypto jwe decrypt  | jq\n\n# \u751f\u6210\u8bc1\u4e66\u4f1a\u8981\u6c42\u9009\u62e9 provisioner\nstep ca certificate mike@example.com mike.crt mike.key\n\nstep certificate inspect --short mike.crt\n\n# \u6dfb\u52a0 google \u4f5c\u4e3a IdP\nstep ca provisioner add Google --type oidc --ca-config $(step path)/config/ca.json \\\n  --client-id 650445034027-jsjdrkiskeq9ke99ud2rqkst82ft8uch.apps.googleusercontent.com \\\n  --client-secret 6Q7lGMua_Oox4nA92QBXYypT \\\n  --configuration-endpoint https://accounts.google.com/.well-known/openid-configuration \\\n  --domain smallstep.com --domain gmail.com\n\n\n# X5C - \u53ef\u4ee5\u518d\u7528\u4e8e\u751f\u6210\u8bc1\u4e66\nstep ca provisioner add x5c-smallstep --type X5C --x5c-root $(step path)/certs/root_ca.crt\n# SSHPOP - renew, revoke, rekey an SSH certificate\nstep ca provisioner add sshpop --type SSHPOP\n# ACME - https://smallstep.com/docs/tutorials/acme-challenge\n# \u4f5c\u4e3a ACMEv2 server\n# https://{ca-host}/acme/{provisioner-name}/directory\nstep ca provisioner add acme --type ACME\n# step certificate install\n\n# K8S SA\nstep ca provisioner add my-kube-provisioner --type K8sSA --pem-keys key.pub\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://hub.docker.com/r/smallstep/step-ca",children:"https://hub.docker.com/r/smallstep/step-ca"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"endpoint",children:"Endpoint"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go",children:"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.a,{href:"https://ca.wener.me/acme/acme/directory",children:"https://ca.wener.me/acme/acme/directory"})})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "newNonce": "https://ca.wener.me/acme/acme/new-nonce",\n  "newAccount": "https://ca.wener.me/acme/acme/new-account",\n  "newOrder": "https://ca.wener.me/acme/acme/new-order",\n  "revokeCert": "https://ca.wener.me/acme/acme/revoke-cert",\n  "keyChange": "https://ca.wener.me/acme/acme/key-change"\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"get-started",children:"Get Started"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# \u521d\u59cb\u5316 CA\n# =====================\nexport STEPPATH=/data/ca\n\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" \\\n  --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --ssh --acme \\\n  --remote-management\n\n# \u6309\u9700\u4fee\u6539 $(step path)/config/ca.json\n# \u4f8b\u5982\u4fee\u6539 db \u5b58\u50a8\n\n# \u542f\u52a8 CA\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\n# \u521d\u59cb\u5316 \u5ba2\u6237\u7aef\n# =====================\ndocker exec -u root -e STEPPATH=/data/step -it stepca bash\n# \u4e0b\u8f7d CA \u8bc1\u4e66\n# $HOME/.step/certs/root_ca.crt\n# $HOME/.step/config/defaults.json\n#   ca-url, fingerprint, root\nstep ca bootstrap --ca-url ca.wener.me --fingerprint $(step certificate fingerprint /data/ca/certs/root_ca.crt)\n\n# \u9700\u8981 root\nstep certificate install $(step path)/certs/root_ca.crt\nls -lash /etc/ssl/certs | grep Wener\n\n# --ca-url https://ca.smallstep.com --root /home/user/.step/certs/root_ca.crt\n# TOKEN=$(step ca token internal.example.com)\n# --token $TOKEN\nstep ca health\n\n# \u7ba1\u7406\u5458\u7528\u6237\nstep ca admin list --super --admin-name step --password-file ca.passwd\n\n# \u751f\u6210\u8bc1\u4e66\nstep ca certificate localhost svr.crt svr.key --provisioner-password-file ./ca.passwd\n# 6m \u6709\u6548\nstep certificate inspect svr.crt --short\n# 1h \u6709\u6548\n# 8760h \u4e3a 1\u5e74, 43800h \u4e3a 5\u5e74, 87600h \u4e3a 10\u5e74\nstep ca certificate localhost svr.crt svr.key --not-after 1h --provisioner-password-file ./ca.passwd\n\n# ACME\nstep ca provisioner add acme --type ACME --password-file ca.passwd\n\ncurl https://ca.wener.me/acme/acme/directory\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/",children:"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"acme",children:"ACME"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/",children:"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"https://{ca-host}/acme/{provisioner-name}/directory"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"yubikey-kms",children:"Yubikey KMS"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Yubikey \u7ba1\u7406 PKI \u7684\u5bc6\u7801"}),"\n",(0,t.jsx)(n.li,{children:"\u7b2c\u4e8c\u6b21\u751f\u6210\u7684 CA \u4f7f\u7528 Yubikey \u4f5c\u4e3a KMS"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# PKI\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./pki.passwd\nSTEPPATH=/data/pki step ca init --pki --name="Wener" --deployment-type standalone --password-file ./pki.passwd\ncp /data/pki/certs/{intermediate_ca.crt,root_ca.crt} .\n\n# \u6dfb\u52a0 crt \u548c key \u5230 yubikey\nykman piv certificates import 9a /data/pki/certs/root_ca.crt\nykman piv keys import 9a /data/pki/secrets/root_ca_key\nykman piv certificates import 9c /data/pki/certs/intermediate_ca.crt\nykman piv keys import 9c /data/pki/secrets/intermediate_ca_key\n\nykman piv info\n\n# \u5c06 data/pki \u4fdd\u5b58\u5230\u5916\u90e8\u5b58\u50a8\u540e\u5220\u9664\n\n# CA\nexport STEPPATH=/data/ca\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name "Wener CA" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address ":443" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\n\n# use pki cert\nmv root_ca.crt intermediate_ca.crt $STEPPATH/certs\nrm -rf $STEPPATH/secrets\n\n# \u4fee\u6539 ca.json \u7684 "key": "/data/ca/secrets/intermediate_ca_key",\n# "key": "yubikey:slot-id=9c",\n# "kms": {\n#     "type": "yubikey",\n#     "pin": "123456"\n# },\nstep-ca $STEPPATH/config/ca.json --password-file ./pki.passwd --provisioner-password-file ./provisioner.passwd\n'})}),"\n",(0,t.jsx)(n.h2,{id:"config",children:"\u914d\u7f6e"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"env"}),(0,t.jsx)(n.th,{children:"for"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"STEPPATH"}),(0,t.jsx)(n.td,{children:"\u6570\u636e\u76ee\u5f55"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"STEPDEBUG"}),(0,t.jsx)(n.td,{})]})]})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["authority.claims\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["maxTLSCertDuration\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u9ed8\u8ba4 24h"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["db\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["KV - \u672c\u5730 - \u4e0d\u652f\u6301 \u5e76\u53d1/\u591a\u8fdb\u7a0b\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"badger -> badgerv1"}),"\n",(0,t.jsx)(n.li,{children:"badgerv1"}),"\n",(0,t.jsx)(n.li,{children:"badgerv2"}),"\n",(0,t.jsx)(n.li,{children:"bbolt"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["SQL - \u8fdc\u7a0b - \u4e5f\u662f\u4f5c\u4e3a KV - nkey, nvalue - 25\u4e2a\u8868\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"mysql"}),"\n",(0,t.jsx)(n.li,{children:"postgresql"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts",children:"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"ssh",children:"ssh"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u521d\u59cb\u5316 CA \u5e26 ssh \u8bc1\u4e66\u652f\u6301\nstep ca init --ssh\n# \u751f\u6210\u914d\u7f6e\nstep ssh config --roots > /path/to/ssh_user_key.pub\n# \u914d\u7f6e CA\ncat << EOF >> /etc/ssh/sshd_config\n# This is the CA's public key for authenticating user certificates:\nTrustedUserCAKeys /path/to/ssh_user_key.pub\nEOF\n# \u751f\u6210\u8bc1\u4e66\nstep ssh certificate alice@smallstep.com id_ecdsa\n# \u67e5\u770b\u751f\u6210\u7684\u8bc1\u4e66\u4fe1\u606f\ncat id_ecdsa-cert.pub | tail -1 | step ssh inspect\n\n# \u751f\u6210 host key\nstep ssh certificate --host internal.example.com ssh_host_ecdsa_key\ncat ssh_host_ecdsa_key-cert.pub | step ssh inspect\n# \u914d\u7f6e host key\nmv ssh_host_ecdsa_key ssh_host_ecdsa_key-cert.pub /etc/ssh\ncat << EOF >> /etc/ssh/sshd_config\n# This is our host private key and certificate:\nHostKey /etc/ssh/ssh_host_ecdsa_key\nHostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub\nEOF\n\n# \u81ea\u52a8\u66f4\u65b0 host key\ncat << EOF > /etc/cron.weekly/rotate-ssh-certificate\n#!/bin/sh\nexport STEPPATH=/root/.step\ncd /etc/ssh && step ssh renew ssh_host_ecdsa_key-cert.pub ssh_host_ecdsa_key --force 2> /dev/null\nexit 0\nEOF\nchmod 755 /etc/cron.weekly/rotate-ssh-certificate\n\n# \u6dfb\u52a0\u5230 known_hosts \u4fe1\u4efb\u4e3b\u673a\nstep ssh config --host --roots\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"STEPPATH"}),"\n",(0,t.jsxs)(n.li,{children:["$(step path --base)/\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"contexts.json"}),"\n",(0,t.jsx)(n.li,{children:"current-context.json"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"authorities/<AUTHORITY>/"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"profiles/<PROFILE>/"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["config/\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"defaults.json"}),"\n",(0,t.jsx)(n.li,{children:"ca.json"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["AUTHORITY/ - \u5982\u679c\u6ca1\u6709 context \u5219\u76ee\u5f55\u4e3a ",(0,t.jsx)(n.code,{children:"$(step path --base)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["certs/\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"intermediate_ca.crt"}),"\n",(0,t.jsx)(n.li,{children:"root_ca.crt"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["config/\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"ca.json"}),"\n",(0,t.jsx)(n.li,{children:"defaults.json"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"db"}),"\n",(0,t.jsxs)(n.li,{children:["secrets\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"intermediate_ca_key"}),"\n",(0,t.jsx)(n.li,{children:"root_ca_key"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"templates"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'tite="contexts.json"',children:'{\n  "alpha-one": {\n    "authority": "alpha-one.ca.smallstep.com",\n    "profile": "alpha-one"\n  },\n  "alpha-two": {\n    "authority": "alpha-two.ca.smallstep.com",\n    "profile": "alpha-two"\n  },\n  "beta": {\n    "authority": "beta.ca.smallstep.com",\n    "profile": "beta"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"k8s",children:"K8S"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://smallstep.com/docs/tutorials/kubernetes-acme-ca",children:"https://smallstep.com/docs/tutorials/kubernetes-acme-ca"})}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"faq",children:"FAQ"}),"\n",(0,t.jsx)(n.h2,{id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk",children:"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner 'Admin JWK'"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"--admin-name=step\n"})}),"\n",(0,t.jsx)(n.h2,{id:"acme-eab-not-enabled-for-provisioner",children:"ACME EAB not enabled for provisioner"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"add acme --type ACME --require-eab\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},38088:(e,n,s)=>{var t=s(96651),r=Symbol.for("react.element"),c=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function o(e,n,s){var t,c={},o=null,d=null;for(t in void 0!==s&&(o=""+s),void 0!==n.key&&(o=""+n.key),void 0!==n.ref&&(d=n.ref),n)i.call(n,t)&&!l.hasOwnProperty(t)&&(c[t]=n[t]);if(e&&e.defaultProps)for(t in n=e.defaultProps)void 0===c[t]&&(c[t]=n[t]);return{$$typeof:r,type:e,key:o,ref:d,props:c,_owner:a.current}}n.Fragment=c,n.jsx=o,n.jsxs=o},2488:(e,n,s)=>{e.exports=s(38088)},62780:(e,n,s)=>{s.d(n,{I:()=>a,M:()=>i});var t=s(96651);const r={},c=t.createContext(r);function i(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);