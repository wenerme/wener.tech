"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[15836],{49613:function(e,t,a){a.d(t,{Zo:function(){return s},kt:function(){return h}});var n=a(59496);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),i=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},s=function(e){var t=i(e.components);return n.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),m=i(a),h=r,d=m["".concat(p,".").concat(h)]||m[h]||u[h]||l;return a?n.createElement(d,c(c({ref:t},s),{},{components:a})):n.createElement(d,c({ref:t},s))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,c=new Array(l);c[0]=m;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o.mdxType="string"==typeof e?e:r,c[1]=o;for(var i=2;i<l;i++)c[i]=a[i];return n.createElement.apply(null,c)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},12817:function(e,t,a){a.r(t),a.d(t,{assets:function(){return k},contentTitle:function(){return h},default:function(){return v},frontMatter:function(){return m},metadata:function(){return d},toc:function(){return y}});var n=a(49613),r=Object.defineProperty,l=Object.defineProperties,c=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,s=(e,t,a)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,u=(e,t)=>{for(var a in t||(t={}))p.call(t,a)&&s(e,a,t[a]);if(o)for(var a of o(t))i.call(t,a)&&s(e,a,t[a]);return e};const m={title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"},h="Reverse proxy cache",d={unversionedId:"devops/web/proxy-cache",id:"devops/web/proxy-cache",title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58",description:"\u63a8\u8350 nginx - poor man's cdn.",source:"@site/../notes/devops/web/proxy-cache.md",sourceDirName:"devops/web",slug:"/devops/web/proxy-cache",permalink:"/notes/devops/web/proxy-cache",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/proxy-cache.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1664804552,formattedLastUpdatedAt:"Oct 3, 2022",frontMatter:{title:"\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"},sidebar:"docs",previous:{title:"openresty",permalink:"/notes/devops/web/openresty"},next:{title:"Proxy FAQ",permalink:"/notes/devops/web/proxy-faq"}},k={},y=[{value:"Varnish",id:"varnish",level:2},{value:"NGINX",id:"nginx",level:2},{value:"HAProxy",id:"haproxy",level:2},{value:"HTTP Cache \u7c7b\u578b",id:"http-cache-types",level:2},{value:"Caching",id:"caching",level:2}],f={toc:y};function v(e){var t,a=e,{components:r}=a,s=((e,t)=>{var a={};for(var n in e)p.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&o)for(var n of o(e))t.indexOf(n)<0&&i.call(e,n)&&(a[n]=e[n]);return a})(a,["components"]);return(0,n.kt)("wrapper",(t=u(u({},f),s),l(t,c({components:r,mdxType:"MDXLayout"}))),(0,n.kt)("h1",u({},{id:"reverse-proxy-cache"}),"Reverse proxy cache"),(0,n.kt)("admonition",u({},{type:"tip"}),(0,n.kt)("p",{parentName:"admonition"},"\u63a8\u8350 nginx - poor man's cdn.")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"varnish",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5185\u5b58\u7f13\u5b58"),(0,n.kt)("li",{parentName:"ul"},"\u53ef mmap \u4e3a\u6587\u4ef6 - \u6240\u6709\u7f13\u5b58\u5728\u4e00\u8d77 - \u91cd\u542f\u4f1a\u5931\u6548"),(0,n.kt)("li",{parentName:"ul"},"pro \u7248\u672c\u66f4\u591a\u5b58\u50a8\u9009\u9879"))),(0,n.kt)("li",{parentName:"ul"},"nginx",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"proxy_cache_path"),(0,n.kt)("li",{parentName:"ul"},"\u9010\u6587\u4ef6\u7f13\u5b58 - \u91cd\u542f\u540e\u8fd8\u662f\u6709\u6548"),(0,n.kt)("li",{parentName:"ul"},"\u6587\u4ef6\u540d\u4e3a md5(cache_key)"),(0,n.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 levels=3"))),(0,n.kt)("li",{parentName:"ul"},"haproxy - cache",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u5185\u5b58\u7f13\u5b58"),(0,n.kt)("li",{parentName:"ul"},"total-max-size"),(0,n.kt)("li",{parentName:"ul"},"max-object-size"),(0,n.kt)("li",{parentName:"ul"},"max-age"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"http-request cache-use mycache")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"http-response cache-store mycache")),(0,n.kt)("li",{parentName:"ul"},"Cache \u8981\u6c42",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"HTTP 1.1 GET 200"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://github.com/haproxy/haproxy/issues/214"}),"https://github.com/haproxy/haproxy/issues/214")))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://github.com/jiangwenyuan/nuster"}),"jiangwenyuan/nuster"))),(0,n.kt)("h2",u({},{id:"varnish"}),"Varnish"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"varnishd -a 127.0.0.1:8080 -b 185.199.109.153:80 -T 127.0.0.1:6082 -d -S $PWD/varnish-secret\n# \u56e0\u4e3a -d \u6240\u4ee5\u9700\u8981\u624b\u52a8\u542f\u52a8\nvarnishadm -S $PWD/varnish-secret -T 127.0.0.1:6082 start\n\ncurl -H 'Host: wener.me' 127.0.0.1:8080\n")),(0,n.kt)("h2",u({},{id:"nginx"}),"NGINX"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-nginx"}),"user nginx;\n\nworker_processes auto;\npcre_jit on;\nerror_log /dev/stdout warn;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n  # https://serverfault.com/a/912897\n  # HIT, MISS, BYPASS, EXPIRED\n  log_format cache_st '$remote_addr - $upstream_cache_status [$time_local]  '\n                    '\"$request\" $status $body_bytes_sent '\n                    '\"$http_referer\" \"$http_user_agent\"';\n  access_log /dev/stdout cache_st;\n\n  proxy_cache_path  /tmp/nginx-cache levels=1:2 keys_zone=static:8m max_size=1000m inactive=600m;\n  proxy_temp_path /tmp/nginx-cache-tmp;\n\n\n  server {\n    listen 8080;\n\n    location / {\n      proxy_pass http://185.199.109.153;\n      proxy_set_header Host $host;\n      proxy_cache static;\n      proxy_cache_valid  200 302  60m;\n      proxy_cache_valid  404      1m;\n    }\n  }\n}\n")),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"nginx -c $PWD/nginx.conf -g 'daemon off;'\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://www.sheshbabu.com/posts/nginx-caching-proxy/"}),"https://www.sheshbabu.com/posts/nginx-caching-proxy/"))),(0,n.kt)("h2",u({},{id:"haproxy"}),"HAProxy"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-haproxy"}),"frontend http\n  mode http\n  bind 0.0.0.0:8080 name v4\n  default_backend gh\nbackend gh\n  http-request cache-use mycache\n  http-response cache-store mycache\n  server svr 185.199.109.153:80 check\n\ncache mycache\n  total-max-size 4095   # MB\n  max-object-size 10000 # bytes\n  max-age 30            # seconds\n")),(0,n.kt)("h2",u({},{id:"http-cache-types"}),"HTTP Cache \u7c7b\u578b"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Page cache - \u901a\u5e38\u4e3a HTML"),(0,n.kt)("li",{parentName:"ul"},"Browser cache - \u8d44\u6e90"),(0,n.kt)("li",{parentName:"ul"},"Object cache - \u6570\u636e\u5e93\u67e5\u8be2"),(0,n.kt)("li",{parentName:"ul"},"Bytecode cache - PHP, JS"),(0,n.kt)("li",{parentName:"ul"},"CDN cache - HTML, Image, CSS, JS"),(0,n.kt)("li",{parentName:"ul"},"Reverse proxy cache - \u53d1\u751f\u5728\u53cd\u5411\u4ee3\u7406\u5c42")),(0,n.kt)("h2",u({},{id:"caching"}),"Caching"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Cloudflare",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u57fa\u4e8e extension \u7f13\u5b58\u800c\u4e0d\u662f mime",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4e0d\u7f13\u5b58 html"))),(0,n.kt)("li",{parentName:"ul"},"\u53ef\u901a\u8fc7 Page Rule \u6dfb\u52a0\u7f13\u5b58",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u7f13\u5b58\u6240\u6709 - Page Rule",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"charts.wener.tech/*")),(0,n.kt)("li",{parentName:"ul"},"Cache Level: Cache Everything"))))),(0,n.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f1a\u7f13\u5b58 robots.txt"),(0,n.kt)("li",{parentName:"ul"},"CF-Cache-Status",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"DYNAMIC - \u8ba4\u4e3a\u662f\u52a8\u6001\u5185\u5bb9\uff0c\u4e0d\u4f1a\u7f13\u5b58")))))),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"curl -I -H 'Host: charts.wener.tech' 185.199.108.153/wener/index.yaml\ncurl -I https://charts.wener.tech/wener/index.yaml\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Github Pages",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"CacheControl: max-age=600")))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://gtmetrix.com/"}),"https://gtmetrix.com/")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://web.dev/measure/"}),"https://web.dev/measure/")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://pagespeed.web.dev/"}),"https://pagespeed.web.dev/")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",u({parentName:"li"},{href:"https://developers.cloudflare.com/cache/about/default-cache-behavior/"}),"https://developers.cloudflare.com/cache/about/default-cache-behavior/"))))}v.isMDXComponent=!0}}]);