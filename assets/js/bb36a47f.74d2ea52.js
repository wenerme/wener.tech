/*! For license information please see bb36a47f.74d2ea52.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[21617],{20530:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>o});var l=s(11527),i=s(47214);const r={title:"Postgresql Scale"},t="Postgresql Scale",a={id:"db/relational/postgresql/postgresql-scale",title:"Postgresql Scale",description:"- scale up",source:"@site/../notes/db/relational/postgresql/postgresql-scale.md",sourceDirName:"db/relational/postgresql",slug:"/db/relational/postgresql/scale",permalink:"/notes/db/relational/postgresql/scale",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-scale.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1687760370,formattedLastUpdatedAt:"Jun 26, 2023",frontMatter:{title:"Postgresql Scale"},sidebar:"docs",previous:{title:"PostgreSQL Replicate",permalink:"/notes/db/relational/postgresql/replication"},next:{title:"Pg SQL \u5e38\u89c1\u95ee\u9898",permalink:"/notes/db/relational/postgresql/sql-faq"}},c={},o=[{value:"Story",id:"story",level:2},{value:"Table Partitioning",id:"table-partitioning",level:2},{value:"Logical Replication",id:"logical-replication",level:2}];function d(n){const e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h1,{id:"postgresql-scale",children:"Postgresql Scale"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["scale up\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5806\u786c\u4ef6"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["scale out replicas\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u8bfb\u5199\u5206\u79bb"}),"\n",(0,l.jsx)(e.li,{children:"pub/sub"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["scale out sharding\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5206\u7247 - \u591a\u8282\u70b9"}),"\n",(0,l.jsxs)(e.li,{children:["\u5e94\u7528\u5206\u7247 - \u903b\u8f91\u6620\u5c04\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ef\u63a7\u6027\u9ad8\u3001\u7279\u6b8a\u573a\u666f"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u670d\u52a1\u5206\u7247 - cdb\u3001citus\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f7f\u7528\u7b80\u5355\u3001\u8981\u6c42\u4f7f\u7528 patten \u7b26\u5408"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsx)(e.p,{children:"PostgreSQL \u5e76\u4e0d\u662f OLAP \u6570\u636e\u5e93\uff0c\u80fd\u529b\u6709\u4e0a\u9650\uff0c\u5f53\u53d1\u73b0\u6709\u66f4\u591a\u7684\u65f6\u95f4\u548c\u8d44\u6e90\u6295\u5165 \u6570\u636e\u4ed3\u5e93 \u65f6\uff0c\u53ef\u4ee5\u8003\u8651\u9009\u62e9\u4e00\u4e2a\u771f\u6b63\u7684\u6570\u4ed3\u6570\u636e\u5e93\u3002"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["backup\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/pgbackrest/pgbackrest",children:"pgbackrest"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"MIT, perl & C"}),"\n",(0,l.jsx)(e.li,{children:"by Crunchy Data"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"/notes/db/relational/postgresql/wal-g",children:"wal-g"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"by Citus Data, Apache-2.0, Go"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["Barman\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"2ndQuadrant, GPL v 3.0, python"}),"\n",(0,l.jsx)(e.li,{children:"basebackup & rsync"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["pg_probackup\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"by Postgres Professional, PostgreSQL License, C"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"BART"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.eu/events/pgconfeu2018/sessions/session/2098/slides/123/Advanced%20backup%20methods.pdf",children:"Advanced PostgreSQL backup & recovery methods"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"story",children:"Story"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["Gitlab \u56e0\u4e3a License \u95ee\u9898\u653e\u5f03 Citus ",(0,l.jsx)(e.a,{href:"https://about.gitlab.com/handbook/engineering/development/enablement/data_stores/database/doc/citus.html",children:"Sharding GitLab with CitusDB"})]}),"\n",(0,l.jsxs)(e.li,{children:["Gitlab PostgreSQL Partitioning with FDW\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://about.gitlab.com/handbook/engineering/development/enablement/data_stores/database/doc/fdw-sharding.html",children:"PostgreSQL 11 sharding with foreign data wrappers and partitioning"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u95ee\u9898\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9700\u8981\u4e3a foreign server \u8fde\u63a5\u4fe1\u606f"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u597d\u7ef4\u62a4 schema"}),"\n",(0,l.jsx)(e.li,{children:"\u53ea\u652f\u6301\u672c\u5730 foreign key"}),"\n",(0,l.jsx)(e.li,{children:"\u53ef\u80fd\u4e0d\u4f1a push down \u95ee\u9898"}),"\n",(0,l.jsx)(e.li,{children:"\u6027\u80fd\u964d\u4f4e"}),"\n",(0,l.jsx)(e.li,{children:"\u6267\u884c\u548c\u8ba1\u5212\u65f6\u95f4\u589e\u52a0"}),"\n",(0,l.jsx)(e.li,{children:"\u6bcf\u4e2a\u5206\u7247\u90fd\u9700\u8981 HA \u96c6\u7fa4"}),"\n",(0,l.jsx)(e.li,{children:"\u6ca1\u6709 parallel scan"}),"\n",(0,l.jsx)(e.li,{children:"\u66f4\u65b0\u6027\u80fd\u95ee\u9898"}),"\n",(0,l.jsx)(e.li,{children:"\u6ca1\u6709\u5168\u5c40\u4e8b\u52a1"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"table-partitioning",children:"Table Partitioning"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u67e5\u8be2\u6027\u80fd\u63d0\u5347\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5f53\u4e3b\u8981\u67e5\u8be2\u7684\u6570\u636e\u90fd\u5728\u4e00\u4e2a\u5206\u7247\u91cc\u65f6\uff0c\u7d22\u5f15\u52a0\u8f7d\u5230\u5185\u5b58\u4f7f\u7528\u7387\u66f4\u9ad8"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5f53\u66f4\u65b0\u548c\u67e5\u8be2\u5355\u4e2a\u5206\u7247\u65f6\u6027\u80fd\u63d0\u5347\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6b64\u65f6\u53ef\u80fd\u901a\u8fc7 seq scan \u800c\u4e0d\u9700\u8981\u4f7f\u7528\u7d22\u5f15\uff0c\u5bfc\u81f4\u968f\u673a\u8bbf\u95ee"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u901a\u8fc7\u64cd\u4f5c\u5206\u7247\u8868\u6765\u6279\u91cf\u64cd\u4f5c\u6570\u636e\uff0c\u6027\u80fd\u5927\u5e45\u5ea6\u63d0\u9ad8"}),"\n",(0,l.jsx)(e.li,{children:"\u8f83\u5c11\u4f7f\u7528\u7684\u5206\u7247\u53ef\u79fb\u5230\u66f4\u4fbf\u5b9c\u7684\u5b58\u50a8\u4e0a"}),"\n"]}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u5f53\u5355\u8868\u5927\u5c0f\u8d85\u8fc7\u7269\u7406\u5185\u5b58\u65f6\uff0c\u5efa\u8bae\u5206\u8868"}),"\n"]}),"\n",(0,l.jsx)(e.admonition,{type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u5206\u8868\u7d22\u5f15\u4e0d\u53ef\u4ee5 CONCURRENTLY\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9664\u975e\u5148 DETACH"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5206\u8868\u53ef\u4ee5\u521b\u5efa CREATE INDEX ON ONLY\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u521b\u5efa\u540e\u7d22\u5f15\u662f\u65e0\u6548\u7684"}),"\n",(0,l.jsx)(e.li,{children:"\u5728\u5355\u72ec\u5206\u7247\u4e0a\u521b\u5efa\u7136\u540e ATTACH"}),"\n",(0,l.jsx)(e.li,{children:"\u53ef\u4ee5\u4f7f\u7528\u8be5\u65b9\u5f0f\u6765\u521b\u5efa UNIQUE \u548c PRIMARY KEY"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u6709\u65f6\u5019\u8868\u7ee7\u627f\u6bd4\u5206\u7247\u66f4\u597d\u7528"}),"\n"]})}),"\n",(0,l.jsx)(e.admonition,{type:"caution",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u552f\u4e00 \u9650\u5236\u5fc5\u987b\u5305\u542b\u6240\u6709 partition key columns"}),"\n",(0,l.jsxs)(e.li,{children:["\u4e0d\u80fd\u521b\u5efa\u8de8\u8868 exclusion constraint\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e0d\u652f\u6301\u8de8\u5206\u7247\u9650\u5236"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.li,{children:"\u9488\u5bf9 INSERT \u7684 BEFORE ROW \u89e6\u53d1\u5668\u65e0\u6cd5\u66f4\u6539\u5206\u7247"}),"\n",(0,l.jsx)(e.li,{children:"\u4e34\u65f6\u8868\u548c\u6301\u4e45\u8868\u4e0d\u53ef\u4ee5\u6df7\u7528"}),"\n"]})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u5206\u8868\u7b56\u7565"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u8303\u56f4 - \u4f8b\u5982 \u65f6\u95f4\u5b57\u6bb5"}),"\n",(0,l.jsx)(e.li,{children:"\u5217\u8868 - \u4f8b\u5982 \u5e74\u5b57\u6bb5"}),"\n",(0,l.jsx)(e.li,{children:"\u54c8\u5e0c - \u4f8b\u5982 UUID \u5b57\u6bb5"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u5e38\u89c1\u7b56\u7565"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u57fa\u4e8e\u4f7f\u7528\u573a\u666f\u7684\u51b7\u70ed\u6570\u636e\u533a\u5206 - \u4f8b\u5982 \u6700\u8fd1\u4e00\u5468\u6570\u636e\u5355\u72ec\u8868"}),"\n",(0,l.jsx)(e.li,{children:"\u57fa\u4e8e\u6570\u636e\u672c\u8eab\u7684\u903b\u8f91\u7ed3\u6784\u533a\u5206 - \u4f8b\u5982 \u533a\u57df\u3001\u5e74\u4efd"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- RANGE \u5206\u7247\n-- \u521b\u5efa\u865a\u62df\u8868\nCREATE TABLE measurement (\n    city_id         int not null,\n    logdate         date not null,\n    peaktemp        int,\n    unitsales       int\n) PARTITION BY RANGE (logdate);\n\n-- LIST \u5206\u7247\nCREATE TABLE cities (\n    city_id      bigserial not null,\n    name         text not null,\n    population   bigint\n) PARTITION BY LIST (left(lower(name), 1));\n-- LIST \u5b50\u8868\nCREATE TABLE cities_ab\n    PARTITION OF cities (\n    CONSTRAINT city_id_nonzero CHECK (city_id != 0)\n) FOR VALUES IN ('a', 'b');\n-- \u9ed8\u8ba4\u5206\u7247\nCREATE TABLE cities_partdef\n    PARTITION OF cities DEFAULT;\n\n-- HASH \u5206\u7247\nCREATE TABLE orders (\n    order_id     bigint not null,\n    cust_id      bigint not null,\n    status       text\n) PARTITION BY HASH (order_id);\n-- HASH \u5b50\u8868\nCREATE TABLE orders_p1 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 0);\nCREATE TABLE orders_p2 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 1);\nCREATE TABLE orders_p3 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 2);\nCREATE TABLE orders_p4 PARTITION OF orders\n    FOR VALUES WITH (MODULUS 4, REMAINDER 3);\n\n-- \u53ef\u76f4\u63a5\u521b\u5efa\u7d22\u5f15 - \u5f53\u589e\u52a0\u5206\u7247\u65f6\u4f1a\u5bf9\u5206\u7247\u52a0\u7d22\u5f15\nCREATE INDEX ON measurement (logdate);\n\nCREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01');\n-- \u53ef\u4fee\u6539 TABLESPACE \u9009\u62e9\u4e0d\u540c\u5b58\u50a8\u4ecb\u8d28\nCREATE TABLE measurement_y2006m03 PARTITION OF measurement\n    FOR VALUES FROM ('2006-03-01') TO ('2006-04-01')\n    TABLESPACE fasttablespace;;\n\n-- \u5206\u7247\u8868\u53ef\u4ee5\u518d\u5206\u7247\nCREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01')\n    PARTITION BY RANGE (peaktemp);\n\n-- \u53d6\u4fdd\u5f00\u542f\u5206\u7247\u88c1\u526a\u914d\u7f6e - \u9ed8\u8ba4\u5f00\u542f\nselect * from pg_settings where name='enable_partition_pruning';\n\n-- \u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u5206\u7247\u8868 - \u4f1a\u9501\u4e3b\u8868\nDROP TABLE measurement_y2006m02;\n-- \u53ef\u4ee5\u6392\u9664\u5206\u7247\nALTER TABLE measurement DETACH PARTITION measurement_y2006m02;\n\n\n-- \u5355\u72ec\u521b\u5efa\u5206\u7247\uff0c\u6dfb\u52a0\u6821\u9a8c\uff0c\u5bfc\u5165\u6570\u636e\uff0c\u52a0\u5165\u5230\u5206\u7247\nCREATE TABLE measurement_y2008m02\n  (LIKE measurement INCLUDING DEFAULTS INCLUDING CONSTRAINTS)\n  TABLESPACE fasttablespace;\n-- \u63d0\u524d\u521b\u5efa\u597d CONSTRAINT - \u5426\u5219 ATTACH \u65f6\u8fd8\u662f\u4f1a\u521b\u5efa\u4e14\u9700\u8981 ACCESS EXCLUSIVE\nALTER TABLE measurement_y2008m02 ADD CONSTRAINT y2008m02\n   CHECK ( logdate >= DATE '2008-02-01' AND logdate < DATE '2008-03-01' );\n\\copy measurement_y2008m02 from 'measurement_y2008m02'\n-- possibly some other data preparation work\n-- SHARE UPDATE EXCLUSIVE\n-- ATTACH \u540e\u53ef\u4ee5\u5220\u9664\u521b\u5efa\u7684 CHECK\n-- \u5982\u679c\u6709 DEFAULT \u4e5f\u4f1a\u68c0\u67e5\uff0c\u9664\u975e\u521b\u5efa\u4e86\u6392\u9664 CHECK\nALTER TABLE measurement ATTACH PARTITION measurement_y2008m02\n    FOR VALUES FROM ('2008-02-01') TO ('2008-03-01' );\n"})}),"\n",(0,l.jsx)(e.h2,{id:"logical-replication",children:"Logical Replication"}),"\n",(0,l.jsx)(e.admonition,{type:"caution",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e0d\u4f1a\u590d\u5236 schema"}),"\n"]})})]})}function h(n={}){const{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(d,{...n})}):d(n)}},3354:(n,e,s)=>{var l=s(50959),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,a=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function o(n,e,s){var l,r={},o=null,d=null;for(l in void 0!==s&&(o=""+s),void 0!==e.key&&(o=""+e.key),void 0!==e.ref&&(d=e.ref),e)t.call(e,l)&&!c.hasOwnProperty(l)&&(r[l]=e[l]);if(n&&n.defaultProps)for(l in e=n.defaultProps)void 0===r[l]&&(r[l]=e[l]);return{$$typeof:i,type:n,key:o,ref:d,props:r,_owner:a.current}}e.Fragment=r,e.jsx=o,e.jsxs=o},11527:(n,e,s)=>{n.exports=s(3354)},47214:(n,e,s)=>{s.d(e,{Z:()=>a,a:()=>t});var l=s(50959);const i={},r=l.createContext(i);function t(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:t(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);