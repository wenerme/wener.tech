/*! For license information please see 55283401.f5f0e5d7.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[87368],{12520:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>o,frontMatter:()=>l,metadata:()=>t,toc:()=>h});var r=s(2488),i=s(62780);const l={title:"K3S"},c="K3S",t={id:"devops/kubernetes/distro/k3s/README",title:"K3S",description:"- \u8282\u70b9\u7684\u540d\u5b57\u9700\u8981\u552f\u4e00",source:"@site/../notes/devops/kubernetes/distro/k3s/README.md",sourceDirName:"devops/kubernetes/distro/k3s",slug:"/devops/kubernetes/distro/k3s/",permalink:"/notes/devops/kubernetes/distro/k3s/",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k3s/README.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1675953425,formattedLastUpdatedAt:"Feb 9, 2023",frontMatter:{title:"K3S"},sidebar:"docs",previous:{title:"k0sctl",permalink:"/notes/devops/kubernetes/distro/k0s/k0sctl"},next:{title:"K3S in Docker",permalink:"/notes/devops/kubernetes/distro/k3s/k3d"}},d={},h=[{value:"k3s server",id:"k3s-server",level:2},{value:"get.k3s.io",id:"getk3sio",level:3},{value:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5",id:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5",level:2},{value:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8",id:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8",level:2},{value:"containerd",id:"containerd",level:2},{value:"registries",id:"registries",level:2},{value:"\u7b14\u8bb0",id:"\u7b14\u8bb0",level:2},{value:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91",id:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91",level:3},{value:"\u5feb\u901f\u542f\u52a8",id:"\u5feb\u901f\u542f\u52a8",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"k3s",children:"K3S"}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8282\u70b9\u7684\u540d\u5b57\u9700\u8981\u552f\u4e00\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9ed8\u8ba4\u4f7f\u7528 hostname"}),"\n",(0,r.jsxs)(n.li,{children:["\u53ef\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"K3S_NODE_NAME"})," \u6216 ",(0,r.jsx)(n.code,{children:"--node-name"})," \u4fee\u6539"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["k3s \u4f1a\u8bfb\u53d6 ",(0,r.jsx)(n.code,{children:"/etc/machine-id"})," \u6216 ",(0,r.jsx)(n.code,{children:"/var/lib/dbus/machine-id"})," \u4f5c\u4e3a\u8282\u70b9 UUID"]}),"\n",(0,r.jsxs)(n.li,{children:["kubconfig \u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"/etc/rancher/k3s/k3s.yaml"})]}),"\n",(0,r.jsx)(n.li,{children:"\u90e8\u7f72 traefik \u4f5c\u4e3a ingress"}),"\n"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/k3s-io/k3s",children:"k3s-io/k3s"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/installation/installation-requirements/",children:"\u73af\u5883\u8981\u6c42"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Linux 3.10+"}),"\n",(0,r.jsx)(n.li,{children:"Server \u5185\u5b58 512 MB+"}),"\n",(0,r.jsx)(n.li,{children:"Agent \u5185\u5b58 75 MB"}),"\n",(0,r.jsx)(n.li,{children:"\u78c1\u76d8 200 MB"}),"\n",(0,r.jsx)(n.li,{children:"\u67b6\u6784 x86_64, ARMv7, ARM64"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup",children:"AlpineLinux \u989d\u5916\u914d\u7f6e"})}),"\n",(0,r.jsxs)(n.li,{children:["Production\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Small <= 10 \u8282\u70b9 - Server 2C4G - Database 1C2G"}),"\n",(0,r.jsx)(n.li,{children:"Medium <= 100 \u8282\u70b9 - Server 4C8G - Database 2C8G"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u7aef\u53e3\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"6443 - server - \u8282\u70b9\u901a\u4fe1 - Kubernetes API"}),"\n",(0,r.jsx)(n.li,{children:"6444"}),"\n",(0,r.jsx)(n.li,{children:"8472/udp - server/agent - Flannel VXLAN"}),"\n",(0,r.jsx)(n.li,{children:"10250 - server/agent - kubelet"}),"\n",(0,r.jsx)(n.li,{children:"10251"}),"\n",(0,r.jsx)(n.li,{children:"10010 - containerd"}),"\n",(0,r.jsx)(n.li,{children:"10248 - 10252"}),"\n",(0,r.jsx)(n.li,{children:"10249 - kube-prpxy"}),"\n",(0,r.jsx)(n.li,{children:"30518"}),"\n",(0,r.jsx)(n.li,{children:"30643"}),"\n",(0,r.jsx)(n.li,{children:"46517"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["K3S \u7ec4\u4ef6 - \u5b89\u88c5\u65f6\u53ef\u7981\u7528\u5185\u7f6e\u7ec4\u4ef6 ",(0,r.jsx)(n.code,{children:"--disable"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"containerd - \u53ef\u9009\u7528 docker"}),"\n",(0,r.jsx)(n.li,{children:"Flannel"}),"\n",(0,r.jsxs)(n.li,{children:["coredns - CoreDNS\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u955c\u50cf ",(0,r.jsx)(n.code,{children:"rancher/coredns-coredns"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"CNI"}),"\n",(0,r.jsxs)(n.li,{children:["traefik - Ingress \u63a7\u5236\u5668\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u955c\u50cf ",(0,r.jsx)(n.code,{children:"rancher/library-traefik"})]}),"\n",(0,r.jsxs)(n.li,{children:["Traefik 2.0 integration - ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/issues/1141",children:"#1141"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"http 80"}),"\n",(0,r.jsx)(n.li,{children:"https 443"}),"\n",(0,r.jsx)(n.li,{children:"dash 8080"}),"\n",(0,r.jsx)(n.li,{children:"metric 9100"}),"\n",(0,r.jsx)(n.li,{children:"httpn 8880"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["servicelb - \u5185\u5d4c\u8d1f\u8f7d\u5747\u8861\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/rancher/klipper-lb",children:"rancher/klipper-lb"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/rancher/klipper-lb/blob/master/entry",children:"https://github.com/rancher/klipper-lb/blob/master/entry"})}),"\n",(0,r.jsx)(n.li,{children:"This works by using a host port for each service load balancer and setting up iptables to forward the request to the cluster IP. The regular k8s scheduler will find a free host port. If there are no free host ports, the service load balancer will stay in pending."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5185\u5d4c\u7f51\u7edc\u7b56\u7565\u63a7\u5236\u5668"}),"\n",(0,r.jsx)(n.li,{children:"local-storage"}),"\n",(0,r.jsxs)(n.li,{children:["metrics-server\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u955c\u50cf ",(0,r.jsx)(n.a,{href:"https://hub.docker.com/r/rancher/metrics-server",children:"rancher/metrics-server"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/metrics-server",children:"kubernetes-sigs/metrics-server"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u53c2\u8003\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://medium.com/better-programming/b0b035c291a9",children:"Using a k3s Kubernetes Cluster for Your GitLab Project"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/architecture",children:"\u67b6\u6784"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u95ee\u9898\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4f7f\u7528 Nginx \u66ff\u4ee3 Traefik - ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/pull/1466/files",children:"#1466"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5df2\u7ecf\u88ab\u56de\u9000"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["K3S \u6709 ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/issues/684#issuecomment-517032871",children:"server-ca \u548c client-ca"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u9ed8\u8ba4 CSR \u662f\u4f7f\u7528 servert-ca\uff0c\u5bfc\u81f4\u521b\u5efa\u7684\u8bc1\u4e66\u65e0\u6cd5\u4f7f\u7528\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"issuer \u662f k3s-server-ca"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u9700\u8981\u4ece\u670d\u52a1\u5668\u53d6 client-ca \u521b\u5efa\u8bc1\u4e66"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/pull/1768",children:"#1768"})," - \u9ed8\u8ba4\u4f7f\u7528 ClientCA \u800c\u4e0d\u662f ServerCA"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/issues/684#issuecomment-517501120",children:"\u81ea\u884c\u521b\u5efa\u811a\u672c"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u76ee\u524d(1.18) admin \u9ed8\u8ba4\u662f\u5bc6\u7801 - ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/issues/1616",children:"#1616"})," - \u9ed8\u8ba4\u4f7f\u7528\u8bc1\u4e66"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"/etc/rancher/node/password"}),"\n",(0,r.jsxs)(n.li,{children:["/var/lib/rancher/k3s/server/cred/node-passwd\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"kubectl -n kube-system delete secrets <agent-node-name>.node-password.k3s"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'apk add util-linux\n[ -f /etc/machine-id ] || ( uuidgen | sudo tee -a /etc/machine-id )\n\napk add wireguard-virt wireguard-tools\n\n# INSTALL_K3S_EXEC \u9ed8\u8ba4\u4e3a agent\n# flannel wireguard - https://github.com/coreos/flannel/blob/master/dist/extension-wireguard\nK3S_NODE_NAME=k3s-server INSTALL_K3S_EXEC="server --flannel-backend=wireguard" INSTALL_K3S_SKIP_START=true INSTALL_K3S_BIN_DIR=/opt/k3s/bin curl -sfL https://get.k3s.io | sh -\n\nk3s server --flannel-backend=wireguard\n\n# \u5982\u679c\u662f root \u5b89\u88c5 - \u4fee\u6539\u4e0b kubeconfig \u6743\u9650\nsudo chmod a+r /etc/rancher/k3s/k3s.yaml\n# k3s \u9ed8\u8ba4\u4f1a\u8bbf\u95ee\u8be5\u6587\u4ef6\n\n# \u5176\u4ed6\u8bbf\u95ee\nexport KUBECONFIG=/etc/rancher/k3s/k3s.yaml\n'})}),"\n",(0,r.jsx)(n.h2,{id:"k3s-server",children:"k3s server"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/",children:"k3s server \u914d\u7f6e"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/advanced/",children:"Advanced Options and Configuration"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--docker"})," - \u4f7f\u7528 docker - \u9ed8\u8ba4 ",(0,r.jsx)(n.a,{href:"https://containerd.io/",children:"containerd"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s/server/manifests"})," \u4e0b\u9762\u7684\u6587\u4ef6\u4f1a\u88ab\u81ea\u52a8\u90e8\u7f72 - kubectl apply\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u9ed8\u8ba4\u5b89\u88c5\u5185\u5bb9 - ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/tree/master/manifests",children:"rancher/k3s/tree/master/manifests"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u9ed8\u8ba4\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"containerd"}),", \u542f\u52a8 agent \u7684\u65f6\u5019\u6dfb\u52a0 ",(0,r.jsx)(n.code,{children:"--docker"})," \u53ef\u4f7f\u7528 docker"]}),"\n",(0,r.jsxs)(n.li,{children:["\u9488\u5bf9 ",(0,r.jsx)(n.code,{children:"containerd"})," \u751f\u6210\u7684\u914d\u7f6e\u4f4d\u4e8e ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s/agent/etc/containerd/config.toml"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u5728\u76ee\u5f55\u4e0b\u521b\u5efa\u4e86 ",(0,r.jsx)(n.code,{children:"config.toml.tmpl"})," \u5219\u4f1a\u88ab\u4f7f\u7528"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6a21\u677f\u53ef\u8bbf\u95ee ",(0,r.jsx)(n.code,{children:"config.Node"})," \u5bf9\u8c61 ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L32",children:"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L32"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["AlpineLinux \u9700\u8981\u989d\u5916\u7684\u914d\u7f6e ",(0,r.jsx)(n.code,{children:"/etc/update-extlinux.conf"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["default_kernel_opts \u6dfb\u52a0 ",(0,r.jsx)(n.code,{children:"cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u7136\u540e ",(0,r.jsx)(n.code,{children:"update-extlinux && reboot"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u975e root \u6570\u636e\u5b58\u653e\u4e8e ",(0,r.jsx)(n.code,{children:"~/.rancher/k3s/data"})]}),"\n",(0,r.jsxs)(n.li,{children:["root \u6570\u636e\u5b58\u653e\u4e8e ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s/data"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u96c6\u7fa4 cidr ",(0,r.jsx)(n.code,{children:"10.42.0.0/16"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8282\u70b9 IP"}),"\n",(0,r.jsx)(n.li,{children:"cni0 - \u672c\u5730\u7f51\u53e3 - \u9644\u5e26 IP"}),"\n",(0,r.jsx)(n.li,{children:"flannel1.1 - \u96c6\u7fa4\u901a\u4fe1"}),"\n",(0,r.jsx)(n.li,{children:"\u4f1a\u5206\u914d\u7ed9\u6bcf\u4e2a Pod"}),"\n",(0,r.jsxs)(n.li,{children:["\u6bcf\u4e2a\u8282\u70b9\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"/24"})," \u5730\u5740 - \u4e0d\u540c\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u8f6c\u53d1"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u670d\u52a1 cidr ",(0,r.jsx)(n.code,{children:"10.43.0.0/16"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u670d\u52a1 IP"}),"\n",(0,r.jsx)(n.li,{children:"\u4e0d\u80fd ping"}),"\n",(0,r.jsx)(n.li,{children:"\u865a\u62df\u5730\u5740\uff0c\u901a\u8fc7 iptables \u914d\u7f6e"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u96c6\u7fa4\u57df\u540d cluster.local"}),"\n",(0,r.jsxs)(n.li,{children:["coredns ",(0,r.jsx)(n.code,{children:"10.43.0.10"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/networking/",children:"\u7f51\u7edc"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9ed8\u8ba4\u4f7f\u7528 flannel \u4f5c\u4e3a CNI\uff0c\u4f7f\u7528 VXLAN \u540e\u7aef"}),"\n",(0,r.jsxs)(n.li,{children:["flannel ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/blob/fe7337937155af41f1aebeb87d1acd07091b71de/pkg/agent/flannel/setup.go#L42",children:"\u914d\u7f6e"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u79c1\u6709\u4ed3\u5e93 ",(0,r.jsx)(n.code,{children:"/etc/rancher/k3s/registries.yaml"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/",children:"\u670d\u52a1\u914d\u7f6e"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"getk3sio",children:"get.k3s.io"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://get.k3s.io",children:"get.k3s.io"})," \u5b89\u88c5\u811a\u672c"]}),"\n",(0,r.jsxs)(n.li,{children:["\u4e0b\u8f7d\u5730\u5740\u4e3a STORAGE_URL=",(0,r.jsx)(n.a,{href:"https://storage.googleapis.com/k3s-ci-builds",children:"https://storage.googleapis.com/k3s-ci-builds"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u4f1a\u5b89\u88c5 openrc \u670d\u52a1\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"/etc/rancher/k3s/k3s.env"}),"\n",(0,r.jsx)(n.li,{children:"/etc/rancher/k3s/k3s-agent.env"}),"\n",(0,r.jsx)(n.li,{children:"/etc/init.d/k3s"}),"\n",(0,r.jsx)(n.li,{children:"/etc/init.d/k3s-agent"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u65e5\u5fd7\u6587\u4ef6 /var/log/k3s.log"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/",children:"\u5b89\u88c5\u9009\u9879"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u9ed8\u8ba4\u5b89\u88c5\u4e3a server \u542f\u52a8\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8bbe\u7f6e ",(0,r.jsx)(n.code,{children:"K3S_URL"})," \u4e14\u8bbe\u7f6e ",(0,r.jsx)(n.code,{children:"K3S_TOKEN"})," \u6216 ",(0,r.jsx)(n.code,{children:"K3S_CLUSTER_SECRET"})]}),"\n",(0,r.jsx)(n.li,{children:"\u6216\u76f4\u63a5\u540e\u9762\u6307\u5b9a agent"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_SKIP_DOWNLOAD"})," - \u4e0d\u4e0b\u8f7d"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_SYMLINK"})," - \u521b\u5efa kubectl\uff0ccrictl\uff0cctr \u7b26\u53f7\u94fe\u63a5 - \u8bbe\u7f6e\u4e3a ",(0,r.jsx)(n.code,{children:"skip"})," \u4f1a\u8c03\u8fc7\uff0c\u8bbe\u7f6e\u4e3a force \u4f1a\u8986\u76d6"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_SKIP_ENABLE"})," - \u4e0d\u542f\u7528\u548c\u542f\u52a8 k3s - \u5373\u4e0d\u4f1a add openrc \u7684 service \u4e5f\u4e0d\u4f1a start"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_SKIP_START"})," - \u4e0d\u542f\u52a8\u670d\u52a1"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_BIN_DIR"})," - \u5b89\u88c5\u76ee\u5f55 - \u9ed8\u8ba4 ",(0,r.jsx)(n.code,{children:"/usr/local/bin"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_EXEC"})," - \u6307\u5411\u547d\u4ee4\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9ed8\u8ba4 agent \u9664\u975e\u6709 K3S_URL"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_CHANNEL_URL"})," - \u9ed8\u8ba4 ",(0,r.jsx)(n.a,{href:"https://update.k3s.io/v1-release/channels",children:"https://update.k3s.io/v1-release/channels"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INSTALL_K3S_CHANNEL"})," - \u9ed8\u8ba4 stable"]}),"\n",(0,r.jsxs)(n.li,{children:["\u989d\u5916\u5b89\u88c5\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/usr/local/bin/k3s-killall.sh"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"service k3s stop"})]}),"\n",(0,r.jsxs)(n.li,{children:["umount\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/run/k3s"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/var/lib/kubelet/pods"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/run/netns/cni-"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u79fb\u9664 ",(0,r.jsx)(n.code,{children:"cni0"})," \u548c ",(0,r.jsx)(n.code,{children:"flannel1.1"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5220\u9664 ",(0,r.jsx)(n.code,{children:"/var/lib/cni/"})]}),"\n",(0,r.jsx)(n.li,{children:"\u79fb\u9664 iptables \u91cc\u7684 KUBE \u548c CNI \u5185\u5bb9"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/usr/local/bin/k3s-uninstall.sh"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/etc/rancher/k3s/k3s.env"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"service \u542f\u52a8\u4f1a source \u8fd9\u4e2a\u6587\u4ef6"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/etc/init.d/k3s"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5b89\u88c5\u53c2\u6570\u4f1a\u76f4\u63a5\u5728\u8fd9\u91cc"}),"\n",(0,r.jsxs)(n.li,{children:["\u65e5\u5fd7\u6587\u4ef6\u4e3a ",(0,r.jsx)(n.code,{children:"/var/log/k3s.log"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:'INSTALL_K3S_EXEC="--disable=traefik" \u53ef\u7981\u7528\u5b89\u88c5\u67d0\u4e9b\u670d\u52a1'}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -sfL https://get.k3s.io | sh -\n\n# \u53ef\u76f4\u63a5\u6307\u5b9a\u53c2\u6570\ncurl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644\n# \u4e5f\u53ef\u4ee5\u73af\u5883\u53d8\u91cf\u6307\u5b9a\ncurl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" sh -s -\n\n# INSTALL_K3S_EXEC \u6307\u5b9a\u547d\u4ee4\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--no-flannel" sh -s -\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --no-flannel" sh -s -\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --no-flannel\ncurl -sfL https://get.k3s.io | sh -s - server --no-flannel\ncurl -sfL https://get.k3s.io | sh -s - --no-flannel\ncurl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_ENABLE=1 sh -s -\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5",children:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/k3s-io/k3s/blob/master/install.sh",children:"https://github.com/k3s-io/k3s/blob/master/install.sh"})}),"\n",(0,r.jsxs)(n.li,{children:["\u955c\u50cf\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh",children:"http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://rancher-mirror.rancher.cn",children:"https://rancher-mirror.rancher.cn"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"arch - k3s, k3s-arm64, k3s-armhf, k3s-s390x"}),"\n",(0,r.jsx)(n.li,{children:"sha256sum-${ARCH}.txt"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ver=$(curl -sfL https://rancher-mirror.rancher.cn/k3s/channels/stable)\ncurl -sfLO https://rancher-mirror.rancher.cn/k3s/${ver/+/-}/k3s\ncurl -sfLO https://rancher-mirror.rancher.cn/k3s/${ver/+/-}/sha256sum-amd64.txt\nsha256sum -c sha256sum-amd64.txt --ignore-missing\n\nchmod +x k3s\nmv k3s /usr/bin/k3s\nk3s check-config\n# k3s server\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"openrc"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"/etc/rancher/k3s/${SYSTEM_NAME}.env"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/init.d/k3s"',children:'#!/sbin/openrc-run\n\n# Based on ...\n#   https://raw.githubusercontent.com/rancher/k3s/master/install.sh\nK3S_LOGFILE="${K3S_LOGFILE:-/var/log/${RC_SVCNAME}.log}"\n\nsupervisor=supervise-daemon\n\nname="k3s"\ncommand="/usr/bin/k3s"\ncommand_args="${K3S_EXEC} ${K3S_OPTS} >>${K3S_LOGFILE} 2>&1"\n\noutput_log=${K3S_LOGFILE}\nerror_log=${K3S_LOGFILE}\n\npidfile="/run/k3s.pid"\nrespawn_delay=5\nrespawn_max=0\n\nrc_ulimit="${K3S_ULIMIT:--c unlimited -n 1048576 -u unlimited}"\n\ndepend() {\n        want cgroups\n        after firewall\n}\n\nstart_pre() {\n        checkpath -f -m 0644 -o root:root "${K3S_LOGFILE}"\n        rm -f /tmp/k3s.*\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/init.d/k3s"',children:'#!/sbin/openrc-run\n\ndepend() {\n    after network-online\n    want cgroups\n}\n\nstart_pre() {\n    rm -f /tmp/k3s.*\n}\n\nsupervisor=supervise-daemon\nname=${SYSTEM_NAME}\ncommand="${BIN_DIR}/k3s"\ncommand_args="$(escape_dq "${CMD_K3S_EXEC}")\n    >>${LOG_FILE} 2>&1"\n\noutput_log=${LOG_FILE}\nerror_log=${LOG_FILE}\n\npidfile="/var/run/${SYSTEM_NAME}.pid"\nrespawn_delay=5\nrespawn_max=0\n\nset -o allexport\nif [ -f /etc/environment ]; then source /etc/environment; fi\nif [ -f ${FILE_K3S_ENV} ]; then source ${FILE_K3S_ENV}; fi\nset +o allexport\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-pre",metastring:'title="/etc/logrotate.d/k3s"',children:"/var/log/k3s.log {\n\tmissingok\n\tnotifempty\n\tcopytruncate\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8",children:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir -p /opt/k3s\ncd /opt/k3s\n# https://github.com/rancher/k3s/releases\nver=$(curl -sL https://api.github.com/repos/rancher/k3s/releases/latest | jq .tag_name -r)\n\ncurl -LOC- https://github.com/rancher/k3s/releases/download/$ver/k3s\ncurl -LOC- https://github.com/rancher/k3s/releases/download/$ver/k3s-images.txt\n\nssh k3s -- \"sudo sh -c 'mkdir -p /opt/k3s && chown admin:admin /opt/k3s'\"\nscp k3s k3s:/opt/k3s\nscp k3s-images.txt k3s:/opt/k3s\n\n# ssh k3s --\ncat /opt/k3s/k3s-images.txt | xargs -n 1 docker pull\n\nk3s server --cluster-init --alsologtostderr --log $PWD/k3s-server.log --docker\n"})}),"\n",(0,r.jsx)(n.h2,{id:"containerd",children:"containerd"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4f1a\u751f\u6210\u914d\u7f6e\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"/var/lib/rancher/k3s/agent/etc/containerd/config.toml"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u6709 config.toml.tmpl \u5219\u4f1a\u4f7f\u7528"}),"\n",(0,r.jsxs)(n.li,{children:["\u9ed8\u8ba4\u6a21\u677f ",(0,r.jsx)(n.a,{href:"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L72",children:"templates.go#ContainerdConfigTemplate"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u6ca1\u6709 docker \u53ef\u4ee5\u5c11 80m \u5185\u5b58"}),"\n",(0,r.jsxs)(n.li,{children:["\u6bcf\u4e2a containerd-shim \u6bd4 containerd-shim-runc-v2 \u5c11\u51e0 m \u5185\u5b58\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"containerd-shim \u662f docker \u7684"}),"\n",(0,r.jsx)(n.li,{children:"containerd-shim-runc-v2 \u662f containerd \u7684"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"registries",children:"registries"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"/etc/rancher/k3s/registries.yaml"})}),"\n",(0,r.jsx)(n.li,{children:"\u542f\u52a8\u65f6\u68c0\u6d4b\uff0ccontainerd \u4f1a\u4f7f\u7528\u8fd9\u91cc\u7684\u5b9a\u4e49"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"mirrors:\n  # \u955c\u50cf DockerHub\n  docker.io:\n    endpoint:\n      - 'https://mycustomreg.com:5000'\nconfigs:\n  # \u6dfb\u52a0\u6388\u6743\u548c\u8bc1\u4e66\n  'mycustomreg:5000':\n    auth:\n      username: xxxxxx # this is the registry username\n      password: xxxxxx # this is the registry password\n    tls:\n      cert_file: # path to the cert file used in the registry\n      key_file: # path to the key file used in the registry\n      ca_file: # path to the ca file used in the registry\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u7b14\u8bb0",children:"\u7b14\u8bb0"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["kubeconfig \u4f4d\u4e8e ",(0,r.jsx)(n.code,{children:"/etc/rancher/k3s/k3s.yaml"})]}),"\n",(0,r.jsxs)(n.li,{children:["K3S_TOKEN \u4f4d\u4e8e ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s/server/node-token"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u8282\u70b9\u9700\u8981\u6709\u552f\u4e00\u4e3b\u673a\u540d - ",(0,r.jsx)(n.code,{children:"K3S_NODE_NAME"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91",children:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"k3s agent \u521d\u59cb\u5316 Agent \u8282\u70b9\u7684 websocket \u94fe\u63a5\u3002\u94fe\u63a5\u4f1a\u6709\u5ba2\u6237\u7aef\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u3002"}),"\n",(0,r.jsxs)(n.li,{children:["Agent \u4f1a\u4f7f\u7528\u96c6\u7fa4\u7684\u5bc6\u94a5\u548c\u968f\u673a\u751f\u6210\u7684\u5bc6\u7801\u6ce8\u518c\uff0c\u5bc6\u7801\u5b58\u50a8\u4e8e ",(0,r.jsx)(n.code,{children:"/etc/rancher/node/password"}),"\uff0c\u670d\u52a1\u7aef\u4f1a\u5b58\u50a8\u8282\u70b9\u7684\u5bc6\u7801\u5230 ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/k3s/server/cred/node-passwd"}),"\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8282\u70b9\u4e0a\u7684 ",(0,r.jsx)(n.code,{children:"/etc/rancher/node"})," \u76ee\u5f55\u88ab\u79fb\u9664\u540e\u5bc6\u7801\u4f1a\u88ab\u4ece\u65b0\u751f\u6210\uff0c\u6216\u7531\u670d\u52a1\u7aef\u79fb\u9664\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:["\u542f\u52a8\u65f6\u53ef\u4e3a\u8282\u70b9\u9644\u52a0\u552f\u4e00\u8282\u70b9\u6807\u793a\uff0c",(0,r.jsx)(n.code,{children:"--with-node-id"}),"\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5feb\u901f\u542f\u52a8",children:"\u5feb\u901f\u542f\u52a8"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl -LO 'https://ghproxy.com/https://github.com/k3s-io/k3s/releases/download/v1.24.1%2Bk3s1/k3s'\nchmod +x k3s\n./k3s server\n"})})]})}function o(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},38088:(e,n,s)=>{var r=s(96651),i=Symbol.for("react.element"),l=Symbol.for("react.fragment"),c=Object.prototype.hasOwnProperty,t=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function h(e,n,s){var r,l={},h=null,a=null;for(r in void 0!==s&&(h=""+s),void 0!==n.key&&(h=""+n.key),void 0!==n.ref&&(a=n.ref),n)c.call(n,r)&&!d.hasOwnProperty(r)&&(l[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===l[r]&&(l[r]=n[r]);return{$$typeof:i,type:e,key:h,ref:a,props:l,_owner:t.current}}n.Fragment=l,n.jsx=h,n.jsxs=h},2488:(e,n,s)=>{e.exports=s(38088)},62780:(e,n,s)=>{s.d(n,{I:()=>t,M:()=>c});var r=s(96651);const i={},l=r.createContext(i);function c(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);