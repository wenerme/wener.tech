/*! For license information please see 783db6fc.3fa2810c.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[52827],{94964:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>i,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>a});var t=s(11527),c=s(47214);const r={title:"stunnel"},l="stunnel",o={id:"service/network/tunnel/stunnel",title:"stunnel",description:"- TLS/SSL tunneling",source:"@site/../notes/service/network/tunnel/stunnel.md",sourceDirName:"service/network/tunnel",slug:"/service/network/tunnel/stunnel",permalink:"/notes/service/network/tunnel/stunnel",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/service/network/tunnel/stunnel.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1680070123,formattedLastUpdatedAt:"Mar 29, 2023",frontMatter:{title:"stunnel"},sidebar:"docs",previous:{title:"localtunnel",permalink:"/notes/service/network/tunnel/localtunnel"},next:{title:"Tunnel Awesome",permalink:"/notes/service/network/tunnel/awesome"}},i={},a=[{value:"stunnel.conf",id:"stunnelconf",level:2},{value:"pgsql",id:"pgsql",level:2},{value:"cert",id:"cert",level:2},{value:"sni",id:"sni",level:2}];function p(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"stunnel",children:"stunnel"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"TLS/SSL tunneling"}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://www.stunnel.org/static/stunnel.html",children:"https://www.stunnel.org/static/stunnel.html"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"apk add stunnel      # AlpineLinux\nbrew install stunnel # macOS\n\necho -n psk: > /etc/stunnel/psk.txt\nopenssl rand -base64 180 | tr -d '\\n' >> /etc/stunnel/psk.txt\n# sed --in-place '1s/^/psk:/' /etc/stunnel/psk.txt\n\necho -e '\\xef\\xbb\\xbf;BOM Here' > /etc/stunnel/stunnel.conf\n# \u670d\u52a1\u7aef\ncat << CONF >> /etc/stunnel/stunnel.conf\nsetuid  = stunnel\nsetgid  = stunnel\npid     = /run/stunnel/stunnel.pid\nsocket  = l:TCP_NODELAY=1\nsocket  = r:TCP_NODELAY=1\ndebug   = 5\n\n; \u914d\u7f6e\u5728\u670d\u52a1\u7aef\n[test server]\nclient      = no\naccept      = 18080\nconnect     = 8080\nciphers     = PSK\nPSKsecrets  = /etc/stunnel/psk.txt\n\n; \u914d\u7f6e\u5728\u5ba2\u6237\u7aef\n[test client]\nclient      = yes\naccept      = 8081\nconnect     = 127.0.0.1:18080 ; host \u4f1a\u53d8\nciphers     = PSK\nPSKsecrets  = /etc/stunnel/psk.txt\nCONF\n\nsocat -u tcp-l:8080,fork exec:/bin/cat # \u670d\u52a1\u7aef\necho Hello | nc 127.0.0.1 8080         # \u672c\u5730\u80fd\u901a\n\nmkdir -p /run/stunnel\nchown stunnel /run/stunnel\n\nstunnel\n\necho Hello | nc 127.0.0.1 8081 # Tunnel \u540e\u7684\u7aef\u53e3\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"/etc/stunnel/stunnel.conf"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"\u7c7b\u4f3c\u5de5\u5177"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"openssl s_client -connect server.com:443 -quiet\n\nsocat TCP-LISTEN:8888 OPENSSL:server.com:443,verify=0\n"})}),"\n",(0,t.jsx)(e.p,{children:"SSH over TLS"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"Host server.com\n    ProxyCommand openssl s_client -connect server.com:443 -quiet\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"HAProxy \u4e5f\u53ef\u4ee5 terminate TLS \u7136\u540e\u8f6c\u53d1\u5230 TCP"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-haproxy",children:"backend secure_http\n    reqadd X-Forwarded-Proto:\\ https\n    rspadd Strict-Transport-Security:\\ max-age=31536000\n    mode http\n    option httplog\n    option forwardfor\n    server local_http_server 127.0.0.1:80\n\nbackend ssh\n    mode tcp\n    option tcplog\n    server ssh 127.0.0.1:22\n    timeout server 2h\n\nfrontend ssl\n    bind X.X.X.X:443 ssl crt /etc/ssl/private/certs.pem no-sslv3\n    mode tcp\n    option tcplog\n    tcp-request inspect-delay 5s\n    tcp-request content accept if HTTP\n\n    acl client_attempts_ssh payload(0,7) -m bin 5353482d322e30\n\n    use_backend ssh if !HTTP\n    use_backend ssh if client_attempts_ssh\n    use_backend secure_http if HTTP\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://blog.chmd.fr/ssh-over-ssl-episode-4-a-haproxy-based-configuration.html",children:"https://blog.chmd.fr/ssh-over-ssl-episode-4-a-haproxy-based-configuration.html"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"stunnelconf",children:"stunnel.conf"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["protocol\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"socks - \u76d1\u542c SOCKS - \u4f5c\u4e3a socks \u4ee3\u7406\u670d\u52a1"}),"\n",(0,t.jsx)(e.li,{children:"connect - HTTP 1.1 CONNECT - \u53ea\u80fd client \u6a21\u5f0f"}),"\n",(0,t.jsx)(e.li,{children:"cifs, capwin, capwinctrl, connect, imap, ldap, nntp, pgsql, pop3, proxy, smtp, socks"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["verify\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"1 - prefer"}),"\n",(0,t.jsx)(e.li,{children:"2 - CA"}),"\n",(0,t.jsx)(e.li,{children:"3 - CA+Cert"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["client\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"yes - \u8fdc\u7a0b\u670d\u52a1\u4f7f\u7528 TLS"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"connect - \u53ef\u914d\u7f6e\u591a\u4e2a - round-robin"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"foreground=no ; yes, quite\nlog=append ; overwrite\n; output=\n; pid=\n; service= ; inetd\nsyslog=yes\n\n; chroot=\n; compression= ; deflate, zlib\ndebug= ; 1-7\n; EGE= ; Entropy Gathering Daemon\nengine=auto\n\n[SERVICE NAME]\nclient=no ; yes\n; \u76d1\u542c\u7aef\u53e3\n; server - \u670d\u52a1\u7aef\u534f\u8bae\n; client - \u901a\u9053\u540e\u7684\u534f\u8bae\naccept=\n; \u8fde\u63a5\u7aef\u53e3\n; server - \u4e0a\u6e38\n; client - \u670d\u52a1\u7aef\nconnect=\n\nexec= ; inetd-type program\nexecArgs=\nretry=no ; connect+exec\npty= ; yes, no\n\nfailover=prio; rr\n\nPSKidentity= ; psk client\nPSKsecrets= ; IDENTITY:KEY\n\n; cifs, capwin, capwinctrl, connect, imap, ldap, nntp, pgsql, pop3, proxy, smtp, socks\nprotocol=\nprotocolAuthentication=\nprotocolDomain=\nprotocolHeader=\nprotocolHost=\nprotocolPassword=\nprotocolUsername=\n\nredirect=\nrenegotiation=yes\n\nreset=yes ; TCP RST\n\nident= ; USERNAME\ninclude= ; DIR\nconfig= ; openssl config\nCApath=\nCAfile=\ncert=\nkey=\n; server - \u5339\u914d\u7684\u540d\u5b57\n; client - \u5b9a\u4e49\u540d\u5b57\nsni=\nrequireCert=no\ncheckEmail=\ncheckHots=\ncheckIP=\ncipgers=\nciphersuites=\nCRLpath=\nCRLfile=\ncurves=\nlogID=\ndebug=\ndelay=no ; delay DNS lookup for connect\nengineId=\nengineNum=\nlibwrap=no ; /etc/hosts.allow, /etc/hosts.deny\nlocal=\nsslVersion=\nsslVersionMax=\nsslVersionMin=\nstack=\n\nOCSP=\nOCSPaia=\nOCSPflag=\nOCSPnonce=\noptions= ; SSL Options\n\nsecurityLevel=\n\nsetgid=\nsetuid=\n\nsessionCacheSize=\nsessionCacheTimeout=\nsessionResume=yes\nsessiond= # TLS cache server\n\nsocket=\nticketKeySecret=\nticketMacSecret=\n\nTIMEOUTbusy=\nTIMEOUTclose=\nTIMEOUTconnect=\nTIMEOUTidle=\n\ntransparent= ; none | source | destination | both\n\nverify=\nverifyChain=\nverifyPeer=no\n"})}),"\n",(0,t.jsx)(e.h2,{id:"pgsql",children:"pgsql"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"[pg]\nclient = yes\nprotocol = pgsql\naccept = 0.0.0.0:5432\nconnect = pg-b:15432\noptions = NO_TICKET\nretry = yes\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"create extension sslinfo();\nselect ssl_is_used()\n"})}),"\n",(0,t.jsx)(e.h2,{id:"cert",children:"cert"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# cert \u548c key \u4e5f\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a\u6587\u4ef6\nopenssl req -new -days 365 -nodes -x509 -out cert.pem -keyout key.pem\n\ncat key.pem cert.pem >> /etc/stunnel/stunnel.pem\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"cert=cert.pem\nkey=key.pem\nCAfile=cert.pem\nverify=3\nclient=no\n"})}),"\n",(0,t.jsx)(e.h2,{id:"sni",children:"sni"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"openssl req -new -days 365 -nodes -x509 -out cert.pem -keyout key.pem\n\nopenssl genrsa -out c1.key 1024\nopenssl req -new -key c1.key -out c1.csr\n\nopenssl ca -extensions v3_ca -days 365 -out c1.cer -policy policy_anything -in c1.csr\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ini",children:"[virtual]\n; \u65e0 SNI \u65f6\nwas not correct\naccept = 443\ncert = /usr/local/etc/stunnel/stunnel.pem\nexec = /usr/local/bin/hello\n\n[server s1]\nsni = virtual:*.example.com\ncert = /usr/local/etc/stunnel/public_cert.pem\nconnect = 10.10.10.11:80\n\n[server s2]\nsni = virtual:secret.net\ncert = /usr/local/etc/stunnel/secret_cert.pem\nconnect = localhost:888\nverifyPeer = yes\nCAfile = /usr/local/etc/stunnel/allowed-clients.pem\n\n\n[cleint]\nclient = yes\nsni = c1.example.com\naccept =  127.0.0.1:80\nconnect = 10.10.10.12:443\ncert = stunnel.pem\nverifyPeer = yes\nCAfile = sni_certs.pem\n"})})]})}function d(n={}){const{wrapper:e}={...(0,c.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(p,{...n})}):p(n)}},3354:(n,e,s)=>{var t=s(50959),c=Symbol.for("react.element"),r=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,o=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function a(n,e,s){var t,r={},a=null,p=null;for(t in void 0!==s&&(a=""+s),void 0!==e.key&&(a=""+e.key),void 0!==e.ref&&(p=e.ref),e)l.call(e,t)&&!i.hasOwnProperty(t)&&(r[t]=e[t]);if(n&&n.defaultProps)for(t in e=n.defaultProps)void 0===r[t]&&(r[t]=e[t]);return{$$typeof:c,type:n,key:a,ref:p,props:r,_owner:o.current}}e.Fragment=r,e.jsx=a,e.jsxs=a},11527:(n,e,s)=>{n.exports=s(3354)},47214:(n,e,s)=>{s.d(e,{Z:()=>o,a:()=>l});var t=s(50959);const c={},r=t.createContext(c);function l(n){const e=t.useContext(r);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(c):n.components||c:l(n.components),t.createElement(r.Provider,{value:e},n.children)}}}]);