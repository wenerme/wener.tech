/*! For license information please see 22bf42b1.11691036.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[51844],{15848:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var s=t(2488),o=t(62780);const r={id:"oauth2-proxy",title:"oauth2-proxy"},i="oauth2-proxy",a={id:"service/auth/oauth2-proxy",title:"oauth2-proxy",description:"- oauth2-proxy/oauth2-proxy",source:"@site/../notes/service/auth/oauth2-proxy.md",sourceDirName:"service/auth",slug:"/service/auth/oauth2-proxy",permalink:"/notes/service/auth/oauth2-proxy",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/service/auth/oauth2-proxy.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1633860901,formattedLastUpdatedAt:"Oct 10, 2021",frontMatter:{id:"oauth2-proxy",title:"oauth2-proxy"},sidebar:"docs",previous:{title:"PKCE",permalink:"/notes/service/auth/oauth/pkce"},next:{title:"OPA",permalink:"/notes/service/auth/opa/"}},l={},c=[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"Ingress",id:"ingress",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"oauth2-proxy",children:"oauth2-proxy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/oauth2-proxy/oauth2-proxy",children:"oauth2-proxy/oauth2-proxy"})}),"\n",(0,s.jsxs)(n.li,{children:["\u73af\u5883\u53d8\u91cf + ",(0,s.jsx)(n.code,{children:"OAUTH2_PROXY_"})," \u524d\u7f00"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://oauth2-proxy.github.io/oauth2-proxy/configuration/sessions",children:"\u4f1a\u8bdd"})," - ",(0,s.jsx)(n.code,{children:"--session-store-type"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["cookie - \u9ed8\u8ba4\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4ee3\u7406\u65e0\u72b6\u6001"}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"cookie-secret"})," \u52a0\u5bc6 cookie"]}),"\n",(0,s.jsx)(n.li,{children:"\u5e76\u53d1\u64cd\u4f5c\u53ef\u80fd\u4f1a\u51b2\u7a81\u5bfc\u81f4\u9700\u8981\u4ece\u65b0\u8ba4\u8bc1"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["redis\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cookie \u8bb0\u5f55 ticket"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"{CookieName}-{ticketID}.{secret}"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CookieName \u9ed8\u8ba4 _oauth2_proxy"}),"\n",(0,s.jsx)(n.li,{children:"ticketID - 128 bit, hex"}),"\n",(0,s.jsx)(n.li,{children:"secret - 128 bit, base64url, no padding"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"--session-store-type=redis"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"--redis-connection-url=redis://host[:port][/db-number]"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://oauth2-proxy.github.io/oauth2-proxy/endpoints",children:"Endpoints"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"/robots.txt"}),"\n",(0,s.jsx)(n.li,{children:"/ping - \u5065\u5eb7\u68c0\u67e5"}),"\n",(0,s.jsx)(n.li,{children:"/oauth2/sign_in"}),"\n",(0,s.jsxs)(n.li,{children:["/oauth2/sign_out\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["rd \u53c2\u6570\u91cd\u5b9a\u5411 \u6216\u8005 \u5934 ",(0,s.jsx)(n.code,{children:"X-Auth-Request-Redirect"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"/oauth2/start - \u5f00\u59cb OAuth\uff0crd \u53c2\u6570\u4e3a\u91cd\u5b9a\u5411\u5730\u5740"}),"\n",(0,s.jsx)(n.li,{children:"/oauth2/callback - OAuth2 \u56de\u8c03\u5730\u5740"}),"\n",(0,s.jsx)(n.li,{children:"/oauth2/userinfo - \u8fd4\u56de\u7528\u6237\u4fe1\u606f"}),"\n",(0,s.jsx)(n.li,{children:"/oauth2/auth - \u8fd4\u56de 202 Accepted \u6216 401 Unauthorized\uff1b\u7528\u4e8e nginx auth_request"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u53c2\u8003\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["ingress-nginx ",(0,s.jsx)(n.a,{href:"https://kubernetes.github.io/ingress-nginx/examples/auth/oauth-external-auth/",children:"oauth external auth"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.syseleven.de/metakube/de/tutorials/setup-ingress-auth-to-use-keycloak-oauth",children:"Setup ingress auth to use keycloak oauth"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# Keycloak\n- args:\n    - --provider=keycloak\n    - --email-domain=*\n    - --upstream=file:///dev/null\n    - --http-address=0.0.0.0:4180\n    - --login-url=https://my.domain.com/auth/realms/authentication/protocol/openid-connect/auth\n    - --redeem-url=https://my.domain.com/auth/realms/authentication/protocol/openid-connect/token\n    - --validate-url=https://my.domain.com/auth/realms/authentication/protocol/openid-connect/userinfo\n    - --whitelist-domain=.my.domain.com\n    - --cookie-domain=.my.domain.com\n    - --oidc-issuer-url=https://my.domain.com/auth/realms/authentication\n    - --keycloak-group=/admin\n    - --cookie-name=keycloak\n    - --proxy-prefix=/second-oauth2\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:'## <addr>:<port> to listen on for HTTP/HTTPS clients\n# http_address = "127.0.0.1:4180"\n# https_address = ":443"\n\n## Are we running behind a reverse proxy? Will not accept headers like X-Real-Ip unless this is set.\n# reverse_proxy = true\n\n## TLS Settings\n# tls_cert_file = ""\n# tls_key_file = ""\n\n## the OAuth Redirect URL.\n# defaults to the "https://" + requested host header + "/oauth2/callback"\n# redirect_url = "https://internalapp.yourcompany.com/oauth2/callback"\n\n## the http url(s) of the upstream endpoint. If multiple, routing is based on path\n# upstreams = [\n#     "http://127.0.0.1:8080/"\n# ]\n\n## Logging configuration\n#logging_filename = ""\n#logging_max_size = 100\n#logging_max_age = 7\n#logging_local_time = true\n#logging_compress = false\n#standard_logging = true\n#standard_logging_format = "[{{.Timestamp}}] [{{.File}}] {{.Message}}"\n#request_logging = true\n#request_logging_format = "{{.Client}} - {{.Username}} [{{.Timestamp}}] {{.Host}} {{.RequestMethod}} {{.Upstream}} {{.RequestURI}} {{.Protocol}} {{.UserAgent}} {{.StatusCode}} {{.ResponseSize}} {{.RequestDuration}}"\n#auth_logging = true\n#auth_logging_format = "{{.Client}} - {{.Username}} [{{.Timestamp}}] [{{.Status}}] {{.Message}}"\n\n## pass HTTP Basic Auth, X-Forwarded-User and X-Forwarded-Email information to upstream\n# pass_basic_auth = true\n# pass_user_headers = true\n## pass the request Host Header to upstream\n## when disabled the upstream Host is used as the Host Header\n# pass_host_header = true\n\n## Email Domains to allow authentication for (this authorizes any email on this domain)\n## for more granular authorization use `authenticated_emails_file`\n## To authorize any email addresses use "*"\n# email_domains = [\n#     "yourcompany.com"\n# ]\n\n## The OAuth Client ID, Secret\n# client_id = "123456.apps.googleusercontent.com"\n# client_secret = ""\n\n## Pass OAuth Access token to upstream via "X-Forwarded-Access-Token"\n# pass_access_token = false\n\n## Authenticated Email Addresses File (one email per line)\n# authenticated_emails_file = ""\n\n## Htpasswd File (optional)\n## Additionally authenticate against a htpasswd file. Entries must be created with "htpasswd -s" for SHA encryption\n## enabling exposes a username/login signin form\n# htpasswd_file = ""\n\n## Templates\n## optional directory with custom sign_in.html and error.html\n# custom_templates_dir = ""\n\n## skip SSL checking for HTTPS requests\n# ssl_insecure_skip_verify = false\n\n\n## Cookie Settings\n## Name     - the cookie name\n## Secret   - the seed string for secure cookies; should be 16, 24, or 32 bytes\n##            for use with an AES cipher when cookie_refresh or pass_access_token\n##            is set\n## Domain   - (optional) cookie domain to force cookies to (ie: .yourcompany.com)\n## Expire   - (duration) expire timeframe for cookie\n## Refresh  - (duration) refresh the cookie when duration has elapsed after cookie was initially set.\n##            Should be less than cookie_expire; set to 0 to disable.\n##            On refresh, OAuth token is re-validated.\n##            (ie: 1h means tokens are refreshed on request 1hr+ after it was set)\n## Secure   - secure cookies are only sent by the browser of a HTTPS connection (recommended)\n## HttpOnly - httponly cookies are not readable by javascript (recommended)\n# cookie_name = "_oauth2_proxy"\n# cookie_secret = ""\n# cookie_domains = ""\n# cookie_expire = "168h"\n# cookie_refresh = ""\n# cookie_secure = true\n# cookie_httponly = true\n'})}),"\n",(0,s.jsx)(n.h2,{id:"ingress",children:"Ingress"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# \u539f\u59cb Ingress\nkind: Ingress\nmetdata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/auth-url: 'https://$host/oauth2/auth'\n    nginx.ingress.kubernetes.io/auth-signin: 'https://$host/oauth2/start?rd=$escaped_request_uri'\n    # \u9700\u8981 set-xauthrequest: true\n    nginx.ingress.kubernetes.io/auth-response-headers: 'x-auth-request-user, x-auth-request-email'\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\u6620\u5c04\u5230\u5176\u4ed6\u7a7a\u95f4"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"kind: Service\napiVersion: v1\nmetadata:\n  name: oauth2-proxy\n  namespace: longhorn-system\nspec:\n  type: ExternalName\n  externalName: oauth2-proxy.auth.svc.cluster.local\n  ports:\n    - port: 80\n      name: http\n      targetPort: 80\n---\n# \u4f8b\u5982 \u4e3a Longhorn UI \u6dfb\u52a0\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: longhorn-oauth2-ingress\n  namespace: longhorn-system\nspec:\n  tls:\n    - hosts:\n        - longhorn.example.com\n      secretName: longhorn-example-com-cert\n  rules:\n    - host: longhorn.example.com\n      http:\n        paths:\n          - backend:\n              service:\n                name: oauth2-proxy\n                port:\n                  name: http\n            path: /oauth2\n            pathType: ImplementationSpecific\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},38088:(e,n,t)=>{var s=t(96651),o=Symbol.for("react.element"),r=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,t){var s,r={},c=null,h=null;for(s in void 0!==t&&(c=""+t),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(h=n.ref),n)i.call(n,s)&&!l.hasOwnProperty(s)&&(r[s]=n[s]);if(e&&e.defaultProps)for(s in n=e.defaultProps)void 0===r[s]&&(r[s]=n[s]);return{$$typeof:o,type:e,key:c,ref:h,props:r,_owner:a.current}}n.Fragment=r,n.jsx=c,n.jsxs=c},2488:(e,n,t)=>{e.exports=t(38088)},62780:(e,n,t)=>{t.d(n,{I:()=>a,M:()=>i});var s=t(96651);const o={},r=s.createContext(o);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);