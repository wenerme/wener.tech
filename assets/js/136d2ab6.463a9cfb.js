/*! For license information please see 136d2ab6.463a9cfb.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[37144],{33860:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>o});var l=s(2488),r=s(62780);const i={title:"Pg SQL \u5e38\u89c1\u95ee\u9898",tags:["FAQ"]},t="PostgreSQL SQL \u95ee\u9898",c={id:"db/relational/postgresql/postgresql-sql-faq",title:"Pg SQL \u5e38\u89c1\u95ee\u9898",description:"Note",source:"@site/../notes/db/relational/postgresql/postgresql-sql-faq.md",sourceDirName:"db/relational/postgresql",slug:"/db/relational/postgresql/sql-faq",permalink:"/notes/db/relational/postgresql/sql-faq",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/db/relational/postgresql/postgresql-sql-faq.md",tags:[{label:"FAQ",permalink:"/notes/tags/faq"}],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1702882608,formattedLastUpdatedAt:"Dec 18, 2023",frontMatter:{title:"Pg SQL \u5e38\u89c1\u95ee\u9898",tags:["FAQ"]},sidebar:"docs",previous:{title:"Postgresql Scale",permalink:"/notes/db/relational/postgresql/scale"},next:{title:"PostgreSQL Tenant",permalink:"/notes/db/relational/postgresql/tenant"}},d={},o=[{value:"XML xpath \u8fd4\u56de\u7ed3\u679c\u5305\u542b CDATA",id:"xml-xpath-\u8fd4\u56de\u7ed3\u679c\u5305\u542b-cdata",level:2},{value:"\u7cfb\u7edf\u4fe1\u606f",id:"\u7cfb\u7edf\u4fe1\u606f",level:2},{value:"\u9759\u6001\u6570\u636e\u884c",id:"\u9759\u6001\u6570\u636e\u884c",level:2},{value:"\u5206\u7ec4\u805a\u5408",id:"\u5206\u7ec4\u805a\u5408",level:2},{value:"function vs procedure",id:"function-vs-procedure",level:2},{value:"plpgsql vs sql",id:"plpgsql-vs-sql",level:2},{value:"\u51fd\u6570\u8fd4\u56de\u5f71\u54cd\u884c",id:"\u51fd\u6570\u8fd4\u56de\u5f71\u54cd\u884c",level:2},{value:"\u6b63\u5219",id:"\u6b63\u5219",level:2},{value:"\u751f\u6210\u5e26\u524d\u7f00\u7684 UUID \u4e3b\u952e",id:"\u751f\u6210\u5e26\u524d\u7f00\u7684-uuid-\u4e3b\u952e",level:2},{value:"\u63a8\u8350\u4e3b\u952e\u521b\u5efa\u65b9\u5f0f",id:"\u63a8\u8350\u4e3b\u952e\u521b\u5efa\u65b9\u5f0f",level:2},{value:"Operator",id:"operator",level:2},{value:"\u5206\u7ec4\u91cc\u9009\u62e9\u6700\u540e\u4e00\u6761\u6570\u636e",id:"\u5206\u7ec4\u91cc\u9009\u62e9\u6700\u540e\u4e00\u6761\u6570\u636e",level:2},{value:"ON CONFLICT \u591a\u5217 UNIQUE",id:"on-conflict-\u591a\u5217-unique",level:2},{value:"LATERAL JOIN",id:"lateral-join",level:2},{value:"\u4e0d\u53ef\u4ee5\u518d WHERE \u4f7f\u7528\u522b\u540d",id:"\u4e0d\u53ef\u4ee5\u518d-where-\u4f7f\u7528\u522b\u540d",level:2},{value:"csv",id:"csv",level:2},{value:"create role if not exists",id:"create-role-if-not-exists",level:2},{value:"role cannot be dropped because some objects depend on it - privileges for table users",id:"role-cannot-be-dropped-because-some-objects-depend-on-it---privileges-for-table-users",level:2},{value:"create role if not exists",id:"create-role-if-not-exists-1",level:2},{value:"create policy if not exists",id:"create-policy-if-not-exists",level:2},{value:"add foreign key if not exists",id:"add-foreign-key-if-not-exists",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",del:"del",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.M)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h1,{id:"postgresql-sql-\u95ee\u9898",children:"PostgreSQL SQL \u95ee\u9898"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Note"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"comment \u4e0d\u80fd\u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a"}),"\n",(0,l.jsx)(n.li,{children:"column \u7684 generated \u4e0d\u80fd\u4fee\u6539"}),"\n",(0,l.jsx)(n.li,{children:"column \u53ea\u652f\u6301 STORE \u7684\u751f\u6210\u5217\uff0c\u4e0d\u652f\u6301\u865a\u62df\u5217"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/functions-json.html",children:"JSON Functions and Operators"})}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"PRIMARY KEY"})," ~= ",(0,l.jsx)(n.code,{children:"UNIQUE"})," + ",(0,l.jsx)(n.code,{children:"NOT NULL"})]}),"\n",(0,l.jsxs)(n.li,{children:["FK\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"MATCH SIMPLE"})}),"\n",(0,l.jsxs)(n.li,{children:["MATCH FULL\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u90fd\u4e0d null\uff0c\u6216\u90fd null"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.del,{children:"MATCH PARTIAL"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["CONSTRAINTS\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"DEFERRED | IMMEDIATE"}),"\n",(0,l.jsxs)(n.li,{children:["\u521b\u5efa\u65f6\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"DEFERRABLE INITIALLY DEFERRED"}),"\n",(0,l.jsx)(n.li,{children:"DEFERRABLE INITIALLY IMMEDIATE"}),"\n",(0,l.jsx)(n.li,{children:"NOT DEFERRABLE"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"xml-xpath-\u8fd4\u56de\u7ed3\u679c\u5305\u542b-cdata",children:"XML xpath \u8fd4\u56de\u7ed3\u679c\u5305\u542b CDATA"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/message-id/5DB23068.3080601%40anastigmatix.net",children:"BUG #16046: xpath returns CDATA tag along with the value in postgres 12"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- PG 12+ \u8fd4\u56de  <![CDATA[text]]>\n-- PG 11 \u8fd4\u56de text\nselect unnest(xpath('/s/text()','<s><![CDATA[text]]></s>'));\n-- \u6dfb\u52a0 string \u8f6c\u6362\u8fd4\u56de\u6b63\u5e38\nselect unnest(xpath('string(/s)','<s><![CDATA[text]]></s>'::xml));\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u7cfb\u7edf\u4fe1\u606f",children:"\u7cfb\u7edf\u4fe1\u606f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"select version();\nshow server_version;\nshow server_version_num;\nshow server_encoding;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u9759\u6001\u6570\u636e\u884c",children:"\u9759\u6001\u6570\u636e\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM (VALUES (1, 'one'), (2, 'two'), (3, 'three')) AS t (num, letter);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5206\u7ec4\u805a\u5408",children:"\u5206\u7ec4\u805a\u5408"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/cube.html",children:"cube"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/devel/queries-table-expressions.html#QUERIES-GROUPING-SETS",children:"GROUPING SETS, CUBE, ROLLUP"})}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"rollup(a,b,c)"})," => ",(0,l.jsx)(n.code,{children:"grouping sets((a,b,c),(a,b),(a),())"})]}),"\n",(0,l.jsx)(n.li,{children:"cube((a),(b),(c)) grouping sets((a,b,c),(a,b),(a,c),(a),(b,c),(b),(c),())"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"GROUP BY a, b, c\n-- \u5bf9\u7b49\n\n\nROLLUP ( a, b , c)\n-- \u5bf9\u7b49\nGROUPING SETS (\n    ( a, b, c ),\n    ( a, b    ),\n    ( a       ),\n    (         )\n)\n\nCUBE ( a, b, c )\n-- \u5bf9\u7b49\nGROUPING SETS (\n    ( a, b, c ),\n    ( a, b    ),\n    ( a,    c ),\n    ( a       ),\n    (    b, c ),\n    (    b    ),\n    (       c ),\n    (         )\n)\n\nCUBE ( (a, b), (c, d) )\n-- \u5bf9\u7b49\nGROUPING SETS (\n    ( a, b, c, d ),\n    ( a, b       ),\n    (       c, d ),\n    (            )\n)\n"})}),"\n",(0,l.jsx)(n.h2,{id:"function-vs-procedure",children:"function vs procedure"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["function\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e0d\u53ef\u4ee5\u64cd\u4f5c\u4e8b\u7269"}),"\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528 SELECT \u8c03\u7528"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["procedure\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6ca1\u6709\u8fd4\u56de\u503c"}),"\n",(0,l.jsx)(n.li,{children:"\u6709 INOUT \u53c2\u6570"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u4ee5 commit \u548c rollback"}),"\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528 CALL \u8c03\u7528"}),"\n",(0,l.jsx)(n.li,{children:"\u4e0d\u53ef\u4ee5\u5d4c\u5957\u5230\u5176\u4ed6 DDL - SELECT,INSERT,UPDATE,DELETE"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"plpgsql-vs-sql",children:"plpgsql vs sql"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["sql\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7b80\u5355"}),"\n",(0,l.jsx)(n.li,{children:"\u5df2\u7ecf\u719f\u6089 SQL"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["plpgsql\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u652f\u6301\u590d\u6742\u8bed\u6cd5"}),"\n",(0,l.jsx)(n.li,{children:"\u652f\u6301\u63a7\u5236\u6d41 - \u80fd\u505a\u5230\u5355\u4e2a SQL \u505a\u4e0d\u5230\u7684\u4e8b\u60c5"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://stackoverflow.com/a/24771561/1870054",children:"https://stackoverflow.com/a/24771561/1870054"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u51fd\u6570\u8fd4\u56de\u5f71\u54cd\u884c",children:"\u51fd\u6570\u8fd4\u56de\u5f71\u54cd\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"get diagnostics cnt = row_count;\nreturn cnt;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6b63\u5219",children:"\u6b63\u5219"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"regexp_match(string, pattern [, flags ]) returns text[]\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["flags\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"g - global"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT (regexp_match('200\u4e07\u4eba\u6c11\u5e01', '[\\d.]+'))[1];\nSELECT (regexp_match('200\u4e07\u4eba\u6c11\u5e01', '\\D+$'))[1];\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u751f\u6210\u5e26\u524d\u7f00\u7684-uuid-\u4e3b\u952e",children:"\u751f\u6210\u5e26\u524d\u7f00\u7684 UUID \u4e3b\u952e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4f8b\u5982\u7528\u4e8e GraphQL \u901a\u8fc7 ID \u5224\u65ad\u7c7b\u578b"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"create table test\n(\n    id    text default 'test-' || public.gen_random_uuid() primary key,\n    value text\n);\n\ninsert into test(value)\nvalues ('test');\n\nselect *\nfrom test;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u63a8\u8350\u4e3b\u952e\u521b\u5efa\u65b9\u5f0f",children:"\u63a8\u8350\u4e3b\u952e\u521b\u5efa\u65b9\u5f0f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5bf9\u6bd4 serial\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6709\u5f52\u5c5e\u5173\u7cfb"}),"\n",(0,l.jsx)(n.li,{children:"\u66f4\u52a0\u89c4\u8303"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"GENERATED { ALWAYS | BY DEFAULT } AS IDENTITY"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ALWAYS"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["INSERT \u6307\u5b9a ID \u4e0d\u4f1a\u751f\u6548\uff0c\u9700\u8981 ",(0,l.jsx)(n.code,{children:"OVERRIDING SYSTEM VALUE"})]}),"\n",(0,l.jsx)(n.li,{children:"UPDATE \u4e0d\u5141\u8bb8\u4fee\u6539 ID"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"BY DEFAULT"})," - \u7528\u6237\u6307\u5b9a\u503c\u4f18\u5148\u7ea7\u66f4\u9ad8"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE users (\n   id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY\n);\n-- \u4e5f\u53ef\u4ee5\u9488\u5bf9\u751f\u6210\u8bbe\u7f6e\u66f4\u591a\u53c2\u6570\nCREATE TABLE users (\n   id bigint GENERATED ALWAYS AS IDENTITY\n             (MINVALUE 0 START WITH 0 CACHE 20)\n             PRIMARY KEY,\n);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"operator",children:"Operator"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u64cd\u4f5c\u7b26\u4e5f\u662f\u51fd\u6570\nSELECT 3 OPERATOR(pg_catalog.+) 4;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5206\u7ec4\u91cc\u9009\u62e9\u6700\u540e\u4e00\u6761\u6570\u636e",children:"\u5206\u7ec4\u91cc\u9009\u62e9\u6700\u540e\u4e00\u6761\u6570\u636e"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"distinct - \u63a8\u8350"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"select distinct on (id) id, date, another_info\nfrom the_table\norder by id, date desc;\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsx)(n.li,{children:"window"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"select data\nfrom (\n        select data,\n                row_number()\n                over (partition by data ->> 'groupId' order by item_date desc) as rn\n        from pulled_items\n    ) lt\nwhere rn = 1\n"})}),"\n",(0,l.jsx)(n.h2,{id:"on-conflict-\u591a\u5217-unique",children:"ON CONFLICT \u591a\u5217 UNIQUE"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT",children:"https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT"})}),"\n",(0,l.jsx)(n.li,{children:"conflict_target can perform unique index inference"}),"\n",(0,l.jsxs)(n.li,{children:["\u591a\u5217 UNIQUE \u4f1a\u6709\u95ee\u9898 - ",(0,l.jsx)(n.a,{href:"https://stackoverflow.com/a/38066008/1870054",children:"https://stackoverflow.com/a/38066008/1870054"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5efa\u8bae\u901a\u8fc7 generate \u5217\u8c03\u6574 uniqe \u903b\u8f91"}),"\n",(0,l.jsx)(n.li,{children:"\u6216\u8005\u518d\u5efa\u4e00\u4e2a\u5305\u542b\u6240\u6709 unique \u5217\u7684\u7d22\u5f15"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5982\u679c\u60f3\u8981\u8fd4\u56de EXCLUDED \u53ef\u4ee5\u4f7f\u7528 CTE \u591a\u6b65\u6267\u884c ",(0,l.jsx)(n.a,{href:"https://stackoverflow.com/a/35953488/1870054",children:"https://stackoverflow.com/a/35953488/1870054"})]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"lateral-join",children:"LATERAL JOIN"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6267\u884c\u4e00\u6b21"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u4ea4\u53c9\u5f15\u7528\u5176\u4ed6 FROM"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL",children:"https://www.postgresql.org/docs/current/queries-table-expressions.html#QUERIES-LATERAL"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u4e0d\u53ef\u4ee5\u518d-where-\u4f7f\u7528\u522b\u540d",children:"\u4e0d\u53ef\u4ee5\u518d WHERE \u4f7f\u7528\u522b\u540d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u4e0d\u53ef\u4ee5\u518d WHERE \u548c HAVING \u4f7f\u7528\u522b\u540d\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/sql-select.html#SQL-SELECT-LIST",children:"https://www.postgresql.org/docs/current/sql-select.html#SQL-SELECT-LIST"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"\u5982\u679c\u4e00\u5b9a\u8981\uff0c\u53ef\u4ee5\u8003\u8651 CTE \u6216 subquery"}),"\n"]}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsxs)(n.p,{children:["An output column's name can be used to refer to the column's value in ",(0,l.jsx)(n.code,{children:"ORDER BY"})," and ",(0,l.jsx)(n.code,{children:"GROUP BY"})," clauses, but ",(0,l.jsx)(n.strong,{children:"not"})," in the ",(0,l.jsx)(n.code,{children:"WHERE"})," or ",(0,l.jsx)(n.code,{children:"HAVING"})," clauses; there you must write out the expression instead."]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"select username, profiles.age as profile_age\nfrom users,\n  left join profiles on (profiles.user_id = users.id)\n-- \u4e0d\u652f\u6301 \u5f15\u7528\nwhere profile_age > 18;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"csv",children:"csv"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"COPY (SELECT * FROM foo) TO '/tmp/test.csv' WITH CSV DELIMITER ',' HEADER;\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"psql"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"\\copy (SELECT * FROM foo) TO '/tmp/test.csv' WITH CSV DELIMITER ',' HEADER;\n\\copy (SELECT * FROM foo) TO STDOUT WITH CSV DELIMITER ',' HEADER;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"create-role-if-not-exists",children:"create role if not exists"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"DO\n$do$\nBEGIN\n   IF EXISTS (\n      SELECT FROM pg_catalog.pg_roles\n      WHERE  rolname = 'my_user') THEN\n\n      RAISE NOTICE 'Role \"my_user\" already exists. Skipping.';\n   ELSE\n      CREATE ROLE my_user LOGIN PASSWORD 'my_password';\n   END IF;\nEND\n$do$;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"role-cannot-be-dropped-because-some-objects-depend-on-it---privileges-for-table-users",children:"role cannot be dropped because some objects depend on it - privileges for table users"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"REASSIGN OWNED BY test TO postgres;\nDROP OWNED BY test;\n\nDROP USER test;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"create-role-if-not-exists-1",children:"create role if not exists"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"DO\n$do$\nBEGIN\n   IF EXISTS (\n      SELECT FROM pg_catalog.pg_roles\n      WHERE  rolname = 'my_user') THEN\n\n      RAISE NOTICE 'Role \"my_user\" already exists. Skipping.';\n   ELSE\n      CREATE ROLE my_user;\n   END IF;\nEND\n$do$;\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5904\u7406 EXCEPTION \u6bd4\u63d0\u524d\u68c0\u6d4b\u66f4\u6162"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"create-policy-if-not-exists",children:"create policy if not exists"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"do\n$do$\n    begin\n        if exists(select *\n                  from pg_catalog.pg_policies\n                  where (schemaname, tablename, policyname) = ('app', 'service_accounts', 'tid'))\n        then\n            raise notice 'policy already exists';\n        else\n            create policy tid on app.service_accounts using (tid = current_tenant_id());\n        end if;\n    end\n$do$;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"add-foreign-key-if-not-exists",children:"add foreign key if not exists"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://stackoverflow.com/q/12855631/1870054",children:"https://stackoverflow.com/q/12855631/1870054"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"DO\n$$\n    BEGIN\n        IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'flow_active_stage_id_fkey') THEN\n            alter table flow\n                add constraint flow_active_stage_id_fkey foreign key (active_stage_id) references flow_stage (id);\n        END IF;\n    END;\n$$;\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},38088:(e,n,s)=>{var l=s(96651),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,c=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function o(e,n,s){var l,i={},o=null,a=null;for(l in void 0!==s&&(o=""+s),void 0!==n.key&&(o=""+n.key),void 0!==n.ref&&(a=n.ref),n)t.call(n,l)&&!d.hasOwnProperty(l)&&(i[l]=n[l]);if(e&&e.defaultProps)for(l in n=e.defaultProps)void 0===i[l]&&(i[l]=n[l]);return{$$typeof:r,type:e,key:o,ref:a,props:i,_owner:c.current}}n.Fragment=i,n.jsx=o,n.jsxs=o},2488:(e,n,s)=>{e.exports=s(38088)},62780:(e,n,s)=>{s.d(n,{I:()=>c,M:()=>t});var l=s(96651);const r={},i=l.createContext(r);function t(e){const n=l.useContext(i);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);