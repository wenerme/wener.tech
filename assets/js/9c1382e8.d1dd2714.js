"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[51070],{49613:function(e,t,a){a.d(t,{Zo:function(){return o},kt:function(){return k}});var n=a(59496);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},o=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,o=c(e,["components","mdxType","originalType","parentName"]),m=p(a),d=r,k=m["".concat(l,".").concat(d)]||m[d]||u[d]||s;return a?n.createElement(k,i(i({ref:t},o),{},{components:a})):n.createElement(k,i({ref:t},o))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=a.length,i=new Array(s);i[0]=d;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c[m]="string"==typeof e?e:r,i[1]=c;for(var p=2;p<s;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},7857:function(e,t,a){a.r(t),a.d(t,{assets:function(){return y},contentTitle:function(){return h},default:function(){return g},frontMatter:function(){return k},metadata:function(){return f},toc:function(){return v}});var n=a(49613),r=Object.defineProperty,s=Object.defineProperties,i=Object.getOwnPropertyDescriptors,c=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,o=(e,t,a)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,m=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&o(e,a,t[a]);if(c)for(var a of c(t))p.call(t,a)&&o(e,a,t[a]);return e},u=(e,t)=>s(e,i(t)),d=(e,t)=>{var a={};for(var n in e)l.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&c)for(var n of c(e))t.indexOf(n)<0&&p.call(e,n)&&(a[n]=e[n]);return a};const k={title:"smallstep"},h="smallstep",f={unversionedId:"security/cert/smallstep",id:"security/cert/smallstep",title:"smallstep",description:"- \u51fa\u4e8e\u5546\u4e1a\u51b3\u5b9a\u79fb\u9664\u4e86 EAB #897",source:"@site/../notes/security/cert/smallstep.md",sourceDirName:"security/cert",slug:"/security/cert/smallstep",permalink:"/notes/security/cert/smallstep",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/security/cert/smallstep.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1699003495,formattedLastUpdatedAt:"Nov 3, 2023",frontMatter:{title:"smallstep"},sidebar:"docs",previous:{title:"Let's Encrypt",permalink:"/notes/security/cert/letsencrypt"},next:{title:"Crypto",permalink:"/notes/security/crypto/"}},y={},v=[{value:"Endpoint",id:"endpoint",level:2},{value:"Get Started",id:"get-started",level:2},{value:"ACME",id:"acme",level:2},{value:"Yubikey KMS",id:"yubikey-kms",level:2},{value:"\u914d\u7f6e",id:"config",level:2},{value:"Concepts",id:"concepts",level:2},{value:"ssh",id:"ssh",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"K8S",id:"k8s",level:2},{value:"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner &#39;Admin JWK&#39;",id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk",level:2},{value:"ACME EAB not enabled for provisioner",id:"acme-eab-not-enabled-for-provisioner",level:2}],N={toc:v},b="wrapper";function g(e){var t=e,{components:a}=t,r=d(t,["components"]);return(0,n.kt)(b,u(m(m({},N),r),{components:a,mdxType:"MDXLayout"}),(0,n.kt)("h1",m({},{id:"smallstep"}),"smallstep"),(0,n.kt)("admonition",m({},{type:"caution"}),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},"\u51fa\u4e8e\u5546\u4e1a\u51b3\u5b9a\u79fb\u9664\u4e86 EAB ",(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/certificates/issues/897"}),"#897")))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/certificates"}),"smallstep/certificates"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Apache-2.0, Go"),(0,n.kt)("li",{parentName:"ul"},"CA, ACME server"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/cli"}),"smallstep/cli")),(0,n.kt)("li",{parentName:"ul"},"kubernetes",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"step-certificates ",(0,n.kt)("a",m({parentName:"li"},{href:"https://hub.helm.sh/charts/smallstep/step-certificates"}),"https://hub.helm.sh/charts/smallstep/step-certificates")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/autocert"}),"smallstep/autocert"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u6ce8\u5165 TLS/HTTPS \u8bc1\u4e66\u5230\u5bb9\u5668"))))),(0,n.kt)("li",{parentName:"ul"},"\u53c2\u8003",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://smallstep.com/blog/everything-pki"}),"Everything you should know about certificates and PKI but are too afraid to ask")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://smallstep.com/blog/use-tls"}),"The case for using TLS everywhere")))),(0,n.kt)("li",{parentName:"ul"},"step-ca",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u652f\u6301\u6570\u636e\u5e93 Badger, BoltDB, MySQL, PostgreSQL",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u76ee\u524d\u6b63\u5728\u5c06 NoSQL \u8c03\u6574\u4e3a SQL \u903b\u8f91 - \u4f1a\u652f\u6301\u66f4\u591a DB ",(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/certificates/issues/282"}),"smallstep/certificates#282")))))),(0,n.kt)("li",{parentName:"ul"},"\u652f\u6301\u7684\u8fd0\u884c\u6a21\u5f0f",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u79bb\u7ebf - \u4e0d\u542f\u52a8\u670d\u52a1\uff0c\u79bb\u7ebf\u7ba1\u7406\u8bc1\u4e66"),(0,n.kt)("li",{parentName:"ul"},"\u5728\u7ebf - \u542f\u52a8 step-ca\uff0c\u63d0\u4f9b\u63a5\u53e3\u80fd\u529b"),(0,n.kt)("li",{parentName:"ul"},"RA - Registration Authority",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"RA \u4f5c\u4e3a CA \u7684\u524d\u7aef"),(0,n.kt)("li",{parentName:"ul"},"\u4f8b\u5982\u4e3a Vault \u63d0\u4f9b ACMEv2 server \u7684\u80fd\u529b")))))),(0,n.kt)("admonition",m({},{type:"tip"}),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},"vault \u4e0d\u652f\u6301\u4f5c\u4e3a acme server\uff0c\u5982\u679c\u9700\u8981\u79c1\u6709\u5316 acme \u53ef\u4ee5\u8003\u8651 step-ca",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/hashicorp/vault/issues/8690"}),"hashicorp/vault#8690")),(0,n.kt)("li",{parentName:"ul"},"step-ca \u652f\u6301\u5c06 vault \u4f5c\u4e3a RA/registration authority"),(0,n.kt)("li",{parentName:"ul"},"\u4e5f\u53ef\u4ee5\u4f7f\u7528 ",(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/letsencrypt/boulder"}),"letsencrypt/boulder")))))),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# macOS\nbrew install step\n# AlpineLinux\napk add step-cli step-certificates -X http://mirrors.sjtug.sjtu.edu.cn/alpine/edge/testing/\n\nstep path # \u6570\u636e\u76ee\u5f55 $HOME/.step\nSTEPPATH=/tmp/step step path\n# \u914d\u7f6e $(step path)/config/ca.json\nmkdir -p $STEPPATH && cd $_\n\n# \u751f\u6210 CA $HOME/.step/certs/root_ca.crt $HOME/.step/secrets/root_ca_key\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\nstep certificate fingerprint certs/root_ca.crt\n\n# step ca certificate --offline foo.smallstep.com foo.crt foo.key\n\n\n# \u83b7\u53d6\u5f53\u524d\u7684 root fingerprint\nstep certificate fingerprint $(step path)/certs/root_ca.crt\n# \u53e6\u5916\u4e00\u4e2a\u8282\u70b9\nstep ca bootstrap --ca-url 127.0.0.1:443 --fingerprint <root fingerprint>\n\n# \u751f\u6210\u8bc1\u4e66\nstep ca certificate localhost srv.crt srv.key\n# \u4fdd\u6301 root ca - \u6709\u4e9b\u573a\u666f\u9700\u8981\u7528\u4e8e\u8ba4\u8bc1\nstep ca root root.crt\n\n# \u67e5\u770b\u8bc1\u4e66\u4fe1\u606f\nstep certificate inspect srv.crt --short\n\n# \u751f\u6210 CSR\nstep certificate create --csr foo.example.com foo.csr foo.key\n# \u5bf9 CSR \u7b7e\u540d\nstep ca sign foo.csr foo.crt\n# renew \u8bc1\u4e66\nstep ca renew foo.crt foo.key\n# \u56de\u6536\u8bc1\u4e66\nstep ca revoke --cert svc.crt --key svc.key\n\n\n# \u5f53\u524d\u652f\u6301 provisioner\nstep ca provisioner list\n# \u6dfb\u52a0\u540e\u9700\u8981\u91cd\u542f ca \u751f\u6548\nstep ca provisioner add you@example.com --create\n\n# step \u5305\u542b jwt \u89e3\u7801\u903b\u8f91\necho $TOKEN | step crypto jwe decrypt  | jq\n\n# \u751f\u6210\u8bc1\u4e66\u4f1a\u8981\u6c42\u9009\u62e9 provisioner\nstep ca certificate mike@example.com mike.crt mike.key\n\nstep certificate inspect --short mike.crt\n\n# \u6dfb\u52a0 google \u4f5c\u4e3a IdP\nstep ca provisioner add Google --type oidc --ca-config $(step path)/config/ca.json \\\n  --client-id 650445034027-jsjdrkiskeq9ke99ud2rqkst82ft8uch.apps.googleusercontent.com \\\n  --client-secret 6Q7lGMua_Oox4nA92QBXYypT \\\n  --configuration-endpoint https://accounts.google.com/.well-known/openid-configuration \\\n  --domain smallstep.com --domain gmail.com\n\n\n# X5C - \u53ef\u4ee5\u518d\u7528\u4e8e\u751f\u6210\u8bc1\u4e66\nstep ca provisioner add x5c-smallstep --type X5C --x5c-root $(step path)/certs/root_ca.crt\n# SSHPOP - renew, revoke, rekey an SSH certificate\nstep ca provisioner add sshpop --type SSHPOP\n# ACME - https://smallstep.com/docs/tutorials/acme-challenge\n# \u4f5c\u4e3a ACMEv2 server\n# https://{ca-host}/acme/{provisioner-name}/directory\nstep ca provisioner add acme --type ACME\n# step certificate install\n\n# K8S SA\nstep ca provisioner add my-kube-provisioner --type K8sSA --pem-keys key.pub\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://hub.docker.com/r/smallstep/step-ca"}),"https://hub.docker.com/r/smallstep/step-ca"))),(0,n.kt)("h2",m({},{id:"endpoint"}),"Endpoint"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go"}),"https://github.com/smallstep/certificates/blob/master/acme/api/handler.go"))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("a",m({parentName:"strong"},{href:"https://ca.wener.me/acme/acme/directory"}),"https://ca.wener.me/acme/acme/directory"))),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-json"}),'{\n  "newNonce": "https://ca.wener.me/acme/acme/new-nonce",\n  "newAccount": "https://ca.wener.me/acme/acme/new-account",\n  "newOrder": "https://ca.wener.me/acme/acme/new-order",\n  "revokeCert": "https://ca.wener.me/acme/acme/revoke-cert",\n  "keyChange": "https://ca.wener.me/acme/acme/key-change"\n}\n')),(0,n.kt)("h2",m({},{id:"get-started"}),"Get Started"),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# \u521d\u59cb\u5316 CA\n# =====================\nexport STEPPATH=/data/ca\n\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name \"Wener CA\" \\\n  --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address \":443\" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --ssh --acme \\\n  --remote-management\n\n# \u6309\u9700\u4fee\u6539 $(step path)/config/ca.json\n# \u4f8b\u5982\u4fee\u6539 db \u5b58\u50a8\n\n# \u542f\u52a8 CA\nstep-ca $(step path)/config/ca.json --password-file ./ca.passwd\n\n# \u521d\u59cb\u5316 \u5ba2\u6237\u7aef\n# =====================\ndocker exec -u root -e STEPPATH=/data/step -it stepca bash\n# \u4e0b\u8f7d CA \u8bc1\u4e66\n# $HOME/.step/certs/root_ca.crt\n# $HOME/.step/config/defaults.json\n#   ca-url, fingerprint, root\nstep ca bootstrap --ca-url ca.wener.me --fingerprint $(step certificate fingerprint /data/ca/certs/root_ca.crt)\n\n# \u9700\u8981 root\nstep certificate install $(step path)/certs/root_ca.crt\nls -lash /etc/ssl/certs | grep Wener\n\n# --ca-url https://ca.smallstep.com --root /home/user/.step/certs/root_ca.crt\n# TOKEN=$(step ca token internal.example.com)\n# --token $TOKEN\nstep ca health\n\n# \u7ba1\u7406\u5458\u7528\u6237\nstep ca admin list --super --admin-name step --password-file ca.passwd\n\n# \u751f\u6210\u8bc1\u4e66\nstep ca certificate localhost svr.crt svr.key --provisioner-password-file ./ca.passwd\n# 6m \u6709\u6548\nstep certificate inspect svr.crt --short\n# 1h \u6709\u6548\n# 8760h \u4e3a 1\u5e74, 43800h \u4e3a 5\u5e74, 87600h \u4e3a 10\u5e74\nstep ca certificate localhost svr.crt svr.key --not-after 1h --provisioner-password-file ./ca.passwd\n\n# ACME\nstep ca provisioner add acme --type ACME --password-file ca.passwd\n\ncurl https://ca.wener.me/acme/acme/directory\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/"}),"https://ypbind.de/maus/notes/real_life_step-ca_with_multiple_users/"))),(0,n.kt)("h2",m({},{id:"acme"}),"ACME"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/"}),"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients/")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"https://{ca-host}/acme/{provisioner-name}/directory"))),(0,n.kt)("h2",m({},{id:"yubikey-kms"}),"Yubikey KMS"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Yubikey \u7ba1\u7406 PKI \u7684\u5bc6\u7801"),(0,n.kt)("li",{parentName:"ul"},"\u7b2c\u4e8c\u6b21\u751f\u6210\u7684 CA \u4f7f\u7528 Yubikey \u4f5c\u4e3a KMS")),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'docker run --rm -it \\\n  -v $PWD/data:/data \\\n  --entrypoint bash \\\n  --hostname ca.wener.me \\\n  -w /data \\\n  -p 443:443 \\\n  --name stepca smallstep/step-ca\n\n# PKI\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./pki.passwd\nSTEPPATH=/data/pki step ca init --pki --name="Wener" --deployment-type standalone --password-file ./pki.passwd\ncp /data/pki/certs/{intermediate_ca.crt,root_ca.crt} .\n\n# \u6dfb\u52a0 crt \u548c key \u5230 yubikey\nykman piv certificates import 9a /data/pki/certs/root_ca.crt\nykman piv keys import 9a /data/pki/secrets/root_ca_key\nykman piv certificates import 9c /data/pki/certs/intermediate_ca.crt\nykman piv keys import 9c /data/pki/secrets/intermediate_ca_key\n\nykman piv info\n\n# \u5c06 data/pki \u4fdd\u5b58\u5230\u5916\u90e8\u5b58\u50a8\u540e\u5220\u9664\n\n# CA\nexport STEPPATH=/data/ca\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./ca.passwd\ncat /dev/urandom | env LC_CTYPE=C tr -dc \'a-zA-Z0-9\' | head -c 32 > ./provisioner.passwd\n# https://smallstep.com/docs/step-cli/reference/ca/init/\n# --dns \u4e5f\u652f\u6301\u5730\u5740\nstep ca init \\\n  --name "Wener CA" --dns ca.wener.me --dns ca.wener.tech \\\n  --provisioner wener@wener.me --address ":443" --deployment-type standalone \\\n  --password-file ./ca.passwd \\\n  --provisioner-password-file ./provisioner.passwd \\\n  --remote-management\n\n# use pki cert\nmv root_ca.crt intermediate_ca.crt $STEPPATH/certs\nrm -rf $STEPPATH/secrets\n\n# \u4fee\u6539 ca.json \u7684 "key": "/data/ca/secrets/intermediate_ca_key",\n# "key": "yubikey:slot-id=9c",\n# "kms": {\n#     "type": "yubikey",\n#     "pin": "123456"\n# },\nstep-ca $STEPPATH/config/ca.json --password-file ./pki.passwd --provisioner-password-file ./provisioner.passwd\n')),(0,n.kt)("h2",m({},{id:"config"}),"\u914d\u7f6e"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",m({parentName:"tr"},{align:null}),"env"),(0,n.kt)("th",m({parentName:"tr"},{align:null}),"for"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",m({parentName:"tr"},{align:null}),"STEPPATH"),(0,n.kt)("td",m({parentName:"tr"},{align:null}),"\u6570\u636e\u76ee\u5f55")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",m({parentName:"tr"},{align:null}),"STEPDEBUG"),(0,n.kt)("td",m({parentName:"tr"},{align:null}))))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"authority.claims",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"maxTLSCertDuration",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 24h"))))),(0,n.kt)("li",{parentName:"ul"},"db",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"KV - \u672c\u5730 - \u4e0d\u652f\u6301 \u5e76\u53d1/\u591a\u8fdb\u7a0b",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"badger -> badgerv1"),(0,n.kt)("li",{parentName:"ul"},"badgerv1"),(0,n.kt)("li",{parentName:"ul"},"badgerv2"),(0,n.kt)("li",{parentName:"ul"},"bbolt"))),(0,n.kt)("li",{parentName:"ul"},"SQL - \u8fdc\u7a0b - \u4e5f\u662f\u4f5c\u4e3a KV - nkey, nvalue - 25\u4e2a\u8868",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"mysql"),(0,n.kt)("li",{parentName:"ul"},"postgresql")))))),(0,n.kt)("h2",m({},{id:"concepts"}),"Concepts"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts"}),"https://smallstep.com/docs/step-ca/certificate-authority-core-concepts"))),(0,n.kt)("h2",m({},{id:"ssh"}),"ssh"),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# \u521d\u59cb\u5316 CA \u5e26 ssh \u8bc1\u4e66\u652f\u6301\nstep ca init --ssh\n# \u751f\u6210\u914d\u7f6e\nstep ssh config --roots > /path/to/ssh_user_key.pub\n# \u914d\u7f6e CA\ncat << EOF >> /etc/ssh/sshd_config\n# This is the CA's public key for authenticating user certificates:\nTrustedUserCAKeys /path/to/ssh_user_key.pub\nEOF\n# \u751f\u6210\u8bc1\u4e66\nstep ssh certificate alice@smallstep.com id_ecdsa\n# \u67e5\u770b\u751f\u6210\u7684\u8bc1\u4e66\u4fe1\u606f\ncat id_ecdsa-cert.pub | tail -1 | step ssh inspect\n\n# \u751f\u6210 host key\nstep ssh certificate --host internal.example.com ssh_host_ecdsa_key\ncat ssh_host_ecdsa_key-cert.pub | step ssh inspect\n# \u914d\u7f6e host key\nmv ssh_host_ecdsa_key ssh_host_ecdsa_key-cert.pub /etc/ssh\ncat << EOF >> /etc/ssh/sshd_config\n# This is our host private key and certificate:\nHostKey /etc/ssh/ssh_host_ecdsa_key\nHostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub\nEOF\n\n# \u81ea\u52a8\u66f4\u65b0 host key\ncat << EOF > /etc/cron.weekly/rotate-ssh-certificate\n#!/bin/sh\nexport STEPPATH=/root/.step\ncd /etc/ssh && step ssh renew ssh_host_ecdsa_key-cert.pub ssh_host_ecdsa_key --force 2> /dev/null\nexit 0\nEOF\nchmod 755 /etc/cron.weekly/rotate-ssh-certificate\n\n# \u6dfb\u52a0\u5230 known_hosts \u4fe1\u4efb\u4e3b\u673a\nstep ssh config --host --roots\n")),(0,n.kt)("h2",m({},{id:"\u914d\u7f6e"}),"\u914d\u7f6e"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"STEPPATH"),(0,n.kt)("li",{parentName:"ul"},"$(step path --base)/",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"contexts.json"),(0,n.kt)("li",{parentName:"ul"},"current-context.json"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"authorities/<AUTHORITY>/")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"profiles/<PROFILE>/"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"config/",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"defaults.json"),(0,n.kt)("li",{parentName:"ul"},"ca.json"))))))),(0,n.kt)("li",{parentName:"ul"},"AUTHORITY/ - \u5982\u679c\u6ca1\u6709 context \u5219\u76ee\u5f55\u4e3a ",(0,n.kt)("inlineCode",{parentName:"li"},"$(step path --base)"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"certs/",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"intermediate_ca.crt"),(0,n.kt)("li",{parentName:"ul"},"root_ca.crt"))),(0,n.kt)("li",{parentName:"ul"},"config/",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"ca.json"),(0,n.kt)("li",{parentName:"ul"},"defaults.json"))),(0,n.kt)("li",{parentName:"ul"},"db"),(0,n.kt)("li",{parentName:"ul"},"secrets",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"intermediate_ca_key"),(0,n.kt)("li",{parentName:"ul"},"root_ca_key"))),(0,n.kt)("li",{parentName:"ul"},"templates")))),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{className:"language-json",metastring:'tite="contexts.json"',tite:'"contexts.json"'}),'{\n  "alpha-one": {\n    "authority": "alpha-one.ca.smallstep.com",\n    "profile": "alpha-one"\n  },\n  "alpha-two": {\n    "authority": "alpha-two.ca.smallstep.com",\n    "profile": "alpha-two"\n  },\n  "beta": {\n    "authority": "beta.ca.smallstep.com",\n    "profile": "beta"\n  }\n}\n')),(0,n.kt)("h2",m({},{id:"k8s"}),"K8S"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",m({parentName:"li"},{href:"https://smallstep.com/docs/tutorials/kubernetes-acme-ca"}),"https://smallstep.com/docs/tutorials/kubernetes-acme-ca"))),(0,n.kt)("h1",m({},{id:"faq"}),"FAQ"),(0,n.kt)("h2",m({},{id:"adminhandlerauthorizetoken-unable-to-load-admin-with-subjects-and-provisioner-admin-jwk"}),"adminHandler.authorizeToken; unable to load admin with subject(s) and provisioner 'Admin JWK'"),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{}),"--admin-name=step\n")),(0,n.kt)("h2",m({},{id:"acme-eab-not-enabled-for-provisioner"}),"ACME EAB not enabled for provisioner"),(0,n.kt)("pre",null,(0,n.kt)("code",m({parentName:"pre"},{}),"add acme --type ACME --require-eab\n")))}g.isMDXComponent=!0}}]);