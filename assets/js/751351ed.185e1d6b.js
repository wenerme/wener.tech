/*! For license information please see 751351ed.185e1d6b.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[26202],{9738:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var s=n(11527),r=n(47214);const o={title:"zustand"},a="zustand",c={id:"web/react/zustand",title:"zustand",description:"- pmndrs/zustand \u662f\u4ec0\u4e48\uff1f",source:"@site/../notes/web/react/zustand.md",sourceDirName:"web/react",slug:"/web/react/zustand",permalink:"/notes/web/react/zustand",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/web/react/zustand.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1693804740,formattedLastUpdatedAt:"Sep 4, 2023",frontMatter:{title:"zustand"},sidebar:"docs",previous:{title:"valtio",permalink:"/notes/web/react/valtio"},next:{title:"robots.txt",permalink:"/notes/web/robots.txt"}},i={},l=[{value:"\u5728\u5916\u90e8\u89e6\u53d1\u72b6\u6001",id:"\u5728\u5916\u90e8\u89e6\u53d1\u72b6\u6001",level:2},{value:"\u901a\u8fc7\u5f15\u7528\u65b9\u5f0f\u4f18\u5316\u5feb\u901f\u53d8\u5316\u7684\u72b6\u6001",id:"\u901a\u8fc7\u5f15\u7528\u65b9\u5f0f\u4f18\u5316\u5feb\u901f\u53d8\u5316\u7684\u72b6\u6001",level:2},{value:"Zustand v4",id:"zustand-v4",level:2}];function u(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"zustand",children:"zustand"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://github.com/pmndrs/zustand",children:"pmndrs/zustand"})," \u662f\u4ec0\u4e48\uff1f\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["out of tree \u72b6\u6001\u7ba1\u7406\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u53ef\u5916\u90e8\u67e5\u8be2\u3001\u4fee\u6539\u3001\u8ba2\u9605"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u591a\u4e2a\u6e32\u67d3\u6811\u4f7f\u7528"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"\u652f\u6301 react concurrency"}),"\n",(0,s.jsx)(t.li,{children:"Context \u53ef\u9009"}),"\n",(0,s.jsx)(t.li,{children:"\u9ed8\u8ba4\u5168\u5c40 store \u5355\u4f8b"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u5728\u5176\u5b83\u6846\u67b6\u4f7f\u7528 - \u4e0d\u4f9d\u8d56 react"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"subscribeWithSelector"}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"useStore \u65f6\u63a8\u8350 memoize \u9009\u62e9\u5668\uff0c\u907f\u514d\u6bcf\u6b21 render \u8ba1\u7b97"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u4ee5\u5c06\u9009\u62e9\u5668\u5b9a\u4e49\u5728\u5916\u90e8\u907f\u514d\u52a8\u6001\u521b\u5efa\u4ea7\u751f\u53d8\u5316"}),"\n",(0,s.jsx)(t.li,{children:"\u53ef\u914d\u5408 immer \u7b80\u5316\u64cd\u4f5c"}),"\n",(0,s.jsx)(t.li,{children:"create \u5305\u542b\u4e09\u4e2a\u53c2\u6570 - set,get,api - \u53ef\u62e6\u622a\u5b9e\u73b0\u4e2d\u95f4\u4ef6\u6a21\u5f0f"}),"\n"]})}),"\n",(0,s.jsx)(t.admonition,{type:"caution",children:(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u4e0a\u4e0b\u6587\u6a21\u5f0f\u5fc5\u987b\u8981\u6c42\u6709 Provider/Context - \u5426\u5219\u4f1a\u5f02\u5e38"}),"\n",(0,s.jsxs)(t.li,{children:["zustand \u4e0d\u597d\u5206\u9694\u72b6\u6001\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/issues/178",children:"#178"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/issues/520#issuecomment-891087525",children:"#520"})}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"// https://github.com/pmndrs/zustand\nimport create from 'zustand';\nimport shallow from 'zustand/shallow';\n\n// \u5b9a\u4e49\nconst useStore = create((set, get) => ({\n  count: 0,\n  add: () => set((state) => ({ count: state.count + 1 })),\n  reset: () => set({ count: 0 }),\n  clear: () => set({}, true), // true \u8868\u793a\u91cd\u7f6e\u6574\u4e2a state\n  fetch: async (pond) => {\n    // \u652f\u6301 async\n    const response = await fetch(pond);\n    set({ fishies: await response.json() });\n  },\n  action: () => {\n    const count = get().count; // \u65b9\u6cd5\u5185\u4f7f\u7528 get \u8bbf\u95ee\u72b6\u6001\n  },\n}));\n// \u4f7f\u7528\nconst state = useStore();\nconst count = useStore((state) => state.count);\nconst add = useStore((state) => state.add);\nconst count = useStore(\n  (state) => state.count,\n  (a, b) => compare(a, b), // \u81ea\u5b9a\u4e49 compare\n);\n// shallow compare\nconst [nuts, honey] = useStore((state) => [state.nuts, state.honey], shallow);\n// \u5efa\u8bae Memoizing selector\nconst fruit = useStore(useCallback((state) => state.fruits[id], [id]));\n// \u76f4\u63a5\u8bbf\u95ee\nuseStore.getState().count;\n// \u76f4\u63a5\u8bbe\u7f6e\nuseStore.setState({ paw: false });\n// \u8ba2\u9605 - \u53ef\u9650\u5b9a\u53d8\u5316\u8303\u56f4\u548c\u6bd4\u8f83\u65b9\u5f0f\nuseStore.subscribe(console.log, (state) => [state.paw, state.fur], shallow);\n// \u6e05\u9664\u6240\u6709 listener\nuseStore.destroy();\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import create from 'zustand';\nconst useStore = create((set) => ({\n  count: 0,\n  reset: () => set({ count: 0 }),\n}));\n\n// shallow compare\nimport shallow from 'zustand/shallow';\nconst { count } = useStore(({ count }) => ({ count }), shallow);\n// useCallback \u53ef\u907f\u514d\u6bcf\u6b21 render \u90fd\u8ba1\u7b97\nconst count = useStore(useCallback((state) => state.count, []));\n// \u5b9a\u4e49\u5728\u7ec4\u5efa\u4e4b\u5916\u4e5f\u53ef\u4ee5\u907f\u514d\nconst selectCount = (state) => state.count;\nconst Counter: React.FC = () => {\n  const count = useStore(selectCount);\n  return <div>{count}</div>;\n};\n\n// vanilla \u53ef\u5728 react \u4e4b\u5916\u4f7f\u7528\nimport createVanilla from 'zustand/vanilla';\nconst store = createVanilla(() => ({}));\nconst { getState, setState, subscribe, destroy } = store;\n\n// \u652f\u6301\u8ba2\u9605 - \u4e4b\u524d\u662f\u5185\u7f6e\u7684\nimport { subscribeWithSelector } from 'zustand/middleware';\nconst useStore = create(subscribeWithSelector(() => ({ count: 0 })));\nconst unsub = useStore.subscribe((state) => state.count, console.log);\n\n// log to redux devtool\nimport { devtools } from 'zustand/middleware';\nconst useStore = create(devtools(store));\n\n// \u4e0a\u4e0b\u6587\u6a21\u5f0f\nimport createContext from 'zustand/context';\n// \u53ef\u4ee5\u5728\u7ec4\u5efa\u5185 \u521d\u59cb\u5316\n// \u53ef\u4ee5\u63d0\u4f9b\u591a\u4e2a context\ninterface DemoState {}\nconst { Provider, useStore, useStoreApi } = createContext<DemoState>();\nconst createStore = () => create((set, get, api) => ({}));\nconst Demo = ({ children }) => {\n  return <Provider createStore={createStore}>{children}</Provider>;\n};\n"})}),"\n",(0,s.jsx)(t.h2,{id:"\u5728\u5916\u90e8\u89e6\u53d1\u72b6\u6001",children:"\u5728\u5916\u90e8\u89e6\u53d1\u72b6\u6001"}),"\n",(0,s.jsx)(t.p,{children:"\u56e0\u4e3a react \u662f\u540c\u6b65\u5904\u7406 setState\uff0c\u56e0\u6b64\u5efa\u8bae\u5305\u88c5\u5728 batchedUpdates \u5904\u7406\u3002"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { unstable_batchedUpdates } from 'react-dom'; // or 'react-native'\n\nconst useStore = create((set) => ({\n  fishes: 0,\n  increaseFishes: () => set((prev) => ({ fishes: prev.fishes + 1 })),\n}));\n\nconst nonReactCallback = () => {\n  unstable_batchedUpdates(() => {\n    useStore.getState().increaseFishes();\n  });\n};\n"})}),"\n",(0,s.jsx)(t.h2,{id:"\u901a\u8fc7\u5f15\u7528\u65b9\u5f0f\u4f18\u5316\u5feb\u901f\u53d8\u5316\u7684\u72b6\u6001",children:"\u901a\u8fc7\u5f15\u7528\u65b9\u5f0f\u4f18\u5316\u5feb\u901f\u53d8\u5316\u7684\u72b6\u6001"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\u4e0d\u76f4\u63a5 useStore - \u907f\u514d rerender"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"const useStore = create((set) => ({ scratches: 0 }));\n\nfunction Component() {\n  // \u521d\u59cb\u72b6\u6001\n  const scratchRef = useRef(useStore.getState().scratches);\n  // \u5c06\u53d8\u5316\u6355\u83b7\u5230\u5f15\u7528 - \u6216\u76f4\u63a5\u8c03\u7528\u5916\u90e8 set\n  useEffect(\n    () =>\n      useStore.subscribe(\n        (scratches) => (scratchRef.current = scratches),\n        (state) => state.scratches,\n      ),\n    [],\n  );\n  return;\n}\n"})}),"\n",(0,s.jsx)(t.h1,{id:"version",children:"version"}),"\n",(0,s.jsx)(t.h2,{id:"zustand-v4",children:"Zustand v4"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { createWithEqualityFn } from 'zustand/traditional'\nconst useFooStore = createWithEqualityFn(..., Object.is)\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"useStoreWithEqualityFn"}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/pmndrs/zustand/discussions/1937",children:"https://github.com/pmndrs/zustand/discussions/1937"})}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},3354:(e,t,n)=>{var s=n(50959),r=Symbol.for("react.element"),o=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var s,o={},l=null,u=null;for(s in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)a.call(t,s)&&!i.hasOwnProperty(s)&&(o[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===o[s]&&(o[s]=t[s]);return{$$typeof:r,type:e,key:l,ref:u,props:o,_owner:c.current}}t.Fragment=o,t.jsx=l,t.jsxs=l},11527:(e,t,n)=>{e.exports=n(3354)},47214:(e,t,n)=>{n.d(t,{Z:()=>c,a:()=>a});var s=n(50959);const r={},o=s.createContext(r);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);