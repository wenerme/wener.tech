/*! For license information please see 1165c82f.e01b2f0f.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[70656],{54452:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>a,frontMatter:()=>r,metadata:()=>d,toc:()=>o});var s=t(2488),i=t(62780);const r={id:"fabio",title:"fabio"},l="fabio",d={id:"devops/service/fabio",title:"fabio",description:"- \u76ee\u524d\u8be5\u9879\u76ee\u5f00\u53d1\u4e0d\u592a\u6d3b\u8dc3\uff0c\u4e0d\u5efa\u8bae\u7528\u6765\u505a\u4e3b\u8981\u7684\u8def\u7531\u6216 Ingress \u89d2\u8272",source:"@site/../notes/devops/service/fabio.md",sourceDirName:"devops/service",slug:"/devops/service/fabio",permalink:"/notes/devops/service/fabio",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/service/fabio.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1630662479,formattedLastUpdatedAt:"Sep 3, 2021",frontMatter:{id:"fabio",title:"fabio"},sidebar:"docs",previous:{title:"Consul",permalink:"/notes/devops/service/consul"},next:{title:"Istio",permalink:"/notes/devops/service/istio"}},c={},o=[{value:"\u8def\u7531\u914d\u7f6e",id:"\u8def\u7531\u914d\u7f6e",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"Consul Policy",id:"consul-policy",level:2}];function h(n){const e={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"fabio",children:"fabio"}),"\n",(0,s.jsx)(e.admonition,{title:"\u6ce8\u610f \u26a0\ufe0f",type:"caution",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u76ee\u524d\u8be5\u9879\u76ee\u5f00\u53d1\u4e0d\u592a\u6d3b\u8dc3\uff0c\u4e0d\u5efa\u8bae\u7528\u6765\u505a\u4e3b\u8981\u7684\u8def\u7531\u6216 Ingress \u89d2\u8272"}),"\n",(0,s.jsx)(e.li,{children:"\u7528\u6765\u5c06 consul \u4e0a\u7684\u670d\u52a1\u5bf9\u5916\u66b4\u9732\u8fd8\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u4e0d\u5efa\u8bae\u4f5c\u4e3a\u552f\u4e00\u4f9d\u8d56"}),"\n"]})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/fabiolb/fabio",children:"fabiolb/fabio"})," - Consul \u5185\u7684\u670d\u52a1 Load-Balancing"]}),"\n",(0,s.jsxs)(e.li,{children:["\u7279\u6027\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8bbf\u95ee\u65e5\u5fd7"}),"\n",(0,s.jsx)(e.li,{children:"\u8bbf\u95ee\u63a7\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u8bc1\u4e66\u5b58\u50a8"}),"\n",(0,s.jsx)(e.li,{children:"\u538b\u7f29"}),"\n",(0,s.jsx)(e.li,{children:"HTTP \u5934\u6ce8\u5165"}),"\n",(0,s.jsx)(e.li,{children:"HTTPS \u4e0a\u6e38"}),"\n",(0,s.jsx)(e.li,{children:"PROXY \u534f\u8bae"}),"\n",(0,s.jsx)(e.li,{children:"\u8def\u5f84\u5254\u9664 - Path stripping"}),"\n",(0,s.jsx)(e.li,{children:"SSE"}),"\n",(0,s.jsx)(e.li,{children:"\u539f\u59cb TCP"}),"\n",(0,s.jsx)(e.li,{children:"TCP SNI"}),"\n",(0,s.jsx)(e.li,{children:"HTTPS TCP SNI"}),"\n",(0,s.jsx)(e.li,{children:"\u6d41\u91cf\u63a7\u5236 - \u8def\u7531 N% \u5230\u4e0d\u540c\u4e0a\u6e38"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301 Vault \u5b58\u50a8 \u8bc1\u4e66"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:"\u9ed8\u8ba4\u53ea\u4f1a\u5904\u7406\u901a\u8fc7\u76d1\u63a7\u68c0\u67e5\u7684\u670d\u52a1"}),"\n",(0,s.jsx)(e.li,{children:"\u9ed8\u8ba4\u7aef\u53e3 9999"}),"\n",(0,s.jsx)(e.li,{children:"\u7ba1\u7406\u7aef\u53e3 9998"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/fabiolb/fabio/wiki/Routing",children:"\u8def\u7531"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Tags\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"urlprefix-{host}/{path}"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"urlprefix-i.com/static"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"urlprefix-/foo/bar proto=https tlsskipverify=true strip=/foo"})}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"urlprefix-:3306 proto=tcp"})," - TCP \u8def\u7531"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://github.com/fabiolb/fabio/blob/master/fabio.properties",children:"fabio.properties"})}),"\n",(0,s.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/weibocom/nginx-upsync-module",children:"weibocom/nginx-upsync-module"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"consul \u751f\u6210 nginx \u914d\u7f6e"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# go\ngo get -u github.com/fabiolb/fabio\n# macOS\nbrew install fabio\n\nconsul agent -dev\n\nconsul kv put fabio/config 'route add wener-me /wener https://wener.me opts \"strip=/wener host=wener.me\"'\n\n# http://localhost:9999/wener\nfabio\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u8def\u7531\u914d\u7f6e",children:"\u8def\u7531\u914d\u7f6e"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u9ed8\u8ba4\u914d\u7f6e\u8def\u5f84 ",(0,s.jsx)(e.code,{children:"/fabio/config"})]}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://fabiolb.net/cfg/",children:"Config Language"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Options"}),(0,s.jsx)(e.th,{children:"Value"}),(0,s.jsx)(e.th,{children:"Desc"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"allow"}),(0,s.jsx)(e.td,{children:"ip:10.0.0.0/8,ip:fe80::/10"}),(0,s.jsx)(e.td,{children:"\u5141\u8bb8\u8bbf\u95ee\u7684 IP"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"deny"}),(0,s.jsx)(e.td,{children:"ip:10.0.0.0/8,ip:fe80::1234"}),(0,s.jsx)(e.td,{children:"\u4e0d\u5141\u8bb8\u8bbf\u95ee\u7684 IP"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"strip"}),(0,s.jsx)(e.td,{children:"/path"}),(0,s.jsxs)(e.td,{children:["\u8def\u5f84\u5254\u9664 - ",(0,s.jsx)(e.code,{children:"/path/to/file"})," -> ",(0,s.jsx)(e.code,{children:"/to/file"})]})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"proto"}),(0,s.jsxs)(e.td,{children:["tcp",(0,s.jsx)(e.br,{}),"https",(0,s.jsx)(e.br,{}),"tcp+sni"]}),(0,s.jsxs)(e.td,{children:["TCP \u7684 dst \u5fc5\u987b\u662f ",(0,s.jsx)(e.code,{children:":<port>"})]})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"pxyproto"}),(0,s.jsx)(e.td,{children:"true"}),(0,s.jsx)(e.td,{children:"PROXY"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"tlsskipverify"}),(0,s.jsx)(e.td,{children:"true"}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"host"}),(0,s.jsx)(e.td,{children:"wener"}),(0,s.jsx)(e.td,{children:"Host \u5934\uff0c\u5982\u679c\u4e3a dst\uff0c\u5219\u4f1a\u4f7f\u7528\u6ce8\u518c\u7684\u4e0a\u6e38\u4e3b\u673a\u540d"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"register"}),(0,s.jsx)(e.td,{}),(0,s.jsx)(e.td,{})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"auth"}),(0,s.jsx)(e.td,{}),(0,s.jsx)(e.td,{})]})]})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ini",children:'# route add <svc> <src> <dst>[ weight <w>][ tags "<t1>,<t2>,..."][ opts "k1=v1 k2=v2 ..."]\n# \u8f6c\u53d1\u5230 wener.me\nroute add wener-me /wener https://wener.me opts "strip=/wener host=wener.me"\n\n# route del <svc>[ <src>[ <dst>]]\n# route del <svc> tags "<t1>,<t2>,..."\n# route del tags "<t1>,<t2>,..."\n\n# route weight <svc> <src> weight <w> tags "<t1>,<t2>,..."\n# route weight <src> weight <w> tags "<t1>,<t2>,..."\n# route weight <svc> <src> weight <w>\n# route weight service host/path weight w tags "tag1,tag2"\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://fabiolb.net/ref/",children:"Reference"})}),"\n"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"conf type"}),(0,s.jsx)(e.th,{children:"demo"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"fabio.properties"}),(0,s.jsx)(e.td,{children:"metrics.target=stdout"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"env"}),(0,s.jsx)(e.td,{children:"metrics_target=stdout"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"env prefix"}),(0,s.jsx)(e.td,{children:"FABIO_metrics_target=stdout"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"ENV"}),(0,s.jsx)(e.td,{children:"FABIO_METRICS_TARGET=stdout"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"arg"}),(0,s.jsx)(e.td,{children:"-metrics.target stdout"})]})]})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"# \u591a\u534f\u8bae\u76d1\u542c\nproxy.addr = 172.16.20.11:80;proto=http;rt=60s;wt=30s,\\\n             172.16.20.11:443;proto=https;rt=60s;wt=30s;cs=all;tlsmin=10, \\\n             172.16.20.11:8443;proto=tcp+sni\n"})}),"\n",(0,s.jsx)(e.h2,{id:"consul-policy",children:"Consul Policy"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-hcl",children:'node_prefix {\n  "" {\n    policy = "read"\n  }\n}\nservice {\n  fabio {\n    policy = "write"\n  }\n  gateway {\n    policy = "write"\n  }\n}\nservice_prefix {\n  "" {\n    policy = "write"\n  }\n}\nkey_prefix {\n  "fabio" {\n    policy = "write"\n  }\n}\nagent {\n  // \u53ef\u9650\u5236\u4e3a fabio\n  "" {\n    policy = "read"\n  }\n}\n'})})]})}function a(n={}){const{wrapper:e}={...(0,i.M)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},38088:(n,e,t)=>{var s=t(96651),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,d=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function o(n,e,t){var s,r={},o=null,h=null;for(s in void 0!==t&&(o=""+t),void 0!==e.key&&(o=""+e.key),void 0!==e.ref&&(h=e.ref),e)l.call(e,s)&&!c.hasOwnProperty(s)&&(r[s]=e[s]);if(n&&n.defaultProps)for(s in e=n.defaultProps)void 0===r[s]&&(r[s]=e[s]);return{$$typeof:i,type:n,key:o,ref:h,props:r,_owner:d.current}}e.Fragment=r,e.jsx=o,e.jsxs=o},2488:(n,e,t)=>{n.exports=t(38088)},62780:(n,e,t)=>{t.d(e,{I:()=>d,M:()=>l});var s=t(96651);const i={},r=s.createContext(i);function l(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);