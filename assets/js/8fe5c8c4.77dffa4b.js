/*! For license information please see 8fe5c8c4.77dffa4b.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[85468],{6836:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>h});var r=s(2488),t=s(62780);const i={tags:["FAQ"]},l="HAProxy FAQ",o={id:"devops/web/haproxy/haproxy-faq",title:"HAProxy FAQ",description:"Memory Usage",source:"@site/../notes/devops/web/haproxy/haproxy-faq.md",sourceDirName:"devops/web/haproxy",slug:"/devops/web/haproxy/faq",permalink:"/notes/devops/web/haproxy/faq",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/web/haproxy/haproxy-faq.md",tags:[{label:"FAQ",permalink:"/notes/tags/faq"}],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1694402622,formattedLastUpdatedAt:"Sep 11, 2023",frontMatter:{tags:["FAQ"]},sidebar:"docs",previous:{title:"HAProxy Data Plane",permalink:"/notes/devops/web/haproxy/dataplane"},next:{title:"HAProxy Proxy Protocol",permalink:"/notes/devops/web/haproxy/proxy-protocol"}},a={},h=[{value:"Memory Usage",id:"memory-usage",level:2},{value:"perf debug",id:"perf-debug",level:2},{value:"req_ssl_sni vs ssl_fc_sni",id:"req_ssl_sni-vs-ssl_fc_sni",level:2},{value:"TLS handshake, Client hello \u540e\u65e0\u54cd\u5e94",id:"tls-handshake-client-hello-\u540e\u65e0\u54cd\u5e94",level:2},{value:"HAProxy exit code 143",id:"haproxy-exit-code-143",level:2},{value:"cannot parse Content-Length: too long int",id:"cannot-parse-content-length-too-long-int",level:2},{value:"Cannot raise FD limit to 20637, limit is 4096.",id:"cannot-raise-fd-limit-to-20637-limit-is-4096",level:2},{value:"ERR_HTTP2_SERVER_REFUSED_STREAM",id:"err_http2_server_refused_stream",level:2},{value:"h3",id:"h3",level:2},{value:"Whitelist",id:"whitelist",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"haproxy-faq",children:"HAProxy FAQ"}),"\n",(0,r.jsx)(n.h2,{id:"memory-usage",children:"Memory Usage"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["e.g.\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"16 kB buffers"}),"\n",(0,r.jsx)(n.li,{children:"34 kB/session"}),"\n",(0,r.jsx)(n.li,{children:"30000 sessions/GB"}),"\n",(0,r.jsx)(n.li,{children:"20000 sessions/GB - \u8003\u8651\u7cfb\u7edf\u4e5f\u4f1a\u9700\u8981\u5185\u5b58"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://sysadminxpert.com/what-is-haproxy-and-important-performance-factors/",children:"https://sysadminxpert.com/what-is-haproxy-and-important-performance-factors/"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"perf-debug",children:"perf debug"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sysctl net.ipv4.ip_local_port_range\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"net.core.wmem_max\nnet.core.rmem_max\nnet.ipv4.tcp_rmem\nnet.ipv4.tcp_wmem\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"nbproc $(nproc)"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"req_ssl_sni-vs-ssl_fc_sni",children:"req_ssl_sni vs ssl_fc_sni"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["req_ssl_sni\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7528\u4e8e ssl paththrough \u65f6"}),"\n",(0,r.jsxs)(n.li,{children:["\u4f1a\u6bd4 hdr(host) \u5feb\u4e00\u70b9\u70b9\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"http://marc.info/?l=haproxy&m=144490809910124&w=2",children:"http://marc.info/?l=haproxy&m=144490809910124&w=2"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["ssl_fc_sni\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7528\u4e8e ssl offload \u65f6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-haproxy",children:"use_backend s1 if { ssl_fc_sni my.domain.org }\nuse_backend s2 if { hdr(host) -i my2.domain.org }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"tls-handshake-client-hello-\u540e\u65e0\u54cd\u5e94",children:"TLS handshake, Client hello \u540e\u65e0\u54cd\u5e94"}),"\n",(0,r.jsx)(n.p,{children:"\u5728 AlpineLinux 3.14 \u4e0a\uff0cHost \u5185\u8fd0\u884c HAProxy\uff0c\u4f7f\u7528 SNI Passthrough \u51fa\u73b0\u8be5\u95ee\u9898\uff0c\u4fee\u6539\u4e3a\u5728\u5bb9\u5668\u5185\u8fd0\u884c\u540e\u95ee\u9898\u89e3\u51b3\u3002\n\u5728\u5bb9\u5668\u5185\u4f7f\u7528\u5b8c\u5168\u76f8\u540c\u7684 HAProxy \u7248\u672c\u4e5f\u6ca1\u6709\u95ee\u9898\uff0c\u4e00\u6b21\u65ad\u5b9a\u662f Host \u73af\u5883\u7684\u95ee\u9898\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u53ef\u80fd\u7684\u539f\u56e0"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7cfb\u7edf\u4f9d\u8d56\u5347\u7ea7\u540e\u672a\u91cd\u542f"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"haproxy-exit-code-143",children:"HAProxy exit code 143"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"SIGTERM"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"cannot-parse-content-length-too-long-int",children:"cannot parse Content-Length: too long int"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"H2, ssl-passthrough \u65f6\u4f1a\u6709\u95ee\u9898"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/haproxy/haproxy/issues/1561",children:"#1561"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"cannot-raise-fd-limit-to-20637-limit-is-4096",children:"Cannot raise FD limit to 20637, limit is 4096."}),"\n",(0,r.jsx)(n.h2,{id:"err_http2_server_refused_stream",children:"ERR_HTTP2_SERVER_REFUSED_STREAM"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://confluence.atlassian.com/jirakb/some-jira-pages-fail-to-render-or-some-actions-fail-to-complete-with-the-error-err_http2_server_refused_stream-1085441145.html",children:"https://confluence.atlassian.com/jirakb/some-jira-pages-fail-to-render-or-some-actions-fail-to-complete-with-the-error-err_http2_server_refused_stream-1085441145.html"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/opnsense/plugins/issues/2013",children:"https://github.com/opnsense/plugins/issues/2013"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"libressl"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"h3",children:"h3"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/haproxytech/kubernetes-ingress/issues/546",children:"https://github.com/haproxytech/kubernetes-ingress/issues/546"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"whitelist",children:"Whitelist"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"acl white_list src 192.168.1.0/24 192.168.10.0/24\ntcp-request content accept if white_list\ntcp-request content reject\n"})})]})}function d(e={}){const{wrapper:n}={...(0,t.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},38088:(e,n,s)=>{var r=s(96651),t=Symbol.for("react.element"),i=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,o=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function h(e,n,s){var r,i={},h=null,c=null;for(r in void 0!==s&&(h=""+s),void 0!==n.key&&(h=""+n.key),void 0!==n.ref&&(c=n.ref),n)l.call(n,r)&&!a.hasOwnProperty(r)&&(i[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===i[r]&&(i[r]=n[r]);return{$$typeof:t,type:e,key:h,ref:c,props:i,_owner:o.current}}n.Fragment=i,n.jsx=h,n.jsxs=h},2488:(e,n,s)=>{e.exports=s(38088)},62780:(e,n,s)=>{s.d(n,{I:()=>o,M:()=>l});var r=s(96651);const t={},i=r.createContext(t);function l(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);