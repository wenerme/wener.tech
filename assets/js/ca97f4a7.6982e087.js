/*! For license information please see ca97f4a7.6982e087.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[54616],{6484:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>a,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var l=i(2488),s=i(62780);const r={title:"CGO"},t="CGO",o={id:"languages/go/go-cgo",title:"CGO",description:"Note",source:"@site/../notes/languages/go/go-cgo.md",sourceDirName:"languages/go",slug:"/languages/go/cgo",permalink:"/notes/languages/go/cgo",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/languages/go/go-cgo.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1682315301,formattedLastUpdatedAt:"Apr 24, 2023",frontMatter:{title:"CGO"},sidebar:"docs",previous:{title:"Go Build",permalink:"/notes/languages/go/build"},next:{title:"Concurrent",permalink:"/notes/languages/go/concurrent"}},c={},d=[{value:"\u7c7b\u578b\u8f6c\u6362",id:"\u7c7b\u578b\u8f6c\u6362",level:2},{value:"dlopen",id:"dlopen",level:2},{value:"sqlite",id:"sqlite",level:2},{value:"\u67e5\u627e\u7528\u5230\u4e86 cgo \u7684\u6a21\u5757",id:"\u67e5\u627e\u7528\u5230\u4e86-cgo-\u7684\u6a21\u5757",level:2},{value:"zig cgo cross compile",id:"zig-cgo-cross-compile",level:2}];function h(n){const e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.M)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h1,{id:"cgo",children:"CGO"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"Note"}),"\nCGO is not GO"]}),"\n"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/ebitengine/purego",children:"ebitengine/purego"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e0d\u9700\u8981 go \u8c03\u7528 lib"}),"\n",(0,l.jsx)(e.li,{children:"\u901a\u8fc7 asm \u8c03\u7528"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u907f\u514d CGO\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/hashicorp/go-plugin",children:"hashicorp/go-plugin"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/notti/nocgo",children:"notti/nocgo"})," - dlopen without cgo\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"dlopen, dlclose, dlerror, dlsym"}),"\n",(0,l.jsx)(e.li,{children:"ffi \u6c47\u7f16, \u652f\u6301 386 \u548c amd64"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/rainycape/dl",children:"rainycape/dl"})," - dlopen / dlsym"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://jonwillia.ms/2022/03/09/isolating-problematic-cgo-code",children:"Isolating problematic Cgo code"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u53c2\u8003\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/golang/go/issues/18296",children:"golang/go#18296"})," - runtime: dlopen/dlsym without CGo"]}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://gist.github.com/zchee/b9c99695463d8902cd33",children:"\u7c7b\u578b\u8f6c\u6362"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["C -> CGO\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/ccgo/v3",children:"modernc.org/ccgo/v3"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/libc",children:"modernc.org/libc"})}),"\n",(0,l.jsxs)(e.li,{children:["\u6848\u4f8b\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://pkg.go.dev/modernc.org/sqlite",children:"modernc.org/sqlite"})}),"\n",(0,l.jsxs)(e.li,{children:["PCRE2 ",(0,l.jsx)(e.a,{href:"https://pkg.go.dev/go.arsenm.dev/pcre",children:"go.arsenm.dev/pcre"})]}),"\n",(0,l.jsxs)(e.li,{children:["uber/h3 ",(0,l.jsx)(e.a,{href:"https://github.com/akhenakh/goh3",children:"akhenakh/goh3"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.admonition,{type:"caution",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u907f\u514d Go \u7684\u540d\u5b57\u548c C \u91cc\u7684\u540d\u5b57\u51b2\u7a81\uff0c\u5426\u5219\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528 ",(0,l.jsx)(e.code,{children:"C.<name>"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f8b\u5982 \u5982\u679c Go \u91cc\u6709 MyStruct\uff0c\u5219\u65e0\u6cd5\u4f7f\u7528 C.MyStruct"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,l.jsx)(e.admonition,{title:"\u907f\u514d\u4f7f\u7528 CGO",type:"tip",children:(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"CGO_ENABLED=0 \u7981\u7528 CGO"}),"\n",(0,l.jsx)(e.li,{children:"CGO \u4f9d\u8d56\u7cfb\u7edf"}),"\n",(0,l.jsx)(e.li,{children:"\u8de8\u5e73\u53f0\u7f16\u8bd1\u590d\u6742"}),"\n",(0,l.jsx)(e.li,{children:"\u65e0 CGO \u65b9\u4fbf\u6784\u5efa -static binary"}),"\n",(0,l.jsxs)(e.li,{children:["\u65b9\u6848\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u627e\u66ff\u4ee3\u5e93"}),"\n",(0,l.jsx)(e.li,{children:"\u7528\u5230 cgo \u7684\u4f5c\u4e3a\u5916\u90e8\u8fdb\u7a0b\u901a\u8fc7 io \u4ea4\u4e92 - \u51cf\u5c11 cgo \u8303\u56f4"}),"\n",(0,l.jsx)(e.li,{children:"dlopen"}),"\n",(0,l.jsx)(e.li,{children:"exec"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5e38\u7528\u7684 CGO \u4f9d\u8d56\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"sqlite"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,l.jsx)(e.h2,{id:"\u7c7b\u578b\u8f6c\u6362",children:"\u7c7b\u578b\u8f6c\u6362"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://pkg.go.dev/cmd/cgo",children:"https://pkg.go.dev/cmd/cgo"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"Go"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:"type InteropFunctions interface {\n\t// CString malloc - \u8c03\u7528\u8005 C.free\n\tCString(s string) *C.char\n\t// CBytes malloc - \u8c03\u7528\u8005 C.free\n\tCBytes([]byte) unsafe.Pointer\n\tGoString(*C.char) string\n\tGoStringN(*C.char, C.int) string\n\tGoBytes(unsafe.Pointer, C.int) []byte\n}\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"C.malloc \u4e0d\u56de\u76f4\u63a5\u8c03\u7528 C \u7684 malloc"}),"\n",(0,l.jsx)(e.li,{children:"C.malloc \u786e\u4fdd\u4e0d\u4f1a\u8fd4\u56de NULL - \u5982\u679c\u7533\u8bf7\u5931\u8d25\u5219\u76f4\u63a5 crash"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:"func GetString(in *C.char, l C.int) *C.char {\n\tinput := C.GoBytes(unsafe.Pointer(in), C.int(l))\n  // \u4f7f\u7528\u8005\u9700\u8981 free \u8fd4\u56de\u7684\u6307\u9488\n\treturn C.CString(string(input))\n}\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// #include <stdio.h>\n// #include <errno.h>\n// #cgo CFLAGS: -DPNG_DEBUG=1\n// #cgo amd64 386 CFLAGS: -DX86=1\n// #cgo LDFLAGS: -lpng\n// #include <png.h>\n// #cgo pkg-config: png cairo\n// #cgo LDFLAGS: -L${SRCDIR}/libs -lfoo\nimport "C"\n'})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-c",metastring:'title="C \u6ce8\u91ca\u4e2d\u53ef\u7528\u7684\u7279\u6b8a\u51fd\u6570"',children:"size_t _GoStringLen(_GoString_ s);\nconst char *_GoStringPtr(_GoString_ s);\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"SRCDIR -> x.go \u7684\u4f4d\u7f6e"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"C"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-c",children:"typedef void *GoMap;\ntypedef void *GoChan;\ntypedef struct { void *t; void *v; } GoInterface;\ntypedef struct { void *data; GoInt len; GoInt cap; } GoSlice;\n\ntypedef struct { const char *p; ptrdiff_t n; } _GoString_;\ntypedef _GoString_ GoString;\n"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["GODEBUG=cgocheck=1\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"0 - \u4e0d\u68c0\u67e5"}),"\n",(0,l.jsx)(e.li,{children:"2 - \u66f4\u4e25\u683c\u7684\u68c0\u67e5"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://pkg.go.dev/runtime/cgo",children:"runtime/cgo"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5b89\u5168\u4f20\u9012 Go \u5185\u6570\u636e"}),"\n",(0,l.jsx)(e.li,{children:"interface{} -> cgo.Handle - uintptr - C.uintptr_t"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"go tool cgo\n"})}),"\n",(0,l.jsx)(e.h2,{id:"dlopen",children:"dlopen"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b so symbol\n# \u6ca1\u6709\u5730\u5740\u7684 symbol \u662f\u52a8\u6001\u7684\nnm -gDC /usr/lib/libsqlite3.so\nobjdump -TC libz.so\nreadelf -Ws libz.so\n# \u53ea\u770b symbol\nreadelf -Ws /usr/lib/libsqlite3.so | awk '{print $8}'\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:'// +build !cgo\n\npackage dlopen\n\n// we have to use the 3 argument format here :( - 2 argument format is only allowed from inside cgo\n\n//go:cgo_import_dynamic libc_dlopen_x dlopen "libdl.so.2"\n//go:cgo_import_dynamic libc_dlclose_x dlclose "libdl.so.2"\n//go:cgo_import_dynamic libc_dlsym_x dlsym "libdl.so.2"\n//go:cgo_import_dynamic libc_dlerror_x dlerror "libdl.so.2"\n\n// on amd64 we don\'t need the following line - on 386 we do...\n// anyway - with those lines the output is better (but doesn\'t matter) - without it on amd64 we get multiple DT_NEEDED with "libc.so.6" etc\n\n//go:cgo_import_dynamic _ _ "libdl.so.2"\n'})}),"\n",(0,l.jsx)(e.h2,{id:"sqlite",children:"sqlite"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://gitlab.com/cznic/sqlite",children:"cznic/sqlite"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"CGo-free port of SQLite/SQLite3 v3.37.0"}),"\n",(0,l.jsx)(e.li,{children:"C to Go"}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/glebarez/go-sqlite",children:"glebarez/go-sqlite"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"driver"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/mattn/go-sqlite3",children:"mattn/go-sqlite3"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"-tags libsqlite3"})," \u53ef link libsqlite3.so"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["No CGO\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/iamacarpet/go-sqlite3-win64",children:"iamacarpet/go-sqlite3-win64"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"sqlite3.dll wrapper"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/cvilsmeier/sqinn-go",children:"cvilsmeier/sqinn-go"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u57fa\u4e8e sqlite \u547d\u4ee4\u884c\u8fdb\u884c IO \u64cd\u4f5c"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/zombiezen/go-sqlite",children:"zombiezen/go-sqlite"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ef\u6267\u884c SQL"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u63d0\u4f9b database/sql driver"}),"\n",(0,l.jsx)(e.li,{children:"fork crawshaw/sqlite"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/crawshaw/sqlite",children:"crawshaw/sqlite"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"low-level Go interface to SQLite 3"}),"\n",(0,l.jsxs)(e.li,{children:["[Go and SQLite: when database/sql chafes](",(0,l.jsx)(e.a,{href:"https://crawshaw.io/blog/go-and-sqlite",children:"https://crawshaw.io/blog/go-and-sqlite"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://github.com/alicebob/sqlittle",children:"alicebob/sqlittle"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u76f4\u63a5\u8bfb\u53d6\u6587\u4ef6 - \u4e0d\u652f\u6301 SQL"}),"\n",(0,l.jsx)(e.li,{children:"\u53ea\u8bfb"}),"\n",(0,l.jsxs)(e.li,{children:["incompatible database version\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u8981\u6c42 journal mode"}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u652f\u6301 WAL"}),"\n",(0,l.jsx)(e.li,{children:"schema format > 1"}),"\n",(0,l.jsx)(e.li,{children:"UTF8 encoding"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(e.h2,{id:"\u67e5\u627e\u7528\u5230\u4e86-cgo-\u7684\u6a21\u5757",children:"\u67e5\u627e\u7528\u5230\u4e86 cgo \u7684\u6a21\u5757"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'go list -f "{{if .CgoFiles}}{{.ImportPath}}{{end}}" $(go list -f "{{.ImportPath}}{{range .Deps}} {{.}}{{end}}" ./...)\n'})}),"\n",(0,l.jsx)(e.h2,{id:"zig-cgo-cross-compile",children:"zig cgo cross compile"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# Go 1.18+\nCGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC="zig cc -target x86_64-linux" CXX="zig c++ -target x86_64-linux" go build --tags extended\n'})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"amd64 -> x86_64"}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://dev.to/kristoff/zig-makes-go-cross-compilation-just-work-29ho",children:"Zig Makes Go Cross Compilation Just Work"})}),"\n"]})]})}function a(n={}){const{wrapper:e}={...(0,s.M)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(h,{...n})}):h(n)}},38088:(n,e,i)=>{var l=i(96651),s=Symbol.for("react.element"),r=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,o=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function d(n,e,i){var l,r={},d=null,h=null;for(l in void 0!==i&&(d=""+i),void 0!==e.key&&(d=""+e.key),void 0!==e.ref&&(h=e.ref),e)t.call(e,l)&&!c.hasOwnProperty(l)&&(r[l]=e[l]);if(n&&n.defaultProps)for(l in e=n.defaultProps)void 0===r[l]&&(r[l]=e[l]);return{$$typeof:s,type:n,key:d,ref:h,props:r,_owner:o.current}}e.Fragment=r,e.jsx=d,e.jsxs=d},2488:(n,e,i)=>{n.exports=i(38088)},62780:(n,e,i)=>{i.d(e,{I:()=>o,M:()=>t});var l=i(96651);const s={},r=l.createContext(s);function t(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:t(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);