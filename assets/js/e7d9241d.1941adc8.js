"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[37893],{49613:function(e,r,t){t.d(r,{Zo:function(){return u},kt:function(){return k}});var n=t(59496);function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function l(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function a(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?l(Object(t),!0).forEach((function(r){o(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function i(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},l=Object.keys(e);for(n=0;n<l.length;n++)t=l[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)t=l[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=n.createContext({}),d=function(e){var r=n.useContext(c),t=r;return e&&(t="function"==typeof e?e(r):a(a({},r),e)),t},u=function(e){var r=d(e.components);return n.createElement(c.Provider,{value:r},e.children)},p={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},s=n.forwardRef((function(e,r){var t=e.components,o=e.mdxType,l=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),s=d(t),k=o,m=s["".concat(c,".").concat(k)]||s[k]||p[k]||l;return t?n.createElement(m,a(a({ref:r},u),{},{components:t})):n.createElement(m,a({ref:r},u))}));function k(e,r){var t=arguments,o=r&&r.mdxType;if("string"==typeof e||o){var l=t.length,a=new Array(l);a[0]=s;var i={};for(var c in r)hasOwnProperty.call(r,c)&&(i[c]=r[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,a[1]=i;for(var d=2;d<l;d++)a[d]=t[d];return n.createElement.apply(null,a)}return n.createElement.apply(null,t)}s.displayName="MDXCreateElement"},21556:function(e,r,t){t.r(r),t.d(r,{assets:function(){return f},contentTitle:function(){return k},default:function(){return v},frontMatter:function(){return s},metadata:function(){return m},toc:function(){return b}});var n=t(49613),o=Object.defineProperty,l=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,u=(e,r,t)=>r in e?o(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,p=(e,r)=>{for(var t in r||(r={}))c.call(r,t)&&u(e,t,r[t]);if(i)for(var t of i(r))d.call(r,t)&&u(e,t,r[t]);return e};const s={title:"DID"},k="Docker In Docker",m={unversionedId:"devops/docker/docker-dind",id:"devops/docker/docker-dind",title:"DID",description:"- 2376 - tls",source:"@site/../notes/devops/docker/docker-dind.md",sourceDirName:"devops/docker",slug:"/devops/docker/dind",permalink:"/notes/devops/docker/dind",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/docker/docker-dind.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1682624699,formattedLastUpdatedAt:"Apr 27, 2023",frontMatter:{title:"DID"},sidebar:"docs",previous:{title:"credential helpers",permalink:"/notes/devops/docker/credential-helpers"},next:{title:"Docker FAQ",permalink:"/notes/devops/docker/faq"}},f={},b=[{value:"rootless",id:"rootless",level:2},{value:"buildx",id:"buildx",level:2},{value:"\u5b58\u5728 mtu \u95ee\u9898",id:"\u5b58\u5728-mtu-\u95ee\u9898",level:2},{value:"invalid TLS configuration: Could not load X509 key pair (cert: &quot;&quot;, key: &quot;&quot;): open : no such file or directory",id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory",level:2},{value:"could not change group /var/run/docker.sock to docker: group docker not found",id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found",level:2}],y={toc:b};function v(e){var r,t=e,{components:o}=t,u=((e,r)=>{var t={};for(var n in e)c.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&i)for(var n of i(e))r.indexOf(n)<0&&d.call(e,n)&&(t[n]=e[n]);return t})(t,["components"]);return(0,n.kt)("wrapper",(r=p(p({},y),u),l(r,a({components:o,mdxType:"MDXLayout"}))),(0,n.kt)("h1",p({},{id:"docker-in-docker"}),"Docker In Docker"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"2376 - tls"),(0,n.kt)("li",{parentName:"ul"},"2375"),(0,n.kt)("li",{parentName:"ul"},"cert 825d"),(0,n.kt)("li",{parentName:"ul"},"\u624b\u52a8\u5173\u95ed tls --tls=fals --tlsverify=false")),(0,n.kt)("admonition",p({},{type:"caution"}),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},"\u6620\u5c04 sock \u5728\u91cd\u542f\u540e\u4f1a\u5931\u6548"),(0,n.kt)("li",{parentName:"ul"},"mtu \u6700\u597d\u8bbe\u7f6e <= 1450 - ",(0,n.kt)("inlineCode",{parentName:"li"},"--mtu")),(0,n.kt)("li",{parentName:"ul"},"dind network create \u4e0d\u4f1a\u7ee7\u627f ",(0,n.kt)("inlineCode",{parentName:"li"},"--mtu")," \u53c2\u6570"))),(0,n.kt)("pre",null,(0,n.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"# -e DOCKER_TLS_CERTDIR=/certs\n# /certs/ca\n# /certs/client - \u53ef\u6302\u8f7d\u7ed9\u5ba2\u6237\u7aef\n# \u4e5f\u53ef\u901a\u8fc7 sock \u6302\u8f7d\u7ed9\u5ba2\u6237\u7aef /var/run/docker.sock\n# \u8bbe\u7f6e DOCKER_TLS_CERTDIR \u4e3a\u7a7a\u5219\u7981\u7528 tls\uff0c\u7aef\u53e3\u4e3a 2375\ndocker run --rm -it \\\n  --privileged \\\n  -e DOCKER_TLS_CERTDIR='' \\\n  -v $PWD/data:/var/lib/docker \\\n  --name dind docker:dind --storage-driver overlay2\n\n# \u901a\u8fc7 HOST \u8c03\u7528\nexport DOCKER_HOST=tcp://dind:2375/\nexport DOCKER_DRIVER=overlay2\n# https://github.com/docker-library/docker/pull/166\nexport DOCKER_TLS_CERTDIR=''\n\ncurl --unix-socket /var/run/docker.sock http://localhost/images/json | jq\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",p({parentName:"li"},{href:"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh"}),"https://github.com/docker-library/docker/blob/master/23.0/dind/dockerd-entrypoint.sh"))),(0,n.kt)("h2",p({},{id:"rootless"}),"rootless"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"\u8bd5\u9a8c\u6027\u7684 rootless",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",p({parentName:"li"},{href:"https://github.com/docker-library/docker/pull/174"}),"docker-library/docker#174")),(0,n.kt)("li",{parentName:"ul"},"\u8fd8\u662f\u9700\u8981 ",(0,n.kt)("inlineCode",{parentName:"li"},"--privileged"))))),(0,n.kt)("pre",null,(0,n.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"docker run -d --name docker --privileged docker:dind-rootless\n")),(0,n.kt)("h2",p({},{id:"buildx"}),"buildx"),(0,n.kt)("pre",null,(0,n.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"BUILDX_VERSION=v0.10.4\n\nmkdir -p ~/.docker/cli-plugins\ncurl -sSLo ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/$BUILDX_VERSION/buildx-$BUILDX_VERSION.linux-amd64\nchmod +x ~/.docker/cli-plugins/docker-buildx\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\ndocker info\n")),(0,n.kt)("h2",p({},{id:"\u5b58\u5728-mtu-\u95ee\u9898"}),"\u5b58\u5728 mtu \u95ee\u9898"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"curl https \u7684\u65f6\u5019 hang"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"--mtu=1400"))),(0,n.kt)("h2",p({},{id:"invalid-tls-configuration-could-not-load-x509-key-pair-cert--key--open--no-such-file-or-directory"}),'invalid TLS configuration: Could not load X509 key pair (cert: "", key: ""): open : no such file or directory'),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"\u4e0d\u8981\u914d\u7f6e ",(0,n.kt)("inlineCode",{parentName:"li"},"--tls=false --tlsverify=false"),",\u53ef\u4ee5\u914d\u7f6e  ",(0,n.kt)("inlineCode",{parentName:"li"},"--tls=false")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",p({parentName:"li"},{href:"https://github.com/moby/moby/issues/27105"}),"https://github.com/moby/moby/issues/27105"))),(0,n.kt)("h2",p({},{id:"could-not-change-group-varrundockersock-to-docker-group-docker-not-found"}),"could not change group /var/run/docker.sock to docker: group docker not found"),(0,n.kt)("p",null,"\u6dfb\u52a0\u542f\u52a8\u53c2\u6570 ",(0,n.kt)("inlineCode",{parentName:"p"},"--group=1000")," \u6216"),(0,n.kt)("pre",null,(0,n.kt)("code",p({parentName:"pre"},{className:"language-dockerfile"}),"FROM docker:dind\nRUN addgroup -g 2999 docker\n")))}v.isMDXComponent=!0}}]);