"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[30861],{49613:function(e,t,n){n.d(t,{Zo:function(){return o},kt:function(){return N}});var a=n(59496);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),k=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},o=function(e){var t=k(e.components);return a.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,o=s(e,["components","mdxType","originalType","parentName"]),m=k(n),c=r,N=m["".concat(p,".").concat(c)]||m[c]||u[c]||l;return n?a.createElement(N,i(i({ref:t},o),{},{components:n})):a.createElement(N,i({ref:t},o))}));function N(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=c;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var k=2;k<l;k++)i[k]=n[k];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},26124:function(e,t,n){n.r(t),n.d(t,{assets:function(){return g},contentTitle:function(){return d},default:function(){return _},frontMatter:function(){return N},metadata:function(){return h},toc:function(){return f}});var a=n(49613),r=Object.defineProperty,l=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,o=(e,t,n)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))p.call(t,n)&&o(e,n,t[n]);if(s)for(var n of s(t))k.call(t,n)&&o(e,n,t[n]);return e},u=(e,t)=>l(e,i(t)),c=(e,t)=>{var n={};for(var a in e)p.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&s)for(var a of s(e))t.indexOf(a)<0&&k.call(e,a)&&(n[a]=e[a]);return n};const N={title:"K3S"},d="K3S",h={unversionedId:"devops/kubernetes/distro/k3s/README",id:"devops/kubernetes/distro/k3s/README",title:"K3S",description:"- \u8282\u70b9\u7684\u540d\u5b57\u9700\u8981\u552f\u4e00",source:"@site/../notes/devops/kubernetes/distro/k3s/README.md",sourceDirName:"devops/kubernetes/distro/k3s",slug:"/devops/kubernetes/distro/k3s/",permalink:"/notes/devops/kubernetes/distro/k3s/",draft:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/distro/k3s/README.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1675953425,formattedLastUpdatedAt:"Feb 9, 2023",frontMatter:{title:"K3S"},sidebar:"docs",previous:{title:"k0sctl",permalink:"/notes/devops/kubernetes/distro/k0s/k0sctl"},next:{title:"K3S in Docker",permalink:"/notes/devops/kubernetes/distro/k3s/k3d"}},g={},f=[{value:"k3s server",id:"k3s-server",level:2},{value:"get.k3s.io",id:"getk3sio",level:3},{value:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5",id:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5",level:2},{value:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8",id:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8",level:2},{value:"containerd",id:"containerd",level:2},{value:"registries",id:"registries",level:2},{value:"\u7b14\u8bb0",id:"\u7b14\u8bb0",level:2},{value:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91",id:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91",level:3},{value:"\u5feb\u901f\u542f\u52a8",id:"\u5feb\u901f\u542f\u52a8",level:2}],b={toc:f},v="wrapper";function _(e){var t=e,{components:n}=t,r=c(t,["components"]);return(0,a.kt)(v,u(m(m({},b),r),{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",m({},{id:"k3s"}),"K3S"),(0,a.kt)("admonition",m({},{type:"tip"}),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"\u8282\u70b9\u7684\u540d\u5b57\u9700\u8981\u552f\u4e00",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f7f\u7528 hostname"),(0,a.kt)("li",{parentName:"ul"},"\u53ef\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"K3S_NODE_NAME")," \u6216 ",(0,a.kt)("inlineCode",{parentName:"li"},"--node-name")," \u4fee\u6539"))),(0,a.kt)("li",{parentName:"ul"},"k3s \u4f1a\u8bfb\u53d6 ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/machine-id")," \u6216 ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/dbus/machine-id")," \u4f5c\u4e3a\u8282\u70b9 UUID"),(0,a.kt)("li",{parentName:"ul"},"kubconfig \u6587\u4ef6 ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/k3s.yaml")),(0,a.kt)("li",{parentName:"ul"},"\u90e8\u7f72 traefik \u4f5c\u4e3a ingress"))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/k3s-io/k3s"}),"k3s-io/k3s")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/installation/installation-requirements/"}),"\u73af\u5883\u8981\u6c42"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Linux 3.10+"),(0,a.kt)("li",{parentName:"ul"},"Server \u5185\u5b58 512 MB+"),(0,a.kt)("li",{parentName:"ul"},"Agent \u5185\u5b58 75 MB"),(0,a.kt)("li",{parentName:"ul"},"\u78c1\u76d8 200 MB"),(0,a.kt)("li",{parentName:"ul"},"\u67b6\u6784 x86_64, ARMv7, ARM64"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup"}),"AlpineLinux \u989d\u5916\u914d\u7f6e")),(0,a.kt)("li",{parentName:"ul"},"Production",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Small <= 10 \u8282\u70b9 - Server 2C4G - Database 1C2G"),(0,a.kt)("li",{parentName:"ul"},"Medium <= 100 \u8282\u70b9 - Server 4C8G - Database 2C8G"))))),(0,a.kt)("li",{parentName:"ul"},"\u7aef\u53e3",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"6443 - server - \u8282\u70b9\u901a\u4fe1 - Kubernetes API"),(0,a.kt)("li",{parentName:"ul"},"6444"),(0,a.kt)("li",{parentName:"ul"},"8472/udp - server/agent - Flannel VXLAN"),(0,a.kt)("li",{parentName:"ul"},"10250 - server/agent - kubelet"),(0,a.kt)("li",{parentName:"ul"},"10251"),(0,a.kt)("li",{parentName:"ul"},"10010 - containerd"),(0,a.kt)("li",{parentName:"ul"},"10248 - 10252"),(0,a.kt)("li",{parentName:"ul"},"10249 - kube-prpxy"),(0,a.kt)("li",{parentName:"ul"},"30518"),(0,a.kt)("li",{parentName:"ul"},"30643"),(0,a.kt)("li",{parentName:"ul"},"46517"))),(0,a.kt)("li",{parentName:"ul"},"K3S \u7ec4\u4ef6 - \u5b89\u88c5\u65f6\u53ef\u7981\u7528\u5185\u7f6e\u7ec4\u4ef6 ",(0,a.kt)("inlineCode",{parentName:"li"},"--disable"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"containerd - \u53ef\u9009\u7528 docker"),(0,a.kt)("li",{parentName:"ul"},"Flannel"),(0,a.kt)("li",{parentName:"ul"},"coredns - CoreDNS",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u955c\u50cf ",(0,a.kt)("inlineCode",{parentName:"li"},"rancher/coredns-coredns")))),(0,a.kt)("li",{parentName:"ul"},"CNI"),(0,a.kt)("li",{parentName:"ul"},"traefik - Ingress \u63a7\u5236\u5668",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u955c\u50cf ",(0,a.kt)("inlineCode",{parentName:"li"},"rancher/library-traefik")),(0,a.kt)("li",{parentName:"ul"},"Traefik 2.0 integration - ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/issues/1141"}),"#1141"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"http 80"),(0,a.kt)("li",{parentName:"ul"},"https 443"),(0,a.kt)("li",{parentName:"ul"},"dash 8080"),(0,a.kt)("li",{parentName:"ul"},"metric 9100"),(0,a.kt)("li",{parentName:"ul"},"httpn 8880"))))),(0,a.kt)("li",{parentName:"ul"},"servicelb - \u5185\u5d4c\u8d1f\u8f7d\u5747\u8861",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/klipper-lb"}),"rancher/klipper-lb"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/klipper-lb/blob/master/entry"}),"https://github.com/rancher/klipper-lb/blob/master/entry")),(0,a.kt)("li",{parentName:"ul"},"This works by using a host port for each service load balancer and setting up iptables to forward the request to the cluster IP. The regular k8s scheduler will find a free host port. If there are no free host ports, the service load balancer will stay in pending."))))),(0,a.kt)("li",{parentName:"ul"},"\u5185\u5d4c\u7f51\u7edc\u7b56\u7565\u63a7\u5236\u5668"),(0,a.kt)("li",{parentName:"ul"},"local-storage"),(0,a.kt)("li",{parentName:"ul"},"metrics-server",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u955c\u50cf ",(0,a.kt)("a",m({parentName:"li"},{href:"https://hub.docker.com/r/rancher/metrics-server"}),"rancher/metrics-server")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/kubernetes-sigs/metrics-server"}),"kubernetes-sigs/metrics-server")))))),(0,a.kt)("li",{parentName:"ul"},"\u53c2\u8003",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://medium.com/better-programming/b0b035c291a9"}),"Using a k3s Kubernetes Cluster for Your GitLab Project")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/architecture"}),"\u67b6\u6784")))),(0,a.kt)("li",{parentName:"ul"},"\u95ee\u9898",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u4f7f\u7528 Nginx \u66ff\u4ee3 Traefik - ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/pull/1466/files"}),"#1466"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u5df2\u7ecf\u88ab\u56de\u9000"))),(0,a.kt)("li",{parentName:"ul"},"K3S \u6709 ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/issues/684#issuecomment-517032871"}),"server-ca \u548c client-ca"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 CSR \u662f\u4f7f\u7528 servert-ca\uff0c\u5bfc\u81f4\u521b\u5efa\u7684\u8bc1\u4e66\u65e0\u6cd5\u4f7f\u7528",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"issuer \u662f k3s-server-ca"))),(0,a.kt)("li",{parentName:"ul"},"\u9700\u8981\u4ece\u670d\u52a1\u5668\u53d6 client-ca \u521b\u5efa\u8bc1\u4e66"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/pull/1768"}),"#1768")," - \u9ed8\u8ba4\u4f7f\u7528 ClientCA \u800c\u4e0d\u662f ServerCA"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/issues/684#issuecomment-517501120"}),"\u81ea\u884c\u521b\u5efa\u811a\u672c")))),(0,a.kt)("li",{parentName:"ul"},"\u76ee\u524d(1.18) admin \u9ed8\u8ba4\u662f\u5bc6\u7801 - ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/issues/1616"}),"#1616")," - \u9ed8\u8ba4\u4f7f\u7528\u8bc1\u4e66"))),(0,a.kt)("li",{parentName:"ul"},"/etc/rancher/node/password"),(0,a.kt)("li",{parentName:"ul"},"/var/lib/rancher/k3s/server/cred/node-passwd",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"kubectl -n kube-system delete secrets <agent-node-name>.node-password.k3s"))))),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'apk add util-linux\n[ -f /etc/machine-id ] || ( uuidgen | sudo tee -a /etc/machine-id )\n\napk add wireguard-virt wireguard-tools\n\n# INSTALL_K3S_EXEC \u9ed8\u8ba4\u4e3a agent\n# flannel wireguard - https://github.com/coreos/flannel/blob/master/dist/extension-wireguard\nK3S_NODE_NAME=k3s-server INSTALL_K3S_EXEC="server --flannel-backend=wireguard" INSTALL_K3S_SKIP_START=true INSTALL_K3S_BIN_DIR=/opt/k3s/bin curl -sfL https://get.k3s.io | sh -\n\nk3s server --flannel-backend=wireguard\n\n# \u5982\u679c\u662f root \u5b89\u88c5 - \u4fee\u6539\u4e0b kubeconfig \u6743\u9650\nsudo chmod a+r /etc/rancher/k3s/k3s.yaml\n# k3s \u9ed8\u8ba4\u4f1a\u8bbf\u95ee\u8be5\u6587\u4ef6\n\n# \u5176\u4ed6\u8bbf\u95ee\nexport KUBECONFIG=/etc/rancher/k3s/k3s.yaml\n')),(0,a.kt)("h2",m({},{id:"k3s-server"}),"k3s server"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/"}),"k3s server \u914d\u7f6e")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/advanced/"}),"Advanced Options and Configuration")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--docker")," - \u4f7f\u7528 docker - \u9ed8\u8ba4 ",(0,a.kt)("a",m({parentName:"li"},{href:"https://containerd.io/"}),"containerd")),(0,a.kt)("li",{parentName:"ul"},"\u5728 ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s/server/manifests")," \u4e0b\u9762\u7684\u6587\u4ef6\u4f1a\u88ab\u81ea\u52a8\u90e8\u7f72 - kubectl apply",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5b89\u88c5\u5185\u5bb9 - ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/tree/master/manifests"}),"rancher/k3s/tree/master/manifests")))),(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"containerd"),", \u542f\u52a8 agent \u7684\u65f6\u5019\u6dfb\u52a0 ",(0,a.kt)("inlineCode",{parentName:"li"},"--docker")," \u53ef\u4f7f\u7528 docker"),(0,a.kt)("li",{parentName:"ul"},"\u9488\u5bf9 ",(0,a.kt)("inlineCode",{parentName:"li"},"containerd")," \u751f\u6210\u7684\u914d\u7f6e\u4f4d\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s/agent/etc/containerd/config.toml"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u5728\u76ee\u5f55\u4e0b\u521b\u5efa\u4e86 ",(0,a.kt)("inlineCode",{parentName:"li"},"config.toml.tmpl")," \u5219\u4f1a\u88ab\u4f7f\u7528"),(0,a.kt)("li",{parentName:"ul"},"\u6a21\u677f\u53ef\u8bbf\u95ee ",(0,a.kt)("inlineCode",{parentName:"li"},"config.Node")," \u5bf9\u8c61 ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L32"}),"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L32")))),(0,a.kt)("li",{parentName:"ul"},"AlpineLinux \u9700\u8981\u989d\u5916\u7684\u914d\u7f6e ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/update-extlinux.conf"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"default_kernel_opts \u6dfb\u52a0 ",(0,a.kt)("inlineCode",{parentName:"li"},"cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory")),(0,a.kt)("li",{parentName:"ul"},"\u7136\u540e ",(0,a.kt)("inlineCode",{parentName:"li"},"update-extlinux && reboot")))),(0,a.kt)("li",{parentName:"ul"},"\u975e root \u6570\u636e\u5b58\u653e\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"~/.rancher/k3s/data")),(0,a.kt)("li",{parentName:"ul"},"root \u6570\u636e\u5b58\u653e\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s/data")),(0,a.kt)("li",{parentName:"ul"},"\u96c6\u7fa4 cidr ",(0,a.kt)("inlineCode",{parentName:"li"},"10.42.0.0/16"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u8282\u70b9 IP"),(0,a.kt)("li",{parentName:"ul"},"cni0 - \u672c\u5730\u7f51\u53e3 - \u9644\u5e26 IP"),(0,a.kt)("li",{parentName:"ul"},"flannel1.1 - \u96c6\u7fa4\u901a\u4fe1"),(0,a.kt)("li",{parentName:"ul"},"\u4f1a\u5206\u914d\u7ed9\u6bcf\u4e2a Pod"),(0,a.kt)("li",{parentName:"ul"},"\u6bcf\u4e2a\u8282\u70b9\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"li"},"/24")," \u5730\u5740 - \u4e0d\u540c\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u8f6c\u53d1"))),(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1 cidr ",(0,a.kt)("inlineCode",{parentName:"li"},"10.43.0.0/16"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1 IP"),(0,a.kt)("li",{parentName:"ul"},"\u4e0d\u80fd ping"),(0,a.kt)("li",{parentName:"ul"},"\u865a\u62df\u5730\u5740\uff0c\u901a\u8fc7 iptables \u914d\u7f6e"))),(0,a.kt)("li",{parentName:"ul"},"\u96c6\u7fa4\u57df\u540d cluster.local"),(0,a.kt)("li",{parentName:"ul"},"coredns ",(0,a.kt)("inlineCode",{parentName:"li"},"10.43.0.10")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/networking/"}),"\u7f51\u7edc"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f7f\u7528 flannel \u4f5c\u4e3a CNI\uff0c\u4f7f\u7528 VXLAN \u540e\u7aef"),(0,a.kt)("li",{parentName:"ul"},"flannel ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/blob/fe7337937155af41f1aebeb87d1acd07091b71de/pkg/agent/flannel/setup.go#L42"}),"\u914d\u7f6e")))),(0,a.kt)("li",{parentName:"ul"},"\u79c1\u6709\u4ed3\u5e93 ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/registries.yaml")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/"}),"\u670d\u52a1\u914d\u7f6e"))),(0,a.kt)("h3",m({},{id:"getk3sio"}),"get.k3s.io"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://get.k3s.io"}),"get.k3s.io")," \u5b89\u88c5\u811a\u672c"),(0,a.kt)("li",{parentName:"ul"},"\u4e0b\u8f7d\u5730\u5740\u4e3a STORAGE_URL=",(0,a.kt)("a",m({parentName:"li"},{href:"https://storage.googleapis.com/k3s-ci-builds"}),"https://storage.googleapis.com/k3s-ci-builds")),(0,a.kt)("li",{parentName:"ul"},"\u4f1a\u5b89\u88c5 openrc \u670d\u52a1",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"/etc/rancher/k3s/k3s.env"),(0,a.kt)("li",{parentName:"ul"},"/etc/rancher/k3s/k3s-agent.env"),(0,a.kt)("li",{parentName:"ul"},"/etc/init.d/k3s"),(0,a.kt)("li",{parentName:"ul"},"/etc/init.d/k3s-agent"))),(0,a.kt)("li",{parentName:"ul"},"\u65e5\u5fd7\u6587\u4ef6 /var/log/k3s.log"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher.com/docs/k3s/latest/en/installation/install-options/"}),"\u5b89\u88c5\u9009\u9879"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u5b89\u88c5\u4e3a server \u542f\u52a8",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e ",(0,a.kt)("inlineCode",{parentName:"li"},"K3S_URL")," \u4e14\u8bbe\u7f6e ",(0,a.kt)("inlineCode",{parentName:"li"},"K3S_TOKEN")," \u6216 ",(0,a.kt)("inlineCode",{parentName:"li"},"K3S_CLUSTER_SECRET")),(0,a.kt)("li",{parentName:"ul"},"\u6216\u76f4\u63a5\u540e\u9762\u6307\u5b9a agent"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_SKIP_DOWNLOAD")," - \u4e0d\u4e0b\u8f7d"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_SYMLINK")," - \u521b\u5efa kubectl\uff0ccrictl\uff0cctr \u7b26\u53f7\u94fe\u63a5 - \u8bbe\u7f6e\u4e3a ",(0,a.kt)("inlineCode",{parentName:"li"},"skip")," \u4f1a\u8c03\u8fc7\uff0c\u8bbe\u7f6e\u4e3a force \u4f1a\u8986\u76d6"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_SKIP_ENABLE")," - \u4e0d\u542f\u7528\u548c\u542f\u52a8 k3s - \u5373\u4e0d\u4f1a add openrc \u7684 service \u4e5f\u4e0d\u4f1a start"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_SKIP_START")," - \u4e0d\u542f\u52a8\u670d\u52a1"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_BIN_DIR")," - \u5b89\u88c5\u76ee\u5f55 - \u9ed8\u8ba4 ",(0,a.kt)("inlineCode",{parentName:"li"},"/usr/local/bin")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_EXEC")," - \u6307\u5411\u547d\u4ee4",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 agent \u9664\u975e\u6709 K3S_URL"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_CHANNEL_URL")," - \u9ed8\u8ba4 ",(0,a.kt)("a",m({parentName:"li"},{href:"https://update.k3s.io/v1-release/channels"}),"https://update.k3s.io/v1-release/channels")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"INSTALL_K3S_CHANNEL")," - \u9ed8\u8ba4 stable"),(0,a.kt)("li",{parentName:"ul"},"\u989d\u5916\u5b89\u88c5",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/usr/local/bin/k3s-killall.sh"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"li"},"service k3s stop")),(0,a.kt)("li",{parentName:"ul"},"umount",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/run/k3s")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/kubelet/pods")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/run/netns/cni-")))),(0,a.kt)("li",{parentName:"ul"},"\u79fb\u9664 ",(0,a.kt)("inlineCode",{parentName:"li"},"cni0")," \u548c ",(0,a.kt)("inlineCode",{parentName:"li"},"flannel1.1")),(0,a.kt)("li",{parentName:"ul"},"\u5220\u9664 ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/cni/")),(0,a.kt)("li",{parentName:"ul"},"\u79fb\u9664 iptables \u91cc\u7684 KUBE \u548c CNI \u5185\u5bb9"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/usr/local/bin/k3s-uninstall.sh")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/k3s.env"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"service \u542f\u52a8\u4f1a source \u8fd9\u4e2a\u6587\u4ef6"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/etc/init.d/k3s"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\u5b89\u88c5\u53c2\u6570\u4f1a\u76f4\u63a5\u5728\u8fd9\u91cc"),(0,a.kt)("li",{parentName:"ul"},"\u65e5\u5fd7\u6587\u4ef6\u4e3a ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/log/k3s.log")))))))),(0,a.kt)("li",{parentName:"ul"},'INSTALL_K3S_EXEC="--disable=traefik" \u53ef\u7981\u7528\u5b89\u88c5\u67d0\u4e9b\u670d\u52a1')),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'curl -sfL https://get.k3s.io | sh -\n\n# \u53ef\u76f4\u63a5\u6307\u5b9a\u53c2\u6570\ncurl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644\n# \u4e5f\u53ef\u4ee5\u73af\u5883\u53d8\u91cf\u6307\u5b9a\ncurl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" sh -s -\n\n# INSTALL_K3S_EXEC \u6307\u5b9a\u547d\u4ee4\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--no-flannel" sh -s -\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --no-flannel" sh -s -\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --no-flannel\ncurl -sfL https://get.k3s.io | sh -s - server --no-flannel\ncurl -sfL https://get.k3s.io | sh -s - --no-flannel\ncurl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_ENABLE=1 sh -s -\n')),(0,a.kt)("h2",m({},{id:"\u624b\u52a8\u955c\u50cf\u5b89\u88c5"}),"\u624b\u52a8\u955c\u50cf\u5b89\u88c5"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/k3s-io/k3s/blob/master/install.sh"}),"https://github.com/k3s-io/k3s/blob/master/install.sh")),(0,a.kt)("li",{parentName:"ul"},"\u955c\u50cf",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh"}),"http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",m({parentName:"li"},{href:"https://rancher-mirror.rancher.cn"}),"https://rancher-mirror.rancher.cn")))),(0,a.kt)("li",{parentName:"ul"},"arch - k3s, k3s-arm64, k3s-armhf, k3s-s390x"),(0,a.kt)("li",{parentName:"ul"},"sha256sum-${ARCH}.txt")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"ver=$(curl -sfL https://rancher-mirror.rancher.cn/k3s/channels/stable)\ncurl -sfLO https://rancher-mirror.rancher.cn/k3s/${ver/+/-}/k3s\ncurl -sfLO https://rancher-mirror.rancher.cn/k3s/${ver/+/-}/sha256sum-amd64.txt\nsha256sum -c sha256sum-amd64.txt --ignore-missing\n\nchmod +x k3s\nmv k3s /usr/bin/k3s\nk3s check-config\n# k3s server\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"openrc")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"/etc/rancher/k3s/${SYSTEM_NAME}.env")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash",metastring:'title="/etc/init.d/k3s"',title:'"/etc/init.d/k3s"'}),'#!/sbin/openrc-run\n\n# Based on ...\n#   https://raw.githubusercontent.com/rancher/k3s/master/install.sh\nK3S_LOGFILE="${K3S_LOGFILE:-/var/log/${RC_SVCNAME}.log}"\n\nsupervisor=supervise-daemon\n\nname="k3s"\ncommand="/usr/bin/k3s"\ncommand_args="${K3S_EXEC} ${K3S_OPTS} >>${K3S_LOGFILE} 2>&1"\n\noutput_log=${K3S_LOGFILE}\nerror_log=${K3S_LOGFILE}\n\npidfile="/run/k3s.pid"\nrespawn_delay=5\nrespawn_max=0\n\nrc_ulimit="${K3S_ULIMIT:--c unlimited -n 1048576 -u unlimited}"\n\ndepend() {\n        want cgroups\n        after firewall\n}\n\nstart_pre() {\n        checkpath -f -m 0644 -o root:root "${K3S_LOGFILE}"\n        rm -f /tmp/k3s.*\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash",metastring:'title="/etc/init.d/k3s"',title:'"/etc/init.d/k3s"'}),'#!/sbin/openrc-run\n\ndepend() {\n    after network-online\n    want cgroups\n}\n\nstart_pre() {\n    rm -f /tmp/k3s.*\n}\n\nsupervisor=supervise-daemon\nname=${SYSTEM_NAME}\ncommand="${BIN_DIR}/k3s"\ncommand_args="$(escape_dq "${CMD_K3S_EXEC}")\n    >>${LOG_FILE} 2>&1"\n\noutput_log=${LOG_FILE}\nerror_log=${LOG_FILE}\n\npidfile="/var/run/${SYSTEM_NAME}.pid"\nrespawn_delay=5\nrespawn_max=0\n\nset -o allexport\nif [ -f /etc/environment ]; then source /etc/environment; fi\nif [ -f ${FILE_K3S_ENV} ]; then source ${FILE_K3S_ENV}; fi\nset +o allexport\n')),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-pre",metastring:'title="/etc/logrotate.d/k3s"',title:'"/etc/logrotate.d/k3s"'}),"/var/log/k3s.log {\n    missingok\n    notifempty\n    copytruncate\n}\n")),(0,a.kt)("h2",m({},{id:"\u624b\u52a8\u5b89\u88c5\u542f\u52a8"}),"\u624b\u52a8\u5b89\u88c5\u542f\u52a8"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"mkdir -p /opt/k3s\ncd /opt/k3s\n# https://github.com/rancher/k3s/releases\nver=$(curl -sL https://api.github.com/repos/rancher/k3s/releases/latest | jq .tag_name -r)\n\ncurl -LOC- https://github.com/rancher/k3s/releases/download/$ver/k3s\ncurl -LOC- https://github.com/rancher/k3s/releases/download/$ver/k3s-images.txt\n\nssh k3s -- \"sudo sh -c 'mkdir -p /opt/k3s && chown admin:admin /opt/k3s'\"\nscp k3s k3s:/opt/k3s\nscp k3s-images.txt k3s:/opt/k3s\n\n# ssh k3s --\ncat /opt/k3s/k3s-images.txt | xargs -n 1 docker pull\n\nk3s server --cluster-init --alsologtostderr --log $PWD/k3s-server.log --docker\n")),(0,a.kt)("h2",m({},{id:"containerd"}),"containerd"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u4f1a\u751f\u6210\u914d\u7f6e",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"/var/lib/rancher/k3s/agent/etc/containerd/config.toml"),(0,a.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709 config.toml.tmpl \u5219\u4f1a\u4f7f\u7528"),(0,a.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u6a21\u677f ",(0,a.kt)("a",m({parentName:"li"},{href:"https://github.com/rancher/k3s/blob/master/pkg/agent/templates/templates.go#L16-L72"}),"templates.go#ContainerdConfigTemplate")))),(0,a.kt)("li",{parentName:"ul"},"\u6ca1\u6709 docker \u53ef\u4ee5\u5c11 80m \u5185\u5b58"),(0,a.kt)("li",{parentName:"ul"},"\u6bcf\u4e2a containerd-shim \u6bd4 containerd-shim-runc-v2 \u5c11\u51e0 m \u5185\u5b58",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"containerd-shim \u662f docker \u7684"),(0,a.kt)("li",{parentName:"ul"},"containerd-shim-runc-v2 \u662f containerd \u7684")))),(0,a.kt)("h2",m({},{id:"registries"}),"registries"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/registries.yaml")),(0,a.kt)("li",{parentName:"ul"},"\u542f\u52a8\u65f6\u68c0\u6d4b\uff0ccontainerd \u4f1a\u4f7f\u7528\u8fd9\u91cc\u7684\u5b9a\u4e49")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-yaml"}),"mirrors:\n  # \u955c\u50cf DockerHub\n  docker.io:\n    endpoint:\n      - 'https://mycustomreg.com:5000'\nconfigs:\n  # \u6dfb\u52a0\u6388\u6743\u548c\u8bc1\u4e66\n  'mycustomreg:5000':\n    auth:\n      username: xxxxxx # this is the registry username\n      password: xxxxxx # this is the registry password\n    tls:\n      cert_file: # path to the cert file used in the registry\n      key_file: # path to the key file used in the registry\n      ca_file: # path to the ca file used in the registry\n")),(0,a.kt)("h2",m({},{id:"\u7b14\u8bb0"}),"\u7b14\u8bb0"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"kubeconfig \u4f4d\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/k3s.yaml")),(0,a.kt)("li",{parentName:"ul"},"K3S_TOKEN \u4f4d\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s/server/node-token")),(0,a.kt)("li",{parentName:"ul"},"\u8282\u70b9\u9700\u8981\u6709\u552f\u4e00\u4e3b\u673a\u540d - ",(0,a.kt)("inlineCode",{parentName:"li"},"K3S_NODE_NAME"))),(0,a.kt)("h3",m({},{id:"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91"}),"\u4ee3\u7406\u8282\u70b9\u6ce8\u518c\u903b\u8f91"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"k3s agent \u521d\u59cb\u5316 Agent \u8282\u70b9\u7684 websocket \u94fe\u63a5\u3002\u94fe\u63a5\u4f1a\u6709\u5ba2\u6237\u7aef\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u3002"),(0,a.kt)("li",{parentName:"ul"},"Agent \u4f1a\u4f7f\u7528\u96c6\u7fa4\u7684\u5bc6\u94a5\u548c\u968f\u673a\u751f\u6210\u7684\u5bc6\u7801\u6ce8\u518c\uff0c\u5bc6\u7801\u5b58\u50a8\u4e8e ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/node/password"),"\uff0c\u670d\u52a1\u7aef\u4f1a\u5b58\u50a8\u8282\u70b9\u7684\u5bc6\u7801\u5230 ",(0,a.kt)("inlineCode",{parentName:"li"},"/var/lib/rancher/k3s/server/cred/node-passwd"),"\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u8282\u70b9\u4e0a\u7684 ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/rancher/node")," \u76ee\u5f55\u88ab\u79fb\u9664\u540e\u5bc6\u7801\u4f1a\u88ab\u4ece\u65b0\u751f\u6210\uff0c\u6216\u7531\u670d\u52a1\u7aef\u79fb\u9664\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u542f\u52a8\u65f6\u53ef\u4e3a\u8282\u70b9\u9644\u52a0\u552f\u4e00\u8282\u70b9\u6807\u793a\uff0c",(0,a.kt)("inlineCode",{parentName:"li"},"--with-node-id"),"\u3002")),(0,a.kt)("h2",m({},{id:"\u5feb\u901f\u542f\u52a8"}),"\u5feb\u901f\u542f\u52a8"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"curl -LO 'https://ghproxy.com/https://github.com/k3s-io/k3s/releases/download/v1.24.1%2Bk3s1/k3s'\nchmod +x k3s\n./k3s server\n")))}_.isMDXComponent=!0}}]);