/*! For license information please see 6e6f22df.0bca3bb4.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[13686],{63941:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>a,frontMatter:()=>r,metadata:()=>d,toc:()=>h});var t=s(11527),i=s(47214);const r={title:"NextAuth"},l="NextAuth",d={id:"web/framework/nextjs/next-auth",title:"NextAuth",description:"- nextauthjs/next-auth",source:"@site/../notes/web/framework/nextjs/next-auth.md",sourceDirName:"web/framework/nextjs",slug:"/web/framework/nextjs/next-auth",permalink:"/notes/web/framework/nextjs/next-auth",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/web/framework/nextjs/next-auth.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1684216634,formattedLastUpdatedAt:"May 16, 2023",frontMatter:{title:"NextAuth"},sidebar:"docs",previous:{title:"NextJS",permalink:"/notes/web/framework/nextjs/"},next:{title:"App Layout",permalink:"/notes/web/framework/nextjs/app"}},c={},h=[{value:"\u6570\u636e\u6a21\u578b",id:"models",level:2},{value:"REST API",id:"rest-api",level:2},{value:"\u5237\u65b0 JWT",id:"\u5237\u65b0-jwt",level:2},{value:"CORS",id:"cors",level:2},{value:"\u4e0d\u80fd\u83b7\u53d6 Cookie",id:"\u4e0d\u80fd\u83b7\u53d6-cookie",level:2}];function o(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"nextauth",children:"NextAuth"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth",children:"nextauthjs/next-auth"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"ISC, TS"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u56de\u8c03 ",(0,t.jsx)(e.code,{children:"/api/auth/callback/<NAME>"})]}),"\n",(0,t.jsxs)(e.li,{children:["Provider\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["Gitlab\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u56de\u8c03\u8981\u5b8c\u6574\uff0c127.0.0.1 \u8981\u989d\u5916\u52a0"}),"\n",(0,t.jsx)(e.li,{children:"\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\u56de\u8c03"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["Github\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u56de\u8c03\u914d\u524d\u7f00\uff0c\u9ed8\u8ba4\u652f\u6301 127.0.0.1"}),"\n",(0,t.jsxs)(e.li,{children:["\u53ea\u80fd\u914d\u7f6e",(0,t.jsx)(e.strong,{children:"\u4e00\u4e2a"}),"\u56de\u8c03"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["credentials \u53ea\u652f\u6301 JWT \u4e0d\u80fd\u6301\u4e45\u5316 session token\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://next-auth.js.org/providers/credentials",children:"https://next-auth.js.org/providers/credentials"})}),"\n"]}),"\n"]}),"\n"]})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"env"}),(0,t.jsx)(e.th,{children:"for"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"NEXTAUTH_URL"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"NEXTAUTH_SECRET"}),(0,t.jsx)(e.td,{children:"\u751f\u4ea7\u73af\u5883\u5fc5\u987b"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"NEXTAUTH_URL_INTERNAL"}),(0,t.jsx)(e.td,{children:"\u9ed8\u8ba4 NEXTAUTH_URL"})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["AUTH_TRUST_HOST || VERCEL\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u7528\u4e8e detectHost"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.admonition,{type:"caution",children:(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/issues/6710",children:"#6710"}),"\nrefresh token rotation doesn't update client session\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://next-auth.js.org/getting-started/client#updating-the-session",children:"https://next-auth.js.org/getting-started/client#updating-the-session"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/4229",children:"https://github.com/nextauthjs/next-auth/discussions/4229"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/1702",children:"#1702"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"one user, multiple account providers"}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"// \u5185\u90e8\u5168\u5c40\u4e0a\u4e0b\u6587\nconst __NEXTAUTH: NextAuthClientConfig = {\n  baseUrl: parseUrl(process.env.NEXTAUTH_URL ?? process.env.VERCEL_URL).origin,\n  basePath: parseUrl(process.env.NEXTAUTH_URL).path,\n  baseUrlServer: parseUrl(process.env.NEXTAUTH_URL_INTERNAL ?? process.env.NEXTAUTH_URL ?? process.env.VERCEL_URL)\n    .origin,\n  basePathServer: parseUrl(process.env.NEXTAUTH_URL_INTERNAL ?? process.env.NEXTAUTH_URL).path,\n  _lastSync: 0,\n  _session: undefined,\n  _getSession: () => {},\n};\n\n// profile \u8f6c account \u903b\u8f91\nconst getProfile = {\n  profile,\n  account: {\n    provider: provider.id,\n    type: provider.type,\n    providerAccountId: profile.id.toString(),\n    ...tokens,\n  },\n  OAuthProfile: profile,\n};\n\nexport const defaultCallbacks: CallbacksOptions = {\n  signIn() {\n    // \u662f\u5426\u5141\u8bb8\u767b\u5f55\n    // \u53ef\u4ee5\u8fd4\u56de \u5b57\u7b26\u4e32\u505a redirect\n    return true;\n  },\n  redirect({ url, baseUrl }) {\n    if (url.startsWith('/')) return `${baseUrl}${url}`;\n    else if (new URL(url).origin === baseUrl) return url;\n    return baseUrl;\n  },\n  session({ session }) {\n    return session;\n  },\n  // jwt session\n  jwt({ token }) {\n    return token;\n  },\n};\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["callbacks - ",(0,t.jsx)(e.a,{href:"https://next-auth.js.org/configuration/callbacks",children:"https://next-auth.js.org/configuration/callbacks"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"signIn - \u53ef\u4ee5\u62d2\u7edd\u7528\u6237\u767b\u5f55"}),"\n",(0,t.jsx)(e.li,{children:"redirect - \u6784\u9020\u8df3\u8f6c URL"}),"\n",(0,t.jsxs)(e.li,{children:["jwt\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u89e6\u53d1 ",(0,t.jsx)(e.code,{children:"/api/auth/signin"}),", ",(0,t.jsx)(e.code,{children:"/api/auth/session"}),", ",(0,t.jsx)(e.code,{children:"getSession()"}),", ",(0,t.jsx)(e.code,{children:"getServerSession()"}),", ",(0,t.jsx)(e.code,{children:"useSession()"})]}),"\n",(0,t.jsx)(e.li,{children:"\u7b2c\u4e00\u6b21\u521b\u5efa\u65f6\u6709\u7684\u53c2\u6570 user, account, profile, isNewUser"}),"\n",(0,t.jsx)(e.li,{children:"\u4e4b\u540e\u90fd\u53ea\u6709 token"}),"\n",(0,t.jsx)(e.li,{children:"token \u57fa\u7840\u5c5e\u6027 - name, email, sub, iat, exp, jti"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["session\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u89e6\u53d1 ",(0,t.jsx)(e.code,{children:"getSession()"}),", ",(0,t.jsx)(e.code,{children:"useSession()"}),", ",(0,t.jsx)(e.code,{children:"/api/auth/session"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["tokens:TokenSet\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5305\u542b access_token"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["createState - state\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"maxAge: 900 - 15m"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"\u4f1a\u5728 sessionMaxAge \u66f4\u65b0 session \u6709\u6548\u671f"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"import { generators } from 'openid-client';\n// \u751f\u6210 state\nconst state = generators.state();\n"})}),"\n",(0,t.jsx)(e.h2,{id:"models",children:"\u6570\u636e\u6a21\u578b"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"User -1-*-> Account"}),"\n",(0,t.jsx)(e.li,{children:"User -1-*-> Session"}),"\n",(0,t.jsx)(e.li,{children:"VerificationToken"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Adapter"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u767b\u5f55\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"createUser"}),"\n",(0,t.jsx)(e.li,{children:"getUser"}),"\n",(0,t.jsx)(e.li,{children:"getUserByEmail"}),"\n",(0,t.jsx)(e.li,{children:"getUserByAccount"}),"\n",(0,t.jsx)(e.li,{children:"linkAccount"}),"\n",(0,t.jsx)(e.li,{children:"createSession"}),"\n",(0,t.jsx)(e.li,{children:"getSessionAndUser"}),"\n",(0,t.jsx)(e.li,{children:"updateSession"}),"\n",(0,t.jsx)(e.li,{children:"deleteSession"}),"\n",(0,t.jsx)(e.li,{children:"updateUser"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u90ae\u7bb1/\u65e0\u5bc6\u7801\u767b\u5f55\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"createVerificationToken"}),"\n",(0,t.jsx)(e.li,{children:"useVerificationToken"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u76ee\u524d\u6ca1\u7528\u5230\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"deleteUser"}),"\n",(0,t.jsx)(e.li,{children:"unlinkAccount"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.hr,{}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://next-auth.js.org/adapters/models",children:"https://next-auth.js.org/adapters/models"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"rest-api",children:"REST API"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"method"}),(0,t.jsx)(e.th,{children:"url"}),(0,t.jsx)(e.th,{children:"note"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/signin"}),(0,t.jsx)(e.td,{children:"\u5185\u7f6e\u767b\u5f55\u9875"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/signout"}),(0,t.jsx)(e.td,{children:"\u5185\u7f6e\u767b\u51fa\u9875"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"POST"}),(0,t.jsx)(e.td,{children:"/api/auth/signout"}),(0,t.jsx)(e.td,{children:"\u9000\u51fa\u767b\u5f55 - CSRF"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/csrf"}),(0,t.jsx)(e.td,{children:"\u83b7\u53d6 CSRF"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/session"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/providers"}),(0,t.jsx)(e.td,{})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"POST"}),(0,t.jsx)(e.td,{children:"/api/auth/signin/:provider"}),(0,t.jsx)(e.td,{children:"\u5f00\u59cb\u767b\u5f55\u6d41\u7a0b"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"GET"}),(0,t.jsx)(e.td,{children:"/api/auth/callback/:provider"}),(0,t.jsx)(e.td,{children:"OAuth \u56de\u8c03"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"POST"}),(0,t.jsx)(e.td,{children:"/api/auth/callback/:provider"}),(0,t.jsx)(e.td,{children:"\u8d26\u53f7\u5bc6\u7801\u767b\u5f55 - CSRF"})]})]})]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://next-auth.js.org/getting-started/rest-api",children:"https://next-auth.js.org/getting-started/rest-api"})}),"\n"]}),"\n",(0,t.jsx)(e.h1,{id:"faq",children:"FAQ"}),"\n",(0,t.jsx)(e.h2,{id:"\u5237\u65b0-jwt",children:"\u5237\u65b0 JWT"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u901a\u8fc7\u81ea\u5b9a\u4e49 SignIn \u6765\u5237\u65b0"}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/discussions/4229",children:"#4229"}),"\nHow to manually trigger next-auth to refresh the JWT?"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"cors",children:"CORS"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://github.com/nextauthjs/next-auth/issues/4327#issuecomment-1090389591",children:"https://github.com/nextauthjs/next-auth/issues/4327#issuecomment-1090389591"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"\u4e0d\u80fd\u83b7\u53d6-cookie",children:"\u4e0d\u80fd\u83b7\u53d6 Cookie"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"HTTP Only"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"function getCookie(name) {\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) return parts.pop().split(';').shift();\n}\ngetCookie('next-auth.session-token');\n"})})]})}function a(n={}){const{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(o,{...n})}):o(n)}},3354:(n,e,s)=>{var t=s(50959),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,d=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function h(n,e,s){var t,r={},h=null,o=null;for(t in void 0!==s&&(h=""+s),void 0!==e.key&&(h=""+e.key),void 0!==e.ref&&(o=e.ref),e)l.call(e,t)&&!c.hasOwnProperty(t)&&(r[t]=e[t]);if(n&&n.defaultProps)for(t in e=n.defaultProps)void 0===r[t]&&(r[t]=e[t]);return{$$typeof:i,type:n,key:h,ref:o,props:r,_owner:d.current}}e.Fragment=r,e.jsx=h,e.jsxs=h},11527:(n,e,s)=>{n.exports=s(3354)},47214:(n,e,s)=>{s.d(e,{Z:()=>d,a:()=>l});var t=s(50959);const i={},r=t.createContext(i);function l(n){const e=t.useContext(r);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),t.createElement(r.Provider,{value:e},n.children)}}}]);