/*! For license information please see b3488f02.28d974b8.js.LICENSE.txt */
"use strict";(self.webpackChunkwener_website=self.webpackChunkwener_website||[]).push([[12935],{68357:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>a,toc:()=>i});var t=s(11527),r=s(47214);const l={title:"Consul"},o="Consul",a={id:"devops/kubernetes/app/k8s-consul",title:"Consul",description:"- Consul K8S \u4f7f\u7528\u573a\u666f",source:"@site/../notes/devops/kubernetes/app/k8s-consul.md",sourceDirName:"devops/kubernetes/app",slug:"/devops/kubernetes/app/k8s-consul",permalink:"/notes/devops/kubernetes/app/k8s-consul",draft:!1,unlisted:!1,editUrl:"https://github.com/wenerme/wener/edit/master/notes/../notes/devops/kubernetes/app/k8s-consul.md",tags:[],version:"current",lastUpdatedBy:"wener",lastUpdatedAt:1693122196,formattedLastUpdatedAt:"Aug 27, 2023",frontMatter:{title:"Consul"},sidebar:"docs",previous:{title:"Kubernetest Application FAQ",permalink:"/notes/devops/kubernetes/app/k8s-app-faq"},next:{title:"Minio",permalink:"/notes/devops/kubernetes/app/k8s-minio"}},c={},i=[{value:"DNS",id:"dns",level:2},{value:"ACL",id:"acl",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"consul",children:"Consul"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/hashicorp/consul-k8s",children:"Consul K8S"})," \u4f7f\u7528\u573a\u666f\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u90e8\u7f72 Consul \u96c6\u7fa4\u670d\u52a1"}),"\n",(0,t.jsx)(n.li,{children:"\u5141\u8bb8 Consol \u5ba2\u6237\u7aef\u6253\u901a\u670d\u52a1"}),"\n",(0,t.jsx)(n.li,{children:"Connect Service Mesh"}),"\n",(0,t.jsx)(n.li,{children:"\u540c\u6b65 K8S \u670d\u52a1\u5230 Consul"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"\u5b89\u88c5\u4f9d\u8d56 PV \u5b58\u50a8"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.consul.io/docs/k8s",children:"\u6587\u6863"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'helm repo add hashicorp https://helm.releases.hashicorp.com\n\n# \u9ed8\u8ba4\u90e8\u7f72    server client dns ui\n# \u9ed8\u8ba4\u4e0d\u90e8\u7f72 tls acl federation externalService snapshotAgent syncCatalog\n#   connectInject centralConfig meshGateway ingressGateways terminatingGateways\n# \u9ed8\u8ba4 datacenter \u4e3a dc1\n# \u5b89\u88c5\u5230 service \u7a7a\u95f4\n# --set server.affinity=null \u5141\u8bb8\u5b89\u88c5\u5230\u5355\u673a\n# server.storageClass \u4fee\u6539\u5b58\u50a8\u7c7b\u578b\nhelm install consul hashicorp/consul \\\n  -n consul --create-namespace \\\n  --set global.name=consul --set global.datacenter=center\n\n# \u8f6c\u53d1 UI\n# \u9ed8\u8ba4\u6ca1\u6709 tls \u548c acl\nkubectl port-forward -n consul svc/consul-server 8500:8500\n# \u5982\u679c\u542f\u7528\u4e86 ACL\nkubectl get -n consul secrets/consul-bootstrap-acl-token --template={{.data.token}} | base64 -d\n\n# \u8bbf\u95ee consul\n# \u6bcf\u4e2a\u8282\u70b9\u90fd\u6709 agent \u56e0\u6b64\u76f4\u63a5\u4f7f\u7528 HOST_IP \u5373\u53ef\nexport CONSUL_HTTP_ADDR="${HOST_IP}:8500"\nconsul kv put hello world\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"env:\n  - name: ADVERTISE_IP\n    valueFrom:\n      fieldRef:\n        fieldPath: status.podIP\n  - name: NAMESPACE\n    valueFrom:\n      fieldRef:\n        fieldPath: metadata.namespace\n  - name: NODE\n    valueFrom:\n      fieldRef:\n        fieldPath: status.nodeName\n  - name: HOST_IP\n    valueFrom:\n      fieldRef:\n        fieldPath: status.hostIP\n  - name: CONSUL_HTTP_ADDR\n    value: $(HOST_IP):8500\n"})}),"\n",(0,t.jsx)(n.h2,{id:"dns",children:"DNS"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# KubeDNS\n# ==========\nCONSUL_DNS_IP=$(kubectl get svc consul-dns -o jsonpath=\'{.spec.clusterIP}\' -n service)\ncat << EOF | kubectl apply -f -\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  labels:\n    addonmanager.kubernetes.io/mode: EnsureExists\n  name: kube-dns\n  namespace: kube-system\ndata:\n  stubDomains: |\n    {"consul": ["$CONSUL_DNS_IP"]}\nEOF\n\nkubectl get configmap kube-dns -n kube-system -o yaml\n\n# CoreDNS\n# ==========\nkubectl edit configmap coredns -n kube-system\n# Corefile: |\n#   consul {\n#     errors\n#     cache 30\n#     forward . <consul-dns-service-cluster-ip>\n#   }\n\n# \u6d4b\u8bd5\u89e3\u6790\nkubectl run --rm -i -t dns-test --image=wener/base --restart=Never -- nslookup consul.service.consul\n'})}),"\n",(0,t.jsx)(n.h2,{id:"acl",children:"ACL"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.consul.io/docs/security/acl/auth-methods/kubernetes",children:"Kubernetes Auth Method"})}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},3354:(e,n,s)=>{var t=s(50959),r=Symbol.for("react.element"),l=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function i(e,n,s){var t,l={},i=null,u=null;for(t in void 0!==s&&(i=""+s),void 0!==n.key&&(i=""+n.key),void 0!==n.ref&&(u=n.ref),n)o.call(n,t)&&!c.hasOwnProperty(t)&&(l[t]=n[t]);if(e&&e.defaultProps)for(t in n=e.defaultProps)void 0===l[t]&&(l[t]=n[t]);return{$$typeof:r,type:e,key:i,ref:u,props:l,_owner:a.current}}n.Fragment=l,n.jsx=i,n.jsxs=i},11527:(e,n,s)=>{e.exports=s(3354)},47214:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>o});var t=s(50959);const r={},l=t.createContext(r);function o(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);