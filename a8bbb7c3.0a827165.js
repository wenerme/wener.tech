(window.webpackJsonp=window.webpackJsonp||[]).push([[530],{603:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return b})),a.d(t,"metadata",(function(){return c})),a.d(t,"toc",(function(){return p})),a.d(t,"default",(function(){return m}));var n=a(3),l=a(8),r=(a(0),a(879)),b={title:"WAL-G"},c={unversionedId:"db/relational/postgresql/wal-g",id:"db/relational/postgresql/wal-g",isDocsHomePage:!1,title:"WAL-G",description:"- \u662f\u4ec0\u4e48\uff1f",source:"@site/notes/db/relational/postgresql/wal-g.md",slug:"/db/relational/postgresql/wal-g",permalink:"/notes/db/relational/postgresql/wal-g",editUrl:"https://github.com/wenerme/wener/edit/master/notes/db/relational/postgresql/wal-g.md",version:"current",sidebar:"docs",previous:{title:"TimeScale",permalink:"/notes/db/relational/postgresql/timescale"},next:{title:"MySQL GTID",permalink:"/notes/db/relational/mysql-gtid"}},p=[{value:"\u64cd\u4f5c",id:"\u64cd\u4f5c",children:[]}],i={toc:p};function m(e){var t=e.components,a=Object(l.a)(e,["components"]);return Object(r.b)("wrapper",Object(n.a)({},i,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"\u662f\u4ec0\u4e48\uff1f",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"PostgreSQL \u5907\u4efd\u3001\u6062\u590d\u5de5\u5177"),Object(r.b)("li",{parentName:"ul"},"WAL-E \u540e\u7ee7 - Golang \u91cd\u5199 Python - \u6027\u80fd x4"),Object(r.b)("li",{parentName:"ul"},"\u652f\u6301 PostgreSQL, MySQL/MariaDB, Mongo"),Object(r.b)("li",{parentName:"ul"},"\u652f\u6301 S3, GCS, Azure, Swift, \u672c\u5730, SSH \u5b58\u50a8"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://github.com/wal-g/wal-g"},"wal-g/wal-g"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Apache 2.0, lzo \u90e8\u5206 GPL 3.0+"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://github.com/wal-g/wal-g/blob/master/PostgreSQL.md"},"PostgreSQL")))),Object(r.b)("li",{parentName:"ul"},"WAL-E \u4e0d\u652f\u6301\u5173\u95ed S3 SSE - SelfHost \u5e38\u89c1\u4e0d\u4fbf\u4e8e\u4f7f\u7528"),Object(r.b)("li",{parentName:"ul"},"\u53c2\u8003",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"https://github.com/camptocamp/wal-g-prometheus-exporter"},"camptocamp/wal-g-prometheus-exporter"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"\u76d1\u63a7\u6307\u6807")))))),Object(r.b)("table",null,Object(r.b)("thead",{parentName:"table"},Object(r.b)("tr",{parentName:"thead"},Object(r.b)("th",{parentName:"tr",align:null},"env"),Object(r.b)("th",{parentName:"tr",align:null},"desc"))),Object(r.b)("tbody",{parentName:"table"},Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_S3_PREFIX"),Object(r.b)("td",{parentName:"tr",align:null},"s3://bucket/path/to/folder")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"AWS_ACCESS_KEY_ID"),Object(r.b)("td",{parentName:"tr",align:null})),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"AWS_SECRET_ACCESS_KEY"),Object(r.b)("td",{parentName:"tr",align:null},"AWS_SESSION_TOKEN,",Object(r.b)("inlineCode",{parentName:"td"},"~/.aws/credentials"),",AWS_PROFILE")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"AWS_REGION"),Object(r.b)("td",{parentName:"tr",align:null},"us-west-2")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"AWS_ENDPOINT"),Object(r.b)("td",{parentName:"tr",align:null},"http://s3-like-service:9000")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"AWS_S3_FORCE_PATH_STYLE"),Object(r.b)("td",{parentName:"tr",align:null},"false",Object(r.b)("br",null),Object(r.b)("inlineCode",{parentName:"td"},"http://BUCKET.s3.amazonaws.com/KEY")," -> ",Object(r.b)("inlineCode",{parentName:"td"},"http://s3.amazonaws.com/BUCKET/KEY"))),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_FILE_PREFIX"),Object(r.b)("td",{parentName:"tr",align:null},Object(r.b)("inlineCode",{parentName:"td"},"/tmp/wal-g-test-data"))),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_SSH_PREFIX"),Object(r.b)("td",{parentName:"tr",align:null},Object(r.b)("inlineCode",{parentName:"td"},"ssh://localhost/walg-folder"))),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"SSH_PORT"),Object(r.b)("td",{parentName:"tr",align:null})),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"SSH_USERNAME"),Object(r.b)("td",{parentName:"tr",align:null})),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"SSH_PASSWORD"),Object(r.b)("td",{parentName:"tr",align:null})),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"TOTAL_BG_UPLOADED_LIMIT"),Object(r.b)("td",{parentName:"tr",align:null},"32")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_S3_STORAGE_CLASS"),Object(r.b)("td",{parentName:"tr",align:null},"STANDARD")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_S3_SSE"),Object(r.b)("td",{parentName:"tr",align:null},"false")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_S3_SSE_KMS_ID"),Object(r.b)("td",{parentName:"tr",align:null})),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"WALG_COMPRESSION_METHOD"),Object(r.b)("td",{parentName:"tr",align:null},"lz4,lzma,brotli")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"S3_USE_LIST_OBJECTS_V1"),Object(r.b)("td",{parentName:"tr",align:null},"false")))),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},"# Minio\nAWS_ACCESS_KEY_ID: '<minio-key>'\nAWS_SECRET_ACCESS_KEY: '<minio-secret>'\nWALG_S3_PREFIX: 's3://my-minio-bucket/sub-dir'\nAWS_ENDPOINT: 'http://minio:9000'\nAWS_S3_FORCE_PATH_STYLE: 'true'\nAWS_REGION: us-east-1\nWALG_S3_CA_CERT_FILE: '/path/to/custom/ca/file'\n")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"docker pull bitnami/wal-g\n")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"wal-g backup-list\n")),Object(r.b)("table",null,Object(r.b)("thead",{parentName:"table"},Object(r.b)("tr",{parentName:"thead"},Object(r.b)("th",{parentName:"tr",align:null},"name"),Object(r.b)("th",{parentName:"tr",align:null},"last_modified"),Object(r.b)("th",{parentName:"tr",align:null},"wal_segment_backup_start"),Object(r.b)("th",{parentName:"tr",align:null},"start_time"),Object(r.b)("th",{parentName:"tr",align:null},"finish_time"),Object(r.b)("th",{parentName:"tr",align:null},"hostname"),Object(r.b)("th",{parentName:"tr",align:null},"data_dir"),Object(r.b)("th",{parentName:"tr",align:null},"pg_version"),Object(r.b)("th",{parentName:"tr",align:null},"start_lsn"),Object(r.b)("th",{parentName:"tr",align:null},"finish_lsn"),Object(r.b)("th",{parentName:"tr",align:null},"is_permanent"))),Object(r.b)("tbody",{parentName:"table"},Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"base_000000020000000000000005"),Object(r.b)("td",{parentName:"tr",align:null},"2021-03-09T08:07:49Z"),Object(r.b)("td",{parentName:"tr",align:null},"000000020000000000000005"),Object(r.b)("td",{parentName:"tr",align:null},"Tuesday, 09-Mar-21 08:07:43 UTC"),Object(r.b)("td",{parentName:"tr",align:null},"Tuesday, 09-Mar-21 08:07:49 UTC"),Object(r.b)("td",{parentName:"tr",align:null},"acid-demo"),Object(r.b)("td",{parentName:"tr",align:null},"/home/postgres/pgdata/pgroot/data"),Object(r.b)("td",{parentName:"tr",align:null},"130002"),Object(r.b)("td",{parentName:"tr",align:null},"83886120"),Object(r.b)("td",{parentName:"tr",align:null},"83927800"),Object(r.b)("td",{parentName:"tr",align:null},"false")),Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",{parentName:"tr",align:null},"base_000000030000000000000008"),Object(r.b)("td",{parentName:"tr",align:null},"2021-03-09T08:14:48Z"),Object(r.b)("td",{parentName:"tr",align:null},"000000030000000000000008"),Object(r.b)("td",{parentName:"tr",align:null},"Tuesday, 09-Mar-21 08:14:42 UTC"),Object(r.b)("td",{parentName:"tr",align:null},"Tuesday, 09-Mar-21 08:14:48 UTC"),Object(r.b)("td",{parentName:"tr",align:null},"acid-demo"),Object(r.b)("td",{parentName:"tr",align:null},"/home/postgres/pgdata/pgroot/data"),Object(r.b)("td",{parentName:"tr",align:null},"130002"),Object(r.b)("td",{parentName:"tr",align:null},"134217768"),Object(r.b)("td",{parentName:"tr",align:null},"134250592"),Object(r.b)("td",{parentName:"tr",align:null},"false")))),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"\u76ee\u5f55\u7ed3\u6784")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"/",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"basebackup_005/",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"base_000000020000000000000005_backup_stop_sentinel.json"),Object(r.b)("li",{parentName:"ul"},"base_000000020000000000000005/",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"metadata.json"),Object(r.b)("li",{parentName:"ul"},"tar_partitions/",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"pg_control.tar.lz4"),Object(r.b)("li",{parentName:"ul"},"part_001.tar.lz4"))))))),Object(r.b)("li",{parentName:"ul"},"wal_005/",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"00000002.history.lz4"),Object(r.b)("li",{parentName:"ul"},"000000020000000000000005.lz4"),Object(r.b)("li",{parentName:"ul"},"000000020000000000000007.partial.lz4"),Object(r.b)("li",{parentName:"ul"},"000000020000000000000005.00000028.backup.lz4")))))),Object(r.b)("h2",{id:"\u64cd\u4f5c"},"\u64cd\u4f5c"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"wal-e ",Object(r.b)("a",{parentName:"li",href:"https://github.com/wal-e/wal-e#id1"},"Primary Commands"))),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"# Push base backup\nwal-g backup-push /data\n# Push WAL \u7247\u6bb5\nwal-g wal-push /data\n")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"postgresql.conf")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ini"},"wal_level = archive # hot_standby and logical in 9.x is also acceptable\narchive_mode = on\narchive_command = 'envdir /etc/wal-e.d/env wal-e wal-push %p'\narchive_timeout = 60\n")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"wal-g backup-fetch /data LATEST\nwal-g backup-fetch /data base_LONGWALNUMBER_POSITION_NUMBER\n")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"recovery.conf")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ini"},"# https://www.postgresql.org/docs/11/recovery-config.html\nrestore_command = 'envdir /etc/wal-e.d/env wal-e wal-fetch %f %p'\nstandby_mode = on\n")),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"# \u63d0\u5347 standby\n# https://www.postgresql.org/docs/current/app-pg-ctl.html\npg_ctl promote\n")))}m.isMDXComponent=!0},879:function(e,t,a){"use strict";a.d(t,"a",(function(){return o})),a.d(t,"b",(function(){return d}));var n=a(0),l=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function b(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?b(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):b(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function p(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var i=l.a.createContext({}),m=function(e){var t=l.a.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},o=function(e){var t=m(e.components);return l.a.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return l.a.createElement(l.a.Fragment,{},t)}},O=l.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,b=e.parentName,i=p(e,["components","mdxType","originalType","parentName"]),o=m(a),O=n,d=o["".concat(b,".").concat(O)]||o[O]||u[O]||r;return a?l.a.createElement(d,c(c({ref:t},i),{},{components:a})):l.a.createElement(d,c({ref:t},i))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,b=new Array(r);b[0]=O;var c={};for(var p in t)hasOwnProperty.call(t,p)&&(c[p]=t[p]);c.originalType=e,c.mdxType="string"==typeof e?e:n,b[1]=c;for(var i=2;i<r;i++)b[i]=a[i];return l.a.createElement.apply(null,b)}return l.a.createElement.apply(null,a)}O.displayName="MDXCreateElement"}}]);