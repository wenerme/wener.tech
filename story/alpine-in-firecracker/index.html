<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/story/rss.xml" title="Wener Live & Life Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/story/atom.xml" title="Wener Live & Life Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Wener Live & Life" href="/opensearch.xml"><title data-react-helmet="true">Firecracker 运行 AlpineLinux | Wener Live &amp; Life</title><meta data-react-helmet="true" property="og:title" content="Firecracker 运行 AlpineLinux | Wener Live &amp; Life"><meta data-react-helmet="true" name="description" content="Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。"><meta data-react-helmet="true" property="og:description" content="Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/styles.f53ced8f.css">
<link rel="preload" href="/styles.daaf3fa9.js" as="script">
<link rel="preload" href="/runtime~main.430e3866.js" as="script">
<link rel="preload" href="/main.cf7091df.js" as="script">
<link rel="preload" href="/1.a5862bf1.js" as="script">
<link rel="preload" href="/2.55b1ee95.js" as="script">
<link rel="preload" href="/3.a9404c11.js" as="script">
<link rel="preload" href="/ccc49370.87535276.js" as="script">
<link rel="preload" href="/65eaf7fb.8dc4b144.js" as="script">
<link rel="preload" href="/ea95f6a6.d6eca2a3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Wener</strong></a><a class="navbar__item navbar__link" href="/notes/java/java">笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/story">故事</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a><a class="navbar__item navbar__link" href="/notes/tool/network/ip-lookup">工具</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Wener</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/notes/java/java">笔记</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/story">故事</a></li><li class="menu__list-item"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/tool/network/ip-lookup">工具</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/fix-init-script">记录一次修复 init 脚本的经历</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/alpinelinux-setup-xfce">AlpineLinux 安装 Xfce 桌面</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/why-need-graphql">为什么需要 GraphQL</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/understand-baby-vision">理解孩子的视力</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/issues-system-design">工单系统设计实现</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Firecracker 运行 AlpineLinux</h1><div class="margin-vert--md"><time datetime="2020-10-23T00:00:00.000Z" class="blogPostDate_Ta7i">October 23, 2020  · 4 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><section class="markdown"><p>Firecracker 是亚马逊 AWS 为了解决虚拟化运行 serveless 服务实现的 VMM/Virtual Machine Monitor，作为 QEMU 的替代品，专注于为云上环境提供虚拟化。</p><p><strong>优点</strong></p><ul><li>启动快 &lt; 125ms</li><li>内存占用少 &lt; 5mb</li><li>Rust 实现</li><li>musl 静态链接</li><li>firecracker 自身约 <strong>1.6 MB</strong> - <strong>无依赖</strong></li></ul><p><strong>设计目标/缺陷</strong></p><ul><li>基于 KVM 实现<ul><li>只有 Linux 平台</li><li>只能运行相同架构</li></ul></li><li>专注于虚拟化场景<ul><li>支持的虚拟设备少<ul><li>virtio-net - 虚拟化网络</li><li>virtio-block - 虚拟化块设备</li><li>virtio-vsock - unix sock</li><li>串口 - ttyS0 终端登陆</li><li>最简键盘控制器</li></ul></li><li>没有 bios</li><li>通过 vmlinux+initramfs+rootfs 启动</li></ul></li><li>要求 Kernel 4.14+</li></ul><p><strong>为什么选择 Alpine？</strong></p><ul><li>最容易构建</li><li>最容易使用</li><li>构建 Firecracker 能使用的 CentOS, Debian, Ubuntu, Fedora 真太难了 - 如果没掌握内部启动机制不建议尝试</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="注意"></a>注意<a class="hash-link" href="#注意" title="Direct link to heading">#</a></h2><p>一些注意事项写在前面：</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Firecracker 注意点</h5></div><div class="admonition-content"><ul><li>没有电源管理，因此不支持重启，会直接退出</li><li>系统内 poweroff 或 halt 不会退出 - reboot 会</li><li>可以发送 SendCtrlAltDel 退出</li><li>不支持 QCOW2 格式，可以考虑配合 NDB 使用</li><li>alpine 内核需要 boot-source.initrd_path =&gt; initramfs-virt</li><li>alpine netboot 的 initramfs-virt 没有 ext4</li></ul></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="安装"></a>安装<a class="hash-link" href="#安装" title="Direct link to heading">#</a></h2><p>Firecracker 的<a href="https://github.com/firecracker-microvm/firecracker/releases" target="_blank" rel="noopener noreferrer">发布页</a>可直接下载每个版本。这里使用 curl 下载最新版并安装到 <code>/usr/loca/bin</code>。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 下载安装 firecracker 到 /usr/local/bin/firecracker</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">latest</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">basename</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">curl -fsSLI -o /dev/null -w  %</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token variable" style="color:rgb(191, 199, 213)">url_effective</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token variable" style="color:rgb(191, 199, 213)"> https://github.com/firecracker-microvm/firecracker/releases/latest</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -L -o /usr/local/bin/firecracker https://github.com/firecracker-microvm/firecracker/releases/download/</span><span class="token variable" style="color:rgb(191, 199, 213)">${latest}</span><span class="token plain">/firecracker-</span><span class="token variable" style="color:rgb(191, 199, 213)">${latest}</span><span class="token plain">-</span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">uname</span><span class="token variable" style="color:rgb(191, 199, 213)"> -m</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">chmod</span><span class="token plain"> +x /usr/local/bin/firecracker</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rootfs"></a>rootfs<a class="hash-link" href="#rootfs" title="Direct link to heading">#</a></h2><p>启动 firecracker 需要 kernel 和 rootfs，实际使用的时候可能大部分时间都是在准备 rootfs。这里使用 alpinelinux，功能完善构建简单。</p><p>因为 alpine 都会提供基础的 rootfs，这里直接下载解压到 ext4 的 loopdev 中。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 创建 root 盘</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># qemu-img create -f raw alpine.rootfs.ext4 1G</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fallocate -l 1G ubuntu.rootfs.ext4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 格式化为 ext4</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mkfs.ext4 ./alpine.rootfs.ext4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 挂载到 /tmp/rootfs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> /tmp/rootfs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">mount</span><span class="token plain"> alpine.rootfs.ext4 /tmp/rootfs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 下载 rootfs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -OJ https://mirrors.aliyun.com/alpine/v3.12/releases/x86_64/alpine-minirootfs-3.12.0-x86_64.tar.gz</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 安装到 /tmp/rootfs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tar</span><span class="token plain"> zxvf alpine-minirootfs-3.12.0-x86_64.tar.gz -C /tmp/rootfs/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>基础 rootfs 还不足以启动系统，因为无法进行系统 init，因此还需要在 rootfs 中安装必要的包启动必要的服务。</p><p>进入 rootfs 之前需要 resolv.conf，包含了 DNS 信息。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 拷贝 dns 配置 - 没有会无法进行 dns 解析</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> /etc/resolv.conf /tmp/rootfs/etc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 如果主机是 alpinelinux 可以从主机拷贝配镜像置文件</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 如果不是建议设置镜像</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># sudo cp /etc/apk/repositories /tmp/rootfs/etc/apk/repositories</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># chroot 进入 rootfs 安装环境</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">chroot</span><span class="token plain"> /tmp/rootfs/ /bin/sh</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>此时进入了 rootfs，因为没有挂载 procfs、sysfs 等目录，并不是一个能完整使用的 rootfs，但对于安装包来说已经足够。</p><ul><li><a href="https://pkgs.alpinelinux.org/package/v3.12/main/x86_64/alpine-base" target="_blank" rel="noopener noreferrer">alpine-base</a><ul><li>基础系统</li><li>依赖了 openrc，layout，busybox，apk，conf 等基础包</li></ul></li><li>linux-virt<ul><li>virt 内核 - 不包含固件（200MB左右），默认 init 包含 virtio 等内核模块</li><li>安装后能获取到内核和 initramfs</li><li>/boot 下 vmlinuz+initramfs+System.map 约 15MB - 启动是不需要的，拿到后可以删除</li></ul></li><li>haveged<ul><li>随机熵服务</li><li>虚拟化环境能更快启动，否则熵初始化可能需要几分钟</li></ul></li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> alpine-base linux-virt haveged</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 开机启动</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rc-update </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> haveged</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root 账号密码</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> root:root </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> chpasswd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 基础服务</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(191, 199, 213)">svc</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> devfs procfs sysfs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">do</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ln</span><span class="token plain"> -fs /etc/init.d/</span><span class="token variable" style="color:rgb(191, 199, 213)">$svc</span><span class="token plain"> /etc/runlevels/boot</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">done</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">exit</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># firecracker 使用 ttyS0</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ln</span><span class="token plain"> -s agetty /etc/init.d/agetty.ttyS0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> ttyS0 </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> /etc/securetty</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rc-update </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> agetty.ttyS0 default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 从 rootfs 获取到 vmlinuz 和 initramfs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> /tmp/rootfs/boot/initramfs-virt initramfs-virt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> /tmp/rootfs/boot/vmlinuz-virt vmlinuz-virt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 取消挂载</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">umount</span><span class="token plain"> /tmp/rootfs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>rootfs 准备完成。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="vmlinuxinitrd"></a>vmlinux+initrd<a class="hash-link" href="#vmlinuxinitrd" title="Direct link to heading">#</a></h2><p>这里解释一下 rootfs 拿到的 Linux 内核 vmlinuz-virt 和初始内存镜像 initramfs-virt</p><ul><li>vmlinuz-virt<ul><li>压缩后的 Linux 内核 - 需要解压后 firecracker 才能识别</li><li>解压后为 ELF 格式可执行文件 - 与一般 Linux 下可执行文件相同</li></ul></li><li>initramfs-virt<ul><li>压缩后的 cpio 格式</li><li>包含了 Linux 内核需要的 virtio 和 ext4 等模块</li><li>包含了 Alpine 的 init 系统<ul><li>加载内核模块</li><li>找到并挂载 rootfs</li></ul></li></ul></li></ul><p>因为内核是压缩后的，因此还需要进行解压</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 下载安装 extract-vmlinux</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> -L -o /usr/local/bin/extract-vmlinux https://raw.githubusercontent.com/torvalds/linux/master/scripts/extract-vmlinux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">chmod</span><span class="token plain"> +x /usr/local/bin/extract-vmlinux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 解压 vmlinuz-virt</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extract-vmlinux vmlinuz-virt </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> vmlinux-virt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="启动"></a>启动<a class="hash-link" href="#启动" title="Direct link to heading">#</a></h2><p>所有准备工作已完成，得到</p><ul><li>alpine.rootfs.ext4 - 系统盘</li><li>vmlinux-virt - 内核</li><li>initramfs-virt - 初始内存镜像</li></ul><p>firecracker 有两种启动方式</p><ol><li>监听端口/socket</li></ol><ul><li>通过调用接口配置 rootfs、内核等</li><li>配置完成后请求 InstanceStart 进行启动</li></ul><ol start="2"><li>通过配置文件配置</li></ol><ul><li>配置文件等同于接口请求</li><li>参数内容和路径与接口一致</li></ul><p>这里使用方法 #2，因为方便书写编辑简单。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 生成 alpine.json 配置</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> </span><span class="token string bash punctuation operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string bash punctuation" style="color:rgb(199, 146, 234)"> alpine.json</span><span class="token string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;boot-source&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;initrd_path&quot;: &quot;initramfs-virt&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;kernel_image_path&quot;: &quot;vmlinux-virt&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;boot_args&quot;: &quot;console=ttyS0 reboot=k panic=1 pci=off modules=virtio_mmio,ext4 rootfstype=ext4&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;drives&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      &quot;drive_id&quot;: &quot;rootfs&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      &quot;path_on_host&quot;: &quot;alpine.rootfs.ext4&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      &quot;is_root_device&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      &quot;is_read_only&quot;: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;machine-config&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;vcpu_count&quot;: 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;mem_size_mib&quot;: 1024,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    &quot;ht_enabled&quot;: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">CONF</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 配置完成 - 启动</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 进入后使用 root:root 登陆</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">firecracker --api-sock /tmp/firecracker.socket --config-file alpine.json</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="停止"></a>停止<a class="hash-link" href="#停止" title="Direct link to heading">#</a></h2><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Firecracker 不能正常关机</h5></div><div class="admonition-content"><p>firecracker 不能使用 poweroff 关机，如果使用了 poweroff 则只能 kill 进程来退出。</p></div></div><p>在系统之外可以请求 <code>Ctrl+Alt+Del</code> 进行关机，实质上是重启的效果，但因为 firecracker 不能重启，因此 init 退出后就关机了。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bash codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> --unix-socket /tmp/firecracker.socket -i </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -X PUT </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://localhost/actions&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -H  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;accept: application/json&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -H  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Content-Type: application/json&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -d </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;{&quot;action_type&quot;: &quot;SendCtrlAltDel&quot;}&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>系统内可以直接 <code>reboot</code> 进行关机。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p>Firecracker 使用起来蛮惊艳，能成功的快速的启动系统，启动速度会比 QEMU 快不少，因为少了 bios、bootloader、内核解压 等过程。</p><p>因为 Firecracker 优缺点非常明显，这里总结一下适用场景：</p><ul><li>serveless 场景 - 需要快速起停，安全隔离，环境独立</li><li>处于安全考虑进行容器执行环境隔离 - 作为容器运行时</li><li>将应用打包为系统进行分发，使用 firecracker 屏蔽系统差异</li></ul><p>不适用场景也很明显：</p><ul><li>如果需要使用 CentOS、Debian、Ubuntu 之类系统，非常不建议<ul><li>构造一个可使用的 rootfs 和 initramfs 非常麻烦</li></ul></li><li>需要用到的设备 firecracker 可能不支持</li><li>需要透传设备到 VM</li></ul><p>Firecracker 相对较新，集成使用方面还有所欠缺，但在 Firecracker 擅长的领域使用起来是非常舒服的。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="参考"></a>参考<a class="hash-link" href="#参考" title="Direct link to heading">#</a></h2><ul><li><a href="https://gist.github.com/wenerme/97a2f088496bb3e6492ef7e8fe23da8a" target="_blank" rel="noopener noreferrer">boot-alpine-in-firecracker.sh</a> - 以上所有代码</li><li><a href="https://github.com/firecracker-microvm/firecracker" target="_blank" rel="noopener noreferrer">firecracker-microvm/firecracker</a> - 核心仓库</li><li><a href="https://github.com/firecracker-microvm/firectl" target="_blank" rel="noopener noreferrer">firecracker-microvm/firectl</a> - Golang 实现用于管理 firecracker 虚拟机的辅助工具</li><li><a href="https://github.com/firecracker-microvm/firecracker-go-sdk" target="_blank" rel="noopener noreferrer">firecracker-microvm/firecracker-go-sdk</a> - Golang 直接操作 Firecracker</li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/story/tags/alpine-linux">AlpineLinux</a><a class="margin-horiz--sm" href="/story/tags/firecracker">Firecracker</a></div></footer></article><div><a href="https://github.com/wenerme/wener/edit/master/story/2020/2020-10-23-alpine-in-firecracker.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/story/rancher-vs-kubesphere"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Rancher vs. Kubesphere</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/story/kubernetes-vs-openstack"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Kubernetes vs OpenStack »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#注意" class="table-of-contents__link">注意</a></li><li><a href="#安装" class="table-of-contents__link">安装</a></li><li><a href="#rootfs" class="table-of-contents__link">rootfs</a></li><li><a href="#vmlinuxinitrd" class="table-of-contents__link">vmlinux+initrd</a></li><li><a href="#启动" class="table-of-contents__link">启动</a></li><li><a href="#停止" class="table-of-contents__link">停止</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li><li><a href="#参考" class="table-of-contents__link">参考</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">笔记</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/notes/java/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/os/alpine/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes/kubernetes">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip/voip">VoIP</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Projects</h4><ul class="footer__items"><li class="footer__item">
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wener/actions" title="wenerme/wener - ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://github.com/wenerme/wener/workflows/Build/badge.svg">
                </a>
              </div>
              </li><li class="footer__item"><a href="https://apis.wener.me" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wener&#x27;s Apis</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/story">Blog</a></li><li class="footer__item"><a href="https://github.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Wener Site" src="/img/wener-logo.svg"></div><div class="footer__copyright">Copyright © 1992-2021 Wener - 构建时间 2021-03-20 01:25</div></div></div></footer></div>
<script src="/styles.daaf3fa9.js"></script>
<script src="/runtime~main.430e3866.js"></script>
<script src="/main.cf7091df.js"></script>
<script src="/1.a5862bf1.js"></script>
<script src="/2.55b1ee95.js"></script>
<script src="/3.a9404c11.js"></script>
<script src="/ccc49370.87535276.js"></script>
<script src="/65eaf7fb.8dc4b144.js"></script>
<script src="/ea95f6a6.d6eca2a3.js"></script>
</body>
</html>