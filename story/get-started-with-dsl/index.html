<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/story/rss.xml" title="Wener Live & Life Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/story/atom.xml" title="Wener Live & Life Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-30404720-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30404720-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30404720-1",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Wener Live & Life" href="/opensearch.xml"><title data-react-helmet="true">如何从0到1实现一门语言 | Wener Live &amp; Life</title><meta data-react-helmet="true" property="og:title" content="如何从0到1实现一门语言 | Wener Live &amp; Life"><meta data-react-helmet="true" name="description" content="语言就是程序员的酒精/Languages are alcohol to programmer。🍺"><meta data-react-helmet="true" property="og:description" content="语言就是程序员的酒精/Languages are alcohol to programmer。🍺"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/styles.f53ced8f.css">
<link rel="preload" href="/styles.4aca93d6.js" as="script">
<link rel="preload" href="/runtime~main.7636200c.js" as="script">
<link rel="preload" href="/main.c6be249c.js" as="script">
<link rel="preload" href="/1.3b32540d.js" as="script">
<link rel="preload" href="/2.0f9894aa.js" as="script">
<link rel="preload" href="/3.28010133.js" as="script">
<link rel="preload" href="/ccc49370.d57437a0.js" as="script">
<link rel="preload" href="/65eaf7fb.dafd68a7.js" as="script">
<link rel="preload" href="/d319ac76.2ba1e520.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Wener</strong></a><a class="navbar__item navbar__link" href="/notes/java/java">笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/story">故事</a><a class="navbar__item navbar__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a><a class="navbar__item navbar__link" href="/notes/tool/network/ip-lookup">工具</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/wener-logo-head.svg" alt="Wener Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Wener</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/notes/java/java">笔记</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/story">故事</a></li><li class="menu__list-item"><a href="https://github.com/wenerme/wener" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/howto/network/dns-prevent-spoofing">指南</a></li><li class="menu__list-item"><a class="menu__link" href="/notes/tool/network/ip-lookup">工具</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/openvox-gw-inside">OpenVox VoxStack 网关分析</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/fix-init-script">记录一次修复 init 脚本的经历</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/alpinelinux-setup-xfce">AlpineLinux 安装 Xfce 桌面</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/why-need-graphql">为什么需要 GraphQL</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/story/understand-baby-vision">理解孩子的视力</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">如何从0到1实现一门语言</h1><div class="margin-vert--md"><time datetime="2019-07-26T00:00:00.000Z" class="blogPostDate_Ta7i">July 26, 2019  · 3 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><section class="markdown"><blockquote><p>语言就是程序员的酒精/Languages are alcohol to programmer。🍺
⏤ wener</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dsl"></a>DSL<a class="hash-link" href="#dsl" title="Direct link to heading">#</a></h2><p>DSL 全名为 Domain-specific Lnaguage/领域特定语言，说到 domain-specific 会不会第一个想到的是 DDD 呢？DDD 中的语言叫做 Ubiquitous Language，即通用语言，指的是在当前 Domain 下使用统一的自然语言进行沟通交流便于上下文的理解和沟通。DSL 的目的是非常类似的，为特定领域实现的语言，目的是为了更加高效便捷的解决特定领域的问题。</p><p>DSL 是领域特定语言，与之相反的语言叫做 General purpose language/通用语言。通用语言均为图灵完备语言，而DSL则不必要具备这样的能力。一个通用语言也有其特定的应用领域，例如 系统编程、Web编程、脚本 等，来区别于其它语言，因此某种程度上来说通用语言也是“DSL”。</p><p><strong>常见的DSL</strong></p><table><thead><tr><th>语言</th><th>领域</th></tr></thead><tbody><tr><td>JSON</td><td>数据交换</td></tr><tr><td>CSS</td><td>样式编排</td></tr><tr><td>SQL</td><td>结构查询</td></tr><tr><td>JSX</td><td>结构化组件</td></tr></tbody></table><p>但无论领域为何，DSL本质是语言，有特定的词法、语法和上下文逻辑。当需要实现一种DSL语言时，需要考虑</p><ul><li>语言的目的</li><li>期望的语法词法</li><li>处理逻辑</li></ul><p>驱动实现一门语言，往往因为</p><ul><li>设计理念不同</li><li>更安全可控 - 限制语言能力</li><li>为应用提供更加灵活的处理能力 - 脚本</li><li>扩展现有语言增强表达能力 - 转译 - JSX、TS</li><li>利用现有的运行环境实现更简洁高效的语言 - Kotlin、Elixir</li><li>能够更快更容易的解决/描述特定领域问题 - DSL</li></ul><p>目的不同驱动实现的方式也各不相同，每种的做法也不尽相同，在这里以实现一个简单的数学计算语言作为演示。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="实现一门语言"></a>实现一门语言<a class="hash-link" href="#实现一门语言" title="Direct link to heading">#</a></h2><ul><li>目的: 实现简单的数值计算，支持基本的三角函数</li><li>语言<ul><li>数学操作支持 加减乘除</li><li>三角函数支持 sin、cos</li><li>运行时数值类型均为双精度浮点数</li></ul></li></ul><p>当语言的基础确定后，需要将语言的语法以某种形式表现出来，表现语言语法的方式也是使用一门语言(♻️😄)。<a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form" target="_blank" rel="noopener noreferrer">EBNF</a> - 扩展巴科斯范式，语法表述如下</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">表达式 = 操作符表达式 | 函数表达式 | 数值</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">操作符表达式 = 表达式 操作符 表达式</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数表达式 = 函数名 ( 表达式 )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">操作符 = + | - | * | /</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">数值 = 一个或多个 数字</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">数字 = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>语法能用通用的 EBNF 表述出来，在各种语言里面有实现类似 EBNF 表达语言语法结构的库，在这里使用 <a href="https://pegjs.org" target="_blank" rel="noopener noreferrer">pegjs</a> 来进行原型验证和实验。</p><p>在 pegjs 的<a href="https://pegjs.org/online" target="_blank" rel="noopener noreferrer">在线Demo</a>我们可以看到已经有一个支持数学运算的语言。现将左侧语法替换为将要实现的语法描述</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">表达式 = 加减表达式</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">加减表达式  = 乘除表达式 ((&#x27;+&#x27; / &#x27;-&#x27;) 乘除表达式)*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">乘除表达式 = 函数表达式 ((&#x27;*&#x27; / &#x27;/&#x27;) 函数表达式)*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数表达式 = 函数名 &#x27;(&#x27; 表达式 &#x27;)&#x27; / 数值</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">数值 = [0-9]+</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数名 = [a-z]+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><blockquote><p>💡 PEG
细心的你可能会发现我们这里定义的语法与 EBNF 有一定区别，例如单独定义了 <code>加减表达式</code>,<code>乘除表达式</code>，并且是自顶向下嵌套的，而不是 EBNF 的 <code>表达式 = 操作符表达式 | 函数表达式 | 数值</code> 一层直接展开。</p><p>之所以书写成这样，是因为 pegjs 是 <a href="https://en.wikipedia.org/wiki/Parsing_expression_grammar" target="_blank" rel="noopener noreferrer">PEG</a> 类的解析器，不能做左递归。该细节涉及到如何实现语言解析和语法的优先级处理，将会在额外的文章中进行阐述解释，并讲解如何实现一个解析语言的语言。</p></blockquote><p>然后在右上输入表达式 <code>sin(1)*2+3</code>, 解析完成后，右下角出现如下 JSON 内容</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;s&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;i&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;n&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;(&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;)&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;3&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>该 JSON 是 pegjs 的输出，在没做任何处理的情况下，也可以理解为语法树。其中每一个数组对应了语法描述中的一个定义。例如 <code>[ &quot;s&quot;, &quot;i&quot;, &quot;n&quot; ], &quot;(&quot;, [ [ [ &quot;1&quot; ], [] ], [] ], &quot;)&quot;</code> 对应语法树中的 <code>函数名 &#x27;(&#x27; 表达式 &#x27;)&#x27;</code>，表示对<code>1</code>执行函数<code>sin</code>。</p><p>为了更好的展示语法树，我们在语法树中调整返回结果</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">表达式 = 加减表达式</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">加减表达式  = a:乘除表达式 b:(op:(&#x27;+&#x27; / &#x27;-&#x27;) right:乘除表达式 {return {type:&#x27;Op&#x27;,op,right}})* {return b.reduce((left,right)=&gt;(right.left=left,right),a)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">乘除表达式 = a:函数表达式 b:(op:(&#x27;*&#x27; / &#x27;/&#x27;) right:函数表达式 {return {type:&#x27;Op&#x27;,op,right}})* {return b.reduce((left,right)=&gt;(right.left=left,right),a)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数表达式 = name:函数名 &#x27;(&#x27; arg:表达式 &#x27;)&#x27; {return {type:&#x27;Func&#x27;,name,arg}} / 数值</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">数值 = [0-9]+ {return {type:&#x27;Int&#x27;,value:parseInt(text())}}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数名 = [a-z]+ {return {type:&#x27;Name&#x27;,name:text()}}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>对同样的表达式 <code>sin(1)*2+3</code> 我们得到的语法树为</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Op&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;op&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;+&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;left&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Op&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token property">&quot;op&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token property">&quot;left&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Func&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sin&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;arg&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Int&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token property">&quot;right&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Int&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;right&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Int&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这时候看上去更像是树的结构，type 为每个节点的类型。</p><ul><li>Func 函数调用节点 - 有 name 和 arg 属性</li><li>Op 数学操作符节点 - 有 op、left、right 属性</li><li>Int 数值节点 - 有 value 属性</li><li>Name 名字节点 - 有 name 属性</li></ul><p>语法结构表现的内容与表达式本身是完全等价的，可认为是程序/计算机理解的表达式，是更加结构化的内容。
语法树会有很多应用场景，因为语法树与表达式等价，也包含了完整的计算逻辑和上下文信息，并且不需要解析器进行解析。可用于生成更加底层的表现形式，也可用于直接执行。场景的场景包含</p><ul><li>生成 IR - 中间形式，便于进行更多后续处理 - .Net、GnuRTL、LLVM</li><li>生成汇编 - 生成能直接在目标平台执行的二进制 - x86</li><li>代码转译 - 利用一定的规则生成非原始类型代码 - Gwt(Java to Js)、java2objc</li><li>代码优化 - 语法树结构比较通用，程序便于处理，可利用公共的规则进行匹配判断</li><li>代码简化 - 在不影响语义的情况下调整代码 - UglifyJs、代码混淆 - 生成原始类型代码</li><li>代码分析 - 静态类型、安全、“坏”代码检测</li><li>代码索引 - 一般生成的语法树节点都可以包含原始代码位置，可实现基于方法或引用等进行快速索引 - sourcegraph</li><li>代码预处理</li><li>...</li></ul><p>表达式转换成语法树，就好比使用机器学习从自然语言中抽取出意图、实体、上下文等信息，是计算机对理解“人”要做什么的第一步。</p><p>既然同样的语法能调整为生成语法树，那么也就能调整为直接计算结果，因此得到如下内容</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">表达式 = 加减表达式</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">加减表达式  = a:乘除表达式 b:((&#x27;+&#x27; / &#x27;-&#x27;) 乘除表达式)* {return b.reduce((r,[o,v])=&gt;o==&#x27;+&#x27;?r+v:r-v,a)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">乘除表达式 = a:函数表达式 b:((&#x27;*&#x27; / &#x27;/&#x27;) 函数表达式)* {return b.reduce((r,[o,v])=&gt;o==&#x27;*&#x27;?r*v:r/v,a)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数表达式 = name:函数名 &#x27;(&#x27; arg:表达式 &#x27;)&#x27; {return Math[name](arg)} / 数值</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">数值 = [0-9]+ {return parseInt(text())}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">函数名 = [a-z]+ {return text()}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>输入表达式 <code>sin(1)*2+3</code>，得到的输出值为 <code>4.6829419696157935</code>。</p><p>至此，一门简单的语言便验证实现完成了。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p>pegjs 是非常方便的工具，但实际在生产中使用时，语法的解析处理需要在个个语言里找类似的实现，当然也可以解析与计算是异构的，例如通过服务端解析完成，下发语法树到客户端进行执行。这也与最近一个 js 标准请求的目的类似,<a href="https://github.com/tc39/proposal-binary-ast" target="_blank" rel="noopener noreferrer">tc39/proposal-binary-ast</a> 希望浏览器能执行二进制的语法树，而不再是每次都进行解析 js，这样的好处是显而易见的。二进制的语法树与汇编/bytecode几乎只有一线之隔，然后这也正是<a href="https://webassembly.org/" target="_blank" rel="noopener noreferrer">webassembly</a>的目的，直接让浏览器执行汇编，😄。语言与运行环境是周而复始迭代的，多么的“自然”。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="附录：常用的语法解析器"></a>附录：常用的语法解析器<a class="hash-link" href="#附录：常用的语法解析器" title="Direct link to heading">#</a></h2><table><thead><tr><th>解析器</th><th>目标语言</th></tr></thead><tbody><tr><td>flex/yacc</td><td>C</td></tr><tr><td>Antlr4</td><td>Java、JS、Python、Switf、C#、C++、Go</td></tr><tr><td>JavaCC</td><td>Java</td></tr><tr><td>pegjs</td><td>JavaScript</td></tr></tbody></table><ul><li><a href="https://github.com/antlr/grammars-v4" target="_blank" rel="noopener noreferrer">https://github.com/antlr/grammars-v4</a><ul><li>其中的 <a href="https://github.com/antlr/grammars-v4/blob/master/dart2/Dart2.g4" target="_blank" rel="noopener noreferrer">Dart2</a> 由我提交</li><li>假如能实现一个针对 Dart2 的 JSX，那么 Flutter 的开发将会更加美好🤩</li></ul></li><li><a href="https://en.wikipedia.org/wiki/Comparison_of_parser_generators" target="_blank" rel="noopener noreferrer">Comparison of parser generators</a></li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/story/tags/开发">开发</a><a class="margin-horiz--sm" href="/story/tags/语言">语言</a></div></footer></article><div><a href="https://github.com/wenerme/wener/edit/master/story/2019/2019-07-26-从0到1实现一门语言.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/story/tt10627720-review"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« 囧 -《哪吒之魔童降世》观后感</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/story/jraphql"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Java with GraphQL »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dsl" class="table-of-contents__link">DSL</a></li><li><a href="#实现一门语言" class="table-of-contents__link">实现一门语言</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li><li><a href="#附录：常用的语法解析器" class="table-of-contents__link">附录：常用的语法解析器</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">笔记</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/notes/java/java">Java</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/os/alpine/alpine">AlpineLinux</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/devops/kubernetes/kubernetes">Kubernates</a></li><li class="footer__item"><a class="footer__link-item" href="/notes/voip/voip">VoIP</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Projects</h4><ul class="footer__items"><li class="footer__item">
              <div>
              <a class="footer__link-item" href="https://github.com/wenerme/wener">Wener</a>
              - <a class="footer__link-item" href="https://github.com/wenerme/wener/actions" title="wenerme/wener - ci">
                <img style="vertical-align: middle;opacity: .4;" src="https://github.com/wenerme/wener/workflows/Build/badge.svg">
                </a>
              </div>
              </li><li class="footer__item"><a href="https://apis.wener.me" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wener&#x27;s Apis</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/story">Blog</a></li><li class="footer__item"><a href="https://github.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/wenerme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Wener Site" src="/img/wener-logo.svg"></div><div class="footer__copyright">Copyright © 1992-2021 Wener - 构建时间 2021-04-04 00:31</div></div></div></footer></div>
<script src="/styles.4aca93d6.js"></script>
<script src="/runtime~main.7636200c.js"></script>
<script src="/main.c6be249c.js"></script>
<script src="/1.3b32540d.js"></script>
<script src="/2.0f9894aa.js"></script>
<script src="/3.28010133.js"></script>
<script src="/ccc49370.d57437a0.js"></script>
<script src="/65eaf7fb.dafd68a7.js"></script>
<script src="/d319ac76.2ba1e520.js"></script>
</body>
</html>