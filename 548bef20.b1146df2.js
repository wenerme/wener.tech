(window.webpackJsonp=window.webpackJsonp||[]).push([[283],{357:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return b})),a.d(t,"metadata",(function(){return i})),a.d(t,"toc",(function(){return c})),a.d(t,"default",(function(){return u}));var n=a(3),r=a(8),l=(a(0),a(899)),b={title:"Keycloak Authz"},i={unversionedId:"service/auth/keycloak-authz",id:"service/auth/keycloak-authz",isDocsHomePage:!1,title:"Keycloak Authz",description:"- \u6388\u6743\u670d\u52a1",source:"@site/notes/service/auth/keycloak-authz.md",slug:"/service/auth/keycloak-authz",permalink:"/notes/service/auth/keycloak-authz",editUrl:"https://github.com/wenerme/wener/edit/master/notes/service/auth/keycloak-authz.md",version:"current",sidebar:"docs",previous:{title:"Kerberos",permalink:"/notes/service/auth/kerberos"},next:{title:"Keycloak \u5ba2\u6237\u7aef",permalink:"/notes/service/auth/keycloak-client"}},c=[{value:"PEP",id:"pep",children:[]},{value:"UMA",id:"uma",children:[]},{value:"Example",id:"example",children:[]}],o={toc:c};function u(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(l.b)("wrapper",Object(n.a)({},o,a,{components:t,mdxType:"MDXLayout"}),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",{parentName:"li",href:"https://www.keycloak.org/docs/latest/authorization_services/"},"\u6388\u6743\u670d\u52a1")),Object(l.b)("li",{parentName:"ul"},"\u8bbf\u95ee\u63a7\u5236\u65b9\u5f0f / Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"ABAC - Attribute-based access control - \u57fa\u4e8e\u5c5e\u6027"),Object(l.b)("li",{parentName:"ul"},"RBAC- Role-based access control - \u57fa\u4e8e\u89d2\u8272"),Object(l.b)("li",{parentName:"ul"},"UBAC - User-based access control - \u57fa\u4e8e\u7528\u6237"),Object(l.b)("li",{parentName:"ul"},"CBAC - Context-based access control - \u57fa\u4e8e\u4e0a\u4e0b\u6587"),Object(l.b)("li",{parentName:"ul"},"Rule-based access control - \u57fa\u4e8e\u89c4\u5219",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u53ef\u4ee5\u4f7f\u7528 JavaScript"))),Object(l.b)("li",{parentName:"ul"},"Time-based access control - \u57fa\u4e8e\u65f6\u95f4"),Object(l.b)("li",{parentName:"ul"},"\u901a\u8fc7\u7b56\u7565 SPI (Service Provider Interface) \u81ea\u5b9a\u4e49\u8bbf\u95ee\u63a7\u5236\u673a\u5236 (ACMs - access control mechanisms)")))),Object(l.b)("table",null,Object(l.b)("thead",{parentName:"table"},Object(l.b)("tr",{parentName:"thead"},Object(l.b)("th",{parentName:"tr",align:null},"abbr"),Object(l.b)("th",{parentName:"tr",align:null},"detail"),Object(l.b)("th",{parentName:"tr",align:null},"role"))),Object(l.b)("tbody",{parentName:"table"},Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"PAP"),Object(l.b)("td",{parentName:"tr",align:null},"Policy Administration Point"),Object(l.b)("td",{parentName:"tr",align:null},"Admin UI")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"PDP"),Object(l.b)("td",{parentName:"tr",align:null},"Policy Decision Point"),Object(l.b)("td",{parentName:"tr",align:null},"Authorization Services")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"PEP"),Object(l.b)("td",{parentName:"tr",align:null},"Policy Enforcement Point"),Object(l.b)("td",{parentName:"tr",align:null},"\u8bf7\u6c42\u62e6\u622a")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"PIP"),Object(l.b)("td",{parentName:"tr",align:null},"Policy Information Point"),Object(l.b)("td",{parentName:"tr",align:null},"\u7b56\u7565\u4fe1\u606f")))),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"\u6388\u6743\u6d41\u7a0b",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u8d44\u6e90\u7ba1\u7406",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u521b\u5efa\u8d44\u6e90\u670d\u52a1 / Resource Server"),Object(l.b)("li",{parentName:"ul"},"\u521b\u5efa\u8d44\u6e90 / Resource",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u4f8b\u5982 URL PATH, UUID, ID"))),Object(l.b)("li",{parentName:"ul"},"\u521b\u5efa\u548c\u5173\u8054\u8d44\u6e90\u57df / Scope",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u4e00\u822c\u5173\u8054 Action+Resource"),Object(l.b)("li",{parentName:"ul"},"\u53ef\u4ee5\u901a\u8fc7\u8d44\u6e90\u5c5e\u6027\u5b9a\u4e49"))))),Object(l.b)("li",{parentName:"ul"},"\u6743\u9650\u548c\u7b56\u7565\u7ba1\u7406",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u521b\u5efa\u7b56\u7565 / Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u4f8b\u5982 \u8981\u6c42\u5339\u914d \u8d44\u6e90\u548c Scope"),Object(l.b)("li",{parentName:"ul"},"\u652f\u6301 JavaScript \u5b9a\u4e49\u7b56\u7565"))),Object(l.b)("li",{parentName:"ul"},"\u5b9a\u4e49\u6743\u9650 / Permission",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Resource + Scope + Policy -> grant/deny"))),Object(l.b)("li",{parentName:"ul"},"\u5e94\u7528\u7b56\u7565\u5230\u6743\u9650"))),Object(l.b)("li",{parentName:"ul"},"Policy Enforcement",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u5728\u670d\u52a1\u4e2d\u6dfb\u52a0\u62e6\u622a\uff0c\u8bf7\u6c42 Keycloak \u8fdb\u884c\u9274\u6743"))))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",{parentName:"li",href:"https://www.keycloak.org/docs/latest/authorization_services/#_service_overview"},"Authorization Services")," - \u6388\u6743\u670d\u52a1 - \u63d0\u4f9b\u63a5\u53e3\u7ed9\u540e\u7aef\u8fdb\u884c\u6743\u9650\u4ea4\u4e92",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Token Endpoint",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Token \u5305\u542b\u7b56\u7565\u4fe1\u606f"),Object(l.b)("li",{parentName:"ul"},"RPT - Requesting Party Token"))),Object(l.b)("li",{parentName:"ul"},"Resource Management Endpoint",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u8d44\u6e90\u7ba1\u7406 - \u521b\u5efa\u3001\u5220\u9664\u3001FindByID\u3001Query"))),Object(l.b)("li",{parentName:"ul"},"Permission Management Endpoint",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Issue Permission Tickets"))))),Object(l.b)("li",{parentName:"ul"},"\u8d44\u6e90/Protection API",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u6ee1\u8db3 ",Object(l.b)("a",{parentName:"li",href:"https://docs.kantarainitiative.org/uma/wg/oauth-uma-federated-authz-2.0-09.html"},"UMA")," \u89c4\u8303\u5b9a\u4e49\u7684\u8d44\u6e90\u6807\u8bc6\u7b26"),Object(l.b)("li",{parentName:"ul"},"\u9700\u8981 uma_protection scope"))),Object(l.b)("li",{parentName:"ul"},"\u6743\u9650/Permission",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"\u6743\u9650\u51b3\u7b56\u7b56\u7565",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Unanimous - \u9ed8\u8ba4 - \u6240\u6709\u90fd\u5141\u8bb8"),Object(l.b)("li",{parentName:"ul"},"Affirmative - \u81f3\u5c11\u4e00\u4e2a\u5141\u8bb8"),Object(l.b)("li",{parentName:"ul"},"Consensus - \u81f3\u5c11\u4e00\u534a\u4ee5\u4e0a\u5141\u8bb8")))))),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre",className:"language-js"},"// \u62d2\u7edd\n$evaluation.deny();\n// \u5141\u8bb8\n$evaluation.grant();\n")),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre",className:"language-java"},"public interface Evaluation {\n\n    /**\n     * Returns the {@link ResourcePermission} to be evaluated.\n     *\n     * @return the permission to be evaluated\n     */\n    ResourcePermission getPermission();\n\n    /**\n     * Returns the {@link EvaluationContext}. Which provides access to the whole evaluation runtime context.\n     *\n     * @return the evaluation context\n     */\n    EvaluationContext getContext();\n\n    /**\n     * Returns a {@link Realm} that can be used by policies to query information.\n     *\n     * @return a {@link Realm} instance\n     */\n    Realm getRealm();\n\n    /**\n     * Grants the requested permission to the caller.\n     */\n    void grant();\n\n    /**\n     * Denies the requested permission.\n     */\n    void deny();\n}\n\npublic interface EvaluationContext {\n    /**\n     * Returns the {@link Identity} that represents an entity (person or non-person) to which the permissions must be granted, or not.\n     *\n     * @return the identity to which the permissions must be granted, or not\n     */\n    Identity getIdentity();\n    /**\n     * Returns all attributes within the current execution and runtime environment.\n     *\n     * @return the attributes within the current execution and runtime environment\n     */\n    Attributes getAttributes();\n}\n")),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Attributes")),Object(l.b)("table",null,Object(l.b)("thead",{parentName:"table"},Object(l.b)("tr",{parentName:"thead"},Object(l.b)("th",{parentName:"tr",align:null},"name"),Object(l.b)("th",{parentName:"tr",align:null},"type"),Object(l.b)("th",{parentName:"tr",align:null},"desc"))),Object(l.b)("tbody",{parentName:"table"},Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.time.date_time"),Object(l.b)("td",{parentName:"tr",align:null},"String"),Object(l.b)("td",{parentName:"tr",align:null},"Current date and time - MM/dd/yyyy hh:mm:ss")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.client.network.ip_address"),Object(l.b)("td",{parentName:"tr",align:null},"String"),Object(l.b)("td",{parentName:"tr",align:null},"IPv4 address of the client")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.client.network.host"),Object(l.b)("td",{parentName:"tr",align:null},"String"),Object(l.b)("td",{parentName:"tr",align:null},"Client\u2019s host name")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.client.id"),Object(l.b)("td",{parentName:"tr",align:null},"String"),Object(l.b)("td",{parentName:"tr",align:null},"The client id")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.client.user_agent"),Object(l.b)("td",{parentName:"tr",align:null},"String[]"),Object(l.b)("td",{parentName:"tr",align:null},"The value of the 'User-Agent' HTTP header")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"kc.realm.name"),Object(l.b)("td",{parentName:"tr",align:null},"String"),Object(l.b)("td",{parentName:"tr",align:null},"The name of the realm")))),Object(l.b)("h2",{id:"pep"},"PEP"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",{parentName:"li",href:"https://www.keycloak.org/docs/latest/authorization_services/#_enforcer_overview"},"Policy Enforcers"))),Object(l.b)("h2",{id:"uma"},"UMA"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",{parentName:"li",href:"https://www.keycloak.org/docs/latest/authorization_services/index.html#_service_authorization_uma_policy_api"},"Managing Resource Permissions using the Policy API"))),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre"},"http://${host}:${port}/auth/realms/${realm_name}/authz/protection/uma-policy/{resource_id}\n")),Object(l.b)("h2",{id:"example"},"Example"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("a",{parentName:"li",href:"https://github.com/keycloak/keycloak-quickstarts/blob/latest/app-authz-uma-photoz/photoz-realm.json"},"https://github.com/keycloak/keycloak-quickstarts/blob/latest/app-authz-uma-photoz/photoz-realm.json"))),Object(l.b)("table",null,Object(l.b)("thead",{parentName:"table"},Object(l.b)("tr",{parentName:"thead"},Object(l.b)("th",{parentName:"tr",align:null},"Resource"),Object(l.b)("th",{parentName:"tr",align:null},"Type"),Object(l.b)("th",{parentName:"tr",align:null},"URI"),Object(l.b)("th",{parentName:"tr",align:null},"Scopes"))),Object(l.b)("tbody",{parentName:"table"},Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"Admin Resources"),Object(l.b)("td",{parentName:"tr",align:null},Object(l.b)("a",{parentName:"td",href:"http://photoz.com/admin"},"http://photoz.com/admin")),Object(l.b)("td",{parentName:"tr",align:null},Object(l.b)("inlineCode",{parentName:"td"},"/admin/*")),Object(l.b)("td",{parentName:"tr",align:null},"admin:manage")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"User Profile Resource"),Object(l.b)("td",{parentName:"tr",align:null},Object(l.b)("a",{parentName:"td",href:"http://photoz.com/profile"},"http://photoz.com/profile")),Object(l.b)("td",{parentName:"tr",align:null},"/profile"),Object(l.b)("td",{parentName:"tr",align:null},"profile:view")),Object(l.b)("tr",{parentName:"tbody"},Object(l.b)("td",{parentName:"tr",align:null},"Album Resource"),Object(l.b)("td",{parentName:"tr",align:null},Object(l.b)("a",{parentName:"td",href:"http://photoz.com/album"},"http://photoz.com/album")),Object(l.b)("td",{parentName:"tr",align:null},Object(l.b)("inlineCode",{parentName:"td"},"/album/*")),Object(l.b)("td",{parentName:"tr",align:null},"album:delete",Object(l.b)("br",null),"album:view")))),Object(l.b)("p",null,Object(l.b)("strong",{parentName:"p"},"Policies")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Only Owner and Administrators Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=aggregate AFFIRMATIVE"),Object(l.b)("li",{parentName:"ul"},"Administration Policy,Only Owner Policy"))),Object(l.b)("li",{parentName:"ul"},"Administration Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=aggregate"),Object(l.b)("li",{parentName:"ul"},"Any Admin Policy,Only From a Specific Client Address"))),Object(l.b)("li",{parentName:"ul"},"Only Owner Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"script-only-owner.js"))),Object(l.b)("li",{parentName:"ul"},"Any Admin Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=role logic=POSITIVE"),Object(l.b)("li",{parentName:"ul"},"roles=admin"))),Object(l.b)("li",{parentName:"ul"},"Only From a Specific Client Address",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"script-only-keycloak-domain-or-admin.js"))),Object(l.b)("li",{parentName:"ul"},"Any User Policy",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=role logic=POSITIVE"),Object(l.b)("li",{parentName:"ul"},"roles=user,photoz-restful-api/manage-albums"))),Object(l.b)("li",{parentName:"ul"},"Admin Resource Permission",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=resource logic=POSITIVE"),Object(l.b)("li",{parentName:"ul"},"defaultResourceType=",Object(l.b)("a",{parentName:"li",href:"http://photoz.com/admin"},"http://photoz.com/admin")),Object(l.b)("li",{parentName:"ul"},"default=true"))),Object(l.b)("li",{parentName:"ul"},"Album Resource Permission",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=scope logic=POSITIVE"),Object(l.b)("li",{parentName:"ul"},"scopes=album:view,album:delete"),Object(l.b)("li",{parentName:"ul"},"resources=Album Resource"))),Object(l.b)("li",{parentName:"ul"},"View User Permission",Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"type=scope logic=POSITIVE"),Object(l.b)("li",{parentName:"ul"},"scopes=profile:view")))))}u.isMDXComponent=!0},899:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return O}));var n=a(0),r=a.n(n);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function b(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?b(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):b(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=r.a.createContext({}),u=function(e){var t=r.a.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=u(e.components);return r.a.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},s=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,b=e.parentName,o=c(e,["components","mdxType","originalType","parentName"]),p=u(a),s=n,O=p["".concat(b,".").concat(s)]||p[s]||m[s]||l;return a?r.a.createElement(O,i(i({ref:t},o),{},{components:a})):r.a.createElement(O,i({ref:t},o))}));function O(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,b=new Array(l);b[0]=s;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:n,b[1]=i;for(var o=2;o<l;o++)b[o]=a[o];return r.a.createElement.apply(null,b)}return r.a.createElement.apply(null,a)}s.displayName="MDXCreateElement"}}]);